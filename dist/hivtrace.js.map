{"version":3,"sources":["webpack:///./src/entry.js","webpack:///./~/font-awesome/css/font-awesome.css","webpack:///./src/hivtrace.css","webpack:///./src/hivtrace.js","webpack:///./~/bootstrap/dist/css/bootstrap.css","webpack:///./src/clusternetwork.js","webpack:///./src/misc.js","webpack:///./src/helpers.js","webpack:///./~/downloadjs/download.js","webpack:///./src/scatterplot.js","webpack:///./~/topojson/dist/topojson.node.js","webpack:///./~/topojson-client/dist/topojson-client.js","webpack:///./~/topojson-server/dist/topojson-server.js","webpack:///./~/topojson-simplify/dist/topojson-simplify.js","webpack:///./src/histogram.js"],"names":["window","require","hivtrace","misc","helpers","module","d3","_","scatterPlot","topojson","_networkGraphAttrbuteID","_networkNodeAttributeID","_networkNodeIDField","_networkMissing","_networkMissingOpacity","_networkMissingColor","_networkContinuousColorStops","_networkShapeOrdering","_defaultFloatFormat","_defaultPercentFormat","_defaultDateFormats","_defaultDateViewFormat","_defaultDateViewFormatShort","_defaultDateViewFormatSlider","_networkDotFormatPadder","_networkCategoricalBase","_networkCategorical","_maximumValuesInCategories","_networkSequentialColor","_networkPresetColorSchemes","trans_categ","Missing","Perinatal","race","missing","White","_networkPresetShapeSchemes","birth_sex","Male","Female","Unknown","Asian","current_gender","hivtrace_cluster_depthwise_traversal","clusters","adjacency","by_node","seed_nodes","n","edges","nodes","e","console","traverse","node","save_edges","neighbor","_networkUpperBoundOnDate","_networkCDCDateField","hivtrace_cluster_network_graph","json","self","options","cdc_extra","description","value","sort","c","help","generator","html","cluster","format","v","presort","str","color","callback","this_cell","data_to_use","payload","buttons","button_text","button_obj","selected","d","id","shaper","top","right","bottom","left","size","filter","date","subcluster_enum","_n_months_ago","depends","label","enum","type","volatile","color_scale","map","binned_vl_recent_value","vl_value","recent_rapid","subcluster_index","age_dx","hiv_aids_dx_dt_year","label_format","range_without_missing","attr","parsed_value","passed","f","handle_cluster_click","container","menu_object","already_fixed","center_cluster_handler","show_on_map_enabled","release","countryCodeAlpha2","countries","countryOutlines","mapsvg","path","countryCodeNumeric","event_handler","network","attr_desc","base_line","font_size","rect_size","width","height","colorizer","prefix","barchart","drag","x","y","export_items","$","additional_options","filtered_json","_extract_single_cluster","custom_filter","jQuery","extra_menu","title","items","custom_name","random_id","s","i","letters","random_prefix","random_tab_id","random_content_id","random_button_bar","tab_container","content_container","go_here_when_closed","new_tab_header","new_link","new_tab_content","option_extras","new_button_bar","cluster_options","no_cdc","secondary","draw_map","other_code","cluster_view","not_nested","handle_node_click","collapse_cluster_handler","mapped_clusters","get_all_clusters","d_clusters","children","cluster_id","treemap","Math","b","a","graphMe","expandedClusters","drawnNodes","hxb2_exists","field_def","custom_edge_filter","extra_menu_items","enclosure","item","set_date","past_date","past_months","diff_year","months","left_over","oldest_nodes_first","date_field","node1_dx","node2_dx","n1","n2","start_date","filter_by_date","node_dx","cutoff_long","cutoff_short","node_iterator","beginning_of_time","filter_result","split_clusters","node_id_to_local_cluster","Nodes","Edges","edge","edge_cluster","source_id","target_id","copied_edge","array_index","subclusters","cluster_nodes","cc","es","c1","c2","parent_cluster","distances","_compute_cluster_degrees","subcluster_json","sub","rr_cluster","priority_nodes","recent_cluster","init_layout","get_initial_xy","coordinate_update","set_init_coords","network_layout","x_scale","delta","y_scale","rescale_x","rescale_y","neighborhood_size","a_node","neighborhood","counter","worker","event","node_to_update","worker_obj","estimate_cubic_compute_cost","memo","cluster_size","a_cluster","member_nodes","triads","triangles","my_neighbors","connected_links","total","graph_data","result","allowed_types","String","Date","Number","return_array","string_id","the_list","column_ids","binned","column","sorted_keys","attribute_record","attribute_list","patient_record","patient_list","group_by_id","button_clicked","link_clicked","modal","cluster_ui_container","fix_handler","obj","layout_reset_handler","fixed","default_layout","cluster_commands","handler_callback","button_group","change_spacing","change_window_size","filter_value","distance_threshold","parseFloat","render_binned_table","attributes","singletons","compute_node_degrees","extra_ui_container","valid_cats","valid_shapes","valid_scales","low_var","bins","scl","mean","values","vrnc","p","determine_scaling","a_date","inject_attribute_node_value_by_id","m","menu_items","_menu_label_gen","cat_menu","j","the_cluster","compute_cluster_gradient","attribute_map","index","range","computed","extension","sorted_array","k","warning_string","sorted_state","sort_table_toggle_icon","table_element","sort_on","parseInt","sort_key","datum","sorted_function","sort_accessor","val","this_sel","current_value","data","handle_sort","repr","clicker","sort_table_by_column","thead","tbody","format_a_cell","_is_subcluster","labels","expand_cluster","collapse_cluster","cluster_json","map_to_id","given_json","include_extra_edges","ne","node_list","cd","node_data","table_headers","dropdown","menu_id","dropdown_button","dropdown_list","alt","handle_change","table_rows","headers","rows","this_row","ed","add_a_sortable_table","skip_clusters","skip_subclusters","element","make_row","_cluster_table_draw_id","actual_cluster","is_subcluster","length","clusters_shown","clusters_removed","nodes_removed","clusters_selected","nodes_selected","symbol_type","node_size","node_color","node_opacity","container_group","draw_from","sums","running_totals","startAngle","endAngle","name","rim","arc_radius","cluster_box_size","paths","cluster_color","cat_id","domain","set_attr","lbl","domain_range","check_for_predefined_shapes","shape_mapper","determine_label_format_cont","field_data","offset","anchor_format","scale","gradient","finite","infinite","render_chord_diagram","func","points","src","tgt","stratify","attribute_cluster_distribution","extended_range","arg","attribute_pairwise_distribution","anything_changed","conditions","did_match","regexp","warning_box","pull","dist_x","dist_y","theta","alpha","dx","dx2","dy","dy2","s1","s2","draw_me","update_network_string","edge_set","tag","step","link","rendered_nodes","rendered_clusters","parent_cluster_id","subcluster_id","meta_data","stats","subcluster","recent_nodes","priority_score","draw_a_node","draw_a_cluster","currently_displayed_objects","sizes","xBoundLower","xBoundUpper","yBoundLower","yBoundUpper","allowed_offset_from_center_of_country","country_code","center","new_attr","r","key","attribute","toggle_tooltip","node_info_string","edge_info_string","by_cluster","cls","idx","open_cluster_queue","compute_cluster_centroids","the_table","matrix","fill","lookup","the_map","sum","text_label","t","svg","chord","text_offset","innerRadius","outerRadius","fade","scan_from","only_expanded","the_matrix","haz_null","dim","d2","string_hash","hash","ci","charCode","hashed","available_keys","reindexed","first_try","second_try","last_resort","attribute_id","attr_info","cluster_info_string","new_nodes","leftover","sequences","degrees","use_these_nodes","node_filter","series","time","subset","condition","dict","stratified","array","annotation","edge_types_dict","existing_nodes","injected_nodes","node_attributes","existing_network_nodes","node_name_2_id","handle_node_attributes","attribute_key","inject_new_node","new_node","node_class","node_annotation","degree","nodes_and_attributes","index_id","attribute_definition","edges_and_attributes","auto_inject","new_edge","source","target","edge_type","directed","JSON","edge_types_by_cluster","edge_clusters","edge_types_by_cluster_sorted","my_keys","edge_types","_edge_colorizer","_social_view_options","init_code","def_color","caption","types","checkbox","edge_class","_social_view_handler","_injected_column_subcluster_button_handler","subcluster_edges","direct_links_only","edge_filter","labeled_links","shown_types","cv","injected_column_subcluster","node_ids","injected_column","other_clusters","directly_linked_ids","cluster_report","recomputed_clusters","cluster_ids","injected_count","cluster_count","existing_cluster","turn_on","this_box","this_data","l_scale","max_points_to_render","gravity_scale","legend_vertical_offset","initial_json_load","hivtrace_cluster_graph_summary","summary_table","table_data","graph","columns","adjacency_list","seq_ids","in_nodes","hivtrace_generate_svg_polygon_lookup","angle_step","hivtrace_generate_svg_ellipse","hivtrace_generate_svg_polygon","current_angle","all_paths","next","intermediate","paths_i_k","hivtrace_get_path","paths_k_j","i_k_index","i_k","k_j_index","k_j","sublist","num_nodes","hivtrace_cluster_adjacency_list","Object","node_count","empty_arr","zeroes","index2","second_node","index_i","n_i","index_j","n_j","distances2","index_k","n_k","d_ik","d_jk","d_ij","ordering","node_obj","nodes_in_cluster","edges_in_cluster","filtered_obj","cb","hivtrace_compute_shortest_paths_with_reconstruction","betweenness","hivtrace_compute_betweenness_centrality","hivtrace_filter_to_node_in_cluster","paths_with_node","hivtrace_paths_with_node","unique_clusters","cb_count","hivtrace_get_node_by_id","results","hivtrace_betweenness_centrality_all_nodes_in_cluster","hivtrace_compute_node_degrees","hivtrace_compute_cluster_betweenness","node_array","hivtrace_is_contaminant","node_csv","pom","document","encodeURIComponent","the_button","table_tag","table_text","hivtrace_compute_local_clustering_coefficients","hivtrace_new_cluster_adjacency_list","formatter","time_series","do_barchart","skip_cumulative","bin_by","year","nearest_quarter","mid_point","quarter","min_diff","x_tick_format","xAxis","yAxis","values_by_attribute","total_id","total_color","max_bin","bin_tag","point","binned_array","min_x","max_x","max_x2","legend_area","y_key","plot_types","on_off","legend_lines","opacity_toggle","last","plot_color","y_accessor","plot_key","bin_accessor","curve","dd","dd2","xc","w","last_y","new_y","curve_year","x_axis","download","datamonkey_error_modal","img","canvas","ctx","blob","onsuccess","datamonkey_export_csv_button","datamonkey_save_image","xmlns","xlink","ss","rule","process_stylesheet","styles","styleSheets","doc","convert_svg_to_png","image","context","get_styles","defsEl","styleEl","rect","doctype","to_download","image_string","navigator","b64toBlob","url","datamonkey_validate_date","class","text","isNaN","processStyleSheet","top_modal_container","nwk","tree_container","datamonkey_get_styles","datamonkey_convert_svg_to_png","regex","span","vector","min","max","median","Q1","Q3","ua","msie","IEwindow","filename","mimeType","sep","header_row","extract_text","first_element","table_id","data_rows","accessor","predicate","transform","margin","h","dates","histogram_svg","y_axis","defaultFloatFormat","histogram_w","histogram_h","hivtrace_render_histogram","edge_lengths","hivtrace_render_histogram_continuous","histogram_data","histogram_line","counts","data_to_plot","fit_line","exports"],"mappings":";;;;;;;;;;;;;AAAAA,iBAAgBA,WAAhBA;;AAEA,oBAAAC,CAAA,CAAAA;AACA,oBAAAA,CAAA,EAAAA;AACA,oBAAAA,CAAA,EAAAA;;AAEA,KAAIC,WAAW,mBAAAD,CAAf,EAAeA,CAAf;;AAEA;AACAD,4B;;;;;;;;;;ACTA,0C;;;;;;;;;;;;;;;ACAA,0C;;;;;;;;;;;;;;;;;;;;;;;;;;ACCA;;AACA;;AACA;;;;AAEA,KAAIG,OAAO,mBAAAF,CAAX,EAAWA,CAAX;AACA,KAAIG,UAAU,mBAAAH,CAAd,EAAcA,CAAd;;AAEAI;AACAA;AACAA;AACAA;AACAA;AACAA;AACAA,uD;;;;;;ACdA,0C;;;;;;;;;;;;;;ACAA,KAAIC,KAAK,mBAAAL,CAAT,EAASA,CAAT;AAAA,KACEM,IAAI,mBAAAN,CADN,EACMA,CADN;AAAA,KAEEE,OAAO,mBAAAF,CAFT,EAESA,CAFT;AAAA,KAGEG,UAAU,mBAAAH,CAHZ,EAGYA,CAHZ;AAAA,KAIEO,cAAc,mBAAAP,CAJhB,EAIgBA,CAJhB;AAAA,KAKEQ,WAAW,mBAAAR,CALb,EAKaA,CALb;;AAOA,KAAIS,0BAAJ;AACA,KAAIC,0BAAJ;AACA,KAAIC,sBAAJ;AACA,KAAIC,kBAAJ;AACA,KAAIC,yBAAJ;AACA,KAAIC,uBAAJ;AACA,KAAIC,+BAAJ;AACA,KAAIC,wBAAwB,0EAA5B,UAA4B,CAA5B;;AAWA,KAAIC,sBAAsBZ,UAA1B,MAA0BA,CAA1B;AACA,KAAIa,wBAAwBb,UAA5B,MAA4BA,CAA5B;AACA,KAAIc,sBAAsB,CACxBd,eADwB,uBACxBA,CADwB,EAExBA,eAFF,uBAEEA,CAFwB,CAA1B;;AAKA,KAAIe,yBAAyBf,eAA7B,WAA6BA,CAA7B;AACA,KAAIgB,8BAA8BhB,eAAlC,OAAkCA,CAAlC;AACA,KAAIiB,+BAA+BjB,eAAnC,UAAmCA,CAAnC;AACA,KAAIkB,0BAA0BlB,UAA9B,KAA8BA,CAA9B;;AAEA,KAAImB,0BAA0B,0HAA9B,SAA8B,CAA9B;;AAeA,KAAIC,sBAAJ;;AAEAnB,QAAO,IAAI,CAAJ,KAAPA,GAAO,CAAPA,EAAuB,aAAY;AACjCA,mCAAgC,aAAY;AAC1CmB,8BAAyBpB,oBAAzBoB,QAAyBpB,EAAzBoB;AADFnB;AADFA;;AAMA,KAAIoB,6BAA6BD,oBAAjC;;AAEA,KAAIE,0BAA0B;AAC5B,MAAG,YADyB,SACzB,CADyB;AAE5B,MAAG,uBAFyB,SAEzB,CAFyB;AAG5B,MAAG,kCAHyB,SAGzB,CAHyB;AAI5B,MAAG,6CAJyB,SAIzB,CAJyB;AAK5B,MAAG,wDALyB,SAKzB,CALyB;AAM5B,MAAG,mEANyB,SAMzB,CANyB;AAe5B,MAAG,8EAfyB,SAezB,CAfyB;AAyB5B,MAAG;AAzByB,EAA9B;;AAsCA,KAAIC,6BAA6B;AAC/BC,gBAAa;AACX,iBADW;AAEX,wBAFW;AAGX,kCAHW;AAIX,oCAJW;AAKX,yCALW;AAMX,iBANW;AAOX,uBAPW;AAQX,mBARW;AASX,wBATW;AAUX,2BAVW;AAWX,6BAXW;AAYX,mBAZW;AAaX,qBAbW;AAcXC,cAdW;AAeX,SAfW;AAgBX,kCAhBW;AAiBXC,gBAjBW;AAkBX,4BAlBW;AAmBX,oBAAe;AAnBJ,IADkB;AAsB/BC,SAAM;AACJ,cADI;AAEJ,+BAFI;AAGJ,wBAHI;AAIJ,sCAJI;AAKJ,+CALI;AAMJ,uBANI;AAOJ,qBAPI;AAQJF,cARI;AASJG,cATI;AAUJC,YAAO;AAVH;AAtByB,EAAjC;;AAoCA,KAAIC,6BAA6B;AAC/BC,cAAW;AACTC,WADS;AAETC,aAFS;AAGTR,cAHS;AAITG,cAJS;AAKTM,cAAS;AALA,IADoB;AAQ/BP,SAAM;AACJQ,YADI;AAEJ,+BAFI;AAGJ,wBAHI;AAIJ,sCAJI;AAKJ,+CALI;AAMJ,uBANI;AAOJ,qBAPI;AAQJV,cARI;AASJG,cATI;AAUJC,YAAO;AAVH,IARyB;AAoB/BO,mBAAgB;AACdJ,WADc;AAEdC,aAFc;AAGd,mCAHc;AAId,mCAJc;AAKd,mCALc;AAMdC,cANc;AAOdT,cAPc;AAQdG,cAAS;AARK;AApBe,EAAjC;;AAgCA;;;AAGA;;;AAGA,KAAIS,uCAAuC,SAAvCA,oCAAuC,oDAMzC;AACA,OAAIC,WAAJ;AAAA,OACEC,YADF;AAAA,OAEEC,UAFF;;AAIAC,gBAAaA,cAAbA;;AAEAxC,iBAAc,aAAY;AACxByC;AACAH,eAAUG,EAAVH;AAFFtC;;AAKA,oBAAiB;AACf0C,aAAQ1C,gBAAR0C,WAAQ1C,CAAR0C;AACD;;AAED1C,iBAAc,aAAY;AACxB,SAAI;AACFsC,iBAAUK,MAAMC,EAAND,QAAVL,SAAmC,CAACK,MAAMC,EAAP,MAACD,CAAD,EAAnCL,CAAmC,CAAnCA;AACAA,iBAAUK,MAAMC,EAAND,QAAVL,SAAmC,CAACK,MAAMC,EAAP,MAACD,CAAD,EAAnCL,CAAmC,CAAnCA;AAFF,OAGE,YAAY;AACZO,mBACE,2CAA2CD,EAA3C,kBAA+DA,EADjEC;AAGA,aAAM,2CACJD,EADI,kBAGJA,EAHF;AAID;AAZH5C;;AAeA,OAAI8C,WAAW,SAAXA,QAAW,OAAe;AAC5B,SAAI,EAAEC,WAAN,OAAI,CAAJ,EAA2B;AACzBV,qBAAc,CAAdA,IAAc,CAAdA;AACAE,eAAQQ,KAARR,MAAmBF,kBAAnBE;AACA,uBAAgB;AACdS;AACD;AACF;AACDD;;AAEA/C,YAAOsC,UAAUS,KAAjB/C,EAAOsC,CAAPtC,EAA2B,oBAAmB;AAC5C,WAAI,CAACiD,YAAL,SAA0B;AACxBV,iBAAQU,YAARV,MAA0BA,QAAQQ,KAAlCR,EAA0BA,CAA1BA;AACAF,kBAASE,QAAQU,YAAjBZ,EAASE,CAATF,OAAuCY,SAAvCZ,CAAuCY,CAAvCZ;AACA,yBAAgB;AACdW,sBAAWT,QAAQU,YAAnBD,EAAWT,CAAXS,OAAyCC,SAAzCD,CAAyCC,CAAzCD;AACD;AACDF,kBAASG,SAATH,CAASG,CAATH;AACD;AARH9C;AAVF;;AAsBAA,sBAAmB,aAAY;AAC7B,SAAI,CAACyC,EAAL,SAAgB;AACdK;AACD;AAHH9C;;AAMA;AAjEF;;AAoEA,KAAIkD,2BAA2B,WAA/B,WAA+B,EAA/B;AACA,KAAIC,uBAAJ;;AAEA,KAAIC,iCAAiC,SAAjCA,8BAAiC,8KAYnC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,OAAI,CAACC,KAAL,uBAAKA,CAAL,EAAoC;AAClCA;AACD;;AAED;AACAA,sBAAmB,aAAY;AAC7B,SAAG,CAACZ,EAAJ,uBAAIA,CAAJ,EAAgC;AAC9BA;AACD;AAHHY;;AAMA,OAAIC,OAAJ;;AAEAA,mBAAgBC,WAAWA,QAAXA,QAAWA,CAAXA,WAAhBD;AACAA,aACEC,WAAWA,QAAXA,OAAWA,CAAXA,GACIA,QADJA,OACIA,CADJA,GAEIxD,qCAHNuD,aAGMvD,CAHNuD;AAIAA;AACAA;AACAA;AACAA;AACAA;AACAA;AACAA;AACAA;;AAGA,OAAIC,WAAWvD,aAAauD,QAA5B,WAA4BA,CAAbvD,CAAf,EAAmD;AACjDuD;AACD;;AAEDD,qBACEC,WAAWA,QAAXA,QAAWA,CAAXA,GAA+BA,QAA/BA,QAA+BA,CAA/BA,GADFD;AAEAA,sCACEC,WAAWA,QAAXA,uBAAWA,CAAXA,GACIA,QADJA,uBACIA,CADJA,GADFD;;AAKAA;;AAEA,OAAIA,KAAJ,UAAmB;;AAEjBA,kCAA6B,+DAA7BA,eAA6B,CAA7BA;;AAEAA,6BACEC,WAAWA,QAAXA,kBAAWA,CAAXA,GACIxD,UAAUwD,QADdA,kBACcA,CAAVxD,CADJwD,GADFD;;AAKAA;;AAEA,SAAIE,YAAY,CACd;AACEC,oBAAa;AACXC,gBADW;AAEXC,eAAM,iBAAY;AAChB,kBAAOC,iBAAiBA,QAAjBA,CAAiBA,CAAjBA,GAAP;AAHS;AAKXC,eAAM;AALK,QADf;AAQEC,kBAAW,4BAAkB;AAC3B,gBAAO;AACLC,iBADK;AAELL,kBAAOM,QAFF;AAGLC,mBAAQ,mBAAY;AAClBC,iBAAIA,KAAJA;AACA,iBAAIA,EAAJ,QAAc;AACZ,sBAAOA,OAAP,IAAOA,CAAP;AADF,oBAEO;AACL;AACD;AACF;AAVI,UAAP;AAYD;AArBH,MADc,EAwBd;AACET,oBAAa;AACXC,gBADW;AAEXC,eAAM;AACJ,0BAAY;AACV,eAAIO,IAAIN,WAAR;AACA,kBAAOM,eAAeA,EAAfA,CAAeA,CAAfA,GAAP;AALO;AAOXC,kBAPW;AAQXN,eACE;AATS,QADf;AAYEC,kBAAW,4BAAkB;AAC3B,gBAAO;AACLC,iBADK;AAELL,kBAAOM,QAFF;AAGLC,mBAAQ,mBAAY;AAClBC,iBAAIA,KAAJA;AACA,iBAAIA,EAAJ,QAAc;AACZ,mBAAIE,MAAMF,OAAV,IAAUA,CAAV;AACA,mBAAIA,QAAJ,GAAe;AACb,qBAAIG,QAAQH,oBAAZ;AACA,wBACE,6CADF;AAGD;AACD;AACD;AACD;AACD;AAhBI,UAAP;AAkBD;AA/BH,MAxBc,CAAhB;;AA2DA,SAAIZ,KAAJ,kBAA2B;AACzBA;AADF,YAEO;AACL,WAAIA,KAAJ,6BAAsC;AACpCA,4CAAmCA,wCAAnCA,SAAmCA,CAAnCA;AADF,cAIO;AACLA;AACD;AACF;AACF;;AAEDA,mCACEC,WAAWA,QAAXA,oBAAWA,CAAXA,GACIA,QADJA,oBACIA,CADJA,GAEI,gBACE,CACE;AACEE,kBAAa;AACXC,cADW;AAEXC,aAFW;AAGXE,aACE;AAJS,MADf;AAOEC,gBAAW,yBAAe;AACxB,cAAO;AACLQ,mBAAU,oCAA2B;AACnC;AACA,eAAIC,YAAYxE,UAAhB,OAAgBA,CAAhB;;AAEA,eAAIyE,cAAc,CAChB,CAACC,WAAD,CAACA,CAAD,EAAgBA,WAAhB,CAAgBA,CAAhB,EAA+BA,WADf,CACeA,CAA/B,CADgB,EAEhB,CAACA,8BAAD,IAAmCA,WAFnB,CAEmBA,CAAnC,CAFgB,EAGhB,CAACA,8BAAD,IAAmCA,WAHnB,CAGmBA,CAAnC,CAHgB,EAIhB,CACEA,sBAAsBA,WAAtBA,CAAsBA,CAAtBA,0BADF,IAIEA,qBAAqBA,WAArBA,CAAqBA,CAArBA,GARJ,IAIE,CAJgB,CAAlB;;AAYA,eAAIC,UAAUH,4BAAd,MAAcA,EAAd;;AAEAvE,+BAAoB,uBAAsB;AACxC;AACA,iBAAI2E,eAAJ,QAA2B;AACzB,mBAAIC,aAAaL,+EAGNI,YAHMJ,CAGNI,CAHMJ,aAITI,YAJR,CAIQA,CAJSJ,CAAjB;;AAMA,mBAAIvE,aAAa2E,YAAjB,CAAiBA,CAAb3E,CAAJ,EAAkC;AAChC4E,wCAAuBD,YAAvBC,CAAuBD,CAAvBC;AADF,sBAEO;AACLA;AACD;AACF;AAdH5E;AAnBG;AAoCL0D,gBAAO,iBAAW;AAChB,kBAAO,CACL,CACEX,wBAAwB,gBAAgBA,KAAxCA,mBADF,mBAGE,wBACI,YAAW;AACTO,kCACEP,KADFO,kBAEE,aAAY;AACV,sBAAOb,sBAAsBM,KAA7B;AAHJO,gBAKE,gBAAgBP,KALlBO;AAFN,eAJG,IACL,CADK,EAiBL,CAACP,sBAAD,GAjBK,aAiBL,CAjBK,EAkBL,CAACA,sBAAD,GAlBK,YAkBL,CAlBK,EAmBL,CAACA,sBAAD,GAnBF,YAmBE,CAnBK,CAAP;AAqBD;AA1DI,QAAP;AA4DD;AApEH,IADF,CADF,GAHNO;;AA8EAA,oBAAiB;AACfuB,eAAU,qBAAY;AACpB,cAAOC,kBAAkB/E,gBAAlB+E,GAAkB/E,CAAlB+E,GAAP;AACD;AAHc,IAAjBxB;;AAMAA,+BACEC,WAAWA,QAAXA,sBAAWA,CAAXA,GACIA,QADJA,sBACIA,CADJA,GADFD;;AAKAA,gBAAaC,WAAWA,QAAXA,OAAWA,CAAXA,GAA8BA,QAA9BA,OAA8BA,CAA9BA,GAAiD,IAA9DD,IAA8D,EAA9DA;;AAEAA,sBAAmB;AACjByB,SADiB;AAEjBC,aAAQ,kBAAW;AACjB;AACD;AAJgB,IAAnB1B;;AAOCA,uBAAD,IAACA,EAA4BA,iBAA7B,KAACA,EAAsDA,yBAAvD,CAACA,EAAoFA,cAAc;AACjG2B,UADiG;AAEjGC,YAFiG;AAGjGC,aAHiG;AAIjGC,WAAM;AAJ2F,IAAlG9B,EAKIA,aACHA,UAAUA,YAAVA,OAA6BA,YAN/B,KAACA,EAMmDA,cAClDA,iBAPF,EAACA,EAOwBA,qBAAqBvD,UAP9C,cAO8CA,CAP7CuD,EASIA,kBAAkBvD,UATvB,WASuBA,CATtBuD,EAWIA,uBAXL,KAACA,EAWoCA,YAXrC,IAACA,EAWwDA,uBAXzD,KAACA,EAWwFA,sCAXzF,KAACA,EAWuIA,mBAXxI,CAACA;;AAaDA,8BAA2B,mBAAmB;AAC1C,SAAIC,WAAW,qBAAf,SAA6C;AACvCD,4BAAqBvD,4BAA4B,CAACuD,mBAAmBA,aAApB,GAAkCA,kBAAkBA,cAAhFvD,CAA4B,CAA5BA,QAAsG,MAAMuD,KAAN,QAA3HA,GAAqBvD,CAArBuD;AACAtD,cAAQsD,KAARtD,sBAAmC,iBAAiB;AAChD0D,2BAAkBJ,mBAAoB,CAACI,MAAD,OAAcA,MAApDA,GAAsC,CAApBJ,CAAlBI;AADJ1D;AAGP;AANHsD;;AASA,OAAIC,WAAW,qBAAXA,WAA2C,sBAA/C,SAA8E;AAC5ED,iCAA4BC,QAA5BD,iBAA4BC,CAA5BD;AACAA,4BAAuBC,QAAvBD,kBAAuBC,CAAvBD;AACAA;AACA;AACAA,2BAAsBC,QAAtBD;AACA;AANF,UAOO;AACLA;AACAA;AACD;;AAEDA;AACA;;;AAGA,OAAIC,WAAW,kBAAf,SAA0C;AACxCD,iCAA4BC,QAA5BD,cAA4BC,CAA5BD;AADF,UAEO;AACL,SAAIA,KAAJ,UAAmB;AACjBA;AADF,YAEO;AACLA;AACD;AACF;;AAED,OAAIC,WAAW,kBAAf,SAA0C;AACxCD,+BAA0BC,QAA1BD,cAA0BC,CAA1BD;AACD;;AAED,OAAIA,KAAJ,UAAmB;AACjBA;AACAA,+BAA0BA,2BAA1BA;AACD;;AAED,OAAIC,WAAW,eAAf,SAAuC;AACrCD,6BAAwBC,QAAxBD,WAAwBC,CAAxBD;AADF,UAEO;AACLA,6BAAwB,CAAxBA;AACD;;AAED,OAAIC,WAAW,iBAAf,SAAyC;AACvCD,mCAA8BC,QAA9BD,aAA8BC,CAA9BD;AADF,UAEO;AACLA;AACD;;AAEDA,yBAAsB,mBAAkB;AACtC,YAAOU,2BAA2BV,KAAlC;AADFA;;AAIAA,sCAAmC,EAAE+B,MAAM/B,KAA3CA,cAAmC,EAAnCA;;AAEAA,iCAA8B,mBAAkB;AAC9C,YAAO,QAAQA,KAAR,6BAA0C,kBAAiB;AAChE,cAAOgC,OAAP,OAAOA,CAAP;AADF,MAAO,CAAP;AADFhC;;AAMAA,wBAAqBC,WAAW,eAAXA,kBAArBD;AACAA,yBACEC,WAAWA,6BAAXA,kBADFD;;AAGAA,kCAA+B,yBAAwB;AACrDiC,YAAOA,QAAQjC,KAAfiC;AACA,SAAIC,kBAAkB,eACN;AACd,iCAA4B;AAC1B1E,4BAAuB2E,oBADzB,EACyBA,CAAvB3E,CADF,GAFoB,KAKpB,4BAA4B;AAC1BA,4BAAuB2E,oBADzB,EACyBA,CAAvB3E,CADF,GALoB,wBAQpB,4BAA4B;AAC1BA,4BAAuB2E,oBADzB,EACyBA,CAAvB3E,CADF,GARoB,KAWpB,wBAAwBA,uBAAxB,IAAwBA,CAAxB,GAXoB,KAWwC;AAC5D,4CAAuCA,uBAAvC,IAAuCA,CAAvC,GAZoB,KAYuD;AAZ7E,0BAAsB,CAAtB;;AAgBA,YAAO;AACL4E,gBADK;AAELC,cAFK;AAGLC,aAHK;AAILC,aAJK;AAKLC,iBALK;AAMLC,oBAAa,uBAAW;AACtB,gBAAOhG,0BAEGyF,uBAAuB,CAF1BzF,eAE0B,CAAvByF,CAFHzF,QAIHC,QACE,wDADFA,SACE,CADFA,EAUE,CAdN,oBAcM,CAVFA,CAJGD,CAAP;AAPG;;AA0BLiG,YAAK,mBAAe;AAClB,aAAIjD,KAAJ,kBAA2B;AACzB,eAAIA,qBAAJ,GAA4B;AAC1B,oBAAOyC,gBAAgBzC,KAAvB,aAAOyC,CAAP;AACD;AACD,kBAAOA,gBAAP,CAAOA,CAAP;AACD;AACD,gBAAOA,gBAAP,CAAOA,CAAP;AACD;AAlCI,MAAP;AAlBFlC;;AAwDAA,gDAA6C;AAC3C;;AAEA2C,6BAAwB;AACtBP,gBADsB;AAEtBC,cAFsB;AAGtBC,aAAM,sBAHgB,QAGhB,CAHgB;AAItBC,aAJsB;AAKtBE,oBAAa,uBAAW;AACtB,gBAAOhG,0BAEG,gCAFHA,eAEG,CAFHA,QAGEC,QAAQqB,wBAARrB,CAAQqB,CAARrB,EAAoC,CAH7C,oBAG6C,CAApCA,CAHFD,CAAP;AANoB;;AAYtBiG,YAAK,mBAAe;AAClB,aAAIE,WAAW5C,yDAAf,IAAeA,CAAf;AAKA,aAAI4C,YAAJ,iBAAiC;AAC/B,eAAIA,YAAJ,KAAqB;AACnB;AACD;AACD,eAAIA,YAAJ,OAAuB;AACrB;AACD;AACD;AACD;AACD;AACD;AA5BqB,MAHmB;;AAkC3CC,mBAAc7C,KAlC6B;;AAoC3C8C,uBAAkB;AAChBV,gBADgB;AAEhBC,cAFgB;AAGhBE,aAHgB;;AAKhBG,YAAK,mBAAe;AAClB,gBAAOjD,KAAP;AACD;AAPe,MApCyB;;AA8C3CsD,aAAQ;AACNX,gBADM;AAENC,cAFM;AAGNC,aAAM,qDAHA,KAGA,CAHA;AAINC,aAJM;AAKNE,oBAAa,uBAAW;AACtB,gBAAOhG,0BAEG,4DAFHA,eAEG,CAFHA,QAYE,8EAZT,SAYS,CAZFA,CAAP;AANI;AA6BNiG,YAAK,mBAAe;AAClB,aAAIE,WAAW5C,sCAAf,KAAeA,CAAf;AACA,aAAI4C,YAAJ,QAAwB;AACtB;AACD;AACD;AACD;AAnCK,MA9CmC;;AAoF3CI,0BAAqB;AACnBZ,gBADmB;AAEnBC,cAFmB;AAGnBE,aAHmB;AAInBU,qBAAexG,UAJI,KAIJA,CAJI;AAKnBiG,YAAK,mBAAe;AAClB,aAAI;AACF,eAAItC,QAAQJ,kBACVA,sCADF,oBACEA,CADUA,CAAZ;AAGA,sBAAW;AACTI,qBAAQ,KAAKA,MAAbA,WAAaA,EAAbA;AADF,kBAEO;AACLA;AACD;AACD;AATF,WAUE,YAAY;AACZ;AACD;AAlBgB;AAoBnBqC,oBAAa,2BAAe;AAC1B,aAAIS,wBAAwBxG,UAC1ByG,KAD0BzG,aAA5B,eAA4BA,CAA5B;AAIA,aAAI+F,cAAc/F,UAChBD,6BADgBC,SAChBD,CADgBC,EAEhBD,yBAEU,CACNyG,sBADM,CACNA,CADM,EAENA,sBAAsBA,+BAJ1BzG,CAIIyG,CAFM,CAFVzG,QAMS,IARX,CAQW,CANTA,CAFgBC,CAAlB;AAUA,gBAAO,aAAY;AACjB,eAAIkE,KAAJ,iBAA0B;AACxB;AACD;AACD,kBAAO6B,YAAP,CAAOA,CAAP;AAJF;AAMD;AAzCkB;AApFsB,IAA7CzC;;AAiIA,OAAIC,WAAWA,QAAf,qBAAeA,CAAf,EAA+C;AAC7CvD,cACEsD,KADFtD,uCAEEuD,QAFFvD,qBAEEuD,CAFFvD;AAID;;AAEDsD,uBAAoB,iBAAgB;AAClC,SAAII,iBAAJ,MAA2B;AACzB;AACD;AACD,SAAIgD,eAAJ;;AAEA,SAAIC,SAAS,2BAA2B,aAAY;AAClDD,sBAAeE,QAAfF,KAAeE,CAAfF;AACA;AAFF,MAAa,CAAb;;AAKA;;AAEA,iBAAY;AACV,WACEpD,kBACCoD,qCACCA,6BAHJ,wBACEpD,CADF,EAIE;AACA;AACD;AACD;AACD;;AAED;AAxBFA;;AA2BA;AACA,OAAIuD,uBAAuB,SAAvBA,oBAAuB,mBAA2B;AACpD,SAAIC,YAAY/G,UAAUuD,KAA1B,SAAgBvD,CAAhB;AACA,SAAIgF,KAAJ;AACA,SAAIgC,cAAcD,iBAAiB,MAAnC,EAAkBA,CAAlB;;AAEA,SAAIC,YAAJ,KAAIA,EAAJ,EAAyB;AACvBA,qBAAcD,kFAAdC,MAAcD,CAAdC;AAKD;;AAEDA;;AAEA,SAAIC,gBAAgBhD,WAAWA,iBAA/B;;AAEA,kBAAa;AACX+C,sGAKe,aAAY;AACvB/C;AACAV;AACAyD;AARJA;;AAWAA,wGAKe,aAAY;AACvB/C;AACAiD;AACAF;AARJA;;AAWAA,wEAIQ,aAAY;AAChB,aAAI/C,QAAJ,OAAmB;AACnB;AANJ+C,sBAQe,aAAY;AACvB/C,yBAAgB,CAACA,QAAjBA;AACA+C;AAVJA;;AAaAA,wEAIQ,aAAY;AAChB;AALJA,sBAOe,aAAY;AACvBzD,sCAA6BU,QAA7BV;AACAyD;AATJA;;AAYA;AACA,WAAIG,sBAAsB5D,KAA1B;;AAGA4D,6BAAsB,QAAQlD,QAAR,UAA0B,gBAAe;AAC7D;AACA,gBAAOV,uCAAP;AAFF4D,QAAsB,CAAtBA;;AAKA,gCAAyB;AACvBH,qGAKe,aAAY;AACvB;AACAzD,wCACEU,QADFV,kBAGE,sBAAgB;AAAE,oBAAO,qBAAP;AAHpBA,cAIE,EAAC,kBAJHA,IAIE,EAJFA;AAPJyD;AAcD;;AAED/C;;AAEA+C,+DAEiB,KAAKhH,SAAL,UAFjBgH,mBAGgB,KAAKhH,SAAL,UAHhBgH;AA5EF,YAiFO;AACL,oBAAa;AACXI;AACD;AACDJ;AACD;;AAEDD,2BAEE,aAAY;AACVD,kCAA2BG,uBAA3BH;AAHJC;AAzGF;;AAkHA;;;AAIAxD,4BAAyB,gBAAgB;AACvC,SAAI8D,oBAAqB9D,sCAAzB,SAAyBA,CAAzB;AACA,SAAI8D,qBAAJ,iBAA0C;AACtCA,2BAAqB9D,sCAArB8D,SAAqB9D,CAArB8D;AACH;AACD;AALF9D;;AAQAA,wBAAqB,qBAAqB;AACxC,SAAIC,WAAW,oBAAf,SAA4C;AACxC,WAAI8D,YAAYnH,kCAAkCoH,wBAAlCpH,WAAhB;AACA,WAAIqH,SAASxH,UAAU,MAAMuD,KAAN,aAAvB,cAAavD,CAAb;AACA,WAAIyH,OAAOzH,yBAAyBuD,KAApC,aAAWvD,CAAX;AACA,WAAIsH,YAAYE,kCAAhB,SAAgBA,CAAhB;;AAGAF;AACAA;;AAEA/D;;AAEAtD,cAAQsD,KAARtD,OAAoB,gBAAgB;AAChC,aAAIoH,oBAAqB9D,uBAAzB,IAAyBA,CAAzB;AACC,aAAImE,qBAAqBnE,6CAAzB;AACD,aAAI,EAAEmE,sBAAsBnE,KAA5B,oBAAI,CAAJ,EAAwD;AACtDA;AACD;AALLtD;;AASAqH,qGAIgB,aAAY;AACxB,aAAIvC,QAAQxB,KAAZ,sBAAuC;AACrC;AADF,gBAEO;AACL;AACD;AATL+D,+BAWwB,aAAY;AAChC,aAAIvC,QAAQxB,KAAZ,sBAAwC;AACtC;AADF,gBAEO;AACL;AACD;AAhBL+D;AAkBH;AACD;AAzCF/D;;AA4CAA,iCAA8B,wBAAuB;AACnD,SAAIoE,gBAAgB,SAAhBA,aAAgB,aAAsB;AACpC,cAAO;AACL9E,aAAI7C,UAAJ6C,CAAI7C,CAAJ6C;AACD;AACD,WAAI,CAAC+E,QAAL,0BAAuC;AACrCA,4CAAmCA,2CAErBrE,kBAFqBqE,mCAGd,gBAAgBA,gBAAhB,OAHrBA,KAAmCA,CAAnCA;;AAKAA,wCAA+B,uBAAsB;AACnD,eAAIlB,OAAJ;AACA,eAAIpC,QAAJ;AACA,eACEsD,oCACA,CAACA,kBAFH,YAEGA,CAFH,EAGE;AACA,iBAAIC,YACFD,sCACEA,kBAFJ,aAEIA,CADFA,CADF;AAIAlB;AACAA,kBAAKkB,kBAALlB,aAAKkB,CAALlB,IAAyCmB,UAAzCnB,OAAyCmB,CAAzCnB;AACApC;AACAA,mBAAMuD,UAANvD,OAAMuD,CAANvD,IAA4BsD,kBAA5BtD,UAA4BsD,CAA5BtD;AACD;;AAEDzE,iCACE+H,oCACErE,KADFqE,0BADF/H,WACE+H,CADF/H,EAME+H,QANF/H,iFAUE;AACEiI,wBADF;AAEE5C,kBAAK0C,eAFP;AAGEzC,oBAAOyC,eAHT;AAIExC,qBAAQ,IAJV;AAKEC,mBAAM,IALR;AAME0C,wBANF;AAOEC,wBAPF;AAQEC,oBAAOL,gBART;AASEM,qBAAQN,iBATV;AAUEO,wBAVF;AAWEC,qBAAQR,QAXV;AAYES,uBAZF;AAaEC,mBAAM;AACJC,kBAAGX,gBADC;AAEJY,kBAAG;AAFC;AAbR,YAVF3I;AAjBF+H;AA+CAA;AACA,gBAAO;AACH/E;AACH;AAxDH,cAyDO;AACL,gBAAO;AACHA;AACH;AACD+E;AACAA;AACAA;AACD;AApEP;;AAuEA,SAAIrE,KAAJ,oBAA6B;AAC3B,yBAAkB;AACdkF,2BAAkB,2BAAlBA,aAAkB,CAAlBA;AADJ,cAKQ;AACJd;AACF;AACH;AAjFHpE;;AAoFAA,mCAAgC,oDAI9B;AACAmF,OAAE,MAAFA;AACAA,OAAE,MAAFA;AACAA,OAAE,MAAFA;AAPFnF;;AAUAA,kCAA+B,8FAM7B;AACA,SAAIU,UAAU,OAAOV,KAAP,UAAsB,aAAY;AAC9C,cAAOM,gBAAP;AADF,MAAc,CAAd;;AAIA,SAAI,CAAJ,SAAc;AACZ;AACD;;AAED8E,0BAAqBA,sBAArBA;;AAEA,SAAIC,gBAAgBC,wBAClBC,gBACI7I,SAASsD,UAATtD,OADJ6I,aACI7I,CADJ6I,GAEI7E,QAHc4E,4BAApB,sBAAoBA,CAApB;;AAUA,SAAIzI,2BAAJ,MAAqC;AACnCwI;AACAG,2BAEEH,cAFFG,uBAEEH,CAFFG,EAGEzF,KAHFyF,uBAGEzF,CAHFyF;AAKD;;AAED,SAAIN,eAAe,CACjB,2BAEE,mBAAkB;AAChB3I,iCACEyD,mCACEA,0BADFA,UACEA,CADFA,EAEEA,KAHJzD,8BAGIyD,EAFFA,CADFzD;AAJN,MACE,CADiB,CAAnB;;AAcA;;AAEA,SAAI,gBAAJ,oBAAwC;AACtCG,4BAAqB,gBAAe;AAClC0I;AADF1I;AADF,YAIO;AACLA,oCAA6B;AAC3B+I,qBAAY;AACVC,kBADU;AAEVC,kBAAOT;AAFG;AADe,QAA7BxI;AAMD;;AAED,YAAOsD,gDAEL4F,cAAcA,YAAdA,UAAcA,CAAdA,GAAwC,aAFnC5F,YAAP,kBAAOA,CAAP;AAjEFA;;AAyEAA,sCAAmC,+CAIjC;AACA,SAAI6F,YAAY,SAAZA,SAAY,mBAA2B;AACzC,WAAIC,IAAJ;AACA,YAAK,IAAIC,IAAT,GAAgBA,IAAhB,aAAiC;AAC/BD,cAAKpJ,SAALoJ,QAAKpJ,CAALoJ;AACD;AACD;AALF;;AAQA,SAAIE,UAAU,+BAAd,GAAc,CAAd;;AAEA,SAAIC,gBAAgBJ,mBAApB,EAAoBA,CAApB;AACA,SAAIK,gBAAgBD,gBAApB;AACA,SAAIE,oBAAoBF,gBAAxB;AACA,SAAIG,oBAAoBH,gBAAxB;;AAEA,YACEd,EAAE,MAAFA,yBACAA,EAAE,MAAFA,mBADAA,UAEAA,EAAE,MAAFA,mBAHF,QAIE;AACAc,uBAAgBJ,mBAAhBI,EAAgBJ,CAAhBI;AACAC,uBAAgBD,gBAAhBC;AACAC,2BAAoBF,gBAApBE;AACAC,2BAAoBH,gBAApBG;AACD;;AAED,SAAIC,gBAAJ;AACA,SAAIC,oBAAJ;AACA,SAAIC,sBAAJ;;AAEA;AACA,SAAIC,iBAAiBrB,0BAArB,aAAqBA,CAArB;AACA,SAAIsB,WAAWtB,0BACC,MADDA,mDAAf,KAAeA,CAAf;AAIAA,iJAIe,YAAW;AACtBnF;AALJmF;;AAYAsB;AACAtB,OAAE,MAAFA;;AAEA,SAAIuB,kBAAkBvB,oFAGHwB,cAHnB,UAAsBxB,CAAtB;;AAKA,SAAIwB,sBAAJ,cAAwC;;AAEtCD,4DAEY,gBAAgBC,sCAF5BD,GAE4BC,CAF5BD;AAGD;;AAED;AACA,SAAIE,iBAAiBzB,mEAArB,IAAqBA,CAArB;AAGAyB;;AAMAA;AACAF,8BAAyB,MAAzBA;;AAEA;AACAvB;;AAEA,SAAI0B,kBAAkB;AACpBC,eAAQ7G,WAAWA,QADC,QACDA,CADC;AAEpB,uBAFoB;AAGpB8G,kBAHoB;AAIpBlC,eAJoB;AAKpBY,mBACExF,WAAW,gBAAXA,UAAqCA,QAArCA,YAAqCA,CAArCA,GANkB;AAOpB,sBACEA,WAAW,iBAAXA,UAAsCA,QAAtCA,aAAsCA,CAAtCA,GARkB;AASpB,yBAToB;AAUpB,gCAAyB;AAVL,MAAtB;;AAaA,wBAAmB;AACjBvD;AACD;;AAED,SAAIiK,gCAAgC3G,KAAhC2G,wBAA6D3G,KAAjE,iBAAuF;AACrF6G;AACAA,4CAAqC7G,KAArC6G;AACAA,6CAAsC7G,KAAtC6G;;AAEA;AACE,WAAI,oBAAJ,iBAAyC;AACrC,aAAIG,WAAW,SAAXA,QAAW,sBAA8B;AACzCC;AACA,kBAAO5C,QAAP,aAAOA,EAAP;AAFJ;;AAKAwC,6CAAoCnK,iBAAkBmK,gBAAtDA,gBAAsDA,CAAlBnK,CAApCmK;AANJ,cAOO;AACHA,6CAAoC,mBAAmB;AACnD,kBAAOxC,QAAP,aAAOA,EAAP;AADJwC;AAGH;AACJ;;AAKD,SAAIK,eAAe7K,uCAEjB,MAFiBA,kGAAnB,eAAmBA,CAAnB;;AAcA,SAAI2D,eAAJ,aAAIA,CAAJ,EAAmC;AACjC,WAAIA,eAAJ,YAAIA,CAAJ,EAAkC;AAChCkH,kDAAyClH,eAAzCkH,aAAyClH,CAAzCkH;AADF,cAEO;AACLA,mDACElH,eADFkH,aACElH,CADFkH;AAGD;AACF;;AAED,SAAIlH,iBAAJ,IAAIA,CAAJ,EAA4B;AAC1BkH,6CAAsClH,iBAAtCkH,IAAsClH,CAAtCkH;AACD;;AAED,SAAIlH,eAAJ,YAAIA,CAAJ,EAAkC;AAChCkH,6CAAsClH,eAAtCkH,YAAsClH,CAAtCkH;AACD;;AAEDA,yCAAoCA,sBAApCA,CAAoCA,CAApCA;AACA;;AAGA;AACA;;;;;AAMA;;;;;AAvKFlH;;AA8KAA,0CAAuC,4BAA2B;AAChE,SAAImH,cAAc,CAACnH,KAAnB,eAAuC;AACrC;AACD;AACD,YACE,CAACmH,kBAAkB,MAAMnH,KAAzB,8DADF;AAJFA;;AAYA;AACAmF;;AAEA,OAAIiC,oBAAoB,SAApBA,iBAAoB,OAAe;AACrC,SAAI5D,YAAY/G,UAAUuD,KAA1B,SAAgBvD,CAAhB;AACA,SAAIgF,KAAJ;AACA,SAAIgC,cAAcD,iBAAiB,MAAnC,EAAkBA,CAAlB;;AAEA,SAAIC,YAAJ,KAAIA,EAAJ,EAAyB;AACvBA,qBAAcD,kFAAdC,MAAcD,CAAdC;AAKD;;AAEDA;;AAEA,eAAU;AACRhE;AACAgE,wGAKe,aAAY;AACvBhE;AACA4H;AACA5D;AARJA;;AAWA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEAA,+DAEiB,KAAKhH,SAAL,UAFjBgH,mBAGgB,KAAKhH,SAAL,UAHhBgH;AA1BF,YA+BO;AACLA;AACD;;AAEDD,2BAEE,aAAY;AACV4D;AAHJ5D;AAlDF;;AA2DA,mCAAgC;AAC9B;AACA,SAAI8D,kBAAkBC,iBAAiBvH,KAAvC,KAAsBuH,CAAtB;;AAEA,SAAIC,aAAa;AACf/F,WADe;AAEfgG,iBAAU;AAFK,MAAjB;;AAKA;AACA,SAAIzH,KAAJ,qBAA8B;AAC5BsH,yBAAkB5K,wBAAwBsD,KAA1CsH,mBAAkB5K,CAAlB4K;AACD;;AAEDE,2BAAsB,uBAAuB,sBAAgB;AAC3D,cAAO;AACLE,qBADK;AAELD,mBAAUrH;AAFL,QAAP;AADFoH,MAAsB,CAAtBA;;AAOA,SAAIG,UAAU,SACV,sBAEQ,CAAC3H,KAAD,OAAaA,KAFrB,MAEQ,CAFR;AAGE;AAHF,eAIY,aAAY;AACpB,cAAOwB,EAAP;AALJ,cAOS,aAAY;AACjB,cAAOoG,SAASpG,kBAAToG,QAAP,GAAOA,CAAP;AARJ,aAUQ,gBAAe;AACnB,cAAOC,UAAUC,EAAjB;AAXJ,gBADU,CACV,CADU,GAeV,yBAEQ,CAAC9H,KAAD,OAAaA,KAFrB,MAEQ,CAFR;AAGE;AAHF,eAIY,aAAY;AACpB,cAAOwB,EAAP;AALJ,cAOS,aAAY;AACjB,cAAOoG,SAASpG,kBAAToG,QAAP,GAAOA,CAAP;AARJ,aAUQ,gBAAe;AACnB,cAAOE,UAAUD,EAAjB;AAXJ,cAfJ,CAeI,CAfJ;;AA8BA,SAAI9I,WAAW4I,cAAf,UAAeA,CAAf;AACAjL,sBAAiB,aAAY;AAC3B;AADFA;AAGA;AACD;;AAED,oCAAiC;AAC/B,SAAIqL,UAAJ;AACAA;AACAA;AACAA;AACAA;;AAEA,SAAIC,mBAAJ;AACA,SAAIC,aAAJ;;AAEAjI,2BAAsB,aAAY;AAChC,WAAIA,4BAAJ,CAAIA,CAAJ,EAAoC;AAClC;AACA,aAAIkI,cACF,gBAAgB,aAAY;AAC1B,kBAAO5H,EAAP;AADF,eAEMN,KAHR;AAIA,aAAI,CAAJ,aAAkB;AAChB,eAAIgF,EAAJ,WAAiB;AACf+C;AACAA;AAFF,kBAGO;AACLC,8BAAiBhD,EAAjBgD;AACD;AACF;AACF;AAfHhI;;AAkBAA,wBAAmB,gBAAe;AAChC,WAAIgI,iBAAiBhD,EAArB,OAAIgD,CAAJ,EAAiC;AAC/BC,yBAAgBF,uBAAuBA,iBAAvCE;AACAF;AACAA;AACD;AALH/H;;AAQAA,wBAAmB,aAAY;AAC7B,WAAI,EAAEgF,aAAahF,KAAnB,YAAI,CAAJ,EAAuC;AACrC,aACEiI,WAAWjD,EAAXiD,yBACAA,WAAWjD,EAAXiD,YAFF,WAGE;AACA,eAAIhD,IAAJ;AACA,gBAAK,IAAL,WAAoB;AAClBA,uBAAUD,EAAVC,IAAUD,CAAVC;AACD;;AAEDA,sBAAWgD,WAAWjD,EAAtBC,MAAWgD,CAAXhD;AACAA,sBAAWgD,WAAWjD,EAAtBC,MAAWgD,CAAXhD;AACA8C;AACD;AACF;AAfH/H;;AAkBA;AACD;;AAEDA,mCAAgC,oBAAoB;;AAElDA;;AAOA,SAAImI,YAAYnI,mCAAhB,QAAgBA,CAAhB;;AAKAA;AACAA,uCACEA,8CADFA,cACEA,CADFA;;AAOAA;AAtBFA;;AA0BAA,0BAAuB,oGAAmG;;AAExH,SAAIqF,gBAAgB,wBAClBE,gBACK7I,2CAA4CA,SAASsD,UAATtD,OADjD6I,aACiD7I,CADjD6I,GAEI7E,QAHc,UAIlB0H,sBAAsB,aAAY;AAChC,cAAO9I,YAAYU,KAAnB;AALgB,qBAApB,sBAAoB,CAApB;;AAYAtD,YAAO2I,cAAP3I,OAA4B,aAAY;AACtCyC;AADFzC;;AAIA,SAAIG,2BAAJ,MAAqC;AACnCwI;AACAG,2BAEEH,cAFFG,uBAEEH,CAFFG,EAGEzF,KAHFyF,uBAGEzF,CAHFyF;AAKD;;AAEDvF,eAAUA,WAAW,IAArBA,MAAqB,EAArBA;;AAEA,SAAIoI,mBAAmB,CACrB,CACE,yBAAwB;AACtB,WAAIC,YAAYC,yCAAhB,IAAgBA,CAAhB;AACA,WAAIlG,QAAQiG,iFAAZ,IAAYA,CAAZ;AAIA,WAAIrG,OAAO,2FAIMvE,6BAA6BsC,KAJnC,KAIMtC,CAJN,cAKIA,6BAA6BsC,KALjC,KAKItC,CALJ,cAQP,6BACE,OAAO2G,QAAP,OAAsB,gBAAe;AACnC,gBAAOA,yCAAP,oBAAOA,CAAP;AAVG,QASL,CADF,CARO,cAiBI,aAAY;AACvB;AACA,aAAImE,WAAW9K,mCAAmC,KAAlD,KAAeA,CAAf;AACA,aAAI,KAAJ,OAAgB;AACd2G;;AAEAiE;AAHF,gBAMO;AACLA;AAGD;AA9BL,QAAW,CAAX;AAPJ,QADqB,IACrB,CADqB,EA2CrB,2BAEE,mBAAkB;AAChB/L,iCACE8H,sCACEA,6BADFA,KACEA,CADFA,EAEEA,QAHJ9H,8BAGI8H,EAFFA,CADF9H;AA9CN,MA2CE,CA3CqB,CAAvB;;AAyDA0D;AACAA,6BAAyBS,QAAzBT;AACA,SAAI,gBAAJ,SAA6B;AACzBA,wCAAkCA,sCAAlCA,gBAAkCA,CAAlCA;AADJ,YAEO;AACHA,+BAAyB;AACrByF,gBADqB;AAErBC,gBAAO0C;AAFc,QAAzBpI;AAIH;;AAED;AACA,SAAIiH,eAAelH,gDAGf4F,eAAe,gBAAgBlF,QAHhBV,YAAnB,OAAmBA,CAAnB;AAMEkH;AACA;;AAEF;;;;;;;;;;;;AA3GFlH;;AA2HA,kDAA+C;AAC7C,SAAIyI,YAAY,SAAhB,cAAgB,CAAhB;AACA,SAAIC,cAAcD,UAAlB,QAAkBA,EAAlB;AACA,SAAIE,YAAYf,WAAWgB,SAA3B,EAAgBhB,CAAhB;AACA,SAAIiB,YAAYD,SAASD,YAAzB;;AAEA,SAAIE,YAAJ,aAA6B;AAC3BJ,6BAAsBA,sCAAtBA;AACAA,0BAAmB,MAAMI,YAAzBJ,WAAmB,CAAnBA;AAFF,YAGO;AACLA,6BAAsBA,0BAAtBA;AACAA,0BAAmBC,cAAnBD;AACD;;AAED;AACA;AACD;;AAED,OAAIK,qBAAqB,SAArBA,kBAAqB,SAAiB;;AAExC,SAAIC,aAAaA,cAAjB;;AAEA;AACA,SAAIC,WAAWhJ,oCAAf,UAAeA,CAAf;AACA,SAAIiJ,WAAWjJ,oCAAf,UAAeA,CAAf;;AAEA,SAAIgJ,YAAJ,UAA0B;AACxB,cAAOE,QAAQC,GAARD,KAAgB,CAAhBA,IAAP;AADF,YAEO;AACL,cAAOF,sBAAsB,CAAtBA,IAAP;AACD;;AAED;AAdF;;AAkBAhJ,qCAAkC,8DAKhC;;AAEA,SAAI;;AAEFoJ,oBAAaA,cAAcpJ,KAA3BoJ;;AAEA,WAAIC,iBAAiB,SAAjBA,cAAiB,eAAuB;AAC1C,aAAIC,UAAUtJ,sCAAd,UAAcA,CAAd;AACA,aAAIsJ,mBAAJ,MAA6B;AAC3B,kBAAOA,qBAAqBA,WAA5B;AADF,gBAEO;AACL,eAAI;AACAA,uBAAUtJ,kBACRA,sCADFsJ,UACEtJ,CADQA,CAAVsJ;AAGA,iBAAIA,mBAAJ,MAA6B;AAC3B,sBAAOA,qBAAqBA,WAA5B;AACD;AANL,aAOE,YAAY;AACZ;AACD;AACF;AACD;AAhBF;;AAmBA,WAAIC,cAAcpH,0BAAlB,WAAkBA,CAAlB;AACA,WAAIqH,eAAerH,0BAAnB,aAAmBA,CAAnB;;AAEA;;AAEA,WAAIiH,cAAcpJ,KAAlB,OAA8B;AAC5ByJ,yBAAgBzJ,KAAhByJ;AADF,cAEO;;AAEL,aAAIC,oBAAoB,IAAxB,IAAwB,EAAxB;AACAA;AACAD;AACA/M,gBAAOsD,KAAPtD,OAAmB,gBAAe;AAChC,eAAIiN,gBAAgBN,kCAApB,IAAoBA,CAApB;AACA,eAAI3M,cAAJ,aAAIA,CAAJ,EAAmC;AACjC+C;AADF,kBAEO;AACH,gCAAmB;AACjBA;AACAgK;AAFF,oBAGO;AACLhK;AACD;AACJ;AAXH/C;AAcD;;AAED;;AAEA,WAAIkN,iBAAJ;AACA,WAAIC,2BAAJ;;AAEA;;AAEAnN,6BAAsB,gBAAe;AACnC,aAAI+C,KAAJ,SAAkB;AAChB,eAAI,EAAEA,gBAAN,cAAI,CAAJ,EAAuC;AACrCmK,4BAAenK,KAAfmK,WAA+B,EAAEE,OAAF,IAAaC,OAA5CH,EAA+B,EAA/BA;AACD;AACDC,oCAAyBpK,KAAzBoK,MACED,eAAenK,KAAfmK,kBADFC;AAEAD,0BAAenK,KAAfmK;AACD;AARHlN;;AAWAA,cAAOsD,KAAPtD,OAAmB,gBAAe;AAChC,aAAIsN,eAAehK,KAAnB,sBAA8C;AAC5C,eAAIiK,eAAelK,WAAWiK,KAAXjK,QAAnB;;AAEA,eAAImK,YAAYnK,WAAWiK,KAAXjK,QAAhB;AAAA,eACEoK,YAAYpK,WAAWiK,KAAXjK,QADd;;AAGA,eACEmK,yCACAC,aAFF,0BAGE;AACA,iBAAIC,cAAc1N,QAAlB,IAAkBA,CAAlB;;AAEA0N,kCAAqBP,yBAArBO,SAAqBP,CAArBO;AACAA,kCAAqBP,yBAArBO,SAAqBP,CAArBO;;AAEAR;AACD;AACF;AAlBHlN;;AAqBAA,8BAAuB,wCAAuC;AAC5D;AACA;;AAEA;;AAEA,aAAI2N,cAAcrK,qBAAlB,aAAkBA,CAAlB;;AAEAA;;AAEA;AACA,aAAIZ,QAAJ;;AAEA,aAAIkL,cAAc,SAChBxL,qCACEyL,cADFzL,OAEEyL,cAFFzL,aADgB,KAChBA,CADgB,EAOhB,cAAa;AACX,kBAAO0L,YAAP;AARJ,UAAkB,CAAlB;;AAYApL,iBAAQ,gBAAgB,cAAa;AACnC,kBAAOqL,YAAP;AADFrL,UAAQ,CAARA;;AAIA;AACA1C,6BAAoB,gBAAe;AACjC4D;AADF5D;;AAIA4N,0BAAiB,kBAAiB;AAChC,kBAAOxB,mBAAmB4B,GAAnB5B,CAAmB4B,CAAnB5B,EAA0B6B,GAAjC,CAAiCA,CAA1B7B,CAAP;AADFwB;;AAIAA,uBAAc,mBAAmB,gBAAe;AAC9C,eAAIjI,QAAQrC,+CAA+C+F,IAA3D,CAAY/F,CAAZ;;AAEAtD,qBAAU,aAAY;AACpByC;AACAA;AACAA;AACAA;AAJFzC;;AAOA,kBAAO;AACL+K,uBAAU/K,QADL,CACKA,CADL;AAELkO,6BAAgB5K,cAFX,WAEWA,CAFX;AAGL0H,yBAHK;AAILmD,wBAAW,wBACT,MAAMzL,MAAN,CAAMA,CAAN,EAAgB,aAAY;AAC1B,sBAAOE,EAAP;AAFO,cACT,CADS;AAJN,YAAP;AAVFgL,UAAc,CAAdA;;AAsBA5N,6BAAoB,aAAY;AAC9BoO;AADFpO;;AAIAsD;;AAEA;;AAEA;;;;;;;AAQAtD,6BAAoB,eAAc;;AAEhC;AACA,eAAIqO,kBAAkBzF,wBACpB5I,SAASsO,IAATtO,UAAuBA,0BADH4I,WACG5I,CAAvBA,CADoB4I,cAAtB,aAAsBA,CAAtB;;AAOA,eAAI2F,aAAa,SACf,qCACEF,gBADF,OAEE,SAASA,gBAAT,OAAgC,aAAY;AAC1C,oBAAOzL,YAAYU,KAAnB;AAJW,YAGb,CAFF,CADe,EAOf,cAAa;AACX,oBAAOwK,YAAP;AARJ,YAAiB,CAAjB;;AAYAQ,0BAAeC,WAAfD;;AAEAC,2BAAgB,gBAAe;AAC7B,oBAAOpD,WAAWC,EAAlB;AADFmD;;AAIAD;AACAA;;AAEAtO,8BAAmB,0BAAyB;;AAE1C,iBAAIwO,iBAAiBxO,0BAEnBA,0BAFF,YAEEA,CAFmBA,CAArB;;AAKAsO,mCAAsBG,eAAtBH;;AAEA,iBAAI,QAAJ,gBAA4B;AAC1BA,uCAAwBE,qBAAxBF;AACAtO,sBAAOwO,eAAPxO,IAAOwO,CAAPxO,EAA6B,aAAY;AACvCyC,mCAAkBkK,oCAAlBlK;AACA,qBAAI+L,+BAAJ,GAAsC;AACpC/L;AACA,uBAAIA,mBAAJ,GAA0B;AACxBA;AACD;AACF;AAPHzC;AASD;AACD,iBAAI,SAAJ,gBAA6B;AAC3BA,sBAAOwO,eAAPxO,KAAOwO,CAAPxO,EAA8B,aAAY;AACxCyC;AADFzC;AAGD;AAzBHA;;AA4BA;AACAsD,uDAA4CgL,IAA5ChL;AA5DFtD;AA5EFA;AA1FF,OAuOE,YAAY;AACZ6C;AACA;AACD;AAjPHS;;AAqPA,mCAAgC;AAC9B;;AAEA,SAAIoL,cAAcC,eAAlB,MAAkBA,CAAlB;;AAEA,SAAIrL,wBAAJ,GAA+B;AAC7BA,uBAAgB,mBAAmB,qBAAoB;AACrD,gBAAO,EAAE,OAAOY,EAAP,eAAT,WAAO,CAAP;AADFZ,QAAgB,CAAhBA;AADF,YAIO;AACL,WAAIsL,oBAAJ;AACA5O,cAAOsD,KAAPtD,UAAsB,aAAY;AAChC4O,2BAAkBhL,EAAlBgL;AADF5O;AAGAA,2BAAoB,aAAY;AAC9B,aAAI,gBAAJ,GAAuB;AACrBA,uBAAY4O,kBAAkBhL,EAA9B5D,UAAY4O,CAAZ5O;AACD;AAHHA;AAKD;;AAED;;AAEA,SAAI6O,kBAAkB,SAClB,aAAY;AACVpM,cAAOA,MAAPA;AACAA,cAAOA,MAAPA;AAHgB,SAKlB,aAAY;AACVA,cAAOA,OAAPA;AACAA,cAAOA,OAAPA;AAPN;;AAUAzC,YAAO,CAACsD,KAAD,OAAaA,KAApBtD,QAAO,CAAPA,EAAoC,gBAAe;AACjDA;AADFA;;AAIAsD;AACD;;AAED,kCAA+B;AAC7BA,8BAAyBA,yBAAzBA;AACAwL;AACD;;AAED,+CAA4C;AAC1C,gBAAW;AACT,WAAIC,UAAU,CAACzL,aAAa0L,QAAd,KAA2B1L,KAAzC;AACA,WAAI2L,UAAU,CAAC3L,cAAc0L,QAAf,KAA4B1L,KAA1C;;AAEAA;AACAA;;AAEA,WAAI4L,YAAY,yBACd,UAAUJ,eAAV,KAAUA,EAAV,EAAkC,gBAAe;AAC/C,gBAAO/L,KAAP;AAFJ,QACE,CADc,CAAhB;AAKAmM,uBACE,MAAMA,UAAN,MAAMA,EAAN,EAA0B,aAAY;AACpC,gBAAOhL,IAAP;AAFJgL,QACE,CADFA;AAKA;AACA,WAAIC,YAAY,yBACd,UAAUL,eAAV,KAAUA,EAAV,EAAkC,gBAAe;AAC/C,gBAAO/L,KAAP;AAFJ,QACE,CADc,CAAhB;AAKAoM,uBACE,MAAMA,UAAN,MAAMA,EAAN,EAA0B,aAAY;AACpC,gBAAOjL,IAAP;AAFJiL,QACE,CADFA;;AAMAnP,cAAO8O,eAAP9O,KAAO8O,EAAP9O,EAA+B,gBAAe;AAC5C+C,kBAASmM,UAAUnM,KAAnBA,CAASmM,CAATnM;AACAA,kBAASoM,UAAUpM,KAAnBA,CAASoM,CAATpM;AAFF/C;AAID;;AAEDsD,kBAAa4H,SAASA,SAAS5H,KAAT4H,OAATA,GAASA,CAATA,EAAb5H,IAAa4H,CAAb5H;AACAA,mBAAc4H,SAASA,SAAS5H,KAAT4H,QAATA,GAASA,CAATA,EAAd5H,IAAc4H,CAAd5H;;AAEAwL,yBAAoB,CAACxL,KAAD,OAAaA,KAAjCwL,MAAoB,CAApBA;AACAxL,oCAA+BA,KAA/BA,sBAA0DA,KAA1DA;AACAA;AACAA;AACA,kBAAa;AACXwL;AADF,YAEO;AACL,kBAAW;AACTxL;AACD;AACF;AACF;;AAEDA,iCAA8B,OAAO,YAAW;AAC9CA,wBAAmB,aAAY;AAC7Bb,qBAAc1C,GAAd0C,GAAc1C,EAAd0C;AADFa;;AAIAA,wBAAmB,aAAY;AAC7BA,kBAAWV,EAAXU,sBAAmCV,EAAnCU;AACAA,kBAAWV,EAAXU,sBAAmCV,EAAnCU;AAFFA;AALFA,IAA8B,CAA9BA;;AAWAA,gDAA6C,OAAO,YAAW;AAC7DA;;AAEAA,wBAAmB,aAAY;AAC7BtD,eAAQ,kBAAiB;AACvBoP,6BAAoBC,iBAApBD,IAAoBC,EAApBD;AACA,aAAIA,oBAAJ,GAA2B;AACzBC,wBAAazP,KAAbyP;AADF,gBAEO;AACL,eAAID,oBAAJ,KAA6B;AAC3BC,0BAAazP,KAAbyP;AADF,kBAEO;AACL;AACAC,4BAAeD,iBAAfC,MAAeD,EAAfC;AACAC;AACA,kBAAK/C,KAAL,GAAaA,KAAb,mBAAqCA,MAArC,GAA8C;AAC5C,oBAAKC,KAAKD,KAAV,GAAkBC,KAAlB,mBAA0CA,MAA1C,GAAmD;AACjD,qBACEnJ,WAAWgM,aAAXhM,EAAWgM,CAAXhM,gBAA2CgM,aAD7C,EAC6CA,CAA3ChM,CADF,EAEE;AACAiM;AACD;AACF;AACF;;AAEDF,0BACE,mCAAmCD,oBADrCC,CACE,CADFA;AAED;AACF;AAxBHrP;AADFsD;AAHFA,IAA6C,CAA7CA;;AAiCAA,yBAAsB,cAAa;AACjC,YAAO,kBAAkB,aAAY;AACnC,cAAOb,QAAP;AADK,QAAP,CAAO,CAAP;AADFa;;AAMAA,uDAAoD,OAAO,YAAW;AACpE,SAAIkM,SAAS,WAAb,gBAAa,CAAb;;AAEAA,wBAAmB,iBAAgB;AACjC,WAAI7M,QAAQ8M,WAAZ;;AAEA9M,qBAAc,aAAY;AACxB+M,0BAAiBpM,oBAAoBb,EAArCiN,EAAiBpM,CAAjBoM;AACAA,8BAAqBjN,QAAQA,EAARA,MAAgB7C,KAArC8P;AAFF/M;AAHF6M;;AASA,SAAIG,aAAJ;AACAA,2BAAsBrM,KAAtBqM;AACAA,2BAAsBrM,KAAtBqM;AACAH;AAfFlM,IAAoD,CAApDA;;AAkBA,OAAIsM,8BAA8B,UAChC,aAAY;AACVtM;AACA,YAAO,SACLtD,QAAQA,QAAQ4D,EAAR5D,yBAAmCD,GAA3CC,UAAQA,CAARA,EADK,CACLA,CADK,EAEL,uBAAsB;AACpB,cAAO6P,OAAP;AAHG,QAAP,CAAO,CAAP;AAH8B,MAWhC,aAAY;AACV,YAAOjM,EAAP;AAZJ,IAAkC,CAAlC;;AAgBAN,iDAA8C,OAAO,YAAW;AAC9DA;;AAEAA,2BAAsB,aAAY;AAChCtD,eAAQ,qBAAoB;AAC1B8P,wBAAeC,mBAAfD;AACA,aAAIA,eAAJ,GAAsB;AACpBC,0BAAenQ,KAAfmQ;AADF,gBAEO;AACL,eAAIH,gDAAJ,SAA6D;AAC3DG,4BAAenQ,KAAfmQ;AADF,kBAEO;AACL;AACAC;;AAEA,iBAAIC,SAAJ;AACA,iBAAIC,YAAJ;;AAEA5M,gCAAmB,gBAAe;AAChC,mBAAIb,aAAasN,UAAjB,YAAuC;AACrCC;AACD;AAHH1M;AAKA0M,kCAAqB,gBAAe;AAClCG,8BAAe,wCAER,aAAY;AACf,wBAAO,CAAP;AAHW,uBAKPpQ,GALRoQ,SAAe,CAAfA;AAMA,oBAAK3D,KAAL,GAAaA,KAAK2D,aAAlB,QAAuC3D,MAAvC,GAAgD;AAC9C,sBAAKC,KAAKD,KAAV,GAAkBC,KAAK0D,aAAvB,QAA4C1D,MAA5C,GAAqD;AACnDwD;AACA,uBACE3M,WAAW6M,aAAX7M,EAAW6M,CAAX7M,gBAA2C6M,aAD7C,EAC6CA,CAA3C7M,CADF,EAEE;AACA4M;AACD;AACF;AACF;AAhBHF;;AAmBAD,4BAAeG,YAAfH;AACD;AACF;AAxCH/P;AADFsD;AAHFA,IAA8C,CAA9CA;;AAiDAA,mCAAgC,oBAAmB;AACjDA,wBAAmB,aAAY;AAC7Bb,qBAAc7C,KAAd6C;AADFa;AADFA;;AAMAA,8BAA2B,YAAW;AACpCvD,mEAA8D;AAC5D,wBAD4D;AAE5D,iBAF4D;AAG5D,kBAAW;AAHiD,MAA9DA;AAKAuD;AACAA;AACAA;AACAvD;AATFuD;;AAYA;AACA,gCAA6B;AAC3B,SAAI8M,kBAAJ;AACA,SAAIC,QAAJ;AACA/M;AACAA;AACAA;;AAEAgN,8BAAyB,aAAY;AACnC,WAAI,OAAOhN,mBAAmBwB,YAA1B,CAAOxB,CAAP,KAAJ,aAA8D;AAC5DA,4BAAmBwB,YAAnBxB;AADF,cAEO;AACLA,4BAAmBwB,YAAnBxB;AACD;AACD,WAAI,aAAJ,GAAoB;AAClBwB,qBAAYA,aAAZA;AACD;;AAED,WAAIA,uCAAJ,GAA8C;AAC5CxB,+BAAsBwB,gBAAtBxB;AACD;AAZHgN;;AAeA;AACA;;AAEAhN;;AAEAA,0CAAqC,+BAA8B;AACjE,WAAIiN,SAAS,CACX,oBAAoB,aAAY;AAC9B,gBAAO3M,EAAP;AAFJ,QACE,CADW,CAAb;AAKA5D,qBAAc,aAAY;AACxBuQ,qBACE,oBAAoB,aAAY;AAC9B,eAAI3M,uBAAJ,qBAAgD;AAC5C,oBAAOnB,EAAP;AACH;AACD,eAAIzC,SAAU4D,EAAd,iBAAI5D,CAAJ,EAAoC;AAChC,oBAAOyC,EAAEmB,EAAT,iBAAOnB,CAAP;AACH;AACD,kBAAOa,mCAAmCM,EAA1C,iBAAON,CAAP;AARJiN,UACE,CADFA;AADFvQ;AAaA;AAnBFsD;;AAsBAA,2CAAsC,oBAAmB;AACvD,WAAIkN,gBAAgB;AAClBC,iBADkB;AAElBC,eAFkB;AAGlBC,iBAAQ;AAHU,QAApB;;AAMA,WAAIC,eAAJ;;AAEA,qBAAc;AACZA,wBAAe,CAAC;AACI,gCADJ;AAEI,mBAFJ;AAGI,oBAHJ;AAII,qBAAW,kBAAY;AAAC;AAAkB;AAJ9C,UAAD,EAMC;AACI,gCADJ;AAEI,mBAFJ;AAGI,oBAHJ;AAII,qBAAW,kBAAY;AAAC;AAAqB;AAJjD,UAND,EAYC;AACI,gCADJ;AAEI,mBAFJ;AAGI,oBAHJ;AAII,qBAAW,kBAAY;AAAC;AAAwB;AAJpD,UAZD,CAAfA;AAmBD;;AAEDA,yBAAkB,SAAStN,UAAT,uBAASA,CAAT,EAA6C,aAAY;AACzE,gBAAOwB,UAAP;AADF8L,QAAkB,CAAlBA;;AAKA,cAAO5Q,wBAAP,IAAOA,CAAP;AApCFsD;;AAuCAA,iCAA4B,cAAa;AACvC,WAAIuN,YAAY9L,GAAhB,QAAgBA,EAAhB;AACA,cAAO,SAASzB,KAAT,OAAqB,aAAY;AACtC,gBAAOb,mBAAmBA,gBAA1B;AADF,QAAO,CAAP;AAFFa;;AAOAA,sCAAiC,oDAI/B;AACAwN;AACA,WAAIC,aAAazN,KAAjB,8BAAiBA,EAAjB;AACA,WAAIuK,gBAAgBvK,0BAApB,UAAoBA,CAApB;;AAEAvD,iBAEIuD,iEAFJvD,IAEIuD,CAFJvD,cAIe,aAAY;AACvBF,mCACEyD,kDADFzD,UACEyD,CADFzD;AALJE;;AAUA,+BAAwB;AACtBC,4BAAmB,kBAAiB;AAClC,eAAIgR,SAAS,yBAAyB,aAAY;AAChD,oBAAO1N,mCAAmC2N,OAA1C,iBAAO3N,CAAP;AADF,YAAa,CAAb;AAGA,eAAI4N,cAAclR,eAAlB,IAAkBA,EAAlB;AACA,eAAImR,mBAAmBL,gBAAvB,IAAuBA,CAAvB;AACAK,gDAAqCF,OAArCE;AACA,eAAIC,iBAAiBD,uDAArB,IAAqBA,CAArB;AAGAnR,+BAAoB,eAAc;AAChCoR;AACAA,8CACE,MAAMJ,OAAN,GAAMA,CAAN,EAAmB,aAAY;AAC7B,sBAAOvO,EAAP;AADF,qBADF2O,IACE,CADFA;AAFFpR;AAVFA;AADF,cAoBO;AACLA,+BAAsB,gBAAe;AACnC,eAAIqR,iBAAiBP,gBAArB,IAAqBA,CAArB;AACAO,8CAAmCtO,KAAnCsO;AACA,eAAIC,eAAeD,qDAAnB,IAAmBA,CAAnB;AAGArR,8BAAmB,kBAAiB;AAClCsR,4CAA+BL,OAA/BK;AACAA,4CAGIhO,sCAAsC2N,OAH1CK,iBAGIhO,CAHJgO;AAFFtR;AANFA;AAeD;AAvDHsD;;AA0DAA,qCAAgC,YAAW;AACzCvD,iBAEIuD,iEAFJvD,IAEIuD,CAFJvD,cAIe,YAAW;AACtBA;AACA,aAAIwR,cAAJ;;AAEA,aAAIC,iBAAiB/I,EAArB,IAAqBA,CAArB;AACA,aAAI+I,+BAAJ,MAAyC;AACvCA;AACAA;AACAD;AAHF,gBAIO;AACLC;AACAA;AACAD;AACD;AACDjO,wCACEkO,+BADFlO,QACEkO,EADFlO,EAEE,CAFFA,aAGEvD,UACEuD,6DAJJA,IAIIA,CADFvD,CAHFuD;AAlBJvD;;AA2BA0I,SACEnF,qDADFmF,IACEnF,CADFmF,sBAEsB,iBAAgB;AACpC,aAAIgJ,eAAehJ,EAAEgH,MAArB,aAAmBhH,CAAnB;AACA,aAAIuC,aAAayG,kBAAjB,SAAiBA,CAAjB;AACA,aAAIC,QAAQ3R,UACVuD,qDADF,IACEA,CADUvD,CAAZ;AAGA2R,8CAEQ,8BAFRA;AAGAjJ,WACEnF,iEADFmF,IACEnF,CADFmF;;AAIAnF,oDAEEmF,EACEnF,iEADFmF,IACEnF,CADFmF,kBAFFnF,MAQEoO,aACEpO,6DATJA,IASIA,CADFoO,CARFpO;AAfFmF;AA5BFnF;;AA0DA,wBAAmB;AACjBA;;AAEA,WAAIqO,uBAAuB5R,UACzBuD,qCADF,8BACEA,CADyBvD,CAA3B;;AAIA4R;;AAEA,WAAIC,cAAc,SAAdA,WAAc,SAAiB;AACjC5R,gBAAO,CAACsD,KAAD,UAAgBA,KAAvBtD,KAAO,CAAPA,EAAoC,gBAAe;AACjDA,wBAAa,eAAc;AACzB6R;AADF7R;AADFA;AADF;;AAQA,WAAI8R,uBAAuB,SAAvBA,oBAAuB,SAAiB;AAC1C,aAAIC,QAAJ;AACA/R,gBAAOsD,KAAPtD,UAAsB,eAAc;AAClC,eAAI6R,IAAJ,OAAe;AACbE;AACD;AACDF;AAJF7R;AAMAgS;AACAlD;AACAxL;AACAtD,uBAAc,eAAc;AAC1B6R;AADF7R;AAXF;;AAgBA,WAAIiS,mBAAmB,CACrB,eAEE,YAAW;AACT,gBAAO3O,KAAP,oBAAOA,EAAP;AAHJ,gBADqB,qBACrB,CADqB,EASrB,iBAEE,YAAW;AACT,gBAAOA,KAAP,sBAAOA,EAAP;AAHJ,gBATqB,uBASrB,CATqB,EAiBrB,oBAEE,YAAW;AACT,gBAAO,0BACL,0BAA0B,aAAY;AACpC,kBAAOb,EAAP;AAFJ,UACE,CADK,CAAP;AAHJ,gBAjBqB,0BAiBrB,CAjBqB,EA6BrB,sBAEE,YAAW;AACT,gBAAO,4BACL,0BAA0B,aAAY;AACpC,kBAAOA,EAAP;AAFJ,UACE,CADK,CAAP;AAHJ,gBA7BqB,4BA6BrB,CA7BqB,EAyCrB,6BAEEzC,uBAFF,IAEEA,CAFF,QAzCqB,uBAyCrB,CAzCqB,EA+CrB,+BAEEA,uBAFF,KAEEA,CAFF,QA/CqB,yBA+CrB,CA/CqB,EAqDrB,0BAEEA,gCAFF,IAEEA,CAFF,QArDqB,uBAqDrB,CArDqB,EA2DrB,yBAEEA,gCAFF,KAEEA,CAFF,QA3DqB,uBA2DrB,CA3DqB,EAiErB,8BAEE,gBAAe;AACbD,8BAGIuD,+CAHJvD;AAOAuD;AAVJ,UAYEA,KAZF,gBAjEF,oCAiEE,CAjEqB,CAAvB;;AAkFA,WAAI,CAACA,KAAL,UAAoB;AAClB2O,+BAAsB,uBAEpB,gBAAe;AACb3O,+BAAoB,CAACA,KAArBA;AACAvD,gCAGIuD,2CAHJvD;AAKAuD;AATkB,YAWpB,YAAW;AACT,kBAAO,OAAOA,KAAP,OAAmB,aAAY;AACpC,oBAAOwB,EAAP;AADF,YAAO,CAAP;AAZkB,YAAtBmN,6BAAsB,CAAtBA;AAkBD;;AAEDA,gCAAyB,uBAAsB;AAC7C,aAAIC,mBAAmBrG,KAAvB,CAAuBA,CAAvB;AACA,aAAIA,KAAJ,CAAIA,CAAJ,EAAa;AACX,8CAEQA,KAFR,CAEQA,CAFR;AAIE;AAJF,wBAKe,aAAY;AACvBqG;AACAnS;AAPJ;AASD;AAZHkS;;AAeA,WAAIE,eAAepS,UACjBuD,qCADF,cACEA,CADiBvD,CAAnB;;AAIA,WAAI,CAACoS,aAAL,KAAKA,EAAL,EAA2B;AACzBA;AACAA,2HAIe,aAAY;AACvBC,0BAAe,IAAfA;AALJD;AASAA,6HAIe,aAAY;AACvBC,0BAAe,IAAfA;AALJD;AASAA,2HAIe,aAAY;AACvBE;AALJF;AASAA,0HAIe,aAAY;AACvBE,8BAAmB,CAAnBA;AALJF;;AAUA,aAAI,CAAC7O,KAAL,UAAoB;AAClB6O,uLAKe,aAAY;AACvBnS,oBAAOsD,KAAPtD;AANJmS;AADF,gBAWO;AACJA,uKAKc,aAAY;AACvB7O;AANH6O;AAUF;;AAEDA;AAIE;AAJFA,sBAKe,aAAY;AACvBtS,qCAA0B,MAAMyD,KAAN,aAA1BzD;AANJsS;AAUD;;AAED1J,SAAEnF,qCAAFmF,QAAEnF,CAAFmF,6BAEE,WAAW,aAAY;AACrB,aAAI6J,eAAe7J,QAAnB,GAAmBA,EAAnB;AACAnF,qBACE,+BAEU,aAAY;AAClB,kBAAOwB,WAAP;AAHJ,gBAKO,aAAY;AACf,eAAIA,WAAJ,GAAkB;AAChB,iBAAIA,eAAeA,EAAEA,WAAFA,MAAnB,KAA2C;AACzC,sBAAO;AACLe,uBADK;AAELnC,wBAAO,WACL,MAAMoB,YAAYA,WAAlB,CAAMA,CAAN,GADK;AAFF,gBAAP;AAOD;AACD,iBAAIA,QAAJ,KAAiB;AACf,mBAAIyN,qBAAqBC,WAAW1N,SAApC,CAAoCA,CAAX0N,CAAzB;AACA,mBAAID,qBAAJ,GAA4B;AAC1B,wBAAO;AACL1M,yBADK;AAELnC,0BAAO6O;AAFF,kBAAP;AAID;AACF;AACF;AACD,kBAAO;AACL1M,mBADK;AAELnC,oBAAO;AAFF,YAAP;AA3BNJ,UACE,CADFA;AAFF,UAFFmF,GAEE,CAFFA;;AAwCAA,SAAEnF,qCAAFmF,aAAEnF,CAAFmF,eAEE,WAAW,aAAY;AACrBnF,gCAAuB,CAACA,KAAxBA;AACAA;AACAA;AAHF,UAFFmF,GAEE,CAFFA;;AASAA,SAAEnF,qCAAFmF,qBAAEnF,CAAFmF,eAEE,WAAW,aAAY;AACrB,aAAI,UAAUnF,KAAd,6BAAgD;AAC9C,kBAAOA,iCAAP,MAAOA,CAAP;AADF,gBAEO;AACLA,sDAA2CA,KAA3CA;AACD;;AAEDA;AAPF,UAFFmF,GAEE,CAFFA;;AAaAA,SACEnF,iEADFmF,IACEnF,CADFmF,eAIE,WAAW,aAAY;AACrBnF,+CAAsC,CAACA,KAAvCA;AACAmP,gDAEEnP,eAFFmP,cAEEnP,CAFFmP,EAGEnP,eAHFmP,mBAGEnP,CAHFmP;AAFF,UAJFhK,GAIE,CAJFA;AAaD;;AAED,SAAItI,2BAAJ,MAAqC;AACnCuS,oBAAarP,KAAbqP,uBAAarP,CAAbqP;AADF,YAEO;AACL,WAAIA,cAAc,cAAlB,YAA4C;AAC1CA,sBAAaA,WAAbA,UAAaA,CAAbA;AACD;AACF;;AAED;AACAC,kBAAa,wBAAwB,gBAAe;AAClD,cAAOzO,cAAP;AADW,QAAbyO;AAGArP,kBAAa,wBAAwB,gBAAe;AAClD,WACEY,aACA,OAAOZ,yBAAyBY,EAAhC,OAAOZ,CAAP,KAFF,aAGE;AACA8M;AACA;AACD;AACD;AARF9M,MAAa,CAAbA;AAUAA,kBAAa,wBAAwB,gBAAe;AAClD,cACE8M,gBAAgBlM,EAAhBkM,wBACAA,gBAAgBlM,EAAhBkM,WAFF;AADF9M,MAAa,CAAbA;AAMAA,kBAAa,eAAe,gBAAe;AACzCY,kBAAWkM,gBAAgBlM,EAA3BA,MAAWkM,CAAXlM;AACAA,kBAAWkM,gBAAgBlM,EAA3BA,MAAWkM,CAAXlM;AACAA;AACA;AAJFZ,MAAa,CAAbA;;AAOAsP,0BAAqBtP,KAArBsP,OAAiCtP,KAAjCsP;;AAEAZ,oBAAe1O,KAAf0O;AACA1O,2BAAsB,gBAAe;AACnCA,4BAAqBwB,EAArBxB;AACAwB,uBAAgB,gBAAgB,aAAY;AAC1C,gBAAOlB,EAAP;AADFkB,QAAgB,CAAhBA;AAGAsJ;AACAtJ;AANFxB;;AASA,SAAI;AACF,WAAIC,WAAWA,QAAf,YAAeA,CAAf,EAAsC;AACpC,aAAIsP,qBAAqB9S,UACvBuD,qCADF,4BACEA,CADuBvD,CAAzB;;AAIAA,mBAEIuD,qCAFJvD,4BAEIuD,CAFJvD,2BAKQwD,sBALRxD,OAKQwD,CALRxD;AAQA;AACA8S;;AAEAtP,gDAAuC,uBAAsB;AAC3D;AACA,eAAI2O,mBAAmBrG,KAAvB,CAAuBA,CAAvB;AACA,eAAI7L,aAAa6L,KAAjB,CAAiBA,CAAb7L,CAAJ,EAA2B;AACzB6L,2BAAc,YAAdA,IAAc,CAAdA;AADF,kBAEO;AACL,gDAEQA,KAFR,CAEQA,CAFR,gCAIe,aAAY;AACvBqG;AACAnS;AANJ;AAQD;AAdHwD;;AAiBAxD,mBAEIuD,qCAFJvD,4BAEIuD,CAFJvD;AAKD;AAvCH,OAwCE,YAAY;AACZ8C;AACD;;AAEDS,yCAAoC,YAAW;AAC7C,0BAAmB;AAAA,aA0HjB,eA1HiB,GA0HjB,4BAA4B;AAC1B,kBACE,CAACwB,kBAAkB,MAAMA,EAAN,YAAMA,CAAN,GAAlBA,OAAD,MAAwDA,EAD1D,OAC0DA,CAD1D;AAGD,UA9HgB;;AAgIjB;AACA;;AAhIA;;AAEA;AACA,aAAIgO,aAAa,SACf9S,MACEsQ,WADFtQ,uBACEsQ,CADFtQ,EAEEsD,KAHa,6BACftD,CADe,EAKf,aAAY;AACV;AACA,kBACE8E,cACA,iBADAA,KAEAA,2BAHF;AAPJ,UAAiB,CAAjB;;AAeA,aAAIiO,eAAe,qBAAqB,aAAY;AAClD,kBACGjO,cAAcA,eAAf,CAACA,IACDA,0BAFF;AADF,UAAmB,CAAnB;;AAOA;;AAEA9E,gBAAO,aAAPA,YAAO,CAAPA,EAAmC,gBAAe;AAChDA,wBAAasD,KAAbtD;AADFA;;AAIA,aAAIgT,eAAe,SACjB,MAAM1C,WAAN,uBAAMA,CAAN,EAA2C,gBAAe;AACxD,yDAA8C;AAC5C,iBAAI2C,UAAJ;;AAEAjT,4BAAe,eAAc;AAC3B8E,kCAAmB/E,UAAnB+E,MAAmB/E,CAAnB+E;AACA,mBAAIoO,OAAO,MACTlT,QADS,4BACTA,CADS,EAET,YAAW;AACT;AAHJ,gBAAW,CAAX;AAMAmT,yBACS,IAAI1S,+BADb0S,CACS,CADTA,SAEUrO,EAFVqO,aAEUrO,CAFVqO;AAGAnT,8BAAe,aAAY;AACzBkT,sBAAKhI,WAAWiI,IAAhBD,CAAgBC,CAAXjI,CAALgI;AADFlT;;AAIA,mBAAIoT,OAAOC,gBAAX;AACA,mBAAIC,OAAO,eAAe,gBAAe;AACvC,wBAAOC,IAAI,CAAC3P,IAAD,SAAcA,IAAzB,IAAW,CAAX;AADF,gBAAW,CAAX;;AAIA;;AAEA,mBAAI0P,OAAJ,SAAoB;AAClBL;AACAnO;AACD;AAzBH9E;AA2BD;;AAED8E;AACA,eAAIA,UAAJ,UAAwB;AACtB,iBAAIuO,SAAS,SACX,MAAM/C,WAAN,OAAwB,cAAa;AACnC,sBAAOhN,uCAAP,IAAOA,CAAP;AAFS,cACX,CADW,EAIX,aAAY;AACV,sBAAOY,KAAP;AALJ,cAAa,CAAb;AAQA;AACAsP,0CAA6B,CAC3BzT,SAD2B,MAC3BA,EAD2B,EAE3BA,SAF2B,GAE3BA,EAF2B,EAG3BA,wBAAwB,IAHG,CAG3BA,CAH2B,EAI3BA,wBAJ2B,IAI3BA,CAJ2B,EAK3BA,wBAL2B,GAK3BA,CAL2B,EAM3BA,wBAAwB,IANG,CAM3BA,CAN2B,EAO3BA,wBAAwB,IAP1ByT,EAOEzT,CAP2B,CAA7ByT;AAVF,kBAmBO;AACL,iBAAI1O,UAAJ,QAAsB;AACpB,mBAAIuO,SAAS,SACX,MAAM/C,WAAN,OAAwB,cAAa;AACnC,qBAAI;AACF,uBAAImD,SAASnQ,oCAAb,CAAaA,CAAb;AACA;AACAoQ,4DAGEpQ,kBAHFoQ,MAGEpQ,CAHFoQ;AAHF,mBAQE,YAAY;AACZA;AACD;AACD,wBAAOpQ,oCAAP,CAAOA,CAAP;AAbS,gBACX,CADW,EAeX,aAAY;AACV,wBAAOY,8BAAP;AAhBJ,gBAAa,CAAb;AAmBA;AACA,mBAAImP,iBAAJ,GAAwB;AACtB;AACA;AACD;AACDG,4CAA6B,CAACzT,QAA9ByT,KAA8BzT,EAAD,CAA7ByT;AACD;AACF;AACD;AAnFe,UACjB,CADiB,EAqFjB,aAAY;AACV,kBAAO1O,sBAAsBA,UAA7B;AAtFJ,UAAmB,CAAnB;;AAmGA,UACE/E,UAAUuD,qCADZ,YACYA,CAAVvD,CADF,EAEEA,UACEuD,uDAHJ,IAGIA,CADFvD,CAFF,UAKU,aAAY;AACpB;;AAEA,eAAI4T,EAAJ,KAAIA,EAAJ,EAAe;AACb;AACD;AACDA;;AAEA,eAAIC,aAAa,CACf,CACE,eAAe5T,UAAUsD,KAAVtD,8BAFF,IAEEA,CAAf,CADF,CADe,EAIf,CAAC,2BAJc,IAId,CAAD,CAJe,SAMf,eAAe,gBAAe;AAC5B,oBAAO,CACL,CACE6T,gBADF,CACEA,CADF,EAEE/O,EAFF,mBAEEA,CAFF,EAGE9E,UACEsD,KADFtD,8BAEE8E,EANN,mBAMMA,CAFF9E,CAHF,CADK,CAAP;AAPJ,YAME,CANe,CAAjB;;AAoBA,eAAIgT,aAAJ,QAAyB;AACvBY,0BAAa,kBACH,CAAC,CAAC,0BADC,IACD,CAAD,CAAD,CADG,SAGT,iBAAiB,gBAAe;AAC9B,sBAAO,CACL,CACEC,gBADF,CACEA,CADF,EAEE/O,EAFF,mBAEEA,CAFF,EAGE9E,UACEsD,KADFtD,6BAEE8E,EANN,mBAMMA,CAFF9E,CAHF,CADK,CAAP;AAJN4T,cAGI,CAHS,CAAbA;AAgBD;;AAED,eAAIE,WAAWH,uBAAf,UAAeA,CAAf;;AAEAG,6DAGuB,aAAY;AAC/B,oBAAOhP,WAAP;AAJJgP,oCAMyB,aAAY;AACjC,oBAAOhP,UAAU,CAAVA,mBAAP;AAPJgP;;AAUAA,wCAEQ,aAAY;AAChB;AAHJA,uCAOQ,mBAAkB;AACtB,oBAAOhP,EAAP,CAAOA,CAAP;AARJgP,4BAUiB,mBAAkB;AAC/B,iBAAIhP,QAAJ,WAAuB;AACvB,iBAAIiP,KAAJ,GAAY;AACV;AACD;AACD;AAfJD,4CAkBe,aAAY;AACvB,iBAAIhP,EAAJ,CAAIA,CAAJ,EAAU;AACRA;AACD;AArBLgP;AAhEF;;AAyFA,UACE/T,UAAUuD,qCADZ,QACYA,CAAVvD,CADF,UAEU,aAAY;AACpB4T;AACA,eAAIG,WAAW,uBACb,CACE,CAAC,eAAe9T,UAAUsD,KAAVtD,0BADlB,IACkBA,CAAf,CAAD,CADF,SAGE,iBAAiB,gBAAe;AAC9B,oBAAO,CACL,CACE6T,gBADF,CACEA,CADF,EAEE/O,EAFF,mBAEEA,CAFF,EAGE9E,UACEsD,KADFtD,0BAEE8E,EANN,mBAMMA,CAFF9E,CAHF,CADK,CAAP;AALN,YAII,CAHF,CADa,CAAf;;AAmBA8T,+DAAoD,aAAY;AAC9D,oBAAOhP,UAAU,CAAVA,mBAAP;AADFgP;;AAIAA,wCAEQ,aAAY;AAChB;AAHJA,uCAOQ,mBAAkB;AACtB,oBAAOhP,EAAP,CAAOA,CAAP;AARJgP,4BAUiB,mBAAkB;AAC/B,iBAAIC,KAAJ,GAAY;AACV;AACD;AACD;AAdJD,4CAiBe,aAAY;AACvB,iBAAIhP,EAAJ,CAAIA,CAAJ,EAAU;AACRA;AACD;AApBLgP;AA3BF;;AAmDArL,WACEnF,qCADFmF,gBACEnF,CADFmF,cAEc,aAAY;AACxB,eAAInF,eAAJ,eAAIA,CAAJ,EAAqC;AACnCA,mDACEA,wCADFA,OACEA,EADFA;AAGAA;AACAA;AACD;AACDmF;AAVFA;;AAaAA,WACEnF,qCADFmF,mBACEnF,CADFmF,cAEc,aAAY;AACxB,eAAInF,eAAJ,aAAIA,CAAJ,EAAmC;AACjCgN,iDAAoChN,eAApCgN,aAAoChN,CAApCgN,iBAGEA,oCACEhN,eADFgN,aACEhN,CADFgN,mBAHFA,OAGEA,EAHFA;AASAhN,mCAAsB,uBAAsB;AAC1C0Q,yCAA0BC,sCAExB3Q,eAFF0Q,aAEE1Q,CAFwB2Q,CAA1BD;AADF1Q;AAMAA;AACAA;AACD;AACDmF;AAtBFA;;AAyBA,UACE1I,UAAUuD,qCADZ,SACYA,CAAVvD,CADF,UAEU,aAAY;AACpB4T;AACA,eAAIG,WAAW,uBACb,CACE,CAAC,eAAe9T,UAAUsD,KAAVtD,0BADlB,IACkBA,CAAf,CAAD,CADF,SAGE,iBAAiB,gBAAe;AAC9B,oBAAO,CACL,CACE8E,EADF,OACEA,CADF,EAEEA,EAFF,mBAEEA,CAFF,EAGE9E,UACEsD,KADFtD,0BAEE8E,EANN,mBAMMA,CAFF9E,CAHF,CADK,CAAP;AALN,YAII,CAHF,CADa,CAAf;;AAmBA8T,+DAAoD,aAAY;AAC9D,oBAAOhP,UAAU,CAAVA,mBAAP;AADFgP;AAGAA,wCAEQ,aAAY;AAChB;AAHJA,uCAOQ,mBAAkB;AACtB,oBAAOhP,EAAP,CAAOA,CAAP;AARJgP,4BAUiB,mBAAkB;AAC/B,iBAAIC,KAAJ,GAAY;AACV;AACD;AACD;AAdJD,4CAiBe,aAAY;AACvB,iBAAIhP,EAAJ,CAAIA,CAAJ,EAAU;AACRA;AACD;AApBLgP;AA1BF;AAiDD;AAvWHxQ;;AA0WA,qBAAgB;AACd;;;;;AAKA,WAAI,mBAAJ,YAAmC;AACjC,aAAI4Q,gBAAgBxB,WAApB,eAAoBA,CAApB;;AAEA,aAAI,0BAA0BwB,8BAA9B,GAA+D;AAC7D5D,iDAAsC,yBAEhC,gBAAe;AACnB,oBAAO;AACL3K,sBADK;AAELE,qBAFK;AAGLwN,uBAHK;AAILc,sBAJK;AAKLC,sBAAO;AALF,cAAP;AAHF9D,YAAsC,CAAtCA;;AAYAA,oCAAyB,aAAY;AACnC7N,0CAA6BA,WAAWyR,cAAxCzR,WAAwCyR,CAAXzR,CAA7BA;AACAA,gDAAmC,gBAAe;AAChD,mBAAI4G,IAAIiH,oCAAR,QAAoD;AAClD,qBAAI,EAAEpM,KAAKoM,uCAAX,QAAWA,CAAP,CAAJ,EAA8D;AAC5DA,yEACEA,uCADFA,OACEA,CADFA;AAEAA;AACD;AACF;AACD;AARF7N;AAFF6N;;AAcAA,uDAA4C,aAAY;AACtD,iBACExL,aAAawL,iBAAbxL,UACAA,aADAA,KAEAA,cAHF,IAIE;AACAA;AACD;AAPHwL;AASD;AACF;;AAEDtQ,cAAOsD,KAAPtD,uCAAmD,yBAGjD;AACA,aAAIA,aAAJ,QAAIA,CAAJ,EAA4B;AAC1BqU,sBAAWA,SAAXA,IAAWA,CAAXA;AACD;;AAED,aACE,CAACA,SAAD,SAACA,CAAD,IACArU,MAAMsQ,WAANtQ,uBAAMsQ,CAANtQ,EAA2CqU,SAF7C,SAE6CA,CAA3CrU,CAFF,EAGE;AACA,eAAIsU,YAAJ;AACAA;AACAtU,oBAASsQ,WAATtQ,uBAASsQ,CAATtQ;AACAsD;AACAtD,kBAAOsQ,WAAPtQ,OAAyB,gBAAe;AACtC0T,0DAGEW,sBAHFX,IAGEW,CAHFX;AADF1T;AAOD;AAvBHA;;AA0BAsD;;AAEA;AACD;;AAED,SAAIA,4BAAJ,sBAAsD;AACpD,WAAIiR,eAAe,uBACZ,gBAAe;AAClB,gBAAO,IAAIlL,IAAX,CAAO,CAAP;AAFe,eAIX,gBAAe;AACnB,gBAAO+B,OAAOD,EAAd,CAAcA,CAAd;AALJ,QAAmB,CAAnB;;AAQA,YAAK,IAAIqJ,IAAT,GAAgBA,IAAID,sBAApB,2BAAqE;AACnEjR,kCAAyBiR,gBAAzBjR,CAAyBiR,CAAzBjR;AACD;;AAEDmR,wBACE,eACCF,sBADD,qDAGAA,aAAaC,IAAbD,GAHA,CAGAA,CAHA,oDADFE;AAQD;;AAEDnR,wBAAmB,gBAAe;AAChCA,qBACEA,qBAAqBA,WAAWV,EAAXU,QADvBA,OACEA,CADFA,iBAEiBV,EAFjBU;AADFA;;AAMAA,2BAAsB,gBAAe;AACnCwB,qBAAcjF,wBAAwBiF,EAAtCA,SAAcjF,CAAdiF;AADFxB;AAGA;;AAEAA;AACD;;AAED,mDAAgD;AAC7C;AACA,gBAAW;AACVmF;AACA1I,wEAGkC2D,SAHlC3D,sCAIiC2D,SAJjC3D,0BAKsB2D,SALtB3D;AAFD,YAQM;AACL,WAAI2U,eAAejM,gBAAnB,QAAmBA,CAAnB;AACAkM,uCAAgCD,iCAAhCC;AACA,cAAOD,wBAAwB3U,GAAxB2U,aAAwC3U,GAA/C;AACD;AACF;;AAED;AACA,iDAA8C;AAC5C,SAAIA,GAAJ,OAAc;AACbA;AACA;AACD,SAAI6U,gBAAgBnM,mBAApB,OAAoBA,CAApB;AACA,SAAImM,cAAJ,QAA0B;AACxB,WAAIC,UAAUC,SAASrM,gBAAvB,WAAuBA,CAATqM,CAAd;AACA,WAAIC,WAAWC,MAAf;AACA,WAAIN,eAAejM,gBAAnB,QAAmBA,CAAnB;AACA,WAAIwM,kBAAkBN,uBAAtB,OAAsBA,CAAtB;;AAEA;;AAEA,qBAAc;AACZ,aAAI3U,aAAJ,QAAIA,CAAJ,EAA4B;AAC1BkV,2BAAgB,0BAAY;AAC1B,oBAAOH,SAAP,CAAOA,CAAP;AADFG;AADF,gBAIO;AACLA,2BAAgB,0BAAY;AAC1B,iBAAIC,MAAM7M,EAAV,QAAUA,CAAV;AACA,iBAAItI,aAAJ,GAAIA,CAAJ,EAAuB;AACvB;AAHFkV;AAKD;AAXH,cAYO;AACLA,yBAAgB,0BAAY;AAC1B;AADFA;AAGD;;AAEDnV,iBACU6U,cADV7U,CACU6U,CADV7U,uCAIQ,gBAAe;AACnB,gBAAOkV,gBACLC,cAAc9J,EADT6J,OACS7J,CAAd8J,CADKD,EAELC,cAAc/J,EAFhB,OAEgBA,CAAd+J,CAFKD,CAAP;AALJlV;;AAWA;;AAEA0I,8DAEU,YAAW;AACjB,gBAAOqM,SAASrM,aAATqM,WAASrM,CAATqM,KAAP;AAHJrM,eAKQ,YAAW;AACfkM;AANJlM;AAQD;AACF;;AAED,6CAA0C;;AAExC,SAAI2M,WAAWrV,UAAf,IAAeA,CAAf;AACA,SAAIsV,gBACF,OAAOC,KAAP,uBAAmCA,KAAnC,KAAmCA,EAAnC,GAAkDA,KADpD;;AAGA,SAAIC,cAAJ;;AAEA,SAAI,cAAJ,MAAwB;AACtBA,qBAAcD,oBAAdC,aAAcD,CAAdC;AADF,YAEO;AACL,WAAIC,OAAO,mBAAmBF,YAAnB,aAAmBA,CAAnB,GAAX;AACA,WAAI,UAAJ,MAAoBF,cAApB,IAAoBA,EAApB,KACKA;AACN;AACC,SAAIG,eAAgB,UAApB,MAAqC;AACnC,WAAIE,UAAU,0DAGC,aAAY;AACvBC;AAJU,iEAAd,KAAc,CAAd;AAQAD;;AAKA,WAAI,aAAJ,MAAuB;AACnB,aAAIH,mBAAJ,QAA+B;AAC3BG;AACH;AACDC,8BAAsBD,QAAtBC,IAAsBD,EAAtBC;AACH;AACJ;AACD,SAAI,UAAJ,MAAoB;AAClBN,8BAAuBE,KAAvBF;AACD;AACF;;AAED,yEAAsE;;AAEpE,SAAIO,QAAQ7O,oBAAZ,OAAYA,CAAZ;AACA,SAAI8O,QAAQ9O,oBAAZ,OAAYA,CAAZ;;AAEA,SAAI8O,iBAAJ,WAAgC;AAC9BA;AACAA,eAAQ9O,iBAAR8O,OAAQ9O,CAAR8O;AACAA,qFAMQ,aAAY;AAChB;AAPJA,oCAWQ,qBAAoB;AACxB,gBAAO,eAAe,gBAAe;AACnC;AACAC;AAFF,UAAO,CAAP;AAZJD;AAiBD;;AAEF;AACA,SAAID,iBAAJ,WAAgC;AAC7BA;AACAA,eAAQ7O,iBAAR6O,OAAQ7O,CAAR6O;AACAA,qFAMQ,aAAY;AAChB;AAPJA,oCAWQ,qBAAoB;AACxB,gBAAO,eAAe,gBAAe;AACnCE;AADF,UAAO,CAAP;AAZJF;AAgBD;AACF;;AAED,qDAAkD;AAChD,SAAIpR,YAAYxE,UAAhB,OAAgBA,CAAhB;AACAwE;AACA,SAAIuR,iBAAiBrR,QAArB,CAAqBA,CAArB;AACA,SAAIuG,aAAavG,QAAjB,CAAiBA,CAAjB;;AAEA,yBAAoB;AAChB;;AAEF;AACA;;AAEA;;;;;;AAMAF;;AAEAA,8GAIe,aAAY;AACvBjB,8BAAqBmB,QAArBnB,CAAqBmB,CAArBnB;AALJiB;AAdF,YAqBO;AACLA;AACAA,8IAKe,aAAY;AACvBjB;AANJiB;AAQD;AACDA,iLAQIjB,qDARJiB,IAQIjB,CARJiB;AAWD;;AAED,0DAAuD;AACrD,SAAIA,YAAYxE,UAAhB,OAAgBA,CAAhB;AACA,SAAIgW,SAAS,CAAC,CAACtR,wBAAD,YAAd,CAAc,CAAD,CAAb;AACA,SAAIA,QAAJ,CAAIA,CAAJ,EAAgB;AACdsR,mBAAY,gBAAZA,CAAY,CAAZA;AACD;AACD,SAAItR,QAAJ,CAAIA,CAAJ,EAAgB;AACdsR,mBAAY,UAAZA,CAAY,CAAZA;AACD;AACD,SAAIrR,UAAUH,mCAAd,MAAcA,CAAd;AACAG;AACAA;AACAA,0DAEQ,aAAY;AAChB,cAAOI,EAAP,CAAOA,CAAP;AAHJJ,yDAMoB,aAAY;AAC5B,cAAOI,oBAAP;AAPJJ,oBASe,aAAY;AACvB,WAAII,QAAJ,GAAe;AACb,aAAIL,QAAJ,CAAIA,CAAJ,EAAgB;AACduR,0BACE1S,cAAcmB,QAAQA,iBAARA,KADhBuR,CACE1S,CADF0S;AADF,gBAKO;AACLC,4BAAiB3S,cAAcmB,QAAQA,iBAARA,KAA/BwR,CAAiB3S,CAAjB2S;AACD;AACD3S,uCAA8BA,KAA9BA;AACA,aAAIA,KAAJ,kBAA2B;AACzBA,yCAA8BA,KAA9BA;AACD;AACF;AAvBLoB;AAyBD;;AAED,8FAA2F;AACzF;;;;;;;;AAUA,SAAIwR,eAAJ;AACA,SAAIC,YAAJ;;AAEAD,0BAAqB,aAAa,gBAAe;AAC/CC,iBAAUvS,EAAVuS;AACA,qBAAc;AACZ;AACD;AACD,WAAIrI,KAAK9N,QAAT,CAASA,CAAT;AACA8N;AACA;AAPFoI,MAAqB,CAArBA;;AAUAE,kBAAaA,cAAbA;;AAEAF,0BAAqB,SAASE,WAAT,OAA2B,aAAY;;AAE1D,WAAGpW,cAAc4C,EAAd5C,WAA2BA,cAAc4C,EAA5C,MAA8B5C,CAA9B,EAAuD;AACrD;AACD;;AAED,cACEoW,iBAAiBxT,EAAjBwT,2BACAA,iBAAiBxT,EAAjBwT,cADAA,cAEAC,uBAAuB,CAAC/S,sBAH1B,CAG0BA,CAFxB8S,CADF;AANFF,MAAqB,CAArBA;;AAaA,iBAAY;AACVA,4BAAqBlW,SAASkW,aAATlW,OAArBkW,MAAqBlW,CAArBkW;AACD;;AAEDA,0BAAqB,MAAMA,aAAN,OAA0B,aAAY;AACzD,WAAII,KAAKtW,QAAT,CAASA,CAAT;AACAsW,mBAAYH,UAAUC,iBAAiBxT,EAAjBwT,QAAtBE,EAAYH,CAAZG;AACAA,mBAAYH,UAAUC,iBAAiBxT,EAAjBwT,QAAtBE,EAAYH,CAAZG;AACA;AAJFJ,MAAqB,CAArBA;;AAOA;AACD;;AAED,uDAAoD;AAClD,SAAI3R,YAAYxE,UAAhB,OAAgBA,CAAhB;AACA,SAAIgW,SAAS,CACXtR,sBACIzE,WAAWyE,QAAXzE,CAAWyE,CAAXzE,IACE,CAACyE,QAAD,CAACA,CAAD,KADFzE,aACE,CADFA,GAEE,mBAHNyE,CAGM,CAHNA,GAII,CAACA,sBAAD,QALN,CAKM,CALO,CAAb;;AAQA,SAAIA,uBAAuBA,cAA3B,GAA4C;AAC1CsR,mBAAY,iBAEV,YAAW;AACTzS,sCAA6BmB,QAA7BnB,CAA6BmB,CAA7BnB;AAHJyS,QAAY,CAAZA;AAMD;;AAED,SAAIrR,UAAUH,mCAAd,MAAcA,CAAd;AACAG;AACAA;AACAA;AAGE;AAHFA,WAIQ,aAAY;AAChB,cAAOI,EAAP,CAAOA,CAAP;AALJJ,yBAOoB,aAAY;AAC5B,cAAOI,QAAQ,CAAC9E,aAAa8E,EAAtBA,CAAsBA,CAAb9E,CAAT8E,gBAAP;AARJJ,oBAUe,aAAY;AACvB,WAAI1E,aAAa8E,EAAjB,CAAiBA,CAAb9E,CAAJ,EAAwB;AACtB8E;AADF,cAEO;AACL,aAAIA,QAAJ,GAAe;AACb,eAAIL,QAAJ,CAAIA,CAAJ,EAAgB;AACdwR,8BACE3S,cAAcmB,QAAQA,iBAARA,KADhBwR,CACE3S,CADF2S;AADF,kBAKO;AACLD,4BAAe1S,cAAcmB,QAAQA,iBAARA,KAA7BuR,CAAe1S,CAAf0S;AACD;AACD;AACA1S,yCAA8BA,KAA9BA;AACD;AACF;AA1BLoB;AA4BAA,kBAAa,gBAAe;AAC1B,WAAII,YAAJ,GAAmB;AACjB/E,+DAAsD+E,EAAtD/E,CAAsD+E,CAAtD/E;AACD;AAHH2E;AAKD;;AAEDpB,mCAAgC,qBAAoB;AAClDwD,sCAEU,gBAAe;AACrB,cAAO,cAAP;AAHJA,aAKQ,gBAAe;AACnB+O;AANJ/O;AADFxD;;AAWAA,mCAAgC,qBAAqB;AACnD,SAAIA,KAAJ,YAAqB;AACnBiT,mBAAYA,aAAajT,KAAzBiT;AACA,WAAIxF,aAAazN,oCAAjB,IAAiBA,CAAjB;;AAEAA,oCAA6B,MAAOA,KAAP,uBAAmC,gBAAgB;AAC9E,aAAItD,WAAJ,CAAIA,CAAJ,EAAoB;;AAGhByC,eAAI,mBAAoB,cAAc;AAClC,oBAAO+T,wBAAP;AADJ/T,YAAI,CAAJA;;AAIA,kBAAO;AACH;AACH;AACD,kBAAOsO,WAAP,CAAOA,CAAP;AACH;AACD;AAbFzN,QAA6B,CAA7BA;;AAgBA,WAAImT,YAAYnT,8CAA+CA,KAA/D,qBAAgBA,CAAhB;AACAmT;AACA,WAAIC,gBAAgB,MAAOpT,KAAP,uBAAmC,qBAAqB;AAC1E,gBAAO;AACHI,kBAAQjB,EADL;AAEHkB,iBAFG;AAGHE,iBAAO,eAAepB,EAAf,QAAyBA,EAH7B;AAIH6B,qBAAU,oCAA2B;AACjC,iBAAIqS,WAAW5W,qDAAf,IAAeA,CAAf;AACA,iBAAI6W,UAAU,0BAAd;AACA,iBAAIC,kBAAkBF,kCAAoC,EAAC,OAAD;AACC,8BADD;AAEE,kCAFtCA,IAAoC,EAApCA,iIAAtB,OAAsBA,CAAtB;;AAOA,iBAAI,YAAJ,GAAmB;AACfE,oCAAsBpU,SAAtBoU,OAAsBpU,CAAtBoU;AADJ,oBAEO;AACHA;AACH;AACDA,iDAAqC;AAC/B,qBAD+B;AAE/B,gCAF+B;AAG/B,wBAAU;AAHqB,cAArCA;AAKA,iBAAIC,gBAAgBH,6EAApB,OAAoBA,CAApB;;AAIAG,6BAAgB,mCAAqC,qBAAsB,eAAe;AACtF,sBAAOC,yBAAyBtU,EAAhC;AADJqU,cAAqD,CAArC,CAAhBA;AAGAA;AACAA,gCAAoB,mBAAmB;AACnC,mBAAIE,gBAAgB,mDAAsD,gBAAgB;AACtF,wBAAO1B,KAAP;AADJ,gBAAoB,CAApB;AAGA0B,yCAA2B,aAAa;AACpC1T;AACAA;AAFJ0T;AAJJF;AASA;AACH;AA1CE,UAAP;AADF,QAAoB,CAApB;;AA+CA,WAAIG,aAAa,cAAe,gBAAe;AACzC,gBAAO,SAAU,mBAAmB;AAChC,eAAI3T,sCAAJ,QAAkD;AAC9C,oBAAO,EAACI,OAAD,MAAeO,QAAS,mBAAa;AACxC,qBAAIC,KAAJ,iBAA0B;AACtB;AACH;AACD,wBAAOlD,6BAAP,CAAOA,CAAP;AAJJ,gBAAO,EAAP;AADJ,kBASO;AACH,iBAAIsC,sCAAJ,UAAoD;AAChD,sBAAO,EAACI,OAAD,MAAeO,QAASlE,UAA/B,KAA+BA,CAAxB,EAAP;AACH;AACJ;AACD,kBAAO,EAAC2D,OAAR,IAAO,EAAP;AAfJ,UAAO,CAAP;AADN,QAAiB,CAAjB;;AAqBAJ,wCAAkC,CAAlCA,aAAkC,CAAlCA;AAED;AA7FHA;;AAgGAA,0BAAuB,mDAAkD;AACvE,SAAIA,KAAJ,YAAqB;AACnBiT,mBAAYA,aAAajT,KAAzBiT;;AAED,WAAI,CAAJ,SAAc;AACVW,mBAAU,CACP,CACE;AACExT,kBADF;AAEEC,iBAFF;AAGEE,iBAAM;AAHR,UADF,EAME;AACEH,kBADF;AAEEC,iBAAM;AAFR,UANF,EAUE;AACED,kBADF;AAEEC,iBAFF;AAGEE,iBAAM;AAHR,UAVF,EAeE;AACEH,kBADF;AAEEC,iBAFF;AAGEE,iBAAM;AAHR,UAfF,CADO,CAAVqT;;AAwBC,4BAAmB;AACjBlX,iCAAsB,aAAY;AAChCkX,6BAAgBpS,EAAhBoS;AADFlX;AAGD;;AAEHmX,gBAAO,cAAc,gBAAe;AAClC,eAAIC,WAAW,CACf;AACE1T,oBAAOjB,EADT;AAEEoB,mBAAM;AAFR,YADe,EAKf;AACEH,oBAAO,iBAAW;AAChB,mBAAIjB,gBAAJ,YAAgC;AAC9B,qBAAI;AACF,uBAAIa,yBAAyBb,EAA7B,OAAIa,CAAJ,EAAyC;AACvC;AACA;AACA,4BAAO,CAACb,EAAR,OAAO,CAAP;AACD;AACD,0BAAO,CACL,CAACa,cAAcA,qBAAqBb,EAAnCa,OAAcA,CAAdA,EADI,WAELb,EAFF,OAAO,CAAP;AANF,mBAUE,YAAY;AACZ,0BAAO,CAAC,CAAR,CAAO,CAAP;AACD;AAbH,sBAcO;AACL,wBAAO,CAACA,EAAR,eAAO,CAAP;AACD;AAlBL;AAoBE6B,uBApBF;AAqBEwB,uBAAU;AArBZ,YALe,EA4Bf;AACEpC,oBAAO,gBAAgBjB,EAAhB,SADT;AAEEoB,mBAAM;AAFR,YA5Be,EAgCf;AACEH,oBAAO,iBAAiBjB,EAAjB,UADT;AAEEoB,mBAAM;AAFR,YAhCe,CAAf;;AAsCE,8BAAmB;AACjB7D,mCAAsB,cAAa;AACjCoX,6BAAcC,gBAAdD,IAAcC,CAAdD;AADFpX;AAGD;AACD;AA5CJmX,UAAO,CAAPA;AA8CD;;AAGDG,4BACEhU,KADFgU,2BAIE;AACA;AALFA;AAOD;AA3FHhU;;AA8FAA,6BAA0B,2CAIxB;;AAEA,SAAIiU,gBAAqBhU,WAAWA,QAAZ,aAAYA,CAAXA,GAAD,IAACA,GAAzB;AACA,SAAIiU,mBAAoBjU,WAAWA,QAAZ,aAAYA,CAAXA,GAAD,KAACA,GAAxB;;AAEAkU,eAAUA,WAAWnU,KAArBmU;;AAEA,kBAAa;AACX,WAAIP,UAAU,CACZ,CACE;AACExT,gBADF;AAEEC,eAAM,iBAAY;AAChB,kBAAO,MAAMC,iBAAN,GAAMA,CAAN,EAA6B,cAAa;AAC/C,oBAAO3C,wBAAwB,CAA/B,EAAOA,CAAP;AADK,mBAAP,GAAO,CAAP;AAHJ;AAOE4C,eAAM;AAPR,QADF,EAUE;AACEH,gBADF;AAEEC,eAFF;AAGEE,eAAM;AAHR,QAVF,EAeE;AACEH,gBADF;AAEEC,eAFF;AAGEE,eAAM;AAHR,QAfF,CADY,CAAd;;AAwBA,WAAI,CAACP,KAAL,UAAoB;AAClB4T,yBAAgB;AACdxT,kBADc;AAEdK,iBAAM;AAFQ,UAAhBmT;;AAKAA,yBAAgB;AACdxT,kBADc;AAEdG,iBAFc;AAGdE,iBAAM;AAHQ,UAAhBmT;AAKD;;AAED,0BAAmB;AACjBlX,+BAAsB,aAAY;AAChCkX,2BAAgBpS,EAAhBoS;AADFlX;AAGD;;AAED,WAAIuD,WAAWA,QAAf,SAAeA,CAAf,EAAoC;AAClCA;AACD;;AAED,WAAI4T,OAAJ;;AAEAnX,cAAOsD,KAAPtD,UAAsB,mBAAkB;AACtC,aAAI0X,WAAW,SAAXA,QAAW,mBAA2B;AACxC,eAAIN,WAAW,CACb;AACE1T,oBAAO,CAACoB,EAAD,2BADT,CACS,CADT,EAC2C;AACzCR,uBAAUqT;AAFZ,YADa,EAKb;AACEjU,oBAAO,iBAAW;AAChB,mBAAIkU,iBAAiBC,gBAAgB/S,EAAhB+S,iBAArB;;AAEA,sBAAO,CACLD,eADK,WAELA,eAFK,aAGLA,eAHK,cAILA,eAJF,UAAO,CAAP;AAJJ;AAWEtT,uBAXF;AAYEwB,uBAAU;AAZZ,YALa,EAmBb;AACEpC,oBAAOoB,WAAWgT;AADpB,YAnBa,CAAf;;AAwBA,eAAI,CAACxU,KAAL,UAAoB;AAClB8T,2BAAc;AACZ1T,sBAAOoB,EADK;AAEZb,uBAAQ,mBAAY;AAClB,qBAAI;AACF,0BACEtD,oBAAoBmE,EAApBnE,MAAoBmE,CAApBnE,WAEAA,oBAAoBmE,EAFpBnE,QAEoBmE,CAApBnE,CAFAA,UAIAA,oBAAoBmE,EAJpBnE,IAIoBmE,CAApBnE,CAJAA,WAMAA,oBAAoBmE,EANpBnE,IAMoBmE,CAApBnE,CANAA,GADF;AADF,mBAWE,UAAU;AACV;AACD;AACF;AAjBW,cAAdyW;AAmBAA,2BAAc;AACZ1T,sBAAOoB,EADK;AAEZb,uBAAQ,mBAAY;AAClB,qBAAI;AACF,0BACEtD,oBAAoBmE,EAApBnE,MAAoBmE,CAApBnE,WAEAA,oBAAoBmE,EAFpBnE,QAEoBmE,CAApBnE,CAFAA,UAIAA,oBAAoBmE,EAJpBnE,IAIoBmE,CAApBnE,CAJAA,WAMAA,oBAAoBmE,EANpBnE,IAMoBmE,CAApBnE,CANAA,GADF;AADF,mBAWE,UAAU;AACV;AACD;AACF;AAjBW,cAAdyW;AAmBD;AACD,8BAAmB;AACjBpX,mCAAsB,cAAa;AACjCoX,6BAAcC,gBAAdD,IAAcC,CAAdD;AADFpX;AAGD;;AAED;AAvEF;;AA0EA,aAAI,CAAJ,eAAoB;AAClBmX,qBAAUO,kBAAVP,KAAUO,CAAVP;AACD;;AAGD,aAAI,CAAJ,kBAAuB;AACrBnX,kBAAOgE,QAAPhE,aAA4B,uBAAsB;AAChDmX,uBAAUO,sBAAVP,IAAUO,CAAVP;AADFnX;AAGD;AApFHA;;AAuFAsX;AAED;AAtJHhU;;AAyJA;AACA,0DAAuD;AACrD,gCAA2B;AACzB,WAAIyU,iBAAiB,SAASzU,KAAT,UAAwB,aAAY;AACrD,gBAAO,CAACM,EAAR;AADiB,UAArB;AAAA,WAGEoU,mBAAmB1U,4BAA4BA,cAHjD;AAAA,WAIE2U,gBACE3H,uCAAuChN,WAL3C;;AAOA,WAAI4U,oBAAoB,SAAS5U,KAAT,UAAwB,aAAY;AAC1D,gBACE,CAACM,EAAD,aAAgBA,mBAAhB,aAAgDA,iBADlD;AADsB,UAAxB;;AAMA,WAAIuU,iBAAiB,SAAS7U,KAAT,OAAqB,aAAY;AACpD,gBAAOb,kBAAkB,CAACA,EAA1B;AADmB,UAArB;;AAIA;;;;;;;AAOA,WAAI2G,IACF,2BACA9F,cADA,oKAOAA,WAPA,uJAaAA,WAbA,uBAeCA,0BAfD,kEADF;;AAqBAvD;AACD;AACF;;AAED,yCAAsC;AACpC,eAAU;AACR+G,mBAAY/G,UAAZ+G,SAAY/G,CAAZ+G;;AAEA,WAAIsR,cACFrV,oBAAoB,CAACA,KAArBA,oBAEIA,iCAAiCO,2BAHvC,IAGuCA,CAHvC;;AAKAP,4BAAqBmI,UAAUmN,UAAVnN,IAAUmN,CAAVnN,QAArBnI;;AAEA+D,2BACalH,8BAA8ByY,UAD3CvR,IAC2CuR,CAA9BzY,CADbkH,mDAG8B,aAAY;AACtC,gBAAOhC,EAAP;AAJJgC,qCAM8B,aAAY;AACtC,gBAAOhC,gBAAP;AAPJgC,4BASqB,aAAY;AAC7B,gBAAO,eAAehC,EAAf,UAA2BA,EAA3B,IAAP;AAVJgC,wBAYiB,aAAY;AACzB,gBAAOwR,WAAP,CAAOA,CAAP;AAbJxR,2BAeoB,aAAY;AAC5B,gBAAOyR,aAAP,CAAOA,CAAP;AAhBJzR,2BAkBoB,aAAY;AAC5B,aAAIhC,EAAJ,WAAiB;AACjB;AApBJgC,wGAyBQgI,sCAzBRhI,YAyBQgI,CAzBRhI;AA0BD;AACF;;AAED,mDAAgD;AAC9C,SAAI0R,kBAAkBzY,UAAtB,SAAsBA,CAAtB;;AAEA,SAAI0Y,YAAY,mCACZ,qCAAqC,aAAY;AAC/C,cAAO3T,SAAS,CAAhB,CAAgB,CAATA,CAAP;AAFU,MACZ,CADY,GAIZ,CAAC,UAJL,CAIK,CAAD,CAJJ;;AAMA,SAAIkP,YAAJ,cAA8B;AAC5ByE,mBAAYA,iBAAiB,CAC3B,aAAazE,YAAb,cAD2B,CAC3B,CAD2B,EAE3B,iBAEEA,8BAA8BA,YAFhC,cAFFyE,CAEE,CAF2B,CAAjBA,CAAZA;AAQD;;AAED,SAAIC,OAAO,CACT,OACE,iBAAiB,aAAY;AAC3B,cAAO5T,QAAP;AAFJ,MACE,CADF,EAIE,aAAY;AACV,cAAOA,EAAP,CAAOA,CAAP;AANK,MACT,CADS,EAST,OACE,iBAAiB,aAAY;AAC3B,cAAOA,QAAP;AAFJ,MACE,CADF,EAIE,aAAY;AACV,cAAOA,EAAP,CAAOA,CAAP;AAdN,MASE,CATS,CAAX;;AAmBA,SAAI6T,iBAAiB,IAArB,CAAqB,CAArB;;AAEAF,iBAAY,cAAc,aAAY;AACpC,WAAItE,QAAQrP,EAAZ,CAAYA,CAAZ;AACA,WAAIZ,IAAI;AACN4C,oBADM;AAEN9C,kBAFM;AAGN4U,qBAAYD,wBAAwBD,KAAxBC,KAAwBD,CAAxBC,OAA0CzN,KAHhD;AAIN2N,mBAAU,CAACF,wBAAwB7T,EAAzB,CAAyBA,CAAzB,IAAiC4T,KAAjC,KAAiCA,CAAjC,OAAmDxN,KAJvD;AAKN4N,eAAMhU,EALA,CAKAA,CALA;AAMNiU,cAAK5E,QAAQ;AANP,QAAR;AAQAwE,gCAAyB7T,EAAzB6T,CAAyB7T,CAAzB6T;AACA;AAXFF,MAAY,CAAZA;;AAcA,SAAIO,aAAaC,gCAAjB;AACAjF,iCAA4BgF,aAA5BhF;AACA,SAAIkF,QAAQV,uCAAZ,SAAYA,CAAZ;AACAU;AACAA;;AAEAA,qEAEoC,aAAY;AAC5C,cAAOlF,2BAA2B,CAAClP,EAAnC;AAHJoU,sCAKiC,aAAY;AACzC,cAAOpU,EAAP;AANJoU,kBAQa,aAAY;AACrB,cAAO,CAACpU,QACJ/E,yBAAyBiZ,aAAzBjZ,eAAqDiZ,aADjDlU,CACJ/E,CADI+E,GAEJ/E,wCAFG,UAEHA,CAFG,EAAP,CAAO,CAAP;AATJmZ,sBAaiB,gBAAe;AAC5B,cAAOpU,QACHxB,2BAA2BwB,EADxBA,IACHxB,CADGwB,GAEHkP,0BACE,UAAUA,YAAV,UAAUA,CAAV,GADFA,MAEEmF,2BAA2BrU,EAJjC,IAIMqU,CAJN;AAdJD,iCAoB4B,gBAAe;AACvC,cAAOT,iCAAP;AArBJS,yBAuBoB,aAAY;AAC5B,WAAIlF,YAAJ,WAA2B;AAC3B;AAzBJkF;AA2BD;;AAED,gDAA6C;AAC3C;;AAEA,SAAIE,UAAJ,4BAA0C;AACxC,WAAIC,SAASrZ,WAEXsQ,2DAFF,MAAatQ,CAAb;;AAKA,cAAO;AACLqZ,iBADK;AAELjF,gBAAO,cAAc,aAAY;AAC/B,kBAAOvS,mCAELyO,2DAFF,CAEEA,CAFKzO,CAAP;AADK;AAFF,QAAP;AANF,YAcO;AACL,cAAO;AACLwX,iBAAQrZ,WAENsQ,4CAHG,SACGtQ,CADH;AAKLoU,gBAAO1T;AALF,QAAP;AAOD;AACF;;AAED4C,mCAAgC,kBAAiB;AAC/C,SAAIgW,WAAJ;;AAEA,wBAAmB,eAAc;AAC/BvZ,iBACUuD,qCADVvD,GACUuD,CADVvD,+CAIiB,gBAAe;AAC5B,aAAI+E,QAAJ,QAAoB;AAClBwU,sBAAWxU,EAAXwU,CAAWxU,CAAXwU;AACA;AACD;AACD;AATJvZ;AAWAA,iBACUuD,qCAAqCiW,MAD/CxZ,QACUuD,CADVvD,OAEQ,uBAFRA;AAZF;;AAiBA,iBAAY;AACV,WAAIyZ,eAAeC,4BAAnB,MAAmBA,CAAnB;;AAEA,WAAIC,eAAe3Z,0BAETyZ,aAFSzZ,QAETyZ,CAFSzZ,QAGVyZ,aAHT,OAGSA,CAHUzZ,CAAnB;AAIAuD;AACAA,oCAA6B,aAAY;AACvC,gBAAOoW,aACLpJ,yDACEhN,mCAFJ,MAEIA,CADFgN,CADKoJ,CAAP;AADFpW;AAOAA,0CACEgN,4CADFhN,WACEgN,CADFhN;AAfF,YAiBO;AACLA;AACAA,iCAA0B,YAAW;AACnC;AADFA;AAGAA;AACD;AACD;AACAA;AACAA;AACAvD;AA/CFuD;;AAkDAA,gCAA6B,YAAW;;AAEtC,SAAIqW,8BAAgC,SAAhCA,2BAAgC,aAAsB;AACtD,WAAI,kBAAJ,YAAkC;AAC9B,gBAAOC,WAAP,cAAOA,CAAP;AACH;AACD,WAAIA,sBAAJ,QAAkC;AAC9B;AACH;AACD,cAAO7Z,UAAP,MAAOA,CAAP;AAPJ;;AAWAuD;;AAEA,SAAIuW,SAAJ;;AAEA,SAAIvW,KAAJ,gBAAyB;AACvBA,qDAEqB,0BAFrBA,2DAKQA,KALRA;AAOAuW;AACD;;AAED,SAAIvW,KAAJ,aAAsB;AACpBA,qDAEqB,0BAFrBA,2DAKQA,iBALRA,SAKQA,CALRA;AAOAuW;;AAEA7Z,cAAOsD,iBAAPtD,OAAOsD,CAAPtD,EAAkC,sBAAqB;AACrDsD,yFAGqB,2BAHrBA;;AAOAI,oBACEJ,gFAGqB,0BAHrBA,yGADFI,IACEJ,CADFI;;AAaAmW;AArBF7Z;AAuBD;;AAED,SAAIsD,eAAJ,aAAIA,CAAJ,EAAmC;AACjC;AACA;;AAEAA,qDAEqB,0BAFrBA,2DAKQ,YAAYA,eALpBA,aAKoBA,CALpBA;AAOAuW;;AAEA,WAAIvW,eAAJ,YAAIA,CAAJ,EAAkC;AAChC,aAAIwW,gBAAgBH,4BAA6BrJ,oCAAoChN,eAArF,aAAqFA,CAApCgN,CAA7BqJ,CAApB;;AAEC,aAAII,QACHzJ,oCAAoChN,eAApCgN,aAAoChN,CAApCgN,EADD,OACCA,CADD;;AAKDtQ,gBAAOA,QAAPA,4BAAOA,CAAPA,EAA8C,iBAAgB;AAC5D,eAAIsI,IAAIyR,aAAR,KAAQA,CAAR;AACAzW,2FAGqB,2BAHrBA,yBAKQwW,cALRxW,CAKQwW,CALRxW;AAMAA,2FAGqB,0BAHrBA,4GASiBA,2BATjBA,CASiBA,CATjBA;;AAWAuW;AAnBF7Z;;AAsBAsD,yFAGqB,2BAHrBA;AAMAA,yFAGqB,0BAHrBA;;AAWAuW;AA/CF,cAgDO;AACL7Z,gBAAOsD,qCAAPtD,KAAOsD,CAAPtD,EAAoD,sBAGlD;AACAsD,2FAGqB,2BAHrBA;AAMAA,2FAGqB,0BAHrBA,4GASiBA,2BATjBA,GASiBA,CATjBA;;AAWAuW;AArBF7Z;AAuBD;AACF;;AAED,SAAIsD,iBAAJ,IAAIA,CAAJ,EAA4B;AAC1BA,qDAEqB,0BAFrBA,2DAKQ,YAAYA,iBALpBA,IAKoBA,CALpBA;AAOAuW;;AAEA,WAAIL,eAAeC,4BAA4BnW,iBAA/C,IAA+CA,CAA5BmW,CAAnB;AACA,WAAIC,eAAe3Z,0BAETyZ,aAFSzZ,QAETyZ,CAFSzZ,QAGVyZ,aAHT,OAGSA,CAHUzZ,CAAnB;;AAKAC,cAAOsD,uCAAPtD,KAAOsD,CAAPtD,EAAsD,sBAGpD;AACAsD,yFAGqB,2BAHrBA;;AAOAA,yFAGqB,0BAHrBA,mEAMa1D,YAAY8Z,aAAZ9Z,KAAY8Z,CAAZ9Z,OANb0D,GAMa1D,CANb0D;;AAUAuW;AArBF7Z;AAuBD;;AAED,SAAIsD,eAAJ,YAAIA,CAAJ,EAAkC;AAChCA,qDAEqB,0BAFrBA,2DAKQ,cAAcA,eALtBA,YAKsBA,CALtBA;AAOAuW;;AAEA,WAAIC,gBAAgBH,4BAA6BrJ,oCAAoChN,eAArF,YAAqFA,CAApCgN,CAA7BqJ,CAApB;;AAGA,WAAII,QACFzJ,oCAAoChN,eAApCgN,YAAoChN,CAApCgN,EADF,OACEA,CADF;;AAKAtQ,cAAOA,QAAPA,4BAAOA,CAAPA,EAA8C,iBAAgB;AAC5D,aAAIsI,IAAIyR,aAAR,KAAQA,CAAR;AACAzW,yFAGqB,2BAHrBA,yBAKQwW,cALRxW,CAKQwW,CALRxW;AAMAA,yFAGqB,0BAHrBA,sIAUoBA,0BAVpBA,CAUoBA,CAVpBA;;AAYAuW;AApBF7Z;;AAuBAsD,uFAGqB,2BAHrBA;AAMAA,uFAGqB,0BAHrBA;;AAYAuW;AACD;AA5PHvW;;AA+PA,sDAAmD;AACjD,iBAAY;AACV,WAAIyB,KAAKzB,yCAAyCA,KAAlD,WAAkDA,EAAlD;AACA,WAAI0W,WAAW1W,uEAAf,EAAeA,CAAf;AAIA,WAAI+P,SAAS,MAAMrP,QAAN,UAAwB,gBAAe;AAClD,aAAIN,QAAQJ,sCAAZ,MAAYA,CAAZ;AACA,gBAAOI,sCAAP;AAFW,eAGL,gBAAe;AACrB,gBAAO,SAAS,IAAhB,CAAO,CAAP;AAJF,QAAa,CAAb;AAMA,WAAIuW,SAAS,iBAAiB,aAAY;AACxC,gBAAOnV,IAAP;AADF,QAAa,CAAb;AAGA,WAAIoV,WAAW7G,gBAAgB4G,OAA/B;;AAEA,qBAAc;AACZD;AAIAA,gDAEkB,KAAKE,WAAW7G,OAAX6G,SAAL,MAFlBF;AAID;;AAEDha,sBAAe,wBAAuB;AACpCga,gDAII,KAAK,CAAC,YAAD,kBAA+B3G,OAApC,SAJJ2G,wBAMsB1W,2BANtB0W,KAMsB1W,CANtB0W;AADFha;AASA;;AAEA;AACD;AACD;AACD;;AAEDsD,mCAAgC,kBAAiB;AAC/C,SAAIgW,WAAJ;;AAEA,yBAAoB,eAAc;AAChCvZ,iBACUuD,qCADVvD,GACUuD,CADVvD,+CAIiB,gBAAe;AAC5B,aAAI+E,QAAJ,QAAoB;AAClBwU,sBAAWxU,EAAXwU,CAAWxU,CAAXwU;AACA;AACD;AACD;AATJvZ;AAWAA,iBACUuD,qCAAqCiW,MAD/CxZ,QACUuD,CADVvD,OAEQ,yBAFRA;AAZF;;AAiBAA,eACUuD,qCADVvD,gBACUuD,CADVvD,mBAEoBuZ,8BAFpBvZ;;AAMAuD;AACA,iBAAY;AACV,WAAIyW,QAAQzJ,4CAAZ,OAAYA,CAAZ;AACAhN,yCAAkCvD,yBAExB,IAAIU,+BAFoBV,CAExB,CAFwBA,QAGzB,OAHTuD,CAGS,CAHyBvD,CAAlCuD;AAIAA,mCAA4B,aAAY;AACtC,aAAIY,KAAJ,iBAA0B;AACxB;AACD;AACD,gBAAOZ,gCAAgCyW,MAAvC,CAAuCA,CAAhCzW,CAAP;AAJFA;AANF,YAYO;AACLA;AACAA;AACD;;AAEDA;AACAA;AACAvD;AA9CFuD;;AAiDAA,sCAAmC,kBAAiB;AAClD,SAAIgW,WAAJ;;AAEAa;AACA1H;;AAEAnP;;AAEAA,2BAAsB,uBAAsB;AAC1C,cAAO0Q,YAAP,mBAAOA,CAAP;AACA,cAAOA,YAAP,UAAOA,CAAP;AAFF1Q;;AAKA,MAAC,eAAD,KAAC,CAAD,EAAwB,mBAAxB,IAAwB,CAAxB,UAA0D,eAAc;AACtEvD,iBACUuD,qCAAqCiW,IAArCjW,CAAqCiW,CAArCjW,EAA6CiW,IADvDxZ,CACuDwZ,CAA7CjW,CADVvD,+CAIiB,gBAAe;AAC5B,aAAI+E,QAAJ,QAAoB;AAClBwU,sBAAWxU,EAAXwU,CAAWxU,CAAXwU;AACA;AACD;AACD;AATJvZ;AAWAA,iBACUuD,qCAAqCiW,SAArCjW,UAAwDiW,IADlExZ,CACkEwZ,CAAxDjW,CADVvD,OAEQ,uBAFRA;AAZF;;AAiBAA,eACUuD,qCADVvD,mBACUuD,CADVvD,mBAEoBuZ,8BAFpBvZ;;AAMA,iBAAY;AACV;;AAEAuD,oCAA6B,OAC3BvD,wBAES,yFAFTA,SAES,CAFTA,SAaUC,QAdiB,4BAcjBA,CAbVD,CAD2B,EAe3B,qBAAoB;AAClB,gBAAOqa,KACL9J,qDADF,GACEA,CADK8J,CAAP;AAnBM,QAGmB,CAA7B9W,CAHU,CAuBP;;AAEH;;AAEAA;AACAA;AACAA,6BAAsB,uBAAsB;AAC1C0Q,mCAA0BC,sCAA1BD,MAA0BC,CAA1BD;AADF1Q;;AAIA,WAAI+W,SAAJ;;AAEAra,cAAOsD,KAAPtD,OAAmB,aAAY;AAC7B,aAAIsa,MAAMhX,gCACNA,WAAWV,EADLU,MACNA,CADMA,UAAV,IAAUA,CAAV;AAAA,aAKEiX,MAAMjX,gCACJA,WAAWV,EADPU,MACJA,CADIA,UALR,IAKQA,CALR;;AAWA,aAAIgX,0BAA0BC,OAA9B,iBAAsD;AACpDF,uBAAY;AACV/R,gBADU;AAEVC,gBAFU;AAGVS,oBACE1F,WAAWV,EAAXU,oCAIAA,WAAWV,EAAXU,QAJAA,kBAOA;AAXQ,YAAZ+W;AAaD;AA1BHra;AA4BAD,iBAEIuD,gEAFJvD,IAEIuD,CAFJvD;;AAMAE,iDAIEqD,uDAJFrD,IAIEqD,CAJFrD,EAKE;AACEqI,YADF;AAEEC,YAAG;AAFL,QALFtI,EASEqQ,uDATFrQ;AArEF,YAgFO;AACLqD;AACAA;AACAA;AACAA;AACAA;AACD;;AAEDA;AACAA;AACAvD;AA9HFuD;;AAiIAA,uCAAoC,kBAAiB;AACnD,SAAIgW,WAAJ;AACAvZ,eACUuD,qCADVvD,mBACUuD,CADVvD;;AAIAuD;;AAEA,MAAC,eAAD,KAAC,CAAD,EAAwB,mBAAxB,IAAwB,CAAxB,UAA0D,eAAc;AACtEvD,iBACUuD,qCAAqCiW,IAArCjW,CAAqCiW,CAArCjW,EAA6CiW,IADvDxZ,CACuDwZ,CAA7CjW,CADVvD,+CAIiB,gBAAe;AAC5B,aAAI+E,QAAJ,QAAoB;AAClBwU,sBAAWxU,EAAXwU,CAAWxU,CAAXwU;AACA;AACD;AACD;AATJvZ;AAWAA,iBACUuD,qCAAqCiW,SAArCjW,UAAwDiW,IADlExZ,CACkEwZ,CAAxDjW,CADVvD,OAEQ,uBAFRA;AAZF;;AAiBAuD,2BAAsB,uBAAsB;AAC1C,cAAO0Q,YAAP,UAAOA,CAAP;AACAA,0CAAmCwG,SACjCC,4CADFzG,MACEyG,CADiCD,CAAnCxG;AAFF1Q;;AAOAA;;AAEA,iBAAY;AACV,WAAI8V,UAAJ,4BAA0C;AACxC,aAAIC,SAAJ;AAAA,aACEjF,QADF;AAEApU,gBAAOsB,2BAAPtB,MAAOsB,CAAPtB,EAA2C,sBAAqB;AAC9DqZ;AACAjF;AAFFpU;AAIAsD,sCAA6BvD,wCAA7BuD,KAA6BvD,CAA7BuD;AAPF,cAWO;AACL,aAAIgN,4CAAJ,aAAIA,CAAJ,EAAgE;AAC9DhN,wCAA6BgN,2DAEZA,oCAFYA,MAEZA,CAFYA,EAA7BhN,IAA6BgN,CAA7BhN;AADF,gBAIO;AACLA,wCAA6BvD,yBAA7BuD,mBAA6BvD,CAA7BuD;AAGA,eAAIoX,iBAAiB1a,QAAQsD,2BAA7B,KAA6BA,EAARtD,CAArB;AACA0a;;AAEApX,6CACEtD,QAAQoB,6BADVkC,CACEtD,CADFsD;AAGAA;;AAEA,eAAIgN,4CAAJ,kBAAIA,CAAJ,EAAqE;AACnEhN,0CAA6B,OAC3BA,eAD2B,UAC3BA,CAD2B,EAE3B,qBAAoB;AAClB,mBAAIqX,OAAJ,iBAA4B;AAC1B,wBAAOP,KAAP,0BAAOA,CAAP;AACD;AACD,sBAAOA,KACL9J,gEADF,GACEA,CADK8J,CAAP;AANJ9W,cAA6B,CAA7BA;AAaA;AACD;AACF;AACF;AACDA;AACAA,wCACEgN,4CADFhN,WACEgN,CADFhN;;AAGA;AACA;;AAEA;AACA;AACAA,6CAAsCsX,wCAEpCtK,4CAFoCsK,WAGpCtX,eAHFA,cAGEA,CAHoCsX,CAAtCtX;AAKA;AACA;AACA;;AAEA6W,8CAEE7W,eAFF6W,cAEE7W,CAFF6W,EAGE7W,eAHF6W,mBAGE7W,CAHF6W;AAKA1H,8CAEEnP,eAFFmP,cAEEnP,CAFFmP,EAGEnP,eAHFmP,mBAGEnP,CAHFmP;AAtEF,YA2EO;AACLnP;AACAA;AACAA;AACAA;AACA6W;AACA1H;AACD;AACD,SAAInP,KAAJ,sBAA+B;AAC7BA;AACD;;AAEDA;AACAA;AACAvD;AA3HFuD;;AA8HAA,4BAAyB,YAAW;AAClCA,2BAAsB,aAAY;AAChCM,qBAAcN,wBAAwB,CAACM,EAAvCA;AADFN;AAGAA,wBAAmB,aAAY;AAC7Bb,qBAAca,wBAAwB,CAACb,EAAvCA;AADFa;AAJFA;;AASAA,iBAAc,mCAAkC;AAC9C,SAAIuX,mBAAJ;;AAEAC,kBAAa,MAAM,OAAN,UAAM,CAAN,EAA0B,eAAc;AACnD,cAAO,MACL,qBAAqB,aAAY;AAC/B,gBAAO5W,UAAP;AAFG,QACL,CADK,EAIL,aAAY;AACV,gBAAOA,EAAP;AALJ,QAAO,CAAP;AADF4W,MAAa,CAAbA;;AAWA,SAAIA,cAAJ,QAA0B;AACxBxX,0BAAmB,aAAY;AAC7Bb;AADFa;;AAIAtD,cAAOsD,KAAPtD,OAAmB,aAAY;AAC7B,aAAI+a,YAAY,OAAOD,WAAP,CAAOA,CAAP,EAAsB,aAAY;AAChD,kBAAOlY,YAAP;AADF,UAAgB,CAAhB;;AAIA,wBAAe;AACbU,sBAAWV,EAAXU;AACAA,sBAAWV,EAAXU;AACD;AARHtD;AALF,YAeO;AACLsD,0BAAmB,aAAY;AAC7Bb;AADFa;AAGD;;AAEDA,2BAAsB,aAAY;AAChCM;AADFN;;AAIAA,wBAAmB,aAAY;AAC7B,WAAIyX,YAAY,OAAOD,WAAP,CAAOA,CAAP,EAAsB,kBAAiB;AACrD,gBACEE,YAAYvY,EAAZuY,OACA,OAAOvY,EAAP,uBAAOA,CAAP,EAAmC,gBAAe;AAChD,kBAAOuY,YAAP,IAAOA,CAAP;AAHJ,UAEE,CAFF;AADF,QAAgB,CAAhB;;AASAD,mBAAYA,aAAatY,EAAzBsY;;AAEA,WAAIA,aAAatY,EAAjB,cAAiC;AAC/BA;AACAoY;AACD;;AAED,WAAIpY,EAAJ,cAAoB;AAClBA;AACD;AAnBHa;;AAsBA,SAAIuX,oBAAoBvX,KAAxB,sBAAmD;AAC/CA,iCAA2B,aAAa;AAAC,gBAAOb,EAAP;AAAzCa;AACH;;AAED,SAAIuX,oBAAoB,CAAxB,aAAsC;AACpC,WAAIvX,KAAJ,iBAA0B;AACxBA;AACD;;AAEDA;AACD;AAvEHA;;AA0EAA,mBAAgB,YAAW;AACzB,YAAOA,6BAAP;AADFA;;AAIAA,0BAAuB,mCAAkC;AACvD,8BAAyB;AACvB,WAAImR,eAAJ,QAA2B;AACzB,aAAIwG,cAAclb,UAAlB,mBAAkBA,CAAlB;AACAkb;AACA,sBAAa;AACXA;AADF,gBAEO;AACLA;AACD;AACDA;AACAxG;AATF,cAUO;AACL1U;AACD;AACF;AAfHuD;;AAkBAA,kCAA+B,aAAY;AACzC,SAAI4X,OAAOpW,UAAX;AACA;;AAEA,SAAIoW,QAAJ,KAAiB;AACf,WAAIC,SAASrW,aAAaA,SAA1B;AACA,WAAIsW,SAAStW,aAAaA,SAA1B;AACA,WAAIoW,OAAOA,OAAOhQ,UAAUiQ,kBAAkBC,SAA9C,MAAkBlQ,CAAlB;;AAEA,WAAImQ,QAAQnQ,UALG,CAKf,CALe,CAKU;;AAEzB,WAAIoQ,QAAQH,SAASjQ,UAAU,UAAnBiQ,MAASjQ,CAATiQ,GAAuCjQ,UAPpC,CAOf,CAPe,CAOiD;;AAEhE,WAAIgQ,OAAJ,GAAc;AACZG,iBAAQ,CAARA;AACAH,gBAAO,CAAPA;AACD;;AAED,WAAIK,KAAKrQ,SAASmQ,QAATnQ,SAAT;AAAA,WACEsQ,MAAMtQ,SAASmQ,QAATnQ,SADR;;AAGA,WAAIuQ,KAAKvQ,SAASmQ,QAATnQ,SAAT;AAAA,WACEwQ,MAAMxQ,SAASmQ,QAATnQ,SADR;;AAGA;AACA,WAAIpG,cAAcA,SAAlB,GAA8B;AAC5B6W,cAAK,KAAK,CAAVA,EAAK,CAALA;AACAC,cAAK,CAAC,CAAD,KAAO,CAAZA,GAAK,CAALA;AAFF,cAGO;AACLD,cAAK,CAAC,CAAD,KAAO,CAAZA,GAAK,CAALA;AACAC,cAAK,KAAK,CAAVA,EAAK,CAALA;AACD;;AAEDpU,cACE,MACA1C,SADA,UAGAA,SAHA,aAKCA,aAAa6W,GALd,CAKcA,CALd,WAOC7W,aAAa6W,GAPd,CAOcA,CAPd,YASC7W,aAAa8W,GATd,CAScA,CATd,WAWC9W,aAAa8W,GAXd,CAWcA,CAXd,WAaA9W,SAbA,UAeAA,SAhBF0C;AA7BF,YA8CO;AACLA,cACE,MACA1C,SADA,UAGAA,SAHA,YAKAA,SALA,UAOAA,SARF0C;AASD;;AAEDzH;AA9DFuD;;AAiEAA,iBAAc,0BAAyB;AACrCA;;AAEA,SAAIC,WAAWA,QAAf,gBAAeA,CAAf,EAA2C;AACvCA;AACH;;AAED,mBAAc;AACZuL;AACD;AACDxL;;AAEA;;AAEA,SAAI,CAAJ,MAAW;AACT,WAAIuY,UAAJ;;AAEA/M,4BAAqB+M,QAArB/M,WAAwC+M,QAAxC/M;AACAgN,6BAAsBD,cAAtBC,QAA4CD,cAA5CC;;AAEA,WAAIC,WAAJ;;AAEA/b,cAAO6b,QAAP7b,OAAsB,aAAY;AAChC8E;AACA,aAAIkX,MAAJ;;AAEA,aAAIlX,WAAWA,EAAf,QAAyB;AACvBkX,iBAAM,KAAKlX,EAAL,eAAsBA,EAA5BkX;AADF,gBAEO;AACLA,iBAAM,KAAKlX,EAAL,eAAsBA,EAA5BkX;AACD;AACD,aAAIA,OAAJ,UAAqB;AACnBD;AADF,gBAEO;AACLA,2BAAgB,CAAhBA,CAAgB,CAAhBA;AACD;AAbH/b;;AAgBAA,wBAAiB,aAAY;AAC3B,aAAIkE,WAAJ,GAAkB;AAChB,eAAI+X,OAAO,KAAK/X,WAAhB,CAAW,CAAX;AACAlE,qBAAU,uBAAsB;AAC9BsN,yBAAY,OAAO6G,QAAnB7G;AADFtN;AAGD;AANHA;;AASAkc,cAAO,yCAECL,QAFD,OAEgB,aAAY;AAC/B,gBAAO/W,EAAP;AAHJoX,QAAO,CAAPA;;AAMA;AACAA;AACAA;;AAEAA,+BACsB,aAAY;AAC9B,gBAAOpX,EAAP;AAFJoX,iCAI0B,aAAY;AAClC,gBAAO,kBAAkBpX,eAAzB;AALJoX,+BAOwB,aAAY;AAChC;AACA,gBAAOpX,eAAexB,KAAtB;AACA;AAVJ4Y;;AAaAA,6EAGU,aAAY;AAClB,gBAAOpX,EAAP;AAJJoX,6BAMsB,UAAU5Y,KAAV,aANtB4Y;;AAQAC,wBAAiB,yCAETN,QAFS,OAEM,aAAY;AAC/B,gBAAO/W,EAAP;AAHJqX,QAAiB,CAAjBA;;AAMAA;AACAA;;AAEAC,2BAAoB,kDAGhB,qBAAqB,aAAY;AAC/B;AAJc,QAGhB,CAHgB,EAMhB,aAAY;AACV,gBAAOtX,EAAP;AAPNsX,QAAoB,CAApBA;;AAWAA;AACAA,8FAIqB,aAAY;AAC7B,gBAAO,eAAetX,EAAf,UAA2BA,EAA3B,IAAP;AALJsX,iHAUQtN,sCAVRsN,eAUQtN,CAVRsN;;AAYA9Y,+BACEA,KADFA,6BAEEA,KAFFA;;AAKA,WAAIA,iBAAiB,EAAEC,WAAWA,QAA9BD,gBAA8BC,CAAb,CAAjBD,IAA4D,EAAEC,WAAWA,QAA7E,uBAA6EA,CAAb,CAAhE,EAAgH;;AAE9GD;;AAEA,aAAI;AACAgN,iEACIhN,kCAAkCA,mCAAoCgN,oCAApChN,cAAoCgN,CAApChN,EADtCgN,cACsChN,CAAlCA,CADJgN;AADJ,WAGE,YAAY;AACVzN;AACH;AACF;;AAED,WAAIS,iBAAiB,EAAEC,WAAWA,QAA9BD,gBAA8BC,CAAb,CAAjBD,IAA6DC,OAA7DD,IAAwEC,QAA5E,uBAA4EA,CAA5E,EAA+G;;AAE7G;AACA;AACA;AACA;AACA;AACA;AACA;;AAEAvD,gBAAOsD,KAAPtD,UAAsB,wCAAuC;AAC3D;AACA;AACA,eAAI4N,cAAc5N,UAAU6N,cAAV7N,UAAkCyC;AAAAA,oBAAKA,EAAzD,aAAoDA;AAAAA,YAAlCzC,CAAlB;AACA4N,yBAAc,SAAS,sBAAsB,gBAAS;AAAE,oBAAO4G,KAAP;AAAxD5G,YAAuB,CAAT,CAAdA;;AAEA;AACA5N,+BAAoB,gBAAe;AACjC4D;AADF5D;;AAIA4N,4BAAiB,kBAAiB;AAChC,oBAAOxB,mBAAmB4B,GAAnB5B,CAAmB4B,CAAnB5B,EAA0B6B,GAAjC,CAAiCA,CAA1B7B,CAAP;AADFwB;;AAIAA,yBAAc,mBAAmB,gBAAe;;AAE9C,iBAAIyO,oBAAoBzY,KAAxB;AACA,iBAAI0Y,gBAAgB1Y,KAApB;AACA,iBAAI+B,QAAQ/B,KAAZ;;AAEA,iBAAIlB,QAAJ;;AAEA,iBAAI6Z,YAAY,SACdna,qCACEyL,cADFzL,OAEEyL,cAFFzL,aADc,KACdA,CADc,EAOd,cAAa;AACX,sBAAO0L,YAAP;AARJ,cAAgB,CAAhB;;AAYApL,qBAAQ,gBAAgB,cAAa;AACnC,sBAAOqL,YAAP;AADFrL,cAAQ,CAARA;;AAIA,iBAAI8Z,QAAQlZ,sDAAZ,aAAYA,CAAZ;;AAEA,oBAAO;AACLyH,yBAAU/K,QADL,CACKA,CADL;AAELkO,+BAFK;AAGLlD,2BAHK;AAILyR,2BAJK;AAKLC,6BAAeF,MALV;AAMLG,+BAAgBH,MANX;AAOLrO,0BAAW,wBACT,MAAMzL,MAAN,CAAMA,CAAN,EAAgB,aAAY;AAC1B,wBAAOE,EAAP;AAFO,gBACT,CADS;AAPN,cAAP;AA1BFgL,YAAc,CAAdA;;AAyCA5N,+BAAoB,aAAY;AAC9BoO;AADFpO;;AAIA6N,uCAA4BD,eAA5BC;;AAEA;AACA,eAAI2O,QAAQlZ,mCAAmCuK,cAA/C,UAAYvK,CAAZ;AACAuK,wCAA6B7N,MAAMA,SAANA,KAAMA,CAANA,EAAuB8E;AAAAA,oBAAKA,qBAAzD+I,CAAoD/I;AAAAA,YAAvB9E,CAA7B6N;AACAA,0CAA+B7N,MAAMA,SAANA,KAAMA,CAANA,EAAuB8E;AAAAA,oBAAKA,uBAA3D+I,CAAsD/I;AAAAA,YAAvB9E,CAA/B6N;AAjEF7N;AAoED;;AAED,WAAIsD,KAAJ,kBAA2B;AACzBA,iCACEA,KADFA,gCAEEA,KAFFA,kBAGE;AACE,0BADF;AAEE,0BAFF;AAGE,sBAAY,2BAAmB;AAC3B4T;AACAA;AACAA;AACH;AAPH,UAHF5T;AAcD;AACD,WAAIA,KAAJ,UAAmB;AACjBA;AADF,cAEO;AACLA,8BAAqBA,KAArBA;AACD;AAtNH,YAuNO;AACL6Y,wBAAiB7Y,2BAAjB6Y,OAAiB7Y,CAAjB6Y;AACAC,2BAAoB9Y,2BAApB8Y,gBAAoB9Y,CAApB8Y;AACAF,cAAO5Y,2BAAP4Y,OAAO5Y,CAAP4Y;AACAJ,6BAAsBK,eAAtBL,IAAsBK,EAAtBL,EAA6CI,KAA7CJ,IAA6CI,EAA7CJ;AACD;;AAEDK,yBAAoB,aAAY;AAC9BS;AADFT;;AAIAC,4BAAuB,aAAY;AACjCS;AADFT;;AAIAF,2BAAsB,aAAY;AAChC,cAAOhR,SAASqN,aAAazT,EAAtBoG,MAASqN,CAATrN,EAAiCqN,aAAazT,EAArD,MAAwCyT,CAAjCrN,CAAP;AADFgR;;AAIA,SAAI5Y,KAAJ,wBAAiC;AAC/B4Y,iBAAU,aAAY;AACpB5Y;AADF4Y;AAGD;;AAEDA,2BAAsB,aAAY;AAChC,WAAIpX,sBAAsBA,SAAtBA,aAA4CA,EAAhD,WAA6D;AAC3D;AACD;AACD;AAJFoX;;AAQA,SAAI,CAAJ,MAAW;AACTY,qCACEV,8BAA8BD,kBADhCW;;AAGAhO,iCAA0B,YAAW;AACnC,aAAIiO,QAAQjO,eAAZ,IAAYA,EAAZ;;AAEAqN,0CAAiC,aAAY;;AAE3C;AACA,eAAIa,cAAJ;AACA,eAAIC,cAAcF,WAAlB;AACA,eAAIG,cAAJ;AACA,eAAIC,cAAcJ,WAAlB;;AAEA,eAAIzZ,KAAJ,gBAAyB;AACvB,iBAAM8Z,wCAAN;AACA;AACA,iBAAIC,eAAe/Z,uBAAnB,CAAmBA,CAAnB;;AAEA,iBAAI+Z,gBAAgB/Z,KAApB,sBAA+C;AAC7C,mBAAIga,SAASha,wCAAb;;AAEA0Z,6BAAcM,YAAdN;AACAC,6BAAcK,YAAdL;AACAC,6BAAcI,YAAdJ;AACAC,6BAAcG,YAAdH;AACD;AACF;;AAED,kBACE,gBACCrY,MAAMoG,sBAELA,sBAAsBpG,EAHxB,CAGEoG,CAFKA,CADP,WAMCpG,MAAMoG,sBAELA,sBAAsBpG,EARxB,CAQEoG,CAFKA,CANP,IADF;AAvBFiR;AAqCAC,6CAAoC,aAAY;AAC9C,kBACE,gBACCtX,MAAMoG,SACLpG,EADKoG,eAELA,SAAS6R,WAAWjY,EAApBoG,eAAqCpG,EAHvC,CAGEoG,CAFKA,CADP,WAMCpG,MAAMoG,SACLpG,EADKoG,eAELA,SAAS6R,WAAWjY,EAApBoG,eAAqCpG,EARvC,CAQEoG,CAFKA,CANP,IADF;AADFkR;;AAgBAF,mBAAU5Y,KAAV4Y;AAxDFpN;;AA2DAA;AA/DF,YAgEO;AACLoN,iBAAU5Y,KAAV4Y;AACD;AAxUH5Y;;AA2UA,mBAAgB;AACd,SAAIyZ,QAAQjO,eAAZ,IAAYA,EAAZ;;AAEA/L,qBACc,aAAY;AACtB,cAAQ+B,MAAMoG,aAAaA,SAAS6R,WAAT7R,IAAwBpG,EAAnD,CAA2BoG,CAAbA,CAAd;AAFJnI,mBAIc,aAAY;AACtB,cAAQ+B,MAAMoG,aAAaA,SAAS6R,WAAT7R,IAAwBpG,EAAnD,CAA2BoG,CAAbA,CAAd;AALJnI;;AAQAmZ,qBACc,aAAY;AACtB,cAAOpX,SAAP;AAFJoX,mBAIc,aAAY;AACtB,cAAOpX,SAAP;AALJoX,mBAOc,aAAY;AACtB,cAAOpX,SAAP;AARJoX,mBAUc,aAAY;AACtB,cAAOpX,SAAP;AAXJoX;AAaD;;AAED;AACA,+CAA4C;AAC1C,UAAK,IAAL,YAAqB;AACnBvZ;AACD;;AAED,UAAK,IAAL,YAAqB;AACnBA,aAAMD,SAANC;AACAA,aAAMD,SAANC;AACD;AACF;;AAEDW,qCAAkC,yBAAwB;AACxD,SAAI;;AAEF,WAAIlD,gCAAJ,IAAwC;;AAEtC,aAAI2E,MAAMD,EAAV,uBAAUA,CAAV,EAAsC;AACpC;;AAEA,eAAIxB,uCAAJ,UAAqD;AACnDY,iBAAIZ,8CAAJY,IAAIZ,CAAJY;AADF,kBAEO;AACLA,iBAAIY,2BAAJZ,EAAIY,CAAJZ;AACD;;AAED,eAAIlE,WAAJ,CAAIA,CAAJ,EAAmB;AACjB,iBAAIkE,YAAJ,GAAmB;AACjB;AADF,oBAEO;AACL,2BAAY;AACVA,qBAAI,CAAJA;AACA,wBAAOlE,+BAAP;AACD;AACF;AACF;AACD;AACD;AACF;AAzBH,OA0BE,UAAU;AACV6C;AACD;AACD;AA9BFS;;AAiCA,4DAAyD;AACvD;AACA,SAAIlD,gCAAJ,IAAwC;AACtC0E;AACD;AACF;;AAEDxB,uCAAoC,kBAAiB;AACnD,SAAInD,2BAA2BmD,KAA/B,MAA0C;AACxC,WAAIia,WAAJ;AACAA;AACAvd,gBAASsD,UAATtD,uBAASsD,CAATtD;AACA;AACD;AANHsD;AAQA,yBAAsB;AACpB,SAAIA,KAAJ,gBAAyB;AACvB;AACD;AACD,SAAIka,IAAI,IAAItS,UAAUpG,EAJF,MAIRoG,CAAZ,CAJoB,CAIa;AACjC,YAAO,QAAP;AACD;;AAED,0BAAuB;AACrB;;;;AAIA,SAAI5H,eAAJ,aAAIA,CAAJ,EAAmC;AACjC,WAAIY,IAAIZ,mCAAmCA,eAA3C,aAA2CA,CAAnCA,CAAR;AACA,WAAIA,eAAJ,YAAIA,CAAJ,EAAkC;AAChC,aAAIY,KAAJ,iBAA0B;AACxB;AACD;AACD;AACD;AACD,cAAOZ,2BAAP,CAAOA,CAAP;AACD;AACD,YAAOwB,0BAA0BA,oBAAjC;AACD;;AAED,4BAAyB;AACvB,SAAIxB,eAAJ,SAAIA,CAAJ,EAA+B;AAC7B,cAAOA,0BACLA,mCAAmCA,eAAnCA,YAAmCA,CAAnCA,EADF,IACEA,CADKA,CAAP;AAGD;AACD;AACD;;AAED,mCAAgC;AAC9B,SAAIwB,EAAJ,mBAAIA,CAAJ,EAA4B;AAC1B,cAAOxB,2BAAP,IAAOA,CAAP;AACD;AACD;AACD;;AAED,+BAA4B;AAC1B;AACD;;AAED,gCAA6B;AAC3B;;AAEA,SAAI,CAACA,KAAL,UAAoB;AAClBc,aACE,gBACA3B,EADA,mDAGA7C,kBAAkB6C,EAAlB7C,KAHA,mBAGAA,CAHA,GADFwE;AADF,YAOO;AACLA,aAAM,iBAAiB3B,EAAjB,SAAN2B;AACD;;AAEDpE,YACEA,QAAQsD,KAARtD,6BAA0C,CACxCsD,eADwC,aACxCA,CADwC,EAExCA,iBAFwC,IAExCA,CAFwC,EAGxCA,eAJJtD,YAIIsD,CAHwC,CAA1CtD,CADFA,EAME,eAAc;AACZ,gBAAS;AACP,aAAIyd,OAAOnN,WAAX,uBAAWA,CAAX,EAAgD;AAC9C,eAAIoN,YAAYpa,mCAAhB,GAAgBA,CAAhB;;AAEA,eAAIgN,oDAAJ,QAAgE;AAC9D,iBAAI;AACFoN,2BAAY5c,uBAAZ4c,SAAY5c,CAAZ4c;AADF,eAEE,YAAY,CAAE;AACjB;AACD,0BAAe;AACbtZ,oBAAO,qCAAPA;AACD;AACF;AACF;AApBLpE;;AAwBA;AACD;;AAED,gCAA6B;AAC3B,SAAIoE,MAAM,gBAAgBzD,oBAAoB8B,EAApC,MAAgB9B,CAAhB,GAAV;AACA,SAAI,aAAJ,GAAoB;AAClByD,cACE,+CACAzD,oBAAoB8B,EADpB,OACA9B,CADA,GADFyD;AAID;;AAED,SAAIsZ,YAAYpa,mCAEdA,eAFF,aAEEA,CAFcA,CAAhB;;AAKA;AACD;;AAED,2BAAwB;AACtBqa,gCAGE,CAACra,gCAAD,WAA4CwB,EAH9C6Y,IAIEC,iBAJFD,CAIEC,CAJFD,EAKEra,KALFqa;AAOD;;AAED,4BAAyB;AACvBA;AACD;;AAED,2BAAwB;AACtBA,gCAGE/a,sBAAsBA,SAHxB+a,IAIEE,iBAJFF,CAIEE,CAJFF,EAKEra,KALFqa;AAOD;;AAED,4BAAyB;AACvBA;AACD;;AAED;;AAEA;;;;AAIA,oCAAiC;AAC/B,SAAIG,aAAa9d,iBAAjB,SAAiBA,CAAjB;AACA;AACD;;AAED,gDAA6C;AAC3C,UAAK,IAAL,eAAwB;AACtB,WAAI+d,MAAM1b,SAAV,CAAUA,CAAV;AACA0b;AACAA;AACA,WAAI/d,WAAJ,UAAIA,CAAJ,EAA4B;AAC1B+d,8BAAqB,aAAY;AAC/BA,oBAASzV,EAATyV;AACAA,oBAASzV,EAATyV;AAFFA;AAIAA,kBAASA,aAATA;AACAA,kBAASA,aAATA;AACD;AACF;AACF;;AAED,2CAAwC;AACtCza;AACAgF;AACAwU,oCAA+BxZ,mBAAmBgF,eAAnBhF,KAA/BwZ;AACA,SAAI,CAAJ,WAAgB;AACd,WAAIkB,MAAMC,2BAA2B3V,EAArC,UAAU2V,CAAV;AACA,WAAID,OAAJ,GAAc;AACZC;AACD;AACF;AACDC,+BAA0B,CAA1BA,CAA0B,CAA1BA;AACA,YAAO5V,WAAP;AACD;;AAED,0CAAuC;AACrChF;AACAgF;AACAwU,oCAA+BxZ,mBAAmBgF,eAAnBhF,KAA/BwZ;AACAmB,6BAAwB3V,EAAxB2V;;AAEA,qBAAgB;AACd3V,0BAAmB,aAAY;AAC7B7F,eAAM6F,MAAM,CAAC4C,gBAAD,OAAwB5C,WAApC7F;AACAA,eAAM6F,MAAM,CAAC4C,gBAAD,OAAwB5C,WAApC7F;AAFF6F;AADF,YAKO;AACLA,0BAAmB,aAAY;AAC7B7F,eAAMa,oBAAoB,CAAC4H,gBAAD,OAAwB5C,WAAlD7F;AACAA,eAAM,OAAOa,KAAP,SAAqB,CAAC4H,gBAAD,OAAwB5C,WAAnD7F;AAFF6F;AAID;AACF;;AAED,qDAAkD;AAChD,SAAI6V,YAAYpe,UAAUuD,yCAA1B,IAA0BA,CAAVvD,CAAhB;AACA,SAAIoe,UAAJ,KAAIA,EAAJ,EAAuB;AACrB;AACD;;AAEDA;AACAA;;AAEApe,eACUuD,qCAAqCyB,KAArCzB,aADVvD,IACUuD,CADVvD,mBAEoBqe,gBAFpBre;;AAIA,iBAAY;AACV,WAAIse,OAAO/a,eAAX,UAAWA,CAAX;AACA,WAAIgb,SAASC,cAAb,QAAaA,CAAb;;AAEA,WAAIrH,UAAU,4DACZ,YACE,cAAc,gBAAe;AAC3B,gBAAOoH,OAAP,CAAOA,CAAP;AAHN,QAEI,CADF,CADY,CAAd;;AAQApH;AACAA,oBACQ,aAAY;AAChB,gBAAO,qBAAP;AAFJA,eAIQ,gBAAe;AACnB,gBAAO;AACLnX,oGAIkB,YAAW;AACzB,oBAAOse,KAAP,CAAOA,CAAP;AALJte;AAOD;AAbLmX;;AAgBA,WAAI5T,KAAJ,gCAAyC;AACvC,aAAIkb,MAAM,cAAc,eAAc;AACpC,kBAAO,cAEL,gBAAe;AACb,oBAAOjL,IAAP;AAHG,cAAP,CAAO,CAAP;AADF,UAAU,CAAV;;AAUA6K,kBAAS,cAAc,0BAAyB;AAC9C,kBAAO,WAAW,aAAY;AAC5B,oBAAOxa,IAAI4a,IAAX,SAAWA,CAAX;AADF,YAAO,CAAP;AADFJ,UAAS,CAATA;AAKD;;AAED,WAAIjH,OAAO,+CACT,WAAW,gBAAe;AACxB,gBAAO,CAACmH,OAAD,CAACA,CAAD,SAAP,CAAO,CAAP;AAFJ,QACE,CADS,CAAX;;AAMAnH;AACAA,iCAEQ,aAAY;AAChB;AAHJA,oCAOQ,gBAAe;AACnB,gBAAO9N,SACH,qBADGA,YAEH/F,sCACE1C,sBADF0C,CACE1C,CADF0C,GAFJ;AARJ6T,eAcQ,gBAAe;AACnB,aAAI9N,KAAJ,GAAY;AACVtJ,oGAIkB,YAAW;AACzB,oBAAOse,KAAP,CAAOA,CAAP;AALJte;AAOD;AAvBLoX;AAyBD;AACF;;AAED,sDAAmD;AACjD,SAAIrQ,YAAY/G,UAAUuD,yCAA1B,IAA0BA,CAAVvD,CAAhB;;AAEA,SAAI+G,UAAJ,KAAIA,EAAJ,EAAuB;AACrB;AACD;;AAEDA;;AAEA/G,eACUuD,qCAAqCyB,KAArCzB,aADVvD,IACUuD,CADVvD,mBAEoBqe,gBAFpBre;;AAIA,iBAAY;;AAwEV;AAxEU,WAyEV,IAzEU,GAyEV,0BAA0B;AACxB,gBAAO,gBAAe;AACpB0e,2BAAgBC,IAAIJ,OAAJI,CAAIJ,CAAJI,GAAhBD;AACAE,+CAEU,aAAY;AAClB,oBAAO7Z,uBAAuBA,kBAA9B;AAHJ6Z;AAFF;AAUD,QApFS;;AACV,WAAIL,SAASC,cAAb,QAAaA,CAAb;;AAEA,WAAII,MAAM7X,iBAAV,KAAUA,CAAV;;AAEA,WAAI8X,QAAQ7e,8CAGKA,GAHLA,mBAAZ,MAAYA,CAAZ;;AAMA,WAAI8e,cAAJ;AAAA,WACE7W,QADF;AAAA,WAEEC,SAFF;AAAA,WAGE6W,cAAc5T,gBAAgBjD,SAAhBiD,eAHhB;AAAA,WAIE6T,cAAcD,cAJhB;;AAMA,WAAIT,OAAO/a,eAAX,UAAWA,CAAX;AAAA,WACEwE,YADF;;AAGA,WAAI2W,aAAaE,kCAIb,eAAe3W,QAAf,WAAkCC,SAAlC,eAJa0W,oFAAjB,EAAiBA,CAAjB;;AAWAA,aAAMA,wCAEY1W,SAFZ0W,2CAMF,eAAe3W,QAAf,UAAiC,CAACC,SAAD,eAAjC,IANJ0W,GAAMA,CAANA;;AASAA,8CAGQC,MAHRD,6CAMiB,aAAY;AACzB,gBAAON,KAAKC,OAAOxZ,EAAnB,KAAYwZ,CAALD,CAAP;AAPJM,0BASmB,aAAY;AAC3B,gBAAON,KAAKC,OAAOxZ,EAAnB,KAAYwZ,CAALD,CAAP;AAVJM,oBAcI5e,kDAdJ4e,WAcI5e,CAdJ4e,kBAgBmBK,UAhBnBL,IAgBmBK,CAhBnBL,iBAiBkBK,QAjBlBL,KAiBkBK,CAjBlBL;;AAmBAA,qEAIQC,MAJRD,yCAOa5e,sBAPb4e,WAOa5e,CAPb4e,gBAQiB,aAAY;AACzB,gBAAON,KAAKvZ,SAAZ,KAAOuZ,CAAP;AATJM;AA0BD;AACF;;AAED,6EAA0E;AACxE,SAAIM,YAAYC,gBAAgBrD,QAAhBqD,QAAgC5b,KAAhD;AACA,SAAI6b,aAAJ;AACA,UAAK,IAAI9V,IAAT,GAAgBA,IAAhB,KAAyBA,KAAzB,GAAiC;AAC/B8V;AACA,YAAK,IAAIpL,IAAT,GAAgBA,IAAhB,KAAyBA,KAAzB,GAAiC;AAC/BoL;AACD;AACF;;AAEDnf,uBAAkB,gBAAe;AAC/B;AACAmf,kBACEZ,QAAQjb,gCAAgCA,WAAWgK,KAA3ChK,MAAgCA,CAAhCA,EADV6b,EACU7b,CAARib,CADFY,EAGEZ,QAAQjb,gCAAgCA,WAAWgK,KAA3ChK,MAAgCA,CAAhCA,EAHV6b,EAGU7b,CAARib,CAHFY;AAFFnf;AAQA;;AAEA,SAAIof,WAAW,gBAAgB,gBAAe;AAC5C,WAAI/V,KAAKgW,MAAT,GAAkB;AAChB,gBAAO,OAAO,cAAa;AACzB,kBAAOC,KAAP;AADF,UAAO,CAAP;AAGD;AACD,cAAOxa,EAAEua,MAAFva,KAAP;AANF,MAAe,CAAf;AAQA,SAAI,CAAJ,UAAe;AACbqa;AACA,YAAK9V,IAAL,GAAYA,IAAIgW,MAAhB,GAAyBhW,KAAzB,GAAiC;AAC/B8V;AACD;AACF;;AAED;;AAEAE,WAAMF,WAANE;;AAEA,UAAKhW,IAAL,GAAYA,IAAZ,KAAqBA,KAArB,GAA6B;AAC3B,YAAK0K,IAAL,GAAYA,IAAZ,KAAqBA,KAArB,GAA6B;AAC3BoL,6BAAoBA,cAApBA,CAAoBA,CAApBA;AACAA,4BAAmBA,cAAnBA,CAAmBA,CAAnBA;AACD;AACF;;AAED;AACD;;AAED7b,wCAAqC,gBAAe;AAClDwB;AACA,SAAI,EAAE,WAAN,CAAI,CAAJ,EAAqB;AACjBA;AACH;AACDA;AACA,SAAIA,aAAJ,UAA2B;AACzBA;AACAA,0BAAmB,OACjB,UAAUwL,WAAV,OAA4B,cAAa;AACvC,gBAAOhN,oCAAP,CAAOA,CAAP;AAFJwB,QACE,CADiB,CAAnBA;AAKAA,wBAAiBA,iBAAjBA;AAPF,YAQO;AACL,WAAI,UAAJ,GAAiB;AACfA;AACAA,4BAAmB9E,QAAQ8E,EAA3BA,MAA2BA,CAAR9E,CAAnB8E;AACA,aAAI,EAAExE,mBAAmBwE,EAAzB,aAAyBA,CAArB,CAAJ,EAA4C;AAC1CA;AACD;AACDA,0BAAiBA,iBAAjBA;AACAA;AACD;AACF;AACD;AAzBFxB;;AA4BAA,uCAAoC,aAAY;AAC9C;AACA,SAAIwB,EAAJ,SAAIA,CAAJ,EAAkB;AAChBuO,gBAASvO,EAATuO,aAASvO,CAATuO;AADF,YAEO;AACL,WAAIvO,aAAJ,UAA2B;AACzBuO,kBAASvO,iBAATuO,IAASvO,EAATuO;;AAEA,aAAIvO,eAAJ,4BAA+C;AAC7C,eAAIya,cAAc,SAAdA,WAAc,MAAc;AAC9B,iBAAIC,OAAJ;AACA,kBAAK,IAAIC,KAAT,GAAiBA,KAAKrb,IAAtB,cAAwC;AACtC,mBAAIsb,WAAWtb,eAAf,EAAeA,CAAf;AACAob,sBAAO,CAACA,QAAS,IAAV,QAAPA;AACD;AACD;AANF;;AASA,eAAIG,SAAS3f,cAAb,WAAaA,CAAb;AACA,eAAI4f,iBAAJ;AACA,eAAIC,YAAJ;;AAEA,gBAAK,IAAIxW,IAAT,GAAgBA,IAAhB,iCAAqD;AACnDuW;AACD;;AAED5f,0BAAe,wBAAuB;AACpC,iBAAI0D,QAAJ,GAAe;AACbA,uBAAQ,CAARA;AACD;;AAED,iBAAIoc,YAAYpc,QAAhB;AACA,iBAAIoc,aAAJ,gBAAiC;AAC/BD,yBAAUxM,OAAVwM,KAAUxM,CAAVwM;AACA,sBAAOD,eAAP,SAAOA,CAAP;AACA;AACD;;AAED,iBAAIG,aACF7U,WAAWxH,QAAXwH,8BADF;AAGA,iBAAI6U,cAAJ,gBAAkC;AAChCF,yBAAUxM,OAAVwM,KAAUxM,CAAVwM;AACA,sBAAOD,eAAP,UAAOA,CAAP;AACA;AACD;;AAED,iBAAII,cAAclL,SAAS9U,8BAA3B,CAA2BA,CAAT8U,CAAlB;AACA+K,uBAAUxM,OAAVwM,KAAUxM,CAAVwM;AACA,oBAAOD,eAAP,WAAOA,CAAP;AAvBF5f;;AA0BA8E;AACD;AACD;AAjDF,cAkDO;AACLuO,kBAASvO,iBAATuO,IAASvO,EAATuO;AACD;AACF;;AAED,SAAIrN,MAAM,IAAV,MAAU,EAAV;;AAEAhG,oBAAe,iBAAgB;AAC7BgG;AADFhG;;AAIA8E,sBAAiB,kBAAiB;AAChC,cAAO2Y,MAAOA,kBAAkBzd,SAAlByd,GAAkBzd,CAAlByd,GAAPA,MAAgDzX,IAAvD,CAAuDA,CAAvD;AADFlB;AAGA;AArEFxB;;AAwEA,sEAAmE;AACjE,SAAI2c,gBAAJ,aAAiC;AAC/B,cAAO,yBAAyB,aAAY;AAC1C,gBAAO3c,mCAAP,YAAOA,CAAP;AADF,QAAO,CAAP;AAGD;AACD;AACD;;AAED,oCAAiC;AAC/B,SAAI0Q,cAAc1Q,cAAcA,qBAAhC,EAAgCA,CAAdA,CAAlB;AAAA,SACE4c,YAAYlM,YADd,mBACcA,CADd;;AAGA;;AAEA,SAAI1Q,KAAJ,UAAmB;AACjBc,aACE,aACAd,mBAAmByB,KADnB,CACAzB,CADA,oEAIA3C,oBAAoBqT,oBAJpB,MAIoBA,CAApBrT,CAJA,kDAOAqT,oBAPA,KAOAA,CAPA,GADF5P;AADF,YAWO;AACLA,aACE,aACAd,mBAAmByB,KADnB,CACAzB,CADA,iDAIA3C,oBAAoBqT,oBAJpB,MAIoBA,CAApBrT,CAJA,qCAOAqT,oBAPA,KAOAA,CAPA,kDAUApU,kBAAkBoU,YAAlBpU,IAVA,mBAUAA,CAVA,GADFwE;AAaD;;AAED,oBAAe;AACb8b,yBAAkB,aAAY;AAC5B9b,gBAAO,SAASU,EAAT,CAASA,CAAT,aAA0BA,EAA1B,CAA0BA,CAA1B,GAAPV;AADF8b;AAGD;;AAED;AACD;;AAED,8BAA2B;AACzBvC,gCAGE,aAAa7Y,EAHf6Y,YAIEwC,oBAAoBrb,EAJtB6Y,UAIEwC,CAJFxC,EAKEra,KALFqa;AAOD;;AAED,+BAA4B;AAC1BA;AACD;;AAEDra,iCAA8B,kCAAiC;AAC7D,SAAIwB,EAAJ,WAAiB;AACf,WAAIsb,YAAY9c,mBAAmBwB,eAAnBxB,KAAhB;;AAEA,WAAI8c,YAAJ,sBAAsC;AACpC3L;AADF,cAEO;AACL,aAAI4L,WACFD,0CADF;AAEA,aAAIC,WAAJ,GAAkB;AAChB,eAAI7L,IAAJ;AACA,kBAAOA,IAAIyJ,mBAAJzJ,UAAiC6L,WAAxC,QAA2D;AACzD,iBAAIrc,UACFV,cAAcA,qBAAqB2a,mBADrC,CACqCA,CAArB3a,CAAdA,CADF;AAEA+c,yBAAYrc,0BAAZqc;AACApK;AACD;AACD,eAAIzB,KAAKyJ,mBAAT,QAAoC;AAClCA;AACD;AACF;;AAED,aAAIoC,YAAJ,GAAmB;AACjBrK,6BAAkB,CAAlBA;AACD;AACF;;AAED,sBAAe;AACb1S;AACD;AACF;AACD;AA/BFA;;AAkCA,yCAAsC;AACpC,SAAIgd,YAAY,IAAhB,MAAgB,EAAhB;AACAtgB,YACE4I,wBACEtF,cAAcA,qBAAqBwB,EAAnCxB,OAAcA,CAAdA,EADFsF,sBADF5I,OAME,aAAY;AACVA,cAAO4C,EAAP5C,WAAoB,aAAY;AAC9B,aAAI,EAAEoJ,KAAN,SAAI,CAAJ,EAAuB;AACrBkX;AACD;AAHHtgB;AAPJA;AAcA;AACD;;AAED,wCAAqC;AACnC,SAAIugB,UAAU,eAAe,aAAY;AACvC,cAAO3c,EAAP;AADF,MAAc,CAAd;AAGA2c,kBAAaxgB,GAAbwgB;AACAzb,iBAAYjF,wBAAZiF,OAAYjF,CAAZiF;AACD;;AAED,mDAAgD;AAC9CmR,sBAAiB3S,cAAcA,qBAAqBwB,EAApDmR,OAA+B3S,CAAdA,CAAjB2S;AACA,oBAAe;AACb3S;AACD;AACF;;AAED,sCAAmC;AACjCwB,WAAMxB,aAANwB;AACAA,WAAMxB,cAANwB;AACAxB;AACD;;AAED,gCAA6B;AAC3B,YAAO,IAAI4H,UAAUtH,WAArB,MAAWsH,CAAX;AACD;;AAED5H,sCAAmC,oDAIjC;AACA,SAAIkd,kBAAkBC,cAClBzgB,SAASsD,KAATtD,OADkBygB,WAClBzgB,CADkBygB,GAElBnd,KAFJ;;AAIA,SAAIiN,SAAS,uBAAuB,gBAAe;AACjD,WAAImQ,SAAS;AACXC,eAAMrd;AADK,QAAb;AAGA,6BAAsB;AACpBtD,kCAAyB,qBAAoB;AAC3C0gB,0BAAepd,sCAAfod,GAAepd,CAAfod;AADF1gB;AAGD;AACD;AATF,MAAa,CAAb;;AAYAuQ,iBAAY,gBAAe;AACzB,WAAInF,SAASD,EAAb,MAAqB,OAAO,CAAP;AACrB,WAAIC,UAAUD,EAAd,MAAsB;AACtB;AAHFoF;;AAMA;AA3BFjN;;AA8BAA,+BAA4B,kBAAiB;AAC3Csd,cAASA,UAAUtd,KAAnBsd;AACAA,oBAAe,aAAY;AACzB,WAAI,CAACtY,EAAL,WAAkB;AAChBhF;AACD;AAHHsd;AAKAtd;AAPFA;;AAUAA,+BAA4B,qBAAoB;AAC9C,YAAO,qBAAqB,gBAAe;AACzC,cAAO,OAAOM,EAAP,UAAmB,aAAY;AACpC,gBAAOid,UAAP,CAAOA,CAAP;AADF,QAAO,CAAP;AADF,MAAO,CAAP;AADFvd;;AAQAA,iCAA8B,kBAAiB;AAC7Csd,cAASA,UAAUtd,KAAnBsd;AACAA,oBAAe,aAAY;AACzB,WAAI,CAACtY,EAAL,WAAkB2N;AADpB2K;AAGAtd;AALFA;;AAQAA,sBAAmB,YAAW;AAC5BA,sBAAiB,CAACA,KAAlBA;AACAA;AAFFA;;AAKA,4BAAyB;AACvB,gBAAW;AACT,WAAIwd,OAAJ;AAAA,WACEC,aADF;;AAGAC,qBAAc,aAAY;AACxB,aAAIlc,KAAJ,MAAe;AACbgc;AADF,gBAEO;AACLA;AACD;AALHE;AAOA,YAAK,IAAL,YAAqB;AACnBD,yBAAgB,KAAKD,KAArBC,EAAqBD,CAAL,CAAhBC;AACD;AACD,cAAO,gBAAgB,gBAAe;AACpC,gBAAO3V,OAAOD,EAAd,CAAcA,CAAd;AADF,QAAO,CAAP;AAGD;AACD;AACD;;AAED7H,2BAAwB,aAAa;AACnC;AACA,YAAO,eAAP;AAFFA;;AAKA;;AAEAA,2BAAwB,4EAKtB;AACA2d,kBAAaA,cAAbA;AACA;;;;;;;;;;;AAYA,SAAIb,YAAJ;AACA,SAAIc,kBAAJ;AACA,SAAIC,iBAAJ;;AAEA,SAAI;AACF,WAAIC,iBAAJ;AACA,WAAIC,kBAAJ;AACA,WAAIC,yBAAJ;AACA,WAAIC,iBAAJ;;AAEAvhB,cAAOsD,UAAPtD,OAAwB,gBAAU;AAC9BshB,gCAAuB7e,EAAvB6e;AACAC,wBAAe9e,EAAf8e;AAFJvhB;;AAKD,WAAMwhB,yBAAyB,SAAzBA,sBAAyB,YAAe;AACvCxhB,mBAAU,0CAAyC;AACjD,eAAIyhB,iBAAJ,UAA+B;AAC7B/N;AAKD;AAPH1T;AADP;;AAYA,WAAM0hB,kBAAkB,SAAlBA,eAAkB,eAAkB;AACvC,aAAIC,WAAW;AACbC,uBADa;AAEbC,4BAFa;AAGbnP,uBAHa;AAIboP,mBAAQ;AAJK,UAAf;AAMAH;AACAA;AACAH;AACAD,qCAA4Bje,gBAA5Bie;AACAje;AACA8c;AAZH;;AAgBC,WAAI2B,wBAAwBA,qBAA5B,QAAyD;;AAEvD,aAAI,EAAEC,YAAYD,qBAAlB,CAAkBA,CAAd,CAAJ,EAA4C;AAC1C,iBAAMC,WAAN;AAED;;AAEDhiB,gBAAO+hB,qBAAP/hB,CAAO+hB,CAAP/hB,EAAgC,gBAAe;AAC7C,eAAIqJ,KAAJ,UAAmB;AACjB,iBAAI4Y,uBAAuB;AACzBtc,sBADyB;AAEzBE,qBAFyB;AAGzBob,2BAAYA;AAHa,cAA3B;AAKA3d;AACD;AARHtD;;AAYAA,sCAA6B,aAAY;AACvC,eAAIyC,eAAJ,wBAA2C;AACzC+e,oCAAuBF,uBAAuB7e,EAA9C+e,QAA8C/e,CAAvB6e,CAAvBE;AACAL;AAFF,kBAGO;AACLO,6BAAiBjf,EAAjBif,QAAiBjf,CAAjBif;AACD;AANH1hB;AAQH;;AAID,WAAIkiB,wBAAwBA,qBAA5B,QAAyD;;AAErD,aAAMC,cAAc,EAAEJ,wBAAwBA,qBAA9C,MAAoB,CAApB;;AAEA,0BAAiB;AACb/hB,yCAA+B;AAAA,oBAA/BA,KAA+B;AAAA,YAA/BA;AACH;;AAEDA,sCAA6B,aAAY;AACvC,eAAI;AACF,iBAAI,gBAAgB,aAAhB,KAAkC,aAAtC,GAAsD;AACpD,mBAAI,EAAE4C,cAAN,cAAI,CAAJ,EAAqC;AACnC,kCAAiB;AACb8e,mCAAiB9e,EAAjB8e,OAAiB9e,CAAjB8e;AADJ,wBAEO;AACH;AACH;AALH,sBAMO;AACL,kCAAiB;AACbJ,0CAAuB1e,EAAvB0e,OAAuB1e,CAAvB0e;AACH;AACF;;AAED,mBAAI,EAAE1e,gBAAN,cAAI,CAAJ,EAAuC;AACrC,kCAAiB;AACb8e,mCAAiB9e,EAAjB8e,SAAiB9e,CAAjB8e;AADJ,wBAEO;AACH;AACH;AALH,sBAMO;AACL,kCAAiB;AACbJ,0CAAuB1e,EAAvB0e,SAAuB1e,CAAvB0e;AACH;AACF;;AAEDJ,+BAAgBte,EAAhBse,SAAgBte,CAAhBse,IACE,CAACA,gBAAgBte,EAAhBse,SAAgBte,CAAhBse,IACGA,gBAAgBte,EADnBse,SACmBte,CAAhBse,CADHA,GAAD,KADFA;;AAKA,mBAAIkB,WAAW;AACbC,yBAAQd,eAAe3e,EADV,OACUA,CAAf2e,CADK;AAEbe,yBAAQf,eAAe3e,EAFV,SAEUA,CAAf2e,CAFK;AAGbgB,4BAAW3f,EAHE,SAGFA,CAHE;AAIbkV,yBAJa;AAKb0K,2BAAU;AALG,gBAAf;;AAQAlf;AAtCF,oBAuCO;AACL;AACD;AA1CH,aA2CE,YAAY;AACZ,mBAAM,+CAGJmf,eAHF,CAGEA,CAHF;AAID;AAjDHziB;;AAoDA,0BAAiB;AACbmhB,4BAAiBnhB,OAAQA,iCAAkC;AAAA,oBAA3DmhB,CAA2D;AAAA,YAAlCnhB,CAARA,CAAjBmhB;AACH;;AAED7d;AACAA;AACA,aAAIA,KAAJ,UAAmB;AACfA,yCAA+BA,UAA/BA;AADJ,gBAEO;AACHA,gCAAqBA,KAArBA,0BAAoDA,UAApDA;AACH;AACD,aAAI,CAACA,KAAL,6BAAuC;AACrCA;AACD;AACD,aAAI,CAACA,KAAL,gCAA0C;AACxCA;AACD;;AAED,aAAIof,wBAAJ;AACA1iB,gBAAOsD,UAAPtD,OAAwB,aAAY;AAClC,eAAI2iB,gBAAgB3iB,QAClBA,OAAOsD,gBAAgBV,EAAhBU,QADWtD,gBAClBA,CADkBA,EAElBA,OAAOsD,gBAAgBV,EAAhBU,QAFT,gBAEEtD,CAFkBA,CAApB;AAIAA,iCAAsB,aAAY;AAChC,iBAAI,EAAE4D,KAAN,qBAAI,CAAJ,EAAmC;AACjC8e;AACD;AACD,iBAAI9f,EAAJ,WAAiB;AACf8f,wCAAyB9f,EAAzB8f;AACD;AANH1iB;AALFA;;AAgBA,aAAI4iB,+BAAJ;AACA5iB,uCAA8B,gBAAe;AAC3C,eAAI6iB,UAAU7iB,OAAd,CAAcA,CAAd;AACA6iB;AACAD;AAHF5iB;;AAMA,aAAI8iB,aAAa9iB,OAAjB,eAAiBA,CAAjB;AACA8iB;AACA,aAAIC,kBAAkBhjB,yDAAtB,UAAsBA,CAAtB;;AAKA;;;;;;AAMA,aAAIijB,uBAAuB,SAAvBA,oBAAuB,6BAAsC;AAC7D,kBAAO;AACH,4BAAe,yCAA8B;AAC3C,mBAAIhjB,SAAJ,WAAIA,CAAJ,EAA2B;AACzBD,oDAII4H,wBAAwB7C,EALH,WAKGA,CAAxB6C,CAJJ5H,EADyB,CAMrB;;AAEJ+E,+BAAc,CAAC6C,oBACb7C,EADFA,WACEA,CADa6C,CAAf7C;AARF,sBAWO;AACLA,+BAAc,CAAC6C,oBAAf7C,EAAe6C,CAAf7C;AACD;AACD/E;AAhBC;;AAmBHkjB,wBAAW,4BAAkB;AAC3B,yCAA0B;AACxB;AACA,qBAAIpd,KAAJ,QAAiB;AACf,wCAEE8B,wBAHa,IAGbA,CAFF,EADe,CAIb;AAJJ,wBAKO;AACL;AACA,uBAAIub,YAAY,WAAhB,QAAgB,CAAhB;AACA;AACA;AACD;AACF;AACDvb;AACA;AACAA,qCAAsB3H,QAAtB2H,WAAsB3H,CAAtB2H;AACAA,qCAAsB;AACpBwb,0BADoB;AAEpBC,wBAAO;AAFa,gBAAtBzb;;AAKA3H,sBAAO2H,QAAP3H,aAA4B,qBAAoB;AAC9C,qBAAI0e,EAAJ,QAAc;AACZ/W,kDAA+B3H,sBAA/B2H,CAA+B3H,CAA/B2H;AADF,wBAKO;AACLA,kEAEI3H,sBAFJ2H,CAEI3H,CAFJ2H;AAGD;AAVH3H;AA1CC;;AAwDH+I,yBAAY;AACVC,sBADU;AAEVC,sBAAO,qBAAqB,sBAAqB;AAC/C,wBAAO,CACL,4BAA2B;AACzB,6CAA0B;AACxBtB,uDAAkC,CAACA,oBAAnCA,UAAmCA,CAAnCA;AAEA0b,8CAEE1b,uCAFF0b;AAMA1b;AACD;;AAED;;AAEA,uBAAI2b,WAAJ,QAAuB;AACrBpH,4BAAOzE,yBAEC6L,aAFD7L,yBAKH9P,wBALG8P,UAKH9P,CALG8P,cAAPyE,cAAOzE,CAAPyE;AADF,0BASO;AACLA,4BAAOzE,wDAAPyE,cAAOzE,CAAPyE;AAID;AACD,uBAAImH,WAAWnH,8DAAf,EAAeA,CAAf;AA/BJ,kBAAO,CAAP;AADK;AAFG;AAxDT,YAAP;AADJ;;AAsGA,aAAIqH,uBAAuB,SAAvBA,oBAAuB,wDAAgE;;AAEvFjgB,gEAIE0f,oCAJF1f,WAIE0f,CAJF1f;AAFJ;;AAWA,aAAIkgB,6CAA6C,SAA7CA,0CAA6C,iCAA0C;;AAEpF,sDAA4C;AACvC,oBAAOlgB,+BAA+BgK,eAAehK,KAArD;AACJ;;AAEA,eAAImgB,mBAAJ;;AAEA,eAAIC,oBAAoB,qCACpBpgB,UADoB,OAEpBA,UAFoB,OAGpBqgB,eAHoB;AAIpB;AAJoB,6BAMpBlf,QANJ,QAAwB,CAAxB;;AASA,eAAImf,gBAAJ;AAAA,eAAwBC,cAAxB;AACA7jB,kBAAQyjB,iBAARzjB,CAAQyjB,CAARzjB,EAA6B,aAAa;AACtC,iBAAI4C,EAAJ,WAAiB;AACbghB,6BAAchhB,EAAdghB;AACAC,2BAAYjhB,EAAZihB;AACH;AAJL7jB;;AAOA4jB,2BAAgB5jB,OAAhB4jB,aAAgB5jB,CAAhB4jB;AACAA;AACAA;AACAC;;AAEA7a,mBAAQA,SAAS,cAAc;AAAE,oBAAO,gBAAgBvE,QAAhB,kCAAP;AAAjCuE;;AAEA,eAAI8a,KAAKxgB,8BAA+BogB,kBAA/BpgB,CAA+BogB,CAA/BpgB,EAAsD0F,MAAOvE,QAA7DnB,UAAsD0F,CAAtD1F,EACD0f,oCADC1f,WACD0f,CADC1f,+BAAT,IAASA,CAAT;AAEA;AACA;AACAwgB,uCAA6B,IAA7BA,IAA6B,EAA7BA;AApCR;;AAyCA,aAAIC,6BAA6B,CAC/B;AACEtgB,wBAAa;AACXC,oBAAOud,aADI;AAEXpd,mBAAM,wCAAwC;AAFnC,YADf;;AAMEC,sBAAW,4BAAmB;AAC1B,oBAAO;AACHJ,sBADG;AAEHY,yBAAU,oCAA2B;AACjC,qBAAIC,YAAYxE,UAAhB,OAAgBA,CAAhB;AACAwE,gIAIQ,cAJRA,wBAKevE,qEALfuE,IAKevE,CALfuE;;AAOA,qBAAIyf,WAAJ;;AAEAhkB,wBAAQyE,QAARzE,UAA0B,aAAa;AACnCgkB,4BAASvhB,EAATuhB;AADJhkB;;AAIAuE,oGAGQ,qBAHRA,wBAIe,+DACP,gBAAgB;AACX,0BAAQjB,gBAAgBgK,KAAhBhK,cAAD,QAACA,IAAiDA,gBAAgBgK,KAAhBhK,cAAzD;AAFE,oBAIX,cAAc;AAAE,0BAAO,gBAAgBmB,QAAhB,0CAAP;AARpBF,kBAIe,CAJfA;AASH;AA1BE,cAAP;AA4BH;AAnCH,UAD+B,CAAjC;;AAyCA,aAAI0f,kBAAkB,CACpB;AACExgB,wBAAa;AACXC,oBAAOud,aADI;AAEXtd,mBAAM,iBAAY;AAChB,sBAAOC,QAAP,CAAOA,CAAP;AAHS;AAKXC,mBAAM,6CAA6Cod;AALxC,YADf;AAQEnd,sBAAW,4BAAkB;;AAE3B,oBAAO;AACLJ,sBAAO,CACLM,iBADK,UACLA,CADK,EAELA,QAFK,iBAGLA,QAJG,UACE,CADF;;AAOLM,yBAAU,oCAA2B;AACnC,qBAAIC,YAAYxE,UAAhB,OAAgBA,CAAhB;AACAwE,gCAAe,CAACE,QAAD,CAACA,CAAD,sBAAfF;AACA,qBAAI2f,iBAAJ;AACA,qBAAIzf,QAAJ,CAAIA,CAAJ,EAAgB;AACdyf,oCAAiBlkB,UAAUA,OAAOyE,QAAjBzE,CAAiByE,CAAPzE,CAAVA,EAA8ByE,QAA/Cyf,CAA+Czf,CAA9BzE,CAAjBkkB;AACA,uBAAIA,eAAJ,QAA2B;AACzBA;AACA3f,qFAII,gBAAgB2f,eAAhB,SAJJ3f,2BAMiB2f,oBANjB3f,IAMiB2f,CANjB3f;AAOD;AACF;;AAED,qBAAIqf,gBAAgB5jB,QAClB4iB,6BAA6Bne,QAD/B,CAC+BA,CAA7Bme,CADkB5iB,CAApB;;AAMA,qBACEyE,kBACAyf,eADAzf,UAECme,6BAA6Bne,QAA7Bme,CAA6Bne,CAA7Bme,KACCgB,cAJJ,QAKE;AACAA;;AAEA,uBAAIC,cAAJ;AACA7jB,yCAAsB,aAAY;AAChC6jB;AADF7jB;;AAKAuE,sGAGQ,qBAHRA,oDAKe,aAAa;AACpB,yBAAI4f,sBAAJ;AACA,yBAAIH,WAAJ;;AAEAhkB,4BAAQgE,QAARhE,UAA0B,aAAa;AACnCgkB,gCAASvhB,EAATuhB;AADJhkB;;AAIA,yBAAI0jB,oBAAoB,qCACpBpgB,UADoB,OAEpBA,UAFoB,OAGpB,gBAAgB;AACX,8BAAQA,gBAAgBgK,KAAhBhK,cAAD,QAACA,IAAiDA,gBAAgBgK,KAAhBhK,cAAzD;AAJe,+BAOpBU,QAPJ,QAAwB,CAAxB;;AAUAhE,4BAAQ0jB,kBAAR1jB,CAAQ0jB,CAAR1jB,EAA8B,aAAa;AACvCmkB,2CAAoB1hB,EAApB0hB;AADJnkB;;AAIA;;;AAGAujB,0CAAsB9e,QAAtB8e,CAAsB9e,CAAtB8e,EAAkC,aAAY;AACtC,8BAAO9gB,QAAP;AADR8gB,oDAEmC,cAAa;AACxC,8BAAO,8CAAP;AAHRA;AA9BRhf;;AAqCAA,sGAGQ,cAHRA,wBAIe,gCAAiCE,QAAjC,CAAiCA,CAAjC,EAA6C,aAAY;AACpE,4BACEhC,sBACAgC,cAAchC,EAFhB;AADW,kDAKkB,cAAa;AACrC,4BAAO,uCAAP;AAVT8B,oBAIe,CAJfA;AAaD;AACF;AAhGI,cAAP;AAkGD;AA5GH,UADoB,CAAtB;;AAiHA,aAAIjB,KAAJ,6BAAsC;AAClCA,8CAAmCA,wCAAnCA,eAAmCA,CAAnCA;AADJ,gBAIO;AACHA;AACH;;AAEDA,iCACEA,KADFA,6BAEEA,KAFFA;;AAKA,aAAIA,KAAJ,kBAA2B;AACvB,eAAIA,KAAJ,gCAAyC;AACrCA,mDAAsCA,2CAAtCA,0BAAsCA,CAAtCA;AADJ,kBAIO;AACHA;AACH;AACDA,mCACMA,KADNA,gCAEMA,KAFNA,kBAGM,EAAC,eAAD,MAAuB,eAH7BA,IAGM,EAHNA;AAKH;AACF;AAxgBH,OAygBE,UAAU;AACV;AACD;;AAED,YAAO;AACLX,cADK;AAELwe,uBAFK;AAGLze,cAAOwe;AAHF,MAAP;AApiBF5d;;AA4iBAA,8CAA2C,gDAIzC;AACA,SAAI8gB,iBAAJ;;AAEA,SAAI;AACF3D,qBACEA,eACA,YAAW;AACT;AAHJA;AAKAkD,qBACEA,eACA,YAAW;AACT;AAHJA;;AAMA,WAAIzW,iBAAJ;AACA,WAAIC,2BAAJ;;AAEA,WAAIkX,sBAAsBjiB,qCACxBpC,SAASsD,UAATtD,OADwBoC,WACxBpC,CADwBoC,EAExBkB,UAFwBlB,aAA1B,KAA0BA,CAA1B;;AAOApC,mCAA4B,aAAY;AACtC,aAAIskB,cAAJ;AACA,aAAIC,iBAAJ;;AAEAvkB,mBAAU,aAAY;AACpBskB,uBAAY7hB,EAAZ6hB;AACAC,6BAAkB9hB,gBAAlB8hB;AAFFvkB;;AAKA;;AAEA;;AAEA;;AAEA,6BAAoB;AAClB,kBAAOskB,YAAP,SAAOA,CAAP;AACD;;AAED,aAAIE,gBAAgBxkB,oBAApB;;AAEAA,mBAAU,aAAY;AACpB,eAAI,sBAAJ,GAA6B;AAC3BA,sBAASyC,EAATzC,kBAASyC,CAATzC;AADF,kBAEO;AACLyC;AACD;AALHzC;;AAQAA,6BAAoB,gBAAe;AACjC;AACA,eAAIykB,mBAAmBnhB,cAAckR,IAArC,CAAuBlR,CAAvB;AACA,eAAI,CAACmhB,iBAAL,UAAgC;AAC9BA;AACD;AACDA;AACA,eAAI,qBAAJ,kBAA2C;AACzCzkB,sBAASykB,iBAATzkB,iBAASykB,CAATzkB;AADF,kBAEO;AACLykB;AACD;AAXHzkB;AA7BFA;AAtBF,OAiEE,YAAY;AACZ6C;AACA;AACD;;AAED;AA7EFS;AA+EA;AACA,oEAAiE;AAC/D;;AAEA,SAAIohB,WAAW,CAACjN,QAAhB,SAAiC;AAC/B;AACAhP,kCAA2B,aAAY;AACrCA;AADFA;;AAIA,WAAIkc,WAAWlc,EAAf,OAAeA,CAAf;AACA,WAAImc,YAAY7kB,mBAAhB,KAAgBA,EAAhB;AACA0X,yBAAkB,iBAAiB;AACjCzO,gBAAOA,iBAD0B;AAEjCjF,eAFiC;AAGjC+C,oBAAWA,wBAAwB;AAHF,QAAjB,CAAlB2Q;;AAMA;;AAEAzX,eAAQA,OAAOyX,gBAAPzX,SAAgCyX,QAAxCzX,OAAQA,CAARA;AAhBF,YAiBO;AACL,WAAI0kB,oBAAoBjN,QAAxB,SAAyC;AACvCA;AACAA;AACD;AACF;AACF;;AAED;;AAEA,OAAIoN,UAAJ;;AAAoB;AAClBvU,gBAAahN,KADf;;AAC0B;AACxBwhB,0BAFF;AAAA,OAGErQ,iBAHF;AAAA,OAIE9B,aAJF;AAAA,OAKEsL,qBALF;AAAA;AAAA,OAOE8G,gBAAgBhlB,oCAGN,IAHMA,MAGN,CAHMA,QAIP,MAXX,IAWW,CAJOA,CAPlB;;AAaA;;AAEA,OAAI+O,iBAAiB,0CAGX,aAAY;AAClB,SAAIxL,KAAJ,gBAAyB;AACvB,cAAO,CAAP;AACD;AACD,SAAIwB,EAAJ,YACE,OACExB,0BAA0B,MAAM,IAAI4H,SAASpG,WAAToG,QADtC,GACsCA,CAApC5H,CADF;AAGF,YAAOA,0BAA0B,KAAK,KAAK4H,UAAUpG,EAArD,MAA2CoG,CAApC5H,CAAP;AAXiB,mBAaL,aAAY;AACxB,YAAO4H,SAASpG,EAAToG,iBAAP;AAdiB,mBAgBL,aAAY;AACxB,SAAI5H,KAAJ,gBAAyB;AACvB;AACD;AACD,SAAIwB,cAAJ,WAA6B;AAC3B,cAAO,KAAK,MAAMA,EAAlB,OAAO,CAAP;AACD;AACD;AAvBiB,qBAyBH+f,UAzBG,cA0BVvhB,0BAA0ByhB,cAAc1hB,WA1B9B,MA0BgB0hB,CA1BhB,WAArB,IAAqB,CAArB;;AA6BAhlB,aAAUuD,KAAVvD;AACAA,aAAUuD,KAAVvD;AACAuD;AACAA;;AAEAA,sBAAmB,UACTA,KADS;AAGjB;AAHiB,eAILA,kBAJK,8BAKFA,aAAaA,YAAbA,OAAgCA,YAL9B,sBAMDA,cAAcA,YAAdA,MAAgCA,YANlDA,MAAmB,CAAnBA;;AAQAA;;AAEA;AACA;;AAEA;AACAA,yBAAsB0hB,yBAAtB1hB,MAAqD0hB,yBAArD1hB;AACAA,qBAAkBA,+CAEG,0CAFrBA,GAAkBA,CAAlBA;;AAIF;;;;;;;;;;;;;;;;;AAiBIA,+DAGYA,kBAHZA,wOAxiNF,4BAwiNEA,EAxiNF,CAqjN4C;;AAE5C+O;;AAEA4S;;AAGA,gBAAa;AACX,SAAIjlB,WAAWuD,QAAf,QAAeA,CAAXvD,CAAJ,EAAmC;AACjCsD,gCAAyBC,QAAzBD,QAAyBC,CAAzBD;AACD;;AAED,SAAI,eAAJ,SAA4B;AAC1BA,wBAAiBC,QAAjBD,WAAiBC,CAAjBD;AACD;;AAED,SAAI,iBAAJ,SAA8B;AAC5BA,0BAAmBC,QAAnBD,aAAmBC,CAAnBD;AACD;;AAED,SAAI,eAAJ,SAA4B;AAC1BC;AACD;;AAGD,SAAIvD,UAAUuD,QAAd,QAAcA,CAAVvD,CAAJ,EAAkC;AAChCsD,iCACE,SAASA,KAAT,UAAwB,aAAY;AAClC,gBAAOC,0BAA0BK,EAA1BL,eAAP;AAFJD,QACE,CADFA;AAKD;AAEF;;AAEDA;AACAvD,aAAUuD,KAAVvD;AACA+O;;AAEA;AAxmNF;;AA2mNA,KAAIoW,iCAAiC,SAAjCA,8BAAiC,aAAqB;AACxD,OAAIC,gBAAgBplB,UAApB,GAAoBA,CAApB;;AAEAolB,mBAAgBplB,sBAAhBolB,OAAgBplB,CAAhBolB;AACA,OAAIA,cAAJ,KAAIA,EAAJ,EAA2B;AACzBA,qBAAgBplB,sBAAhBolB,OAAgBplB,CAAhBolB;AACD;;AAED,OAAIC,aAAJ;;AAEA,OAAI,CAACD,cAAL,KAAKA,EAAL,EAA4B;AAC1BnlB,YAAOqlB,MAAPrlB,iBAAOqlB,CAAPrlB,EAAiC,sBAAqB;AACpD,WAAIsD,iBAAiBma,OAArB,SAAqC;AACnCA;AACD;AACD,WAAIzd,WAAJ,KAAIA,CAAJ,EAAuB;AACrBolB,yBAAgB,MAAhBA,KAAgB,CAAhBA;AACD;AANHplB;AAQD;;AAED,OAAIugB,UAAJ;AACAvgB,UAAOqlB,iBAAPrlB,cAAOqlB,CAAPrlB,EAAyC,wBAAuB;AAC9D,UAAK,IAAIwU,IAAT,GAAgBA,IAAhB,YAAgC;AAC9B+L,oBAAapM,QAAboM;AACD;AAHHvgB;AAKAugB,aAAU1gB,wBAAV0gB,OAAU1gB,CAAV0gB;AACA6E,mBAAgB,eAAhBA,EAAgB,CAAhBA;AACAA,mBAAgB,4BAEdzkB,oBAAoB4f,QAFtB6E,MAEsB7E,CAApB5f,CAFc,CAAhBykB;AAIAA,mBAAgB,8BAEdzkB,oBAAoB4f,QAFtB6E,QAEsB7E,CAApB5f,CAFc,CAAhBykB;AAIAA,mBAAgB,6BAEd7E,yBAAyBA,QAF3B6E,KAE2B7E,CAFX,CAAhB6E;AAIAA,mBAAgB,2CAEd7E,wBAAwBA,QAF1B6E,IAE0B7E,CAFV,CAAhB6E;;AAKA7E,aAAU1gB,wBAAwBwlB,MAAlC9E,eAAkC8E,CAAxBxlB,CAAV0gB;AACA6E,mBAAgB,kBAAhBA,EAAgB,CAAhBA;AACAA,mBAAgB,4BAEdzkB,oBAAoB4f,QAFtB6E,MAEsB7E,CAApB5f,CAFc,CAAhBykB;AAIAA,mBAAgB,8BAEdzkB,oBAAoB4f,QAFtB6E,QAEsB7E,CAApB5f,CAFc,CAAhBykB;AAIAA,mBAAgB,6BAEd7E,yBAAyBA,QAF3B6E,KAE2B7E,CAFX,CAAhB6E;AAIAA,mBAAgB,2CAEd7E,wBAAwBA,QAF1B6E,IAE0B7E,CAFV,CAAhB6E;;AAKA,OAAI9hB,KAAJ,UAAmB;AACjBid,eAAU,wBACR,MAAM8E,MAAN,OAAMA,CAAN,EAAsB,aAAY;AAChC,cAAOziB,EAAP;AAFJ2d,MACE,CADQ,CAAVA;AAKA6E,qBAAgB,mCAAhBA,EAAgB,CAAhBA;AACAA,qBAAgB,4BAEdxkB,sBAAsB2f,QAFxB6E,MAEwB7E,CAAtB3f,CAFc,CAAhBwkB;AAIAA,qBAAgB,8BAEdxkB,sBAAsB2f,QAFxB6E,QAEwB7E,CAAtB3f,CAFc,CAAhBwkB;AAIAA,qBAAgB,6BAEdxkB,sBAAsB2f,QAAtB3f,KAAsB2f,CAAtB3f,YAEEA,sBAAsB2f,QAJ1B6E,KAI0B7E,CAAtB3f,CAJY,CAAhBwkB;AAMAA,qBAAgB,2CAEdxkB,sBAAsB2f,QAAtB3f,IAAsB2f,CAAtB3f,YAEEA,sBAAsB2f,QAJ1B6E,IAI0B7E,CAAtB3f,CAJY,CAAhBwkB;AAMD;;AAED,OAAIjO,OAAOgO,mCAAX,UAAWA,CAAX;AACAhO;AACAA;AACA,OAAImO,UAAU,0BAA0B,aAAY;AAClD;AADF,IAAc,CAAd;AAGAA;AACAA;AACAA,gBAAa,aAAY;AACvB;AADFA;AAtGF;;AA2GAxlB;AACAA;AACAA,8D;;;;;;;;;;;;;;AC78NA,KAAIC,KAAK,mBAAAL,CAAT,EAASA,CAAT;AAAA,KACEM,IAAI,mBAAAN,CADN,EACMA,CADN;AAAA,KAEEG,UAAU,mBAAAH,CAFZ,EAEYA,CAFZ;;AAIA,+CAA8C;AAC5C,OAAIiD,QAAQkP,IAAZ;AAAA,OACEnP,QAAQmP,IADV;;AAGA,OAAI0T,iBAAJ;;AAEA7iB,iBAAc,gBAAe;AAC3B,8BAAyB;AACvB,cAAOD,QAAP;AACD;;AAED,SAAI+iB,UAAU5iB,EAAd,WAAcA,CAAd;;AAEA,SAAI4J,KAAK,aAAa,aAAY;AAC9B,cAAOiZ,YAAYD,QAAnB,CAAmBA,CAAZC,CAAP;AADK,QAAT,CAAS,CAAT;AAAA,SAGEhZ,KAAK,aAAa,aAAY;AAC5B,cAAOgZ,YAAYD,QAAnB,CAAmBA,CAAZC,CAAP;AADG,QAHP,CAGO,CAHP;;AAOAF,oBAAe/Y,GAAf+Y,MACIA,eAAe/Y,GAAf+Y,SADJA,EACIA,CADJA,GAEKA,eAAe/Y,GAAf+Y,MAAwB,CAF7BA,EAE6B,CAF7BA;AAGAA,oBAAe9Y,GAAf8Y,MACIA,eAAe9Y,GAAf8Y,SADJA,EACIA,CADJA,GAEKA,eAAe9Y,GAAf8Y,MAAwB,CAF7BA,EAE6B,CAF7BA;AAjBF7iB;;AAsBA;AACD;;AAED,KAAIgjB,uCAAJ;;AAEA1lB,QAAOA,WAAPA,EAAOA,CAAPA,EAAuB,aAAY;AACjC,OAAI2lB,aAAaza,cAAjB;AACAwa,6CAA0C,MAAM1lB,WAAN,CAAMA,CAAN,EAAqB,aAAY;AACzE,YAAO,CAACkL,SAASya,aAAV,CAACza,CAAD,EAA2BA,SAASya,aAA3C,CAAkCza,CAA3B,CAAP;AADFwa,IAA0C,CAA1CA;AAFF1lB;;AAOA,6CAA4C;AAC1C;AACE;AACA;AACA;AACA;AACA;AACA;AACE,cAAOD,qBAAP,IAAOA,CAAP;AACF;AACE,cAAO,0CAAP,CAAO,CAAP;AACF;AACE,cAAO,0CAAP,CAAO,CAAP;AACF;AACE,cAAO,0CAAP,CAAO,CAAP;AACF;AACE,cAAO,0CAAP,CAAO,CAAP;AACF;AACE,cAAO,0CAAP,CAAO,CAAP;AACF;AACE,cAAO,IAAP,6BAAO,EAAP;AAnBJ;AAqBA;AACA,UAAOA,qBAAP,QAAOA,CAAP;AACD;;AAED,KAAI6lB,gCAAgC,SAAhCA,6BAAgC,GAAW;AAC7C,OAAItiB,OAAJ;;AAEAA,kBAAe,YAAW;AACxB,SAAIkE,OACF,OACAlE,KADA,mBAGAA,cAHA,UAKAA,cALA,mBAOAA,KAPA,SADF;AAUA;AAXFA;;AAcAA,uBAAoB,YAAW;AAC7B,YAAOA,KAAP;AADFA;;AAIAA,uBAAoB,gBAAe;AACjC,SAAItD,WAAJ,IAAIA,CAAJ,EAAsB;AACpBsD;AACAA,qBAAc4H,UAAU,cAAcA,KAAtC5H,EAAc4H,CAAd5H;AACA,cAAOA,KAAP;AACD;;AAED,YAAOA,KAAP;AAPFA;;AAUAA;;AAEA,UAAOA,KAAP;AAjCF;;AAoCA,KAAIuiB,gCAAgC,SAAhCA,6BAAgC,GAAW;AAC7C,OAAIviB,OAAJ;;AAEAA,kBAAe,YAAW;AACxB,SAAIkE,OAAO,OAAOlE,KAAP,SAAX;;AAEA,SAAIA,cAAJ,sCAAwD;AACtDkE,eAAQ,qCAAqClE,KAArC,WACD,iBAAgB;AACnB,gBAAO,OAAOA,cAAcI,MAArB,CAAqBA,CAArB,SAAsCJ,cAAcI,MAA3D,CAA2DA,CAA3D;AAFI,eAAR8D,GAAQ,CAARA;AADF,YAMO;AACL,WAAIme,aAAaza,cAAc5H,KAA/B;AAAA,WACEwiB,gBADF;AAEA,YAAKzc,IAAL,GAAYA,IAAI/F,aAAhB,QAAqC;AACnCwiB;AACAte,iBACE,OACAlE,cAAc4H,SADd,aACcA,CADd,SAGA5H,cAAc4H,SAJhB1D,aAIgB0D,CAJhB1D;AAKD;AACF;;AAEDA;AACA;AAvBFlE;;AA0BAA,wBAAqB,gBAAe;AAClC,SAAItD,oBAAoByG,OAAxB,GAAkC;AAChCnD;AACA,cAAOA,KAAP;AACD;;AAED,YAAOA,KAAP;AANFA;;AASAA,uBAAoB,YAAW;AAC7B,YAAOA,KAAP;AADFA;;AAIAA,uBAAoB,gBAAe;AACjC,SAAItD,WAAJ,IAAIA,CAAJ,EAAsB;AACpBsD;AACAA,qBAAc4H,UAAUzE,OAAOyE,KAA/B5H,EAAc4H,CAAd5H;AACA,cAAOA,KAAP;AACD;;AAED,YAAOA,KAAP;AAPFA;;AAUAA;AACAA;;AAEA,UAAOA,KAAP;AAvDF;;AA0DA,mDAAkD;AAChD,OAAIX,QAAQkP,IAAZ;AAAA,OACEnP,QAAQmP,IADV;;AAGAlP,iBAAc,aAAY;AACxBF,mBAAc1C,GAAd0C,GAAc1C,EAAd0C;AADFE;;AAIAD,iBAAc,aAAY;AACxBC,WAAMC,EAAND,sBAA8BC,EAA9BD;AACAA,WAAMC,EAAND,sBAA8BC,EAA9BD;AAFFD;AAID;;AAED;AACA,wCAAuC;AACrC,OAAIqjB,YAAJ;AACA1c,OAAIyL,SAAJzL,CAAIyL,CAAJzL;AACA0K,OAAIe,SAAJf,CAAIe,CAAJf;;AAEA,QAAK,IAAInQ,IAAT,GAAgBA,IAAIoiB,WAApB,aAA4C;AAC1C,SAAIxR,IAAIwR,WAAR,CAAQA,CAAR;AACA,SAAIC,eAAJ;;AAEA,SAAIA,yBAAyBA,gBAA7B,GAAgD;AAC9C,cAAO,CAAC,CAACnR,SAAD,CAACA,CAAD,EAAcA,SAAtB,CAAsBA,CAAd,CAAD,CAAP;AADF,YAEO;AACL,WAAIoR,YAAYC,2BAAhB,YAAgBA,CAAhB;AACA,WAAIC,YAAYD,sCAAhB,CAAgBA,CAAhB;;AAEA,YAAK,IAAIE,YAAT,GAAwBA,YAAYH,UAApC,qBAAmE;AACjE,aAAII,MAAMJ,UAAV,SAAUA,CAAV;AACA,cAAK,IAAIK,YAAT,GAAwBA,YAAYH,UAApC,qBAAmE;AACjE,eAAII,MAAMJ,UAAV,SAAUA,CAAV;AACA,eAAIE,IAAJ,QAAgB;AACd,iBACEA,eACAA,IAAIA,aAAJA,MADAA,KAEAE,UAFAF,KAGAE,IAAIA,aAAJA,MAJF,GAKE;AACAF;AACAP,8BAAeO,WAAfP,GAAeO,CAAfP;AACD;AACF;AACF;AACF;AACF;AACF;;AAED;AACD;;AAED,qDAAoD;AAClD,OAAI7M,QAAQiN,2BAAZ,CAAYA,CAAZ;;AAEA;AACAjN,WAAQ,UAAU,mBAAkB;AAClC,YAAOuN,iBAAiB,CAAxB,CAAOA,CAAP;AADFvN,IAAQ,CAARA;;AAIA,OAAI,CAAJ,OAAY;AACV;AACD;;AAED,OAAIwN,YAAJ;;AAEA,QAAK,IAAIlS,IAAT,GAAgBnL,IAAI6P,MAApB,aAAuC;AACrCuN,eAAUvN,MAAVuN,CAAUvN,CAAVuN;AACAC,oBACE,OACE,YAAY,aAAY;AACtB,cAAOjkB,KAAP;AAHNikB,MAEI,CADF,CADFA;AAOD;;AAED,OAAItT,OAAOrT,QAAX,SAAWA,CAAX;;AAEA,OAAIqT,SAAJ,WAAwB;AACtBA;AACD;;AAED;AACD;;AAED;AACA,iGAIE;AACA;AACA,OAAIjF,YAAJ;AACA,OAAI6X,OAAJ;AACA,OAAIrjB,QAAQkP,IAAZ;AACA,OAAInP,QAAQmP,IAAZ;AACA,OAAImS,WAAJ;;AAEA,OAAIuB,iBAAiBoB,gCAArB,GAAqBA,CAArB;;AAEA,OAAI,CAAJ,QAAa;AACX/F,cAASgG,YAAThG,cAASgG,CAAThG;AACD;;AAED,OAAIiG,aAAajG,OAAjB;;AAEA,QAAK,IAAIvX,IAAT,GAAgBA,IAAIuX,OAApB,aAAwC;AACtC,SAAIvR,SAASuR,OAAb,CAAaA,CAAb;AACA,SAAIkG,YAAY,wBAAwB,aAAY;AAClD;AADF,MAAgB,CAAhB;AAGA,SAAIC,SAAS,wBAAwB,aAAY;AAC/C;AADF,MAAa,CAAb;AAGA5Y;AACA6X;AACD;;AAED,QAAK,IAAI7R,QAAT,GAAoBA,QAAQyM,OAA5B,iBAAoD;AAClD,SAAIvR,SAASuR,OAAb,KAAaA,CAAb;AACA,UAAK,IAAIoG,SAAT,GAAqBA,SAASpG,OAA9B,kBAAuD;AACrD,WAAIqG,cAAcrG,OAAlB,MAAkBA,CAAlB;AACA,WAAIqG,eAAJ,QAA2B;AACzB,aACE,2BACO,aAAY;AACf,kBAAOxkB,EAAP;AAFJ,oCAI2B,CAL7B,GAME;AACA0L;AACAA;AACD;AACF;AACF;AACF;;AAED,QAAK,IAAI+Y,UAAT,GAAsBA,UAAUtG,OAAhC,mBAA0D;AACxD,SAAIuG,MAAMvG,OAAV,OAAUA,CAAV;AACA,UAAK,IAAIwG,UAAT,GAAsBA,UAAUxG,OAAhC,mBAA0D;AACxD,WAAIyG,MAAMzG,OAAV,OAAUA,CAAV;AACA,WAAIsG,WAAJ,SAAwB;AACtBlB;AADF,cAEO;AACLA,kCAAyB,CAAzBA,OAAyB,CAAzBA;AACD;AACF;AACF;;AAED;AACA,OAAIsB,aAAatnB,iBAAiBA,EAAlC,KAAiBA,CAAjB;AACA,OAAI4D,IAAJ;;AAEA,QAAK,IAAI2jB,UAAT,GAAsBA,UAAU3G,OAAhC,mBAA0D;AACxD,SAAI4G,MAAM5G,OAAV,OAAUA,CAAV;AACA,UAAK,IAAIsG,UAAT,GAAsBA,UAAUtG,OAAhC,mBAA0D;AACxD,WAAIuG,MAAMvG,OAAV,OAAUA,CAAV;AACA,YAAK,IAAIwG,UAAT,GAAsBA,UAAUxG,OAAhC,mBAA0D;AACxD,aAAIyG,MAAMzG,OAAV,OAAUA,CAAV;;AAEA,aAAIuG,OAAJ,KAAgB;AACdM,kBAAOtZ,mBAAPsZ,OAAOtZ,CAAPsZ;AACAC,kBAAOvZ,mBAAPuZ,OAAOvZ,CAAPuZ;AACAC,kBAAOxZ,mBAAPwZ,OAAOxZ,CAAPwZ;;AAEA,eAAIF,iBAAiBC,SAArB,MAAoC;AAClCD;AACA,iBAAIE,iBAAiBA,OAArB,MAAkC;AAChCL;AACAA;AACAtB;AACAA,wCAAyBA,8BACvBA,cADFA,OACEA,CADuBA,CAAzBA;AAGA;AAPF,oBAQO,IAAI2B,QAAJ,MAAkB;AACvB3B,wCAAyBA,8BACvBA,cADFA,OACEA,CADuBA,CAAzBA;AAGD;AACF;AACDpiB;AACA0jB,0CAA+BnZ,mBAA/BmZ,OAA+BnZ,CAA/BmZ;AACAA,0CAA+BnZ,mBAA/BmZ,OAA+BnZ,CAA/BmZ;AACD;AACF;AACF;;AAED,SAAI5I,IAAJ;AACA4I;AACAnZ;AACD;;AAED,UAAO;AACLyZ,eADK;AAELzZ,gBAFK;AAGL6X,WAAMA;AAHD,IAAP;AAKD;;AAED,wDAAuD;AACrD,OAAIrjB,QAAQkP,IAAZ;AAAA,OACEnP,QAAQmP,IADV;AAAA,OAEE7G,aAFF;;AAIA;AACA,OAAI6c,WAAW,aAAa,aAAY;AACtC,YAAO9kB,QAAQN,EAAf;AADF,IAAe,CAAf;;AAIA,iBAAc;AACZuI,kBAAa6c,YAAb7c;AADF,UAEO;AACLnI;AACA;AACD;;AAED;AACA,OAAIilB,mBAAmB,aAAa,aAAY;AAC9C,YAAO9c,cAAcvI,EAArB;AADF,IAAuB,CAAvB;AAGA,OAAIuhB,WAAW,qBAAqB,aAAY;AAC9C,YAAOvhB,EAAP;AADF,IAAe,CAAf;AAGA,OAAIslB,mBAAmB,aAAa,aAAY;AAC9C,YAAO/D,iBAAiBphB,YAAjBohB,CAAiBphB,CAAjBohB,KAAoC,CAA3C;AADF,IAAuB,CAAvB;;AAIA,OAAIgE,eAAJ;AACAA;AACAA;AACA;AACD;;AAED,yFAIE;AACA,OAAIrlB,QAAQkP,IAAZ;AAAA,OACEnP,QAAQmP,IADV;;AAGA,OAAIiW,mBAAmB,aAAa,aAAY;AAC9C,YAAO9jB,WAAWvB,EAAlB;AADF,IAAuB,CAAvB;AAGA,OAAIuhB,WAAW,qBAAqB,aAAY;AAC9C,YAAOvhB,EAAP;AADF,IAAe,CAAf;AAGA,OAAIslB,mBAAmB,aAAa,aAAY;AAC9C,YAAO/D,iBAAiBphB,YAAjBohB,CAAiBphB,CAAjBohB,KAAoC,CAA3C;AADF,IAAuB,CAAvB;;AAIA,OAAIgE,eAAJ;AACAA;AACAA;;AAEA;AACA,OAAIF,0BAAJ,IAAkC;AAChCG;AACA;AACD;;AAED;AACA,OAAI/O,QAAQgP,oDAAZ,YAAYA,CAAZ;AACA,OAAIlE,WAAW,qBAAqB,aAAY;AAC9C,YAAOvhB,EAAP;AADF,IAAe,CAAf;;AAIA,OAAI0lB,cAAJ;AACAL,4BAAyB,aAAY;AACnCK,iBAAY1lB,EAAZ0lB,MAAoBC,wCAClB3lB,EADkB2lB,kBAApBD,KAAoBC,CAApBD;AADFL;;AAQAG;AACA;AACD;;AAED;AACA;AACA,oEAAmE;AACjE,OAAI,CAAJ,OAAY;AACV,SAAID,eAAeK,yCAAnB,GAAmBA,CAAnB;AACAnP,aAAQgP,oDAARhP,YAAQgP,CAARhP;AACD;;AAED;AACA,OAAI/E,QAAQ+E,uBAAZ,IAAYA,CAAZ;;AAEA,OAAI/E,SAAS,CAAb,GAAiB;AACf;AACD;;AAED,OAAI2D,SAASoB,gBAAb;;AAEA,OAAIpB,UAAJ,GAAiB;AACfiC,aAAQ,KAAK,CAACjC,SAAD,MAAgBA,SAA7BiC,CAAa,CAAL,CAARA;AADF,UAEO;AACLA;AACD;;AAED;AACA;AACA,OAAIuO,kBAAJ;AACA,QAAK,IAAL,KAActoB,QAAd,MAAcA,CAAd,EAA+B;AAC7B,UAAK,IAAL,KAAcA,QAAd,MAAcA,CAAd,EAA+B;AAC7BsoB,4BAAqBC,gCAAgCrP,MAAhCqP,SAArBD,CAAqBC,CAArBD;AACD;AACF;;AAED,UAAOvoB,0BAAP;AACD;;AAED,6CAA4C;AAC1C,OAAI4C,QAAQkP,IAAZ;AAAA,OACEnP,QAAQmP,IADV;;AAGA,QAAK,IAAL,YAAqB;AACnBlP;AACD;;AAED,QAAK,IAAL,YAAqB;AACnBA,WAAMD,SAANC;AACAA,WAAMD,SAANC;AACD;AACF;;AAED,2CAA0C;AACxC,UACE,iBAAiB,aAAY;AAC3B,YAAOoC,MAAMtC,EAAb;AADF,YADF;AAKD;;AAED,8DAA6D;AAC3D,OAAIE,QAAQkP,IAAZ;;AAEA,2CAAwC;AACtC,YAAOvO,wBAAP;AACD;;AAED;AACA,OAAIjB,WAAW,UAAU,aAAY;AACnC,YAAOI,EAAP;AADF,IAAe,CAAf;AAGA,OAAI+lB,kBAAkBnmB,gBAAtB,UAAsBA,CAAtB;;AAEA,OAAIomB,WAAJ;;AAEA,6BAA0B;AACxBA;;AAEA,UAAK,IAAL,iBAA0B;AACxBC,2DAAoDC,QAApDD,IAAoDC,CAApDD;AACD;;AAED,SAAID,YAAYD,gBAAhB,QAAwC;AACtClkB;AACD;AACF;;AAED;AACAkkB,2BAAwB,sBAAqB;AAC3CI;AADFJ;;AAIA;AACD;;AAED,wCAAuC;AACrC,UAAOzlB,0CAA0C,CAAjD;AACD;;AAED,iDAAgD;AAC9C;AACA8lB;;AAEAC,6CAA0C,eAAc;AACtD,SAAIC,aAAa,cAAc,aAAY;AACzC,cAAO,CACLjkB,EADK,IAELA,EAFK,SAGLA,EAHK,QAILA,EAJK,aAKLkkB,wBALK,CAKLA,CALK,EAMLlkB,kBANF,GAMEA,CANK,CAAP;AADF,MAAiB,CAAjB;AAUAikB,wBAAmB,gEAAnBA,YAAmB,CAAnBA;AAQAE,gBAAWlpB,cAAXkpB,UAAWlpB,CAAXkpB;AACA3kB;AApBFwkB;AAsBD;;AAED,iDAAgD;AAC9C,OAAIxT,OAAO,+BAA+B,qBAAoB;AAC5D,SAAIA,SAAJ,MAAmB;AACjB,WAAI4T,MAAMC,uBAAV,GAAUA,CAAV;AACAD,gCAEE,iCAAiCE,mBAFnCF,IAEmCE,CAFnCF;AAIAA;AACAA;AACAA;AAEAzgB;AACD;AAZH,IAAW,CAAX;AAcD;;AAED,mEAAkE;AAChE,OAAI4gB,aAAatpB,UAAjB,SAAiBA,CAAjB;AACAspB;;AAEAA,gBAAa,iGAIE,yBAAwB;AACnCtpB;AACA,SAAIupB,YAAYvpB,qBAAhB,YAAgBA,CAAhB;AACA,SAAIwpB,aAAa1pB,sBAAjB,SAAiBA,CAAjB;AACAA,wCAEEypB,yBAFFzpB;AARS,yBAAbwpB,QAAa,CAAbA;;AAgBAA;AACA;AACD;;AAED,KAAIG,iDAAiD,OAAO,eAAc;AACxEC;;AAEA,OAAI9mB,QAAQkP,IAAZ;;AAEAlP,iBAAc,aAAY;AACxB,SAAI0M,SAAJ;AACA,SAAID,oBAAoBC,iBAAxB,IAAwBA,EAAxB;;AAEA,SAAID,oBAAJ,GAA2B;AACzBC;AADF,YAEO;AACL,WAAID,oBAAJ,KAA6B;AAC3BC;AADF,cAEO;AACL;AACAC,wBAAeD,iBAAfC,MAAeD,EAAfC;AACAC;AACA,cAAK/C,KAAL,GAAaA,KAAb,mBAAqCA,MAArC,GAA8C;AAC5C,gBAAKC,KAAKD,KAAV,GAAkBC,KAAlB,mBAA0CA,MAA1C,GAAmD;AACjD,iBAAI9J,MAAM2M,aAAN3M,EAAM2M,CAAN3M,gBAAsC2M,aAA1C,EAA0CA,CAAtC3M,CAAJ,EAA6D;AAC3D4M;AACD;AACF;AACF;AACDF,sBAAa,mCAAmCD,oBAAhDC,CAAa,CAAbA;AACD;AACF;AAtBH1M;AALF,EAAqD,CAArD;;AA+BA,2DAA0D;AACxD;AACA;AACA;AACA;AACD;;AAED,kDAAiD;AAC/C,OAAI,iBAAJ,aAAkC;AAChC;AACD;AACD,OAAIe,UAAJ,oBAAkC;AAChC;AACD;AACD,OAAIA,UAAJ,oBAAkC;AAChC;AACD;;AAED,OAAIA,UAAJ,qBAAmC;AACjC;AACD;;AAED,UAAOgmB,YAAYA,UAAZA,KAAYA,CAAZA,GAAP;AACD;;AAGD,6GAQE;AACAnmB,aAAUA,WAAW;AACnBsE,gBADmB;AAEnB5C,UAFmB;AAGnBC,YAHmB;AAInBC,aAAQ,IAJW;AAKnBC,WAAM,IALa;AAMnB0C,gBANmB;AAOnBC,gBAPmB;AAQnBC,YARmB;AASnBC,aAAQ;AATW,IAArB1E;AAaD;;AAED,6GAQE;AACAA,aAAUA,WAAW;AACnBsE,gBADmB;AAEnB5C,UAFmB;AAGnBC,YAHmB;AAInBC,aAAQ,IAJW;AAKnBC,WAAM,IALa;AAMnB0C,gBANmB;AAOnBC,gBAPmB;AAQnBC,YARmB;AASnBC,aAAQ;AATW,IAArB1E;;AAYA,OAAIomB,sBAAJ,GAA6B;AAC3B;AACD;;AAED,OAAIC,cAAkBrmB,WAAWA,QAAjC,UAAiCA,CAAjC;AACA,OAAIsmB,kBAAkBtmB,WAAWA,QAAXA,iBAAWA,CAAXA,IAAtB;;AAIA,OAAIyE,QAAQzE,gBAAgBA,QAAhBA,OAA+BA,QAA3C;AACA,OAAI0E,SAAS1E,iBAAiBA,QAAjBA,MAA+BA,QAA5C;AACA;;AAEA,OAAI,CAAJ,QAAa;AACXumB,cAAS,sBAAe;AACtB,WAAIC,OAAOxkB,KAAX,WAAWA,EAAX;AAAA,WACEykB,kBAAkB,IADpB,IACoB,EADpB;AAAA,WAEEC,YAAY,IAFd,IAEc,EAFd;;AAIAD;AACAA;AACAC;;AAEA,WAAIC,UAAUhf,WAAW3F,kBAAX2F,KAAd;AACA8e,gCAAyBE,UAAzBF;AACAA;AACAC;;AAEAD,mCAA4BD,QAAQG,mBAApCF,CAA4BD,CAA5BC;AACAC,0BAAmBC,cAAnBD;AACAA;;AAEA,cAAO,CAAC,sBAAD,uBAAP,SAAO,CAAP;AAlBFH;;AAqBAK,gBAAW,uBAAsB,kBAAjCA,CAAiC,CAAjCA;AACD;;AAID,OAAIC,gBAAgB,0BAAa;AAC/B,SAAIL,OAAOjlB,EAAX,WAAWA,EAAX;AACA,SAAIolB,UAAUhf,WAAWpG,eAAXoG,KAAd;;AAEA,YAAO,mBAAP;AAJF;;AAOA,OAAI3H,WAAWA,QAAf,eAAeA,CAAf,EAA0C;AACxC6mB,qBAAgB7mB,QAAhB6mB,eAAgB7mB,CAAhB6mB;AACD;;AAED;;;;;;;;;;;;AAeA,OAAI9hB,IAAIvI,sBAAsB,IAA9B,KAA8B,CAAtBA,CAAR;;AAEA,OAAIwI,IAAI0G,oBAAoBlP,SAA5B,MAA4BA,EAA5B;;AAGA,OAAI,CAAJ,SAAc;AACZwI,kBAAc,SAAdA,CAAc,CAAdA;AADF,UAEO;AACLA,aAAQ,SAARA,CAAQ,CAARA;AACD;;AAED,OAAI8hB,QAAQtqB,4DAKEA,eALd,OAKcA,CALFA,CAAZ;;AAOA,sBAAmB;AACjBsqB;AACD;;AAED,OAAIC,QAAQ,iDAAiD,aAAa;AACxE,SAAIpmB,UAAJ,GAAiB;AAAE;AACf;AACH;AACD;AAJF,IAAY,CAAZ;;AAOA,OAAI8M,SAAJ;AACA,OAAIuZ,sBAAJ;AACA,OAAIC,WAAJ;AACA,OAAIC,cAAJ;AACA,OAAItiB,SAAS5E,WAAWA,QAAXA,QAAWA,CAAXA,GAA+BA,QAA/BA,QAA+BA,CAA/BA,GAAb;AACA,OAAImnB,UAAJ;;AAEA1qB,uBAAoB,wBAAuB;AACzC,SAAI2qB,UAAUb,OAAOc,MAArB,MAAqBA,CAAPd,CAAd;AACA,SAAI,EAAEa,cAAN,MAAI,CAAJ,EAA6B;AAC3B3Z,cAAO2Z,QAAP3Z,CAAO2Z,CAAP3Z,IAAqB,EAAE2P,MAAMgK,QAAR,CAAQA,CAAR,EAAoBriB,GAAGqiB,QAA5C3Z,CAA4C2Z,CAAvB,EAArB3Z;AACAA,cAAO2Z,QAAP3Z,CAAO2Z,CAAP3Z;AACAhR,qBAAc,gBAAe;AAC3B,aAAIwU,KAAJ,QAAiB;AACfxD,kBAAO2Z,QAAP3Z,CAAO2Z,CAAP3Z;AACD;AAHHhR;AAKD;;AAEDgR,YAAO2Z,QAAP3Z,CAAO2Z,CAAP3Z;AACA0Z,eAAUxf,kBAAkB8F,OAAO2Z,QAAP3Z,CAAO2Z,CAAP3Z,EAA5B0Z,QAA4B1Z,CAAlB9F,CAAVwf;;AAEA,SAAIniB,IAAJ;AACAA,mBAAc4L,QAAd5L;AACAvI,mBAAc,gBAAe;AAC3B,WAAIwU,KAAJ,QAAiB;AACfxD,gBAAO2Z,QAAP3Z,CAAO2Z,CAAP3Z,UAA2BA,OAAO2Z,QAAP3Z,CAAO2Z,CAAP3Z,UACvBA,OAAO2Z,QAAP3Z,CAAO2Z,CAAP3Z,UADuBA,IAA3BA;AAGA,aAAI,EAAEwD,KAAN,mBAAI,CAAJ,EAAiC;AAC/B+V;AACD;AACD,aAAIrmB,KAAKqmB,oBAAT,CAASA,CAAT,EAAiC;AAC/BA;AADF,gBAEO;AACLA;AACD;AACDG,mBAAUxf,kBAAkB8F,OAAO2Z,QAAP3Z,CAAO2Z,CAAP3Z,KAA5B0Z,CAA4B1Z,CAAlB9F,CAAVwf;AACAniB,gBAAOvI,QAAQuqB,oBAAfhiB,CAAegiB,CAARvqB,CAAPuI;AACD;AAfHvI;;AAkBA4qB;AACAA,qBAAgBD,QAAhBC,CAAgBD,CAAhBC;AApCF5qB;;AAuCA,OAAI6qB,eAAJ;AACA7qB,kBAAe,gBAAe;AAC5BkE;AACA2mB;AAFF7qB;;AAMA6qB,qBAAkB,gBAAe;AAC/B,YAAO1f,YAAYC,EAAZD,MAAYC,CAAZD,OAA4BA,aAAaC,EAAbD,MAAaC,CAAbD,OAA6B,CAAhE;AADF0f;;AAKA,oBAAiB;AACf,SAAI7qB,cAAJ,QAAIA,CAAJ,EAA8B;AAC5BA,4BAAqB,gBAAgB;AAC/B,aAAIqJ,IAAJ,GAAW;AACP8gB,sBAAWjf,mBAAoB,EAAEpG,YAAY+lB,aAAaxhB,IAAbwhB,GAA7CV,MAA6CU,CAAd,CAApB3f,CAAXif;AACH;AAHPnqB;AAKD;AACDmqB,gBAAWA,WARI,GAQfA,CARe,CAQY;AAC5B;;AAID,OAAIW,QAAQ,oBAAoB,aAAY;AAC1C,YAAOhmB,YAAYA,EAAZA,MAAYA,CAAZA,GAAwBA,EAAxBA,MAAwBA,CAAxBA,GAAoCA,EAA3C,MAA2CA,CAA3C;AADF,IAAY,CAAZ;AAGA,OAAIimB,QAAQ,oBAAoB,aAAY;AAC1C,YAAOjmB,YAAYA,EAAZA,MAAYA,CAAZA,GAAwBA,EAAxBA,MAAwBA,CAAxBA,GAAoCA,EAA3C,MAA2CA,CAA3C;AADF,IAAY,CAAZ;;AAIA,oBAAiB;AACd,SAAIkmB,SAAS,IAAb,IAAa,EAAb;AACAA,oBAAeD,kBAAfC;AACAD;AACF;;AAEDziB,YAAS,QAATA,KAAS,CAATA;AACAC,YACU,MAEN2C,WAAW2e,kBAAkBa,UAAlBb,IAAgCF,qBAH/CphB,GAGI2C,CAFM,CADV3C;;AAOA;;AAEA;;;;AAIAzB,4BA9MA,MA8MAA,GA9MA,CA8MmC;;AAEnC,OAAImkB,cAAcnkB,wCAId,gBACGvD,eAAeA,oBADlB,cAGGA,cAAcA,QAHjB,aAJJ,GAAkBuD,CAAlB;;AAWA,OAAI6X,MAAM7X,wCAEW,eAAevD,QAAf,aAAoCA,QAApC,MAFrB,GAAUuD,CAAV;;AAIA;;AAEA,OAAIokB,QAAQlrB,4BAAZ,CAAYA,CAAZ;;AAEA,OAAI+F,cACF,0BACAxC,QADA,WACAA,CADA,IAEA2nB,SAAS3nB,QAFT,WAESA,CAFT,GAGIA,qBAHJ,KAGIA,CAHJ,GAIIxD,SALN,UAKMA,EALN;;AAOAgG,iBAAc,oBAAoB,qBAAoB;AACpD,SAAI4U,OAAJ,UAAqB;AACrB,YAAOP,KAAP,GAAOA,CAAP;AAFFrU,IAAc,CAAdA;;AAKA,OAAIolB,aAAanrB,OAAOuqB,oBAAxB,KAAwBA,CAAPvqB,CAAjB;;AAEA,oBAAiB;AACf,SAAImrB,qBAAJ,GAA4B;AACxBA;AACH;AAHH,UAIO;AACLA;AACD;;AAEDA;;AAEA,OAAI5nB,WAAWA,QAAf,MAAeA,CAAf,EAAgC;AAC9B,SAAI8E,OAAOtI,YAAX,IAAWA,EAAX;AACAsI,qBAAgB,YAAW;AACzB9E,4BAAqBxD,SAArBwD;AACAA,4BAAqBxD,SAArBwD;AACAxD,yCAII,eAAewD,gBAAf,UAAyCA,gBAAzC,IAJJxD;AAHFsI;AAUAvB;AACD;;AAED,wCAAqC;AACnC,sBAAiB;AACb/G,oBACa,yBADbA,4BAEyBqrB,aAFzBrrB;AADJ,YAKO;AACHA,oBACa,yBADbA,4BAEyBqrB,eAFzBrrB;AAGH;AACDA,kBACa,0BADbA,4BAEyBqrB,aAFzBrrB;AAGD;;AAED,OAAI,gBAAgBorB,oBAAhB,KAAyCA,iBAA7C,UAAwE;;AAEpE,SAAIE,eAAeJ,gCAAnB,UAAmBA,CAAnB;;AAEAI;;AAGAA,yCAEQ,aAAY;AAChB,cAAO,CAAP,CAAO,CAAP;AAHJA,iDAOqB,mBAAkB;AACnC,cACE,eACA9nB,QADA,mBAGCA,qBAAqB4nB,wBAArB5nB,MACEA,oBAAoBA,QAJvB,SAGCA,CAHD,IADF;AARJ8nB,+CAkBsB9nB,QAlBtB8nB,gBAmBQ,aAAY;AAChB;AApBJA,wBAsBmB,aAAY;AAC3BC,sBAAenjB,SAAfmjB;AAvBJD,uBAyBkB,aAAY;AAC1BC,sBAAenjB,SAAfmjB;AA1BJD;;AA6BAA,yCAEQ,aAAY;AAChB,cAAO,CAAP,CAAO,CAAP;AAHJA,sDAQa,mBAAkB;AAC3B,cAAO9nB,qBAAqB4nB,wBAA5B,CAAO5nB,CAAP;AATJ8nB,sBAWiB9nB,QAXjB8nB,0BAYkB9nB,QAZlB8nB,+CAciB,mBAAkB;AAC/B,cAAOtlB,YAAP,CAAOA,CAAP;AAfJslB,wBAiBmB,aAAY;AAC3BC,sBAAenjB,SAAfmjB;AAlBJD,uBAoBkB,aAAY;AAC1BC,sBAAenjB,SAAfmjB;AArBJD;AAuBD;;AAEH,OAAIE,OAAOvrB,QAAQ2pB,YAAYA,qBAA/B,CAAmBA,CAAR3pB,CAAX;AACAurB,kBAAejjB,WAAfijB,CAAejjB,CAAfijB;AACA5B;;AAIA3pB,sBAAmB,yBAAwB;;AAGzC,SAAIwrB,aAAazlB,YAAjB,QAAiBA,CAAjB;AACA,SAAI0lB,aAAa,SAAbA,UAAa,IAAY;AAC3B;AACA,WAAIC,YAAY5mB,EAAhB,GAAgBA,CAAhB,EAAwB;AACtB,gBAAOA,OAAP,QAAOA,CAAP;AACD;AACD,WAAIomB,SAASpmB,EAAb,GAAaA,CAAb,EAAqB;AACnB,aAAI4mB,YAAY5mB,OAAhB,KAAgBA,CAAhB,EAA+B;AAC7B,kBAAOA,cAAP,QAAOA,CAAP;AACD;AACF;AACD;AAVF;;AAaA,SAAI6mB,eAAe,SAAfA,YAAe,IAAY;AAC7B,WAAIT,SAASQ,YAAY5mB,EAAzB,KAAyBA,CAAzB,EAAmC;AACjC,gBAAOA,SAAP,QAAOA,CAAP;AADF,cAEO;AACL,aAAI4mB,YAAJ,GAAmB;AACjB,kBAAO5mB,EAAP,QAAOA,CAAP;AACD;AACF;AACD;AARF;;AAWA,SAAI,CAAJ,iBAAsB;AACpB,WAAI8mB,QAAQ,gBAEP,aAAY;AACb,gBAAOtjB,EAAExD,EAAT,MAASA,CAAFwD,CAAP;AAHQ,aAKN,aAAY;AACd,gBAAOC,EAAEkjB,WAAT,CAASA,CAAFljB,CAAP;AANQ,aAQN,aAAY;AACd,gBAAOA,EAAP,CAAOA,CAAP;AATQ,sBAAZ,MAAY,CAAZ;;AAaAoW,+JAOuBxW,SAPvBwW;AAQD;;AAID,sBAAiB;AACbkM,4BAAqB,aAAY;AAC7B,aAAIgB,KAAK,IAAT,IAAS,EAAT;AACAA,oBAAW/mB,sBAAsBqlB,WAAjC0B;AACA,aAAIC,MAAM,IAAV,IAAU,EAAV;AACAA,qBAAYhnB,sBAAsBqlB,WAAlC2B;AACA,aAAIC,KAAKzjB,EAAT,EAASA,CAAT;AACA,aAAI0jB,IAAI1jB,SAASA,EAAjB,EAAiBA,CAAjB;AACA,aAAI2jB,SAAU,YAAD,CAAC,GAAiBnnB,EAAlB,QAAkBA,CAAjB,GAAd;AACA,aAAIonB,QAAQP,aAAZ,CAAYA,CAAZ;AACAhN,oDAEepW,EAAE0jB,SAFjBtN,KAEepW,CAFfoW,iBAGqBpW,OAAOA,EAH5BoW,KAG4BpW,CAH5BoW,uCAI0CxW,SAJ1CwW,4EAOoB5e,0BAPpB4e,CAOoB5e,CAPpB4e,gDAS2B+M,yCAClBtB,gBAAgBA,cAActlB,EAA9BslB,MAA8BtlB,CAAdslB,CAAhBA,GAA2CtlB,EAVpD6Z,MAUoD7Z,CADzB4mB,CAT3B/M;;AAYA7Z,uBAAc,CAACA,cAAcA,EAAdA,QAAcA,CAAdA,GAAD,KAAdA;AArBJ+lB;AADJ,YAyBO;;AAEHA,4BAAqB,aAAY;AAC/BlM,yCAEcrW,EAAExD,EAFhB6Z,MAEgB7Z,CAAFwD,CAFdqW,aAGcpW,EAAEojB,aAHhBhN,CAGgBgN,CAAFpjB,CAHdoW,2GAQiB+M,mBAAmBC,aARpChN,CAQoCgN,CARpChN;AADFkM;;AAYA,WAAIsB,aAAa,gBAEZ,aAAY;AACb,gBAAO7jB,EAAExD,EAAT,MAASA,CAAFwD,CAAP;AAHa,YAKZ,aAAY;AACb,gBAAOC,EAAEojB,aAAT,CAASA,CAAFpjB,CAAP;AANa,sBAAjB,UAAiB,CAAjB;;AAUAoW,6IAMwBxW,SANxBwW;AAOH;AA9GH3e;;AAiHA;AACA,OAAIosB,SAASzN,0DAGQ,0BAHRA,wBAISpb,QAJTob,gBAAb,KAAaA,CAAb;;AAOAyN;;AAMAA,mCAEapkB,QAFbokB,yEAKsB7oB,oBALtB6oB;;AAQA;AACAzN,8DAGsBpb,QAHtBob,yDAMsBpb,oBANtBob;AAUE;AAVFA,qCAreA,OAqeAA,EAreA,CAifkB;AACnB;;AAED7e;AACAA;AACAA;AACAA;AACAA;AACAA;AACAA;AACAA;AACAA;AACAA;AACAA;AACAA;AACAA;AACAA;AACAA;AACAA;AACAA,kE;;;;;;;;;ACjsCA,KAAIusB,WAAW,mBAAA3sB,CAAf,EAAeA,CAAf;;AAEA,KAAI4sB,yBAAyB,SAAzBA,sBAAyB,MAAc;AACzC7jB;AACAA;AAFF;;AAKA,6CAA4C;AAC1C,OAAI8jB,MAAM,IAAV,KAAU,EAAV;;AAEAA;;AAEAA,gBAAa,kBAAkB;AAC7B,SAAIC,SAASrD,wBAAb,oBAAaA,CAAb;AACAqD,oBAAeD,IAAfC;AACAA,qBAAgBD,IAAhBC;;AAEA,SAAIC,MAAMD,kBAAV,IAAUA,CAAV;AACAC;AACAA,wBAAmBD,OAAnBC,OAAiCD,OAAjCC;AACAA,8BAAyBD,OAAzBC,OAAuCD,OAAvCC;;AAEA,SAAID,OAAJ,UAAqB;AACnB,WAAIE,OAAOF,gBAAX,SAAWA,CAAX;AACAG;AACAltB;AAHF,YAIO;AACL+sB;AACD;AAhBHD;;AAmBAA;AACD;;AAED,KAAIK,+BAA+B,SAA/BA,4BAA+B,OAAe;AAChDtX,UAAOvV,cAAPuV,IAAOvV,CAAPuV;AACA,OAAIA,SAAJ,MAAmB;AACjB,SAAI4T,MAAMC,uBAAV,GAAUA,CAAV;AACAD,8BAEE,iCAAiCE,mBAFnCF,IAEmCE,CAFnCF;AAIAA;AACAA;AACAA;AAEAzgB;AACAygB;AACAA;AACD;AAfH;;AAkBA,KAAI2D,wBAAwB,SAAxBA,qBAAwB,kBAA0B;AACpD,OAAI1kB,SAAS;AACX2kB,YADW;AAEXC,YAFW;AAGXpO,UAAK;AAHM,IAAb;;AAMA,4BAAyB;AACvB,qCAAgC;AAC9B,WAAI;AACF,aAAIqO,GAAJ,UAAiB;AACf,gBAAK,IAAI3jB,IAAT,GAAgBA,IAAI2jB,YAApB,aAA6C;AAC3C,iBAAIC,OAAOD,YAAX,CAAWA,CAAX;AACA,iBAAIC,cAAJ,GAAqB;AACnB;AACAC,kCAAmBD,KAAnBC;AAFF,oBAGO;AACL;AACA,mBAAID,KAAJ,cAAuB;AACrB,qBAAIA,mCAAmC,CAAvC,GAA2C;AACzCE,6BAAU,OAAOF,KAAjBE;AACD;AACF;AACF;AACF;AACF;AAhBH,SAiBE,UAAU;AACVtqB,qBAAY,oCAAZA;AACD;AACF;;AAED,SAAIsqB,SAAJ;AAAA,SACEC,cAAcC,IADhB;;AAGA,sBAAiB;AACf,YAAK,IAAIhkB,IAAT,GAAgBA,IAAI+jB,YAApB,aAA6C;AAC3CF,4BAAmBE,YAAnBF,CAAmBE,CAAnBF;AACD;AACF;;AAED;AACD;;AAED,OAAII,qBAAqB,SAArBA,kBAAqB,eAAuB;AAC9C,SAAIC,QAAQpE,wBAAZ,mBAAYA,CAAZ;;AAEAoE,oBAAe,YAAW;AACxB,WAAIf,SAASrD,wBAAb,oBAAaA,CAAb;AACAqD,sBAAee,MAAff;AACAA,uBAAgBe,MAAhBf;AACA,WAAIgB,UAAUhB,kBAAd,IAAcA,CAAd;AACAgB;AACAA,8BAAuBD,MAAvBC,OAAoCD,MAApCC;AACAA;AACA,WAAIjB,MAAMC,iBAAV,WAAUA,CAAV;AACA,WAAItD,MAAMC,uBAAV,GAAUA,CAAV;AACAD;AACAA,kBAAWsD,iBAAXtD,WAAWsD,CAAXtD;AACAzgB;AACAygB;AACAA;AAdFqE;;AAiBAA;AApBF;;AAuBA,OAAI5O,MAAMlW,yBAAV,CAAUA,CAAV;AACA,OAAI,CAAJ,KAAU;AACRkW,WAAMlW,aAANkW,CAAMlW,CAANkW;AACD;;AAED,OAAIwO,SAASM,WAAWhuB,OAAxB,QAAaguB,CAAb;;AAEA9O;;AAEA,OAAI+O,SAASvE,uBAAb,MAAaA,CAAb;AACAxK,4BAAyBA,IAAzBA;;AAEA,OAAIgP,UAAUxE,uBAAd,OAAcA,CAAd;AACAuE;AACAC;;AAEA;AACAhP;AACAA;;AAEA;AACA,OAAI,CAACA,mBAAmBxW,OAAnBwW,OAAL,OAAKA,CAAL,EAAgD;AAC9CA,wBAAmBxW,OAAnBwW,gBAA0CxW,OAA1CwW;AACD;;AAED,OAAI,CAACA,mBAAmBxW,OAAnBwW,OAAL,aAAKA,CAAL,EAAsD;AACpDA,wBAAmBxW,OAAnBwW,sBAAgDxW,OAAhDwW;AACD;;AAED,OAAI0D,SAAS,+DAEU,uBAFvB,aAAa,CAAb;AAGA,OAAIuL,OAAOjP,IAAX,qBAAWA,EAAX;AACA,OAAIkP,UAAJ;AAEA,OAAIC,cAAc,CAACD,UAAnB,MAAkB,CAAlB;AACA,OAAIE,eACF,+BAA+B3E,mBADjC,WACiCA,CADjC;;AAGA,OAAI4E,UAAJ,YAA0B;AACxB;AACA3B;AAFF,UAGO,IAAIxmB,QAAJ,OAAmB;AACxBooB,6BAEE,gBAAe;AACb,WAAIC,MAAMzuB,2BAAV,IAAUA,CAAV;AACA,WAAIypB,MAAMC,uBAAV,GAAUA,CAAV;AACAD;AACAA;AACAzgB;AACAygB;AACAA;AATJ+E,QAWE,iBAAgB;AACdprB;AAZJorB;AADK,UAgBA;AACL,SAAI/E,MAAMC,uBAAV,GAAUA,CAAV;AACAD;AACAA;AACAzgB;AACAygB;AACAA;AACD;AAnIH;;AAsIA,KAAIiF,2BAA2B,SAA3BA,wBAA2B,GAAW;AACxC;AACA,OAAI1lB,yBAAJ,GAAgC;AAC9BA;AACAA;AACAA;;AAEAK,uBAAkB;AAChBslB,cADgB;AAEhBC,aAAM;AAFU,MAAlBvlB,cAGeL,EAHfK,IAGeL,CAHfK;AALF,UASO,IAAIwlB,MAAM5d,WAAWjI,QAArB,GAAqBA,EAAXiI,CAAN4d,CAAJ,EAAsC;AAC3C7lB;AACAA;AACAA;;AAEAK,uBAAkB;AAChBslB,cADgB;AAEhBC,aAAM;AAFU,MAAlBvlB,cAGeL,EAHfK,IAGeL,CAHfK;AALK,UASA;AACLL;AACAA;AACAA;AACD;AAxBH;;AA2BA,qCAAoC;AAClC,OAAI0kB,SAAJ;AAAA,OACEC,cAAcC,IADhB;;AAGA,oBAAiB;AACf,UAAK,IAAIhkB,IAAT,GAAgBA,IAAI+jB,YAApB,aAA6C;AAC3CmB,yBAAkBnB,YAAlBmB,CAAkBnB,CAAlBmB;AACD;AACF;;AAED,kCAA+B;AAC7B,SAAIvB,GAAJ,UAAiB;AACf,YAAK,IAAI3jB,IAAT,GAAgBA,IAAI2jB,YAApB,aAA6C;AAC3C,aAAIC,OAAOD,YAAX,CAAWA,CAAX;AACA,aAAIC,cAAJ,GAAqB;AACnB;AACAsB,6BAAkBtB,KAAlBsB;AAFF,gBAGO;AACL;AACA,eAAItB,KAAJ,cAAuB;AACrB,iBAAIA,mCAAmC,CAAvC,GAA2C;AACzCE,yBAAU,OAAOF,KAAjBE;AACD;AACF;AACF;AACF;AACF;AACF;AACD;AACD;;AAED,2CAA0C;AACxC,OAAIqB,sBAAJ;AACA,OAAIC,MAAMhmB,4BAAV,MAAUA,CAAV;AACA,OAAIygB,MAAMC,uBAAV,GAAUA,CAAV;AACAD,4BAEE,0CAA0CE,mBAF5CF,GAE4CE,CAF5CF;AAIAA;AACAzgB;AACAygB;AACAA;AACD;;AAED,sDAAqD;AACnD,OAAIqE,QAAQpE,wBAAZ,OAAYA,CAAZ;AACAoE;;AAEAA,kBAAe,YAAW;AACxB,SAAIf,SAASrD,wBAAb,QAAaA,CAAb;AACAqD,oBAAee,MAAff;AACAA,qBAAgBe,MAAhBf;AACA,SAAIgB,UAAUhB,kBAAd,IAAcA,CAAd;AACAgB;AACAA,4BAAuBD,MAAvBC,OAAoCD,MAApCC;AACAA;AACA,SAAIjB,MAAMC,iBAAV,WAAUA,CAAV;;AAEA,SAAItD,MAAMC,uBAAV,GAAUA,CAAV;AACAD;AACAA,gBAAWsD,iBAAXtD,WAAWsD,CAAXtD;AACAzgB;AACAygB;AACAA;AAfFqE;AAiBD;;AAED,4CAA2C;AACzC,OAAIplB,SAAS;AACX2kB,YADW;AAEXC,YAFW;AAGXpO,UAAK;AAHM,IAAb;;AAMA,OAAI+P,iBAAJ;AACA,OAAI/P,MAAMlW,iCAAV,CAAUA,CAAV;AACA,OAAI0kB,SAASwB,sBAAsBlvB,OAAnC,QAAakvB,CAAb;;AAEAhQ;;AAEA,OAAI+O,SAASvE,uBAAb,MAAaA,CAAb;AACAxK,4BAAyBA,IAAzBA;;AAEA,OAAIgP,UAAUxE,uBAAd,OAAcA,CAAd;AACAuE;AACAC;;AAEA;AACAhP;AACAA;;AAEA;AACA,OAAI,CAACA,mBAAmBxW,OAAnBwW,OAAL,OAAKA,CAAL,EAAgD;AAC9CA,wBAAmBxW,OAAnBwW,gBAA0CxW,OAA1CwW;AACD;;AAED,OAAI,CAACA,mBAAmBxW,OAAnBwW,OAAL,aAAKA,CAAL,EAAsD;AACpDA,wBAAmBxW,OAAnBwW,sBAAgDxW,OAAhDwW;AACD;;AAED,OAAI0D,SAAS,+DAEU,uBAFvB,aAAa,CAAb;AAGA,OAAIuL,OAAOjP,IAAX,qBAAWA,EAAX;AACA,OAAIkP,UAAJ;AAEA,OAAIC,cAAc,CAACD,UAAnB,MAAkB,CAAlB;AACA,OAAIE,eACF,+BAA+B3E,mBADjC,WACiCA,CADjC;;AAGA,OAAIvjB,QAAJ,OAAmB;AACjB+oB;AADF,UAEO;AACL,SAAI1F,MAAMC,uBAAV,GAAUA,CAAV;AACAD;AACAA;AACAzgB;AACAygB;AACAA;AACD;AACF;;AAED,2CAA0C;AACxC,OAAIzgB,8CAAJ,SAA2D;AACzD,SAAIomB,QAAJ;AACA,SAAIA,WAAWpmB,mCAAf,GAAeA,EAAXomB,CAAJ,EAA0D;AACxD;AACApmB;AACAA;AACAA;AAJF,YAKO;AACLA;AACAA;AACAA;AACAA;AACA,WAAIqmB,OAAO,kBAAkB;AAC3BV,gBAD2B;AAE3BC,eAAM;AAFqB,QAAlB,cAGI5lB,EAHf,IAGeA,CAHJ,CAAX;AAID;AAhBH,UAiBO;AACLA;AACAA;AACAA;AACD;AACF;;AAED,sDAAqD;AACnD,OAAI3D,IAAJ;;AAEA,OAAIiqB,OAAJ,QAAmB;AACjBA,iBAAYhvB,GAAZgvB;;AAEA,SAAIjqB,IAAI;AACNkqB,YAAKjvB,OADC,MACDA,CADC;AAENkvB,YAAKlvB,OAFC,MAEDA,CAFC;AAGNmvB,eAAQnvB,UAHF,MAGEA,CAHF;AAINovB,WAAIpvB,oBAJE,IAIFA,CAJE;AAKNqvB,WAAIrvB,oBALE,IAKFA,CALE;AAMNqT,aAAMrT;AANA,MAAR;AAHF,UAWO;AACL,SAAI+E,IAAI;AACNkqB,YADM;AAENC,YAFM;AAGNC,eAHM;AAINC,WAJM;AAKNC,WALM;AAMNhc,aAAM;AANA,MAAR;AAQD;;AAED,gBAAa;AACXtO,SACE,kBACAA,EADA,KACAA,CADA,SAGAA,EAHA,KAGAA,CAHA,uBAMAA,EANA,IAMAA,CANA,SAQAA,EARA,IAQAA,CARA,uBAWAA,EAXA,MAWAA,CAXA,uBAcAA,EAdA,QAcAA,CAdA,UADFA;;AAmBA;;;;;;AAMD;;AAED;AACD;;AAED,8DAA6D;AAC3D,0BAAuB;AACrB,SAAIuqB,KAAK5vB,iBAAT;AACA,SAAI6vB,OAAOD,WAAX,OAAWA,CAAX;AACA,SAAIC,YAAY,CAAC,CAACtB,0BAAlB,mBAAkBA,CAAlB,EAAkE;AAChE;AACD;AACD;AACD;;AAED,sBAAmB;AACjB,SAAIuB,WAAW9vB,OAAf,IAAeA,EAAf;AACA8vB;AACAA;AACAA,mDAA8CC,WAA9CD;AACAA;AALF,UAMO;AACL,SAAIrG,MAAMC,uBAAV,GAAUA,CAAV;AACAD,8BAEE,WACGuG,YADH,oCAGErG,mBALJF,IAKIE,CALJF;AAOAA,kCAA6BsG,YAA7BtG;AACAA;AACAA;AACD;AACF;;AAED,kDAAiD;AAC/CwG,SAAMA,OAANA;AACA,OAAIC,aAAJ;AACA,OAAIC,eAAe,SAAfA,YAAe,IAAa;AAC9B,SAAIC,gBAAgB9vB,uBAApB,iBAAoBA,CAApB;AACA,SAAI,CAAC8vB,cAAL,KAAKA,EAAL,EAA4B;AACxB,cAAO9vB,UAAU8vB,cAAV9vB,IAAU8vB,EAAV9vB,EAAP,IAAOA,EAAP;AADJ,YAEO;AACH,cAAOA,aAAP,IAAOA,EAAP;AACH;AANH;;AASAA,gBAAa+vB,WAAb/vB,kBAA0C,YAAW;AACnD4vB,qBAAgBC,aAAhBD,IAAgBC,CAAhBD;AADF5vB;AAGA,OAAIgwB,YAAJ;AACAhwB,aAAU+vB,WAAV/vB,+BAAqD,gBAAe;AAClEgwB;AACAhwB,0CAAqC,YAAW;AAC9CgwB,yBAAkBH,aAAlBG,IAAkBH,CAAlBG;AADFhwB;AAFFA;;AAOA,UACE4vB,8BAEA,cACO,aAAY;AACf,YAAO7qB,OAAP,GAAOA,CAAP;AAFJ,WAHF,IAGE,CAHF;AASD;;AAED,mCAAkC;AAChC,OAAIsE,WAAJ,GAAkB;AAChB,YAAOA,qBAAqBA,QAA5B,CAA4BA,CAA5B;AADF,UAEO;AACL;AACD;AACF;;AAED,4CAA2C;AACzC,OAAI;AACF,YAAOpJ,aAAP;AADF,KAEE,UAAU;AACV;AACD;AACD;AACD;;AAED,2CAA0C;AACxCgwB,cACEA,YACA,iBAAgB;AACd;AAHJA;AAKA,UAAO,iBAEL,6BAA4B;AAC1B,YAAOxR,MAAMwR,gBAAb,KAAaA,CAAb;AAHG,MAAP,CAAO,CAAP;AAOD;;AAED,uDAAsD;AACpD,OAAI;AACF,YAAO,eAAe3sB,KAAf,YAAeA,CAAf,EAAmC,iBAAgB;AACxD,cAAOK,qBAAP;AADF,MAAO,CAAP;AADF,KAIE,UAAU;AACV;AACD;AACD;AACD;;AAED,2DAA0D;AACxD,OAAI6M,SAAJ;AACA0f,eAAYjwB,kBAAZiwB,OAAYjwB,CAAZiwB;AACAjwB,gBAEE,OAAO,sBAAqB;AAC1B,SAAIiwB,iBAAJ,GAAIA,CAAJ,EAA2B;AACzB1f;AACD;AAHH,MAFFvQ,OAEE,CAFFA;AAQA;AACD;;AAED,wDAAuD;AACrD,OAAIuQ,SAAJ;AACA2f,eAAYlwB,kBAAZkwB,OAAYlwB,CAAZkwB;AACAlwB,gBAEE,OAAO,sBAAqB;AAC1BuQ,mBAAc2f,iBAAd3f,GAAc2f,CAAd3f;AADF,MAFFvQ,OAEE,CAFFA;AAMA;AACD;;AAEDF;AACAA;AACAA;AACAA;;AAEAA;AACAA;AACAA;AACAA;AACAA;AACAA;AACAA;AACAA;AACAA;AACAA;AACAA;AACAA;AACAA,0C;;;;;;;ACxjBA,iIAAgC;AAChC;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,GAAE;AACF;AACA;AACA;AACA;AACA,GAAE;AACF;AACA;AACA;AACA,EAAC;;AAED;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,2BAA0B,kBAAkB;AAC5C;AACA;AACA;AACA;AACA;;AAEA,6BAA4B;AAC5B;AACA;AACA;AACA;;;AAGA,+BAA8B;AAC9B;AACA,sBAAqB;AACrB,0CAAyC;AACzC;AACA;AACA;AACA,oC;AACA;AACA;AACA,iCAAgC,cAAc,KAAK;AACnD;AACA,KAAI;AACJ,IAAG;;;AAGH;AACA,oCAAmC;;AAEnC;AACA;AACA;AACA,KAAI,K;AACJ;AACA;AACA,sBAAqB;AACrB;;AAEA,IAAG,KAAK;AACR,sC;AACA;AACA,WAAU,KAAK;AACf,uCAAsC,eAAe;AACrD,K;AACA;AACA;AACA;AACA,2BAA0B,eAAe;;;AAGzC;AACA,gCAA+B;AAC/B;AACA;AACA;AACA;AACA;AACA;;AAEA,UAAS,KAAK;;AAEd,gCAA+B,WAAW;AAC1C;;AAEA;;AAEA,+BAA8B;AAC9B;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,yBAAwB,sBAAsB,wCAAwC;AACtF,MAAK;AACL;AACA;;AAEA;AACA;AACA;AACA,2BAA0B;AAC1B,oHAAmH,mBAAmB;AACtI;AACA;AACA;;AAEA;AACA;AACA;;AAEA,uCAAsC;AACtC;AACA;AACA;AACA,0BAAyB,8BAA8B,EAAE;;AAEzD,IAAG;;;;;AAKH,8BAA6B;AAC7B;AACA;;AAEA,gBAAe;AACf;AACA,IAAG;AACH;AACA;AACA;AACA,8CAA6C;AAC7C,MAAK;AACL;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAG;AACH,EAAC;;;;;;;;;ACtKD,KAAIC,KAAK,mBAAAL,CAAT,EAASA,CAAT;AAAA,KACEM,IAAI,mBAAAN,CADN,EACMA,CADN;;AAGA,uEAAsE;AACpE,OAAIoB,yBAAyBf,eAA7B,WAA6BA,CAA7B;AACA,OAAIY,sBAAsBZ,UAA1B,MAA0BA,CAA1B;AACA,OAAIgB,8BAA8BhB,eAAlC,OAAkCA,CAAlC;;AAEA,OAAIowB,SAAS;AACTlrB,UADS;AAETC,YAFS;AAGTC,aAHS;AAITC,WAAM;AAJG,IAAb;AAAA,OAME4C,QAAQgkB,IAAImE,OAAJnE,OAAkBmE,OAN5B;AAAA,OAOEloB,SAASmoB,IAAID,OAAJC,MAAiBD,OAP5B;;AASA,OAAI7nB,IAAI,CAAC+nB,QAAQtwB,QAARswB,KAAQtwB,EAARswB,GAA0BtwB,SAA3B,MAA2BA,EAA3B,SAEJ,kBAAkB,aAAY;AAC5B,YAAOwT,EAAP;AAHE,IAEJ,CAFI,QAMC,IANT,KAMS,CAND,CAAR;;AAQA,OAAIhL,IAAI,CAAC8nB,QAAQtwB,QAARswB,KAAQtwB,EAARswB,GAA0BtwB,SAA3B,MAA2BA,EAA3B,SAEJ,kBAAkB,aAAY;AAC5B,YAAOwT,EAAP;AAHE,IAEJ,CAFI,QAMC,SANT,CAMS,CAND,CAAR;;AAQA,OAAI8W,QAAQtqB,mDAIEswB,sCAJd,mBAAYtwB,CAAZ;;AAMA,OAAIuqB,QAAQvqB,iDAIEswB,sCAJd,mBAAYtwB,CAAZ;;AAMA,OAAIuwB,gBAAgBvwB,wBAApB,KAAoBA,CAApB;;AAEA,OAAI,CAACuwB,cAAL,KAAKA,EAAL,EAA4B;AAC1BA;AACD;;AAEDA,mBAAgBvwB,6FAMK,eAAeowB,OAAf,aAAmCA,OAAnC,MANrBG,GAAgBvwB,CAAhBuwB;;AAQAjW,YAASiW,uCAATjW,MAASiW,CAATjW;AACAA;;AAEAA,qBACc,aAAY;AACtB,YAAO/R,EAAExD,EAAT,CAAOwD,CAAP;AAFJ+R,iBAIc,aAAY;AACtB,YAAO9R,EAAEzD,EAAT,CAAOyD,CAAP;AALJ8R;;AAUAA,eAAY,aAAY;AACtB,SAAI,WAAJ,GAAkB;AAChBta,4CAAqC+E,EAArC/E;AACD;AAHHsa;;AAMA,OAAI+R,SAASkE,oEAGQ,0BAHRA,UAAb,KAAaA,CAAb;;AAMAlE;AAMAA,8BAEQrW,OAFRqW,qBAGqB,uBAHrBA;;AAOA,OAAImE,SAASD,oEAGQ,qBAHRA,UAAb,KAAaA,CAAb;;AAMAC;AAMAA,8BAEQxa,OAFRwa;AAMD;;AAEDzwB,0D;;;;;;ACrHA;;AAEA,+CAA8C,cAAc;;AAE5D;AACA;AACA;;;;AAIA,qDAAoD,oCAAoC,EAAE;AAC1F,qDAAoD,oCAAoC,EAAE;AAC1F,uDAAsD,sCAAsC,EAAE;;;;;;;ACZ9F;AACA;AACA;AACA;AACA,mDAAkD;AAClD,EAAC,4BAA4B;;AAE7B;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA,qEAAoE;AACpE,8CAA6C;AAC7C,2DAA0D;AAC1D;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAG;;AAEH;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA,UAAS,mEAAmE,+BAA+B,EAAE;AAC7G;AACA;;AAEA;AACA;AACA;AACA,6CAA4C;AAC5C;AACA,wCAAuC;AACvC,yBAAwB;AACxB,UAAS;AACT;;AAEA;AACA;AACA;;AAEA;AACA;AACA,4DAA2D,OAAO;AAClE;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA,qCAAoC,OAAO;AAC3C,mDAAkD;AAClD;AACA;;AAEA;AACA;AACA,sDAAqD;AACrD;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA,0CAAyC;AACzC,wDAAuD;AACvD,iEAAgE;AAChE,qDAAoD;AACpD,8DAA6D;AAC7D,qDAAoD;AACpD,8DAA6D;AAC7D;AACA;AACA,aAAY;AACZ;;AAEA;AACA;;AAEA;AACA,wBAAuB;AACvB,2BAA0B;AAC1B,yBAAwB;AACxB;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,IAAG;;AAEH;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,QAAO;AACP;AACA;AACA,MAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA,QAAO;AACP;AACA;AACA,MAAK;AACL;AACA;AACA;AACA,IAAG;;AAEH;AACA;AACA,oEAAmE,gCAAgC,EAAE;AACrG;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,8BAA6B,kCAAkC,EAAE;AACjE;AACA;AACA;;AAEA;AACA;AACA,6BAA4B,wDAAwD,EAAE;;AAEtF;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA,+DAA8D,OAAO;AACrE,WAAU;AACV;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA,mDAAkD,cAAc;AAChE;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA,iEAAgE;AAChE,2CAA0C;AAC1C,gEAA+D;AAC/D,6CAA4C;AAC5C;AACA;;AAEA;;AAEA;AACA,0BAAyB,uBAAuB;AAChD,0BAAyB,0EAA0E,EAAE;;AAErG;AACA;;AAEA;AACA;AACA;AACA,yBAAwB;AACxB;;AAEA;AACA;AACA;;AAEA;AACA,yBAAwB;AACxB;AACA;;AAEA;;AAEA;AACA;AACA,iEAAgE;AAChE,uCAAsC;AACtC,oDAAmD;AACnD;AACA;;AAEA;AACA;AACA;AACA;AACA,QAAO;AACP,MAAK;AACL;AACA;;AAEA;AACA,6CAA4C,8BAA8B;AAC1E;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,cAAa;AACb,YAAW;AACX,UAAS;AACT;AACA;AACA,IAAG;;AAEH;AACA;AACA,IAAG;;AAEH;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,YAAW;AACX,UAAS;AACT,QAAO;;AAEP;AACA;;AAEA;AACA;AACA;AACA;AACA,kDAAiD,OAAO;AACxD;AACA;AACA;AACA;AACA;;AAEA;AACA,MAAK;AACL;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,wBAAuB;AACvB,2CAA0C,WAAW,EAAE;;AAEvD;AACA;AACA;AACA;AACA;AACA;AACA,MAAK;AACL;;AAEA;AACA,iCAAgC,cAAc,EAAE;AAChD;;AAEA;AACA,4EAA2E,gBAAgB,EAAE;AAC7F;AACA;;AAEA;AACA;AACA;AACA;AACA,sCAAqC,6BAA6B,iBAAiB,EAAE,EAAE;AACvF;;AAEA;;AAEA;AACA,mEAAkE,OAAO;AACzE,0BAAyB,OAAO;AAChC;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA,kBAAiB;AACjB,IAAG;AACH;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA,4CAA2C,gFAAgF;AAC3H,+BAA8B,8DAA8D;AAC5F,oCAAmC,uEAAuE;AAC1G;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,kEAAiE;AACjE;AACA,0EAAyE;AACzE,uCAAsC;AACtC;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,+CAA8C,cAAc;;AAE5D,EAAC;;;;;;;ACxfD;AACA;AACA;AACA;AACA,mDAAkD;AAClD,EAAC,4BAA4B;;AAE7B;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA,sCAAqC,qCAAqC,EAAE;AAC5E,yBAAwB,2BAA2B,EAAE;AACrD,8BAA6B,mCAAmC,EAAE;AAClE,8BAA6B,mBAAmB,EAAE;AAClD,mCAAkC,2BAA2B,EAAE;AAC/D,2BAA0B,2BAA2B,EAAE;AACvD,gCAA+B,gCAAgC;AAC/D;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA,kBAAiB,UAAU;AAC3B;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA,sCAAqC,OAAO;AAC5C;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA,kBAAiB,UAAU;AAC3B;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA,yCAAwC,OAAO;AAC/C;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,6CAA4C,IAAI;AAChD,8BAA6B,IAAI,KAAK,IAAI;AAC1C;AACA;AACA,oBAAmB,IAAI;AACvB,qDAAoD;AACpD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,sCAAqC,OAAO;AAC5C;AACA;;AAEA,gCAA+B,OAAO;AACtC;AACA;AACA;AACA;AACA;AACA,wDAAuD;AACvD;AACA;AACA;AACA,qDAAoD;AACpD;;AAEA,sCAAqC,OAAO;AAC5C;AACA;;AAEA,gCAA+B,OAAO;AACtC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,oDAAmD;AACnD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAK;AACL;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA,4CAA2C,OAAO;AAClD;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;;AAEA;AACA,sCAAqC,OAAO;AAC5C;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,gCAA+B,OAAO;AACtC;AACA;AACA;AACA;AACA;AACA,iBAAgB;AAChB;AACA;AACA;AACA;AACA;;AAEA,gCAA+B,OAAO;AACtC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,mBAAkB;AAClB;AACA;AACA,UAAS,OAAO;AAChB;AACA;AACA;AACA,+BAA8B,YAAY;AAC1C;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA,oDAAmD,aAAa;AAChE;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA,gCAA+B,OAAO;AACtC,qBAAoB;AACpB;AACA,gCAA+B,OAAO;AACtC,qBAAoB;AACpB;;AAEA;AACA;;AAEA,gCAA+B,OAAO;AACtC;AACA;AACA;AACA,MAAK;AACL;;AAEA,gCAA+B,OAAO;AACtC;AACA,qBAAoB;AACpB;AACA;AACA,QAAO;AACP,MAAK;AACL;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA,wCAAuC,OAAO;AAC9C;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA,sCAAqC,OAAO;AAC5C;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,wCAAuC;AACvC,oCAAmC;AACnC;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,sCAAqC,OAAO;AAC5C;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA,sCAAqC,OAAO;AAC5C;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,oCAAmC;AACnC;AACA;;AAEA;AACA;AACA;AACA;AACA,WAAU,UAAU;AACpB;AACA;;AAEA;AACA;AACA;AACA;AACA,WAAU,UAAU;AACpB;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,oBAAmB,OAAO;AAC1B;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,oBAAmB,OAAO;AAC1B;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA,oCAAmC;;AAEnC;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA,sCAAqC,uCAAuC,EAAE;AAC9E,8BAA6B,8BAA8B,EAAE;AAC7D,mCAAkC,kCAAkC,EAAE;AACtE,2BAA0B,kCAAkC,EAAE;AAC9D,gCAA+B,uCAAuC;AACtE;;AAEA;AACA,qCAAoC,OAAO;AAC3C,gBAAe;AACf;AACA;AACA;;AAEA;AACA,qCAAoC,OAAO;AAC3C,gBAAe;AACf;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,wDAAuD,WAAW;AAClE,iBAAgB,mBAAmB;AACnC;AACA;AACA,mBAAkB;AAClB;AACA;AACA;;AAEA;AACA,2BAA0B;AAC1B;AACA;AACA;AACA;;AAEA;AACA,iBAAgB;AAChB;AACA;AACA;;AAEA;AACA,qDAAoD;AACpD;AACA;AACA,kCAAiC,sCAAsC,OAAO;AAC9E;AACA;;AAEA;AACA,8BAA6B;AAC7B,uDAAsD;AACtD,kEAAiE;AACjE,UAAS,2CAA2C;AACpD;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,gEAA+D;AAC/D;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA,sCAAqC,wCAAwC,EAAE;AAC/E,yBAAwB,8CAA8C,EAAE;AACxE,8BAA6B,kDAAkD,EAAE;AACjF,8BAA6B,+BAA+B,EAAE;AAC9D,mCAAkC,mCAAmC,EAAE;AACvE,2BAA0B,kCAAkC,EAAE;AAC9D,gCAA+B,sCAAsC;AACrE;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,8BAA6B;AAC7B;AACA;AACA;AACA;AACA,IAAG;;AAEH;AACA;;AAEA;AACA;AACA;;AAEA;AACA,sCAAqC,qCAAqC,EAAE;AAC5E,8BAA6B,4BAA4B,EAAE;AAC3D,mCAAkC,gCAAgC,EAAE;AACpE,2BAA0B,gCAAgC,EAAE;AAC5D,gCAA+B,qCAAqC;AACpE;;AAEA;AACA;AACA;AACA;AACA;AACA,MAAK;AACL;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA,+CAA8C,cAAc;;AAE5D,EAAC;;;;;;;ACn0BD;AACA;AACA;AACA;AACA,mDAAkD;AAClD,EAAC,2CAA2C;;AAE5C;AACA;AACA,sBAAqB;AACrB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA,yEAAwE;AACxE,+CAA8C;AAC9C,4DAA2D;AAC3D,oDAAmD;AACnD,8DAA6D;AAC7D;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA,4CAA2C,+EAA+E;AAC1H,oCAAmC,mDAAmD;AACtF,yCAAwC,4DAA4D;AACpG,iCAAgC,oDAAoD;AACpF,sCAAqC,8DAA8D;AACnG;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA,sBAAqB;AACrB;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA,0BAAyB,4BAA4B,IAAI;AACzD;AACA;AACA;AACA;AACA,iCAAgC,iCAAiC,IAAI;AACrE;AACA;AACA;AACA;AACA,iCAAgC,6CAA6C,IAAI;AACjF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,IAAG;AACH;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA,qEAAoE;AACpE,wCAAuC;AACvC,qDAAoD;AACpD;AACA;;AAEA;AACA,qCAAoC,OAAO;AAC3C,uDAAsD,OAAO;AAC7D;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA,0CAAyC,OAAO;AAChD;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA,qDAAoD,8BAA8B;AAClF;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA,gBAAe;AACf;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA,sCAAqC;AACrC;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA,oCAAmC,OAAO;AAC1C;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA,sCAAqC,OAAO;AAC5C;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,IAAG;;AAEH;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA,gCAA+B;AAC/B;AACA;AACA,MAAK;AACL,IAAG;;AAEH;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;A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","file":"hivtrace.js","sourcesContent":["window.jQuery = window.$ = $;\n\nrequire(\"font-awesome/css/font-awesome.css\");\nrequire(\"./hivtrace.css\");\nrequire(\"bootstrap\");\n\nvar hivtrace = require(\"./hivtrace.js\");\n\n// Create new hyphy-vision export\nwindow.hivtrace = hivtrace;\n\n\n\n// WEBPACK FOOTER //\n// ./src/entry.js","// removed by extract-text-webpack-plugin\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./~/font-awesome/css/font-awesome.css\n// module id = 5\n// module chunks = 0","// removed by extract-text-webpack-plugin\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./src/hivtrace.css\n// module id = 15\n// module chunks = 0","import Bootstrap from \"bootstrap/dist/css/bootstrap.css\";\nimport { clusterNetwork, graphSummary } from \"./clusternetwork.js\";\nimport { histogram, histogramDistances } from \"./histogram.js\";\nimport { scatterPlot } from \"./scatterplot.js\";\n\nvar misc = require(\"./misc.js\");\nvar helpers = require(\"./helpers.js\");\n\nmodule.exports.clusterNetwork = clusterNetwork;\nmodule.exports.graphSummary = graphSummary;\nmodule.exports.histogram = histogram;\nmodule.exports.histogramDistances = histogramDistances;\nmodule.exports.helpers = helpers;\nmodule.exports.misc = misc;\nmodule.exports.scatterPlot = scatterPlot;\n\n\n\n// WEBPACK FOOTER //\n// ./src/hivtrace.js","// removed by extract-text-webpack-plugin\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./~/bootstrap/dist/css/bootstrap.css\n// module id = 31\n// module chunks = 0","var d3 = require(\"d3\"),\n  _ = require(\"underscore\"),\n  misc = require(\"misc\"),\n  helpers = require(\"helpers\"),\n  scatterPlot = require(\"scatterplot\"),\n  topojson = require (\"topojson\");\n\nvar _networkGraphAttrbuteID = \"patient_attribute_schema\";\nvar _networkNodeAttributeID = \"patient_attributes\";\nvar _networkNodeIDField     = \"hivtrace_node_id\";\nvar _networkMissing = \"missing\";\nvar _networkMissingOpacity = \"0.1\";\nvar _networkMissingColor = \"#999\";\nvar _networkContinuousColorStops = 9;\nvar _networkShapeOrdering = [\n  \"circle\",\n  \"square\",\n  \"hexagon\",\n  \"diamond\",\n  \"cross\",\n  \"octagon\",\n  \"ellipse\",\n  \"pentagon\"\n];\n\nvar _defaultFloatFormat = d3.format(\",.2r\");\nvar _defaultPercentFormat = d3.format(\",.3p\");\nvar _defaultDateFormats = [\n  d3.time.format(\"%Y-%m-%dT%H:%M:%S.%LZ\"),\n  d3.time.format(\"%Y-%m-%dT%H:%M:%S.%LZ\")\n];\n\nvar _defaultDateViewFormat = d3.time.format(\"%B %d, %Y\");\nvar _defaultDateViewFormatShort = d3.time.format(\"%B %Y\");\nvar _defaultDateViewFormatSlider = d3.time.format(\"%Y-%m-%d\");\nvar _networkDotFormatPadder = d3.format(\"08d\");\n\nvar _networkCategoricalBase = [\n  \"#a6cee3\",\n  \"#1f78b4\",\n  \"#b2df8a\",\n  \"#33a02c\",\n  \"#fb9a99\",\n  \"#e31a1c\",\n  \"#fdbf6f\",\n  \"#ff7f00\",\n  \"#cab2d6\",\n  \"#6a3d9a\",\n  \"#ffff99\",\n  \"#b15928\"\n];\n\nvar _networkCategorical = [];\n\n_.each([0, -0.5, 0.5], function(k) {\n  _.each(_networkCategoricalBase, function(s) {\n    _networkCategorical.push(d3.rgb(s).darker(k).toString());\n  });\n});\n\nvar _maximumValuesInCategories = _networkCategorical.length;\n\nvar _networkSequentialColor = {\n  2: [\"#feb24c\", \"#e31a1c\"],\n  3: [\"#ffeda0\", \"#feb24c\", \"#f03b20\"],\n  4: [\"#ffffb2\", \"#fecc5c\", \"#fd8d3c\", \"#e31a1c\"],\n  5: [\"#ffffb2\", \"#fecc5c\", \"#fd8d3c\", \"#f03b20\", \"#bd0026\"],\n  6: [\"#ffffb2\", \"#fed976\", \"#feb24c\", \"#fd8d3c\", \"#f03b20\", \"#bd0026\"],\n  7: [\n    \"#ffffb2\",\n    \"#fed976\",\n    \"#feb24c\",\n    \"#fd8d3c\",\n    \"#fc4e2a\",\n    \"#e31a1c\",\n    \"#b10026\"\n  ],\n  8: [\n    \"#ffffcc\",\n    \"#ffeda0\",\n    \"#fed976\",\n    \"#feb24c\",\n    \"#fd8d3c\",\n    \"#fc4e2a\",\n    \"#e31a1c\",\n    \"#b10026\"\n  ],\n  9: [\n    \"#ffffcc\",\n    \"#ffeda0\",\n    \"#fed976\",\n    \"#feb24c\",\n    \"#fd8d3c\",\n    \"#fc4e2a\",\n    \"#e31a1c\",\n    \"#bd0026\",\n    \"#800026\"\n  ]\n};\n\nvar _networkPresetColorSchemes = {\n  trans_categ: {\n    \"MSM-Male\": \"#1f78b4\",\n    \"MSM-Unknown sex\": \"#1f78b4\",\n    \"Heterosexual Contact-Male\": \"#e31a1c\",\n    \"Heterosexual Contact-Female\": \"#e31a1c\",\n    \"Heterosexual Contact-Unknown sex\": \"#e31a1c\",\n    \"IDU-Male\": \"#33a02c\",\n    \"MSM & IDU-Male\": \"#33a02c\",\n    \"IDU-Female\": \"#33a02c\",\n    \"IDU-Unknown sex\": \"#33a02c\",\n    \"Other/Unknown-Male\": \"#636363\",\n    \"Other/Unknown-Female\": \"#636363\",\n    \"Other-Male\": \"#636363\",\n    \"Other-Female\": \"#636363\",\n    Missing: \"#636363\",\n    \"\": \"#636363\",\n    \"Other/Unknown-Unknown sex\": \"#636363\",\n    Perinatal: \"#ff7f00\",\n    \"Other/Unknown-Child\": \"#ff7f00\",\n    \"Other-Child\": \"#ff7f00\"\n  },\n  race: {\n    \"Asian\": \"#1f77b4\",\n    \"Black/African American\": \"#bcbd22\",\n    \"Hispanic/Latino\": \"#9467bd\",\n    \"American Indian/Alaska Native\": \"#2ca02c\",\n    \"Native Hawaiian/Other Pacific Islander\": \"#17becf\",\n    \"Multiple Races\": \"#e377c2\",\n    \"Unknown race\": \"#999\",\n    Missing: \"#999\",\n    missing: \"#999\",\n    White: \"#d62728\"\n  }\n};\n\nvar _networkPresetShapeSchemes = {\n  birth_sex: {\n    Male: \"square\",\n    Female: \"ellipse\",\n    Missing: \"diamond\",\n    missing: \"diamond\",\n    Unknown: \"diamond\"\n  },\n  race: {\n    Asian: \"hexagon\",\n    \"Black/African American\": \"square\",\n    \"Hispanic/Latino\": \"triangle\",\n    \"American Indian/Alaska Native\": \"pentagon\",\n    \"Native Hawaiian/Other Pacific Islander\": \"octagon\",\n    \"Multiple Races\": \"diamond\",\n    \"Unknown race\": \"diamond\",\n    Missing: \"diamond\",\n    missing: \"diamond\",\n    White: \"ellipse\"\n  },\n  current_gender: {\n    Male: \"square\",\n    Female: \"ellipse\",\n    \"Transgender-Male to Female\": \"hexagon\",\n    \"Transgender-Female to Male\": \"pentagon\",\n    \"Additional Gender Identity\": \"diamond\",\n    Unknown: \"diamond\",\n    Missing: \"diamond\",\n    missing: \"diamond\"\n  }\n};\n\n// Constants for the map.\n\n\n// TODO: convert and save this data rather than do it each time.\n\n\nvar hivtrace_cluster_depthwise_traversal = function(\n  nodes,\n  edges,\n  edge_filter,\n  save_edges,\n  seed_nodes\n) {\n  var clusters = [],\n    adjacency = {},\n    by_node = {};\n\n  seed_nodes = seed_nodes || nodes;\n\n  _.each(nodes, function(n) {\n    n.visited = false;\n    adjacency[n.id] = [];\n  });\n\n  if (edge_filter) {\n    edges = _.filter(edges, edge_filter);\n  }\n\n  _.each(edges, function(e) {\n    try {\n      adjacency[nodes[e.source].id].push([nodes[e.target], e]);\n      adjacency[nodes[e.target].id].push([nodes[e.source], e]);\n    } catch (err) {\n      console.log(\n        \"Edge does not map to an existing node \" + e.source + \" to \" + e.target\n      );\n      throw \"Edge does not map to an existing node \" +\n        e.source +\n        \" to \" +\n        e.target;\n    }\n  });\n\n  var traverse = function(node) {\n    if (!(node.id in by_node)) {\n      clusters.push([node]);\n      by_node[node.id] = clusters.length - 1;\n      if (save_edges) {\n        save_edges.push([]);\n      }\n    }\n    node.visited = true;\n\n    _.each(adjacency[node.id], function(neighbor) {\n      if (!neighbor[0].visited) {\n        by_node[neighbor[0].id] = by_node[node.id];\n        clusters[by_node[neighbor[0].id]].push(neighbor[0]);\n        if (save_edges) {\n          save_edges[by_node[neighbor[0].id]].push(neighbor[1]);\n        }\n        traverse(neighbor[0]);\n      }\n    });\n  };\n\n  _.each(seed_nodes, function(n) {\n    if (!n.visited) {\n      traverse(n);\n    }\n  });\n\n  return clusters;\n};\n\nvar _networkUpperBoundOnDate = new Date().getFullYear();\nvar _networkCDCDateField = \"hiv_aids_dx_dt\";\n\nvar hivtrace_cluster_network_graph = function(\n  json,\n  network_container,\n  network_status_string,\n  network_warning_tag,\n  button_bar_ui,\n  attributes,\n  filter_edges_toggle,\n  clusters_table,\n  nodes_table,\n  parent_container,\n  options\n) {\n  // [REQ] json                        :          the JSON object containing network nodes, edges, and meta-information\n  // [REQ] network_container           :          the CSS selector of the DOM element where the SVG containing the network will be placed (e.g. '#element')\n  // [OPT] network_status_string       :          the CSS selector of the DOM element where the text describing the current state of the network is shown (e.g. '#element')\n  // [OPT] network_warning_tag         :          the CSS selector of the DOM element where the any warning messages would go (e.g. '#element')\n  // [OPT] button_bar_ui               :          the ID of the control bar which can contain the following elements (prefix = button_bar_ui value)\n  //                                                - [prefix]_cluster_operations_container : a drop-down for operations on clusters\n  //                                                - [prefix]_attributes :  a drop-down for operations on attributes\n  //                                                - [prefix]_filter : a text box used to search the graph\n  // [OPT] network_status_string       :          the CSS selector of the DOM element where the text describing the current state of the network is shown (e.g. '#element')\n  // [OPT] attributes                  :          A JSON object with mapped node attributes\n\n  // if schema is not set, set to empty dictionary\n  if (!json[_networkGraphAttrbuteID]) {\n    json[_networkGraphAttrbuteID] = {};\n  }\n\n  // annotate each node with patient_attributes if does not exist\n  json.Nodes.forEach(function(n) {\n    if(!n[_networkNodeAttributeID]) {\n      n[_networkNodeAttributeID] = [];\n    }\n  });\n\n  var self = {};\n\n  self._is_CDC_ = options && options[\"no_cdc\"] ? false : true;\n  self.ww =\n    options && options[\"width\"]\n      ? options[\"width\"]\n      : d3.select(parent_container).property(\"clientWidth\");\n  self.container = network_container;\n  self.nodes = [];\n  self.edges = [];\n  self.clusters = [];\n  self.cluster_sizes = [];\n  self.cluster_mapping = {};\n  self.percent_format = _defaultPercentFormat;\n  self.missing = _networkMissing;\n\n\n  if (options && _.isFunction(options[\"init_code\"])) {\n    options[\"init_code\"].call(null, self, options);\n  }\n\n  self.dom_prefix =\n    options && options[\"prefix\"] ? options[\"prefix\"] : \"hiv-trace\";\n  self.extra_cluster_table_columns =\n    options && options[\"cluster-table-columns\"]\n      ? options[\"cluster-table-columns\"]\n      : null;\n\n  self.subcluster_table = null;\n\n  if (self._is_CDC_) {\n\n    self.displayed_node_subset = [_networkNodeIDField, \"trans_categ\", \"race\", \"hiv_aids_dx_dt\", \"cur_city_name\"];\n\n    self.subcluster_table =\n      options && options[\"subcluster-table\"]\n        ? d3.select(options[\"subcluster-table\"])\n        : null;\n    \n    self.extra_subcluster_table_columns = null;\n\n    var cdc_extra = [\n      {\n        description: {\n          value: \"Cases dx within 36 months\",\n          sort: function(c) {\n            return c.value.length ? c.value[0] : 0;\n          },\n          help: \"Number of cases diagnosed in the past 36 months connected only through cases diagnosed within the past 36 months\"\n        },\n        generator: function(cluster) {\n          return {\n            html: true,\n            value: cluster.recent_nodes,\n            format: function(v) {\n              v = v || [];\n              if (v.length) {\n                return v.join(\", \");\n              } else {\n                return \"\";\n              }\n            }\n          };\n        }\n      },\n      {\n        description: {\n          value: \"Cases dx within 12 months\",\n          sort: //\"value\",\n            function(c) {\n              let v = c.value || [];\n              return v.length > 0 ? v[0] : 0;\n            },\n          presort : \"desc\",\n          help:\n            \"Number of cases diagnosed in the past 12 months connected only through cases diagnosed within the past 36 months\"\n        },\n        generator: function(cluster) {\n          return {\n            html: true,\n            value: cluster.priority_score,\n            format: function(v) {\n              v = v || [];\n              if (v.length) {\n                var str = v.join(\", \");\n                if (v[0] >= 3) {\n                  var color = v[0] >= 5 ? 'red' : 'orange';\n                  return (\n                    \"<span style='color:\" + color + \"'>\" + str + \"</span>\"\n                  );\n                }\n                return str;\n              }\n              return \"\";\n            }\n          };\n        }\n      }\n    ];\n\n    if (self.subcluster_table) {\n      self.extra_subcluster_table_columns = cdc_extra;\n    } else {\n      if (self.extra_cluster_table_columns) {\n        self.extra_cluster_table_columns = self.extra_cluster_table_columns.concat(\n          cdc_extra\n        );\n      } else {\n        self.extra_cluster_table_columns = cdc_extra;\n      }\n    }\n  }\n\n  self.extra_node_table_columns =\n    options && options[\"node-table-columns\"]\n      ? options[\"node-table-columns\"]\n      : self._is_CDC_\n        ? [\n            {\n              description: {\n                value: \"Recent and Rapid\",\n                sort: \"value\",\n                help:\n                  \"Is the node a member of a regular or recent & rapid subcluster?\"\n              },\n              generator: function(node) {\n                return {\n                  callback: function(element, payload) {\n                    //payload = _.filter (payload, function (d) {return d});\n                    var this_cell = d3.select(element);\n\n                    var data_to_use = [\n                      [payload[0][0], payload[0][1], payload[0][2]],\n                      [payload[1][0] ? \"36 months\" : \"\", payload[1][1]],\n                      [payload[2][0] ? \"12 months\" : \"\", payload[2][1]],\n                      [\n                        payload.length > 3 && payload[3][0]\n                          ? \"Recent cluster  3\"\n                          : \"\",\n                        payload.length > 3 ? payload[3][1] : null\n                      ]\n                    ];\n\n                    var buttons = this_cell.selectAll(\"span\").remove();\n\n                    _.each(data_to_use, function(button_text) {\n                      //self.open_exclusive_tab_view (cluster_id)\n                      if (button_text[0].length) {\n                        var button_obj = this_cell\n                          .append(\"span\")\n                          .classed(\"btn btn-xs btn-node-property\", true)\n                          .classed(button_text[1], true)\n                          .text(button_text[0]);\n\n                        if (_.isFunction(button_text[2])) {\n                          button_obj.on(\"click\", button_text[2]);\n                        } else {\n                          button_obj.attr(\"disabled\", true);\n                        }\n                      }\n                    });\n                  },\n                  value: function() {\n                    return [\n                      [\n                        node.subcluster_label ? \"Subcluster \" + node.subcluster_label : \"\",\n                        \"btn-primary\",\n                        node.subcluster_label\n                          ? function() {\n                              self.view_subcluster(\n                                node.subcluster_label,\n                                function(n) {\n                                  return n.subcluster_label == node.subcluster_label;\n                                },\n                                \"Subcluster \" + node.subcluster_label\n                              );\n                            }\n                          : null\n                      ],\n\n                      [node.priority_flag == 3, \"btn-warning\"],\n                      [node.priority_flag == 1, \"btn-danger\"],\n                      [node.priority_flag == 2, \"btn-danger\"]\n                    ];\n                  }\n                };\n              }\n            }\n          ]\n        : null;\n\n  self.colorizer = {\n    selected: function(d) {\n      return d == \"selected\" ? d3.rgb(51, 122, 183) : \"#FFF\";\n    }\n  };\n\n  self.subcluster_threshold =\n    options && options[\"subcluster-thershold\"]\n      ? options[\"subcluster-thershold\"]\n      : 0.005;\n\n  self.today = options && options[\"today\"] ? options[\"today\"] : new Date();\n\n  self.node_shaper = {\n    id: null,\n    shaper: function() {\n      return \"circle\";\n    }\n  };\n\n  (self.filter_edges = true), (self.hide_hxb2 = false), (self.charge_correction = 5), (self.margin = {\n    top: 20,\n    right: 10,\n    bottom: 30,\n    left: 10\n  }), (self.width =\n    self.ww - self.margin.left - self.margin.right), (self.height =\n    self.width * 9 / 16), (self.cluster_table = d3.select(\n    clusters_table\n  )), (self.node_table = d3.select(\n    nodes_table\n  )), (self.needs_an_update = false), (self.json = json), (self.hide_unselected = false), (self.show_percent_in_pairwise_table = false), (self.gradient_id = 0);\n\n  self._calc_country_nodes = function (options) {\n      if (options && \"country-centers\" in options) {\n            self.mapProjection = d3.geo.mercator().translate([self.margin.left + self.width/2, self.margin.top + self.height/2]).scale(150 * self.width / 960);\n            _.each (self.countryCentersObject, function (value) {\n                value.countryXY = self.mapProjection ([value.longt, value.lat]);\n     });\n    }\n  };\n\n  if (options && \"country-centers\" in options && \"country-outlines\" in options) {\n    self.countryCentersObject = options[\"country-centers\"];\n    self.countryOutlines = options[\"country-outlines\"];\n    self._calc_country_nodes (options);\n    //console.log (self.countryCentersObject);\n    self.showing_on_map = options.showing_on_map;\n    //console.log (self.showing_on_map);\n  } else {\n    self.countryCentersObject = null;\n    self.showing_on_map = false;\n  }\n\n  self._additional_node_pop_fields = [];\n  /** this array contains fields that will be appended to node pop-overs in the network tab\n      they will precede all the fields that are shown based on selected labeling */\n\n  if (options && \"minimum size\" in options) {\n    self.minimum_cluster_size = options[\"minimum size\"];\n  } else {\n    if (self._is_CDC_) {\n      self.minimum_cluster_size = 5;\n    } else {\n      self.minimum_cluster_size = 0;\n    }\n  }\n\n  if (options && \"cluster-time\" in options) {\n    self.cluster_time_scale = options[\"cluster-time\"];\n  }\n\n  if (self._is_CDC_) {\n    self._additional_node_pop_fields.push(_networkCDCDateField);\n    self.cluster_time_scale = self.cluster_time_scale || _networkCDCDateField;\n  }\n\n  if (options && \"core-link\" in options) {\n    self.core_link_length = options[\"core-link\"];\n  } else {\n    self.core_link_length = -1;\n  }\n\n  if (options && \"edge-styler\" in options) {\n    self.additional_edge_styler = options[\"edge-styler\"];\n  } else {\n    self.additional_edge_styler = null;\n  }\n\n  self.filter_by_size = function(cluster) {\n    return cluster.children.length >= self.minimum_cluster_size;\n  };\n\n  self.cluster_filtering_functions = { size: self.filter_by_size };\n\n  self.cluster_display_filter = function(cluster) {\n    return _.every(self.cluster_filtering_functions, function(filter) {\n      return filter(cluster);\n    });\n  };\n\n  self.primary_graph = options && \"secondary\" in options ? false : true;\n  self.initial_packed =\n    options && options[\"initial_layout\"] == \"tiled\" ? false : true;\n\n  self.recent_rapid_definition = function(network, date) {\n    date = date || self.today;\n    var subcluster_enum = [\n      \"Subcluster\", // 0\n      \"12 months (on ar after \" + // 1\n        _defaultDateViewFormat(_n_months_ago(date, 12)) +\n        \")\",\n      \"12 months (on ar after \" + // 2\n        _defaultDateViewFormat(_n_months_ago(date, 12)) +\n        \") and R&R subcluster\",\n      \"36 months (on ar after \" + // 3\n        _defaultDateViewFormat(_n_months_ago(date, 36)) +\n        \")\",\n      \"Future node (after \" + _defaultDateViewFormat(date) + \")\", // 4\n      \"Not a member of subcluster (as of \" + _defaultDateViewFormat(date) + \")\", // 5\n      \"Not in a subcluster\"\n    ];\n\n    return {\n      depends: _networkCDCDateField,\n      label: \"Subcluster or Priority Node\",\n      enum: subcluster_enum,\n      type: \"String\",\n      volatile: true,\n      color_scale: function() {\n        return d3.scale\n          .ordinal()\n          .domain(subcluster_enum.concat([_networkMissing]))\n          .range(\n            _.union(\n              [\n                \"#CCCCCC\",\n                \"pink\",\n                \"red\",\n                \"blue\",\n                \"#9A4EAE\",\n                \"yellow\",\n                \"#FFFFFF\"\n              ],\n              [_networkMissingColor]\n            )\n          );\n      },\n\n      map: function(node) {\n        if (node.subcluster_label) {\n          if (node.priority_flag > 0) {\n            return subcluster_enum[node.priority_flag];\n          }\n          return subcluster_enum[0];\n        }\n        return subcluster_enum[6];\n      }\n    };\n  };\n\n  self._networkPredefinedAttributeTransforms = {\n    /** runtime computed node attributes, e.g. transforms of existing attributes */\n\n    binned_vl_recent_value: {\n      depends: \"vl_recent_value\",\n      label: \"binned_vl_recent_value\",\n      enum: [\"200\", \"200-10000\", \">10000\"],\n      type: \"String\",\n      color_scale: function() {\n        return d3.scale\n          .ordinal()\n          .domain([\"200\", \"200-10000\", \">10000\", _networkMissing])\n          .range(_.union(_networkSequentialColor[3], [_networkMissingColor]));\n      },\n\n      map: function(node) {\n        var vl_value = self.attribute_node_value_by_id(\n          node,\n          \"vl_recent_value\",\n          true\n        );\n        if (vl_value != _networkMissing) {\n          if (vl_value <= 200) {\n            return \"200\";\n          }\n          if (vl_value <= 10000) {\n            return \"200-10000\";\n          }\n          return \">10000\";\n        }\n        return _networkMissing;\n      }\n    },\n\n    recent_rapid: self.recent_rapid_definition,\n\n    subcluster_index: {\n      depends: _networkCDCDateField,\n      label: \"Subcluster ID\",\n      type: \"String\",\n\n      map: function(node) {\n        return node.subcluster_label;\n      }\n    },\n\n    age_dx: {\n      depends: \"age\",\n      label: \"age_dx\",\n      enum: [\"<13\", \"13-19\", \"20-29\", \"30-39\", \"40-49\", \"50-59\", \"60\"],\n      type: \"String\",\n      color_scale: function() {\n        return d3.scale\n          .ordinal()\n          .domain([\n            \"<13\",\n            \"13-19\",\n            \"20-29\",\n            \"30-39\",\n            \"40-49\",\n            \"50-59\",\n            \"60\",\n            _networkMissing\n          ])\n          .range([\n            \"#b10026\",\n            \"#e31a1c\",\n            \"#fc4e2a\",\n            \"#fd8d3c\",\n            \"#feb24c\",\n            \"#fed976\",\n            \"#ffffb2\",\n            \"#636363\"\n          ]);\n      },\n      map: function(node) {\n        var vl_value = self.attribute_node_value_by_id(node, \"age\");\n        if (vl_value == \">=60\") {\n          return \"60\";\n        }\n        return vl_value;\n      }\n    },\n\n    hiv_aids_dx_dt_year: {\n      depends: _networkCDCDateField,\n      label: \"hiv_aids_dx_dt_year\",\n      type: \"Number\",\n      label_format : d3.format (\".0f\"),\n      map: function(node) {\n        try {\n          var value = self._parse_dates(\n            self.attribute_node_value_by_id(node, _networkCDCDateField)\n          );\n          if (value) {\n            value = \"\" + value.getFullYear();\n          } else {\n            value = _networkMissing;\n          }\n          return value;\n        } catch (err) {\n          return _networkMissing;\n        }\n      },\n      color_scale: function(attr) {\n        var range_without_missing = _.without(\n          attr.value_range,\n          _networkMissing\n        );\n        var color_scale = _.compose(\n          d3.interpolateRgb(\"#ffffcc\", \"#800026\"),\n          d3.scale\n            .linear()\n            .domain([\n              range_without_missing[0],\n              range_without_missing[range_without_missing.length - 1]\n            ])\n            .range([0, 1])\n        );\n        return function(v) {\n          if (v == _networkMissing) {\n            return _networkMissingColor;\n          }\n          return color_scale(v);\n        };\n      }\n    }\n  };\n\n  if (options && options[\"computed-attributes\"]) {\n    _.extend(\n      self._networkPredefinedAttributeTransforms,\n      options[\"computed-attributes\"]\n    );\n  }\n\n  self._parse_dates = function(value) {\n    if (value instanceof Date) {\n      return value;\n    }\n    var parsed_value = null;\n\n    var passed = _.any(_defaultDateFormats, function(f) {\n      parsed_value = f.parse(value);\n      return parsed_value;\n    });\n\n    //console.log (value + \" mapped to \" + parsed_value);\n\n    if (passed) {\n      if (\n        self._is_CDC_ &&\n        (parsed_value.getFullYear() < 1970 ||\n          parsed_value.getFullYear() > _networkUpperBoundOnDate)\n      ) {\n        throw \"Invalid date\";\n      }\n      return parsed_value;\n    }\n\n    throw \"Invalid date\";\n  };\n\n  /*------------ Network layout code ---------------*/\n  var handle_cluster_click = function(cluster, release) {\n    var container = d3.select(self.container);\n    var id = \"d3_context_menu_id\";\n    var menu_object = container.select(\"#\" + id);\n\n    if (menu_object.empty()) {\n      menu_object = container\n        .append(\"ul\")\n        .attr(\"id\", id)\n        .attr(\"class\", \"dropdown-menu\")\n        .attr(\"role\", \"menu\");\n    }\n\n    menu_object.selectAll(\"li\").remove();\n\n    var already_fixed = cluster && cluster.fixed == 1;\n\n    if (cluster) {\n      menu_object\n        .append(\"li\")\n        .append(\"a\")\n        .attr(\"tabindex\", \"-1\")\n        .text(\"Expand cluster\")\n        .on(\"click\", function(d) {\n          cluster.fixed = 0;\n          self.expand_cluster_handler(cluster, true);\n          menu_object.style(\"display\", \"none\");\n        });\n\n      menu_object\n        .append(\"li\")\n        .append(\"a\")\n        .attr(\"tabindex\", \"-1\")\n        .text(\"Center on screen\")\n        .on(\"click\", function(d) {\n          cluster.fixed = 0;\n          center_cluster_handler(cluster);\n          menu_object.style(\"display\", \"none\");\n        });\n\n      menu_object\n        .append(\"li\")\n        .append(\"a\")\n        .attr(\"tabindex\", \"-1\")\n        .text(function(d) {\n          if (cluster.fixed) return \"Allow cluster to float\";\n          return \"Hold cluster at current position\";\n        })\n        .on(\"click\", function(d) {\n          cluster.fixed = !cluster.fixed;\n          menu_object.style(\"display\", \"none\");\n        });\n\n      menu_object\n        .append(\"li\")\n        .append(\"a\")\n        .attr(\"tabindex\", \"-1\")\n        .text(function(d) {\n          return \"Show this cluster in separate tab\";\n        })\n        .on(\"click\", function(d) {\n          self.open_exclusive_tab_view(cluster.cluster_id);\n          menu_object.style(\"display\", \"none\");\n        });\n\n      // Only show the \"Show on map\" option for clusters with valid country info (for now just 2 letter codes) for each node.\n      var show_on_map_enabled = self.countryCentersObject;\n\n\n      show_on_map_enabled = _.every(cluster.children, function(node) {\n        //console.log (node.patient_attributes);\n        return self._get_node_country (node).length == 2;\n      })\n\n      if (show_on_map_enabled) {\n        menu_object\n          .append(\"li\")\n          .append(\"a\")\n          .attr(\"tabindex\", \"-1\")\n          .text(\"Show on map\")\n          .on(\"click\", function(d) {\n            //console.log(cluster)\n            self.open_exclusive_tab_view(\n              cluster.cluster_id,\n              null,\n              (cluster_id) => { return \"Map of cluster: \" + cluster_id },\n              {'showing_on_map': true}\n            )\n          });\n      }\n\n      cluster.fixed = 1;\n\n      menu_object\n        .style(\"position\", \"absolute\")\n        .style(\"left\", \"\" + d3.event.offsetX + \"px\")\n        .style(\"top\", \"\" + d3.event.offsetY + \"px\")\n        .style(\"display\", \"block\");\n    } else {\n      if (release) {\n        release.fixed = 0;\n      }\n      menu_object.style(\"display\", \"none\");\n    }\n\n    container.on(\n      \"click\",\n      function(d) {\n        handle_cluster_click(null, already_fixed ? null : cluster);\n      },\n      true\n    );\n  };\n\n  /*self._handle_inline_charts = function (e) {\n\n  }*/\n\n  self._get_node_country = function (node) {\n    var countryCodeAlpha2 =  self.attribute_node_value_by_id (node, \"country\");\n    if (countryCodeAlpha2 == _networkMissing) {\n        countryCodeAlpha2 =  self.attribute_node_value_by_id (node, \"Country\");\n    }\n    return countryCodeAlpha2;\n  };\n\n  self._draw_topomap = function (no_redraw) {\n    if (options && \"showing_on_map\" in options) {\n        var countries = topojson.feature(countryOutlines, countryOutlines.objects.countries).features;\n        var mapsvg = d3.select(\"#\" + self.dom_prefix + \"-network-svg\");\n        var path = d3.geo.path().projection(self.mapProjection);\n        var countries = mapsvg.selectAll(\".country\")\n          .data(countries);\n\n        countries.enter().append(\"path\");\n        countries.exit().remove();\n\n        self.countries_in_cluster = {};\n\n        _.each (self.nodes, function (node) {\n            var countryCodeAlpha2 =  self._get_node_country (node);\n             var countryCodeNumeric = self.countryCentersObject[countryCodeAlpha2].countryCodeNumeric;\n            if (!(countryCodeNumeric in self.countries_in_cluster)) {\n              self.countries_in_cluster[countryCodeNumeric] = true;\n            }\n        });\n\n\n        countries\n          .attr(\"class\", \"country\")\n          .attr(\"d\", path)\n          .attr(\"stroke\", \"saddlebrown\")\n          .attr(\"fill\", function(d) {\n            if (d.id in self.countries_in_cluster) {\n              return \"navajowhite\";\n            } else {\n              return \"bisque\";\n            }\n          })\n          .attr(\"stroke-width\", function(d) {\n            if (d.id in self.countries_in_cluster)  {\n              return 1.5;\n            } else {\n              return 0.5;\n            }\n          });\n    }\n    return self;\n  };\n\n  self._check_for_time_series = function(export_items) {\n    var event_handler = function (network, e) {\n          if (e) {\n            e = d3.select(e);\n          }\n          if (!network.network_cluster_dynamics) {\n            network.network_cluster_dynamics = network.network_svg\n              .append(\"g\")\n              .attr(\"id\", self.dom_prefix + \"-dynamics-svg\")\n              .attr(\"transform\", \"translate (\" + network.width * 0.45 + \",0)\");\n\n            network.handle_inline_charts = function(plot_filter) {\n              var attr = null;\n              var color = null;\n              if (\n                network.colorizer[\"category_id\"] &&\n                !network.colorizer[\"continuous\"]\n              ) {\n                var attr_desc =\n                  network.json[_networkGraphAttrbuteID][\n                    network.colorizer[\"category_id\"]\n                  ];\n                attr = {};\n                attr[network.colorizer[\"category_id\"]] = attr_desc[\"label\"];\n                color = {};\n                color[attr_desc[\"label\"]] = network.colorizer[\"category\"];\n              }\n\n              misc.cluster_dynamics(\n                network.extract_network_time_series(\n                  self.cluster_time_scale,\n                  attr,\n                  plot_filter\n                ),\n                network.network_cluster_dynamics,\n                \"Quarter of Diagnosis\", \"Number of Cases\",\n                null,\n                null,\n                {\n                  base_line: 20,\n                  top: network.margin.top,\n                  right: network.margin.right,\n                  bottom: 3 * 20,\n                  left: 5 * 20,\n                  font_size: 12,\n                  rect_size: 14,\n                  width: network.width / 2,\n                  height: network.height / 2,\n                  colorizer: color,\n                  prefix: network.dom_prefix,\n                  barchart: true,\n                  drag: {\n                    x: network.width * 0.45,\n                    y: 0\n                  }\n                }\n              );\n            };\n            network.handle_inline_charts();\n            if (e) {\n                e.text(\"Hide time-course plots\");\n            }\n          } else {\n            if (e) {\n                e.text(\"Show time-course plots\");\n            }\n            network.network_cluster_dynamics.remove();\n            network.network_cluster_dynamics = null;\n            network.handle_inline_charts = null;\n          }\n        };\n\n    if (self.cluster_time_scale) {\n      if (export_items) {\n          export_items.push([\n            \"Show time-course plots\",\n            event_handler\n          ]);\n       } else {\n          event_handler (self);\n       }\n    }\n  };\n\n  self.open_exclusive_tab_close = function(\n    tab_element,\n    tab_content,\n    restore_to_tag\n  ) {\n    $(\"#\" + restore_to_tag).tab(\"show\");\n    $(\"#\" + tab_element).remove();\n    $(\"#\" + tab_content).remove();\n  };\n\n  self.open_exclusive_tab_view = function(\n    cluster_id,\n    custom_filter,\n    custom_name,\n    additional_options,\n    include_injected_edges\n  ) {\n    var cluster = _.find(self.clusters, function(c) {\n      return c.cluster_id == cluster_id;\n    });\n\n    if (!cluster) {\n      return;\n    }\n\n    additional_options = additional_options || {};\n\n    var filtered_json = _extract_single_cluster(\n      custom_filter\n        ? _.filter(self.json.Nodes, custom_filter)\n        : cluster.children,\n        null,\n        null,\n        null,\n        include_injected_edges\n    );\n\n    if (_networkGraphAttrbuteID in json) {\n      filtered_json[_networkGraphAttrbuteID] = {};\n      jQuery.extend(\n        true,\n        filtered_json[_networkGraphAttrbuteID],\n        json[_networkGraphAttrbuteID]\n      );\n    }\n\n    var export_items = [\n      [\n        \"Export cluster to .CSV\",\n        function(network) {\n          helpers.export_csv_button(\n            self._extract_attributes_for_nodes(\n              self._extract_nodes_by_id(cluster_id),\n              self._extract_exportable_attributes()\n            )\n          );\n        }\n      ]\n    ];\n\n    //self._check_for_time_series(export_items);\n\n    if (\"extra_menu\" in additional_options) {\n      _.each(export_items, function(item) {\n        additional_options[\"extra_menu\"][\"items\"].push(item);\n      });\n    } else {\n      _.extend(additional_options, {\n        extra_menu: {\n          title: \"Action\",\n          items: export_items\n        }\n      });\n    }\n\n    return self.open_exclusive_tab_view_aux(\n      filtered_json,\n      custom_name ? custom_name(cluster_id) : \"Cluster \" + cluster_id,\n      additional_options\n    );\n  };\n\n\n  self.open_exclusive_tab_view_aux = function(\n    filtered_json,\n    title,\n    option_extras\n  ) {\n    var random_id = function(alphabet, length) {\n      var s = \"\";\n      for (var i = 0; i < length; i++) {\n        s += _.sample(alphabet);\n      }\n      return s;\n    };\n\n    var letters = [\"a\", \"b\", \"c\", \"d\", \"e\", \"f\", \"g\"];\n\n    var random_prefix = random_id(letters, 32);\n    var random_tab_id = random_prefix + \"_tab\";\n    var random_content_id = random_prefix + \"_div\";\n    var random_button_bar = random_prefix + \"_ui\";\n\n    while (\n      $(\"#\" + random_tab_id).length ||\n      $(\"#\" + random_content_id).length ||\n      $(\"#\" + random_button_bar).length\n    ) {\n      random_prefix = random_id(letters, 32);\n      random_tab_id = random_prefix + \"_tab\";\n      random_content_id = random_prefix + \"_div\";\n      random_button_bar = random_prefix + \"_ui\";\n    }\n\n    var tab_container = \"top_level_tab_container\";\n    var content_container = \"top_level_tab_content\";\n    var go_here_when_closed = \"trace-default-tab\";\n\n    // add new tab to the menu bar and switch to it\n    var new_tab_header = $(\"<li></li>\").attr(\"id\", random_tab_id);\n    var new_link = $(\"<a></a>\")\n      .attr(\"href\", \"#\" + random_content_id)\n      .attr(\"data-toggle\", \"tab\")\n      .text(title);\n    $(\n      '<button type=\"button\" class=\"close\" aria-label=\"Close\"><span aria-hidden=\"true\">&times;</span></button>'\n    )\n      .appendTo(new_link)\n      .on(\"click\", function() {\n        self.open_exclusive_tab_close(\n          random_tab_id,\n          random_content_id,\n          go_here_when_closed\n        );\n      });\n\n    new_link.appendTo(new_tab_header);\n    $(\"#\" + tab_container).append(new_tab_header);\n\n    var new_tab_content = $(\"<div></div>\")\n      .addClass(\"tab-pane\")\n      .attr(\"id\", random_content_id)\n      .data(\"cluster\", option_extras.cluster_id);\n\n    if (option_extras.type == \"subcluster\") {\n\n      new_tab_content\n        .addClass(\"subcluster-view\")\n        .addClass(\"subcluster-\" + option_extras.cluster_id.replace(\".\", \"_\"));\n    }\n\n    //     <li class='disabled' id=\"attributes-tab\"><a href=\"#trace-attributes\" data-toggle=\"tab\">Attributes</a></li>\n    var new_button_bar = $('[data-hivtrace=\"cluster-clone\"]')\n      .clone()\n      .attr(\"data-hivtrace\", null);\n    new_button_bar\n      .find(\"[data-hivtrace-button-bar='yes']\")\n      .attr(\"id\", random_button_bar)\n      .addClass(\"cloned-cluster-tab\")\n      .attr(\"data-hivtrace-button-bar\", null);\n\n    new_button_bar.appendTo(new_tab_content);\n    new_tab_content.appendTo(\"#\" + content_container);\n\n    // show the new tab\n    $(new_link).tab(\"show\");\n\n    var cluster_options = {\n      no_cdc: options && options[\"no_cdc\"],\n      \"minimum size\": 0,\n      secondary: true,\n      prefix: random_prefix,\n      extra_menu:\n        options && \"extra_menu\" in options ? options[\"extra_menu\"] : null,\n      \"edge-styler\":\n        options && \"edge-styler\" in options ? options[\"edge-styler\"] : null,\n      \"no-subclusters\": true,\n      \"no-subcluster-compute\": false\n    };\n\n    if (option_extras) {\n      _.extend(cluster_options, option_extras);\n    }\n\n    if (option_extras.showing_on_map && self.countryCentersObject && self.countryOutlines) {\n      cluster_options[\"showing_on_map\"] = true;\n      cluster_options[\"country-centers\"] = self.countryCentersObject;\n      cluster_options[\"country-outlines\"] = self.countryOutlines;\n\n      // Create an array of the countries in the selected cluster for use in styling the map.\n        if (\"extra-graphics\" in cluster_options) {\n            var draw_map = function (other_code,network) {\n                other_code (network);\n                return network._draw_topomap();\n            };\n\n            cluster_options[\"extra-graphics\"] = _.wrap (draw_map, cluster_options[\"extra-graphics\"]);\n        } else {\n            cluster_options[\"extra-graphics\"] = function (network) {\n                return network._draw_topomap();\n            }\n        }\n    }\n\n\n\n\n    var cluster_view = hivtrace.clusterNetwork(\n      filtered_json,\n      \"#\" + random_content_id,\n      null,\n      null,\n      random_button_bar,\n      attributes,\n      null,\n      null,\n      null,\n      parent_container,\n      cluster_options\n    );\n\n    if (self.colorizer[\"category_id\"]) {\n      if (self.colorizer[\"continuous\"]) {\n        cluster_view.handle_attribute_continuous(self.colorizer[\"category_id\"]);\n      } else {\n        cluster_view.handle_attribute_categorical(\n          self.colorizer[\"category_id\"]\n        );\n      }\n    }\n\n    if (self.node_shaper[\"id\"]) {\n      cluster_view.handle_shape_categorical(self.node_shaper[\"id\"]);\n    }\n\n    if (self.colorizer[\"opacity_id\"]) {\n      cluster_view.handle_attribute_opacity(self.colorizer[\"opacity_id\"]);\n    }\n\n    cluster_view.expand_cluster_handler(cluster_view.clusters[0], true);\n    return cluster_view;\n\n\n    // copy all the divs other than the one matching the network tab ID\n    /*var cloned_empty_tab  = $('#trace-results').clone();\n    cloned_empty_tab.attr (\"id\", random_content_id);\n    console.log (cloned_empty_tab);\n\n    cloned_empty_tab.appendTo (\".tab-content\");    */\n\n    /*self.cluster_filtering_functions ['cluster_id'] = function (c) {return c.cluster_id == cluster.cluster_id;};\n    cluster.exclusive = 1;\n    self.has_exclusive_view = cluster.cluster_id;\n    self.draw_attribute_labels();\n    self.update(false);*/\n  };\n\n  self.get_ui_element_selector_by_role = function(role, not_nested) {\n    if (not_nested && !self.primary_graph) {\n      return undefined;\n    }\n    return (\n      (not_nested ? \"\" : \"#\" + self.ui_container_selector) +\n      \" [data-hivtrace-ui-role='\" +\n      role +\n      \"']\"\n    );\n  };\n\n  // ensure all checkboxes are unchecked at initialization\n  $('input[type=\"checkbox\"]').prop(\"checked\", false);\n\n  var handle_node_click = function(node) {\n    var container = d3.select(self.container);\n    var id = \"d3_context_menu_id\";\n    var menu_object = container.select(\"#\" + id);\n\n    if (menu_object.empty()) {\n      menu_object = container\n        .append(\"ul\")\n        .attr(\"id\", id)\n        .attr(\"class\", \"dropdown-menu\")\n        .attr(\"role\", \"menu\");\n    }\n\n    menu_object.selectAll(\"li\").remove();\n\n    if (node) {\n      node.fixed = 1;\n      menu_object\n        .append(\"li\")\n        .append(\"a\")\n        .attr(\"tabindex\", \"-1\")\n        .text(\"Collapse cluster\")\n        .on(\"click\", function(d) {\n          node.fixed = 0;\n          collapse_cluster_handler(node, true);\n          menu_object.style(\"display\", \"none\");\n        });\n\n      // SW20180605 : To be implemented\n\n      //menu_object\n      //  .append(\"li\")\n      //  .append(\"a\")\n      //  .attr(\"tabindex\", \"-1\")\n      //  .text(\"Show sequences used to make cluster\")\n      //  .on(\"click\", function(d) {\n      //    node.fixed = 0;\n      //    show_sequences_in_cluster (node, true);\n      //    menu_object.style(\"display\", \"none\");\n      //  });\n\n      menu_object\n        .style(\"position\", \"absolute\")\n        .style(\"left\", \"\" + d3.event.offsetX + \"px\")\n        .style(\"top\", \"\" + d3.event.offsetY + \"px\")\n        .style(\"display\", \"block\");\n    } else {\n      menu_object.style(\"display\", \"none\");\n    }\n\n    container.on(\n      \"click\",\n      function(d) {\n        handle_node_click(null);\n      },\n      true\n    );\n  };\n\n  function get_initial_xy(packed) {\n    // create clusters from nodes\n    var mapped_clusters = get_all_clusters(self.nodes);\n\n    var d_clusters = {\n      id: \"root\",\n      children: []\n    };\n\n    // filter out clusters that are to be excluded\n    if (self.exclude_cluster_ids) {\n      mapped_clusters = _.omit(mapped_clusters, self.exclude_cluster_ids);\n    }\n\n    d_clusters.children = _.map(mapped_clusters, (value, key) => {\n      return {\n        cluster_id: key,\n        children: value\n      };\n    });\n\n    var treemap = packed\n      ? d3.layout\n          .pack()\n          .size([self.width, self.height])\n          //.sticky(true)\n          .children(function(d) {\n            return d.children;\n          })\n          .value(function(d) {\n            return Math.pow(d.parent.children.length, 1.5);\n          })\n          .sort(function(a, b) {\n            return b.value - a.value;\n          })\n          .padding(5)\n      : d3.layout\n          .treemap()\n          .size([self.width, self.height])\n          //.sticky(true)\n          .children(function(d) {\n            return d.children;\n          })\n          .value(function(d) {\n            return Math.pow(d.parent.children.length, 1.0);\n          })\n          .sort(function(a, b) {\n            return a.value - b.value;\n          })\n          .ratio(1);\n\n    var clusters = treemap.nodes(d_clusters);\n    _.each(clusters, function(c) {\n      //c.fixed = true;\n    });\n    return clusters;\n  }\n\n  function prepare_data_to_graph() {\n    var graphMe = {};\n    graphMe.all = [];\n    graphMe.edges = [];\n    graphMe.nodes = [];\n    graphMe.clusters = [];\n\n    var expandedClusters = [];\n    var drawnNodes = [];\n\n    self.clusters.forEach(function(x) {\n      if (self.cluster_display_filter(x)) {\n        // Check if hxb2_linked is in a child\n        var hxb2_exists =\n          x.children.some(function(c) {\n            return c.hxb2_linked;\n          }) && self.hide_hxb2;\n        if (!hxb2_exists) {\n          if (x.collapsed) {\n            graphMe.clusters.push(x);\n            graphMe.all.push(x);\n          } else {\n            expandedClusters[x.cluster_id] = true;\n          }\n        }\n      }\n    });\n\n    self.nodes.forEach(function(x, i) {\n      if (expandedClusters[x.cluster]) {\n        drawnNodes[i] = graphMe.nodes.length + graphMe.clusters.length;\n        graphMe.nodes.push(x);\n        graphMe.all.push(x);\n      }\n    });\n\n    self.edges.forEach(function(x) {\n      if (!(x.removed && self.filter_edges)) {\n        if (\n          drawnNodes[x.source] !== undefined &&\n          drawnNodes[x.target] !== undefined\n        ) {\n          var y = {};\n          for (var prop in x) {\n            y[prop] = x[prop];\n          }\n\n          y.source = drawnNodes[x.source];\n          y.target = drawnNodes[x.target];\n          graphMe.edges.push(y);\n        }\n      }\n    });\n\n    return graphMe;\n  }\n\n  self._refresh_subcluster_view = function (set_date) {\n\n    self.annotate_priority_clusters(\n      _networkCDCDateField,\n      36,\n      12,\n      set_date\n    );\n\n    var field_def = self.recent_rapid_definition(\n      self,\n      set_date\n    );\n\n    self.inject_attribute_description(\"recent_rapid\", field_def);\n    self._aux_process_category_values(\n      self._aux_populate_category_fields(\n        field_def,\n        \"recent_rapid\"\n      )\n    );\n\n    self.handle_attribute_categorical(\"recent_rapid\");\n\n  };\n\n  self.view_subcluster = function(cluster, custom_filter, custom_name, options, custom_edge_filter, include_injected_edges) {\n\n    var filtered_json = _extract_single_cluster(\n      custom_filter\n        ? (_.isArray (custom_filter) ? custom_filter : _.filter(self.json.Nodes, custom_filter))\n        : cluster.children,\n      custom_edge_filter || function(e) {\n        return e.length <= self.subcluster_threshold;\n      },\n      false,\n      null,\n      include_injected_edges\n    );\n\n    _.each(filtered_json.Nodes, function(n) {\n      n.subcluster = \"1.1\";\n    });\n\n    if (_networkGraphAttrbuteID in json) {\n      filtered_json[_networkGraphAttrbuteID] = {};\n      jQuery.extend(\n        true,\n        filtered_json[_networkGraphAttrbuteID],\n        json[_networkGraphAttrbuteID]\n      );\n    }\n\n    options = options || new Object;\n\n    var extra_menu_items = [\n      [\n        function(network, item) {\n          var enclosure = item.append(\"div\").classed(\"form-group\", true);\n          var label = enclosure\n            .append(\"label\")\n            .text(\"Recalculate R&R from \")\n            .classed(\"control-label\", true);\n          var date = enclosure\n            .append(\"input\")\n            .attr(\"type\", \"date\")\n            .classed(\"form-control\", true)\n            .attr(\"value\", _defaultDateViewFormatSlider(self.today))\n            .attr(\"max\", _defaultDateViewFormatSlider(self.today))\n            .attr(\n              \"min\",\n              _defaultDateViewFormatSlider(\n                d3.min(network.nodes, function(node) {\n                  return network.attribute_node_value_by_id(\n                    node,\n                    _networkCDCDateField\n                  );\n                })\n              )\n            )\n            .on(\"input\", function(e) {\n              //d3.event.preventDefault();\n              var set_date = _defaultDateViewFormatSlider.parse(this.value);\n              if (this.value) {\n                network._refresh_subcluster_view (set_date);\n\n                enclosure\n                  .classed(\"has-success\", true)\n                  .classed(\"has-error\", false);\n              } else {\n                enclosure\n                  .classed(\"has-success\", false)\n                  .classed(\"has-error\", true);\n              }\n            });\n        },\n        null\n      ],\n      [\n        \"Export cluster to .CSV\",\n        function(network) {\n          helpers.export_csv_button(\n            network._extract_attributes_for_nodes(\n              network._extract_nodes_by_id(\"1.1\"),\n              network._extract_exportable_attributes()\n            )\n          );\n        }\n      ]\n    ];\n\n\n    options [\"type\"] = \"subcluster\";\n    options [\"cluster_id\"] = cluster.cluster_id;\n    if (\"extra_menu\" in options) {\n        options [\"extra_menu\"][\"items\"] = options [\"extra_menu\"][\"items\"].concat (extra_menu_items);\n    } else {\n        options [\"extra_menu\"] = {\n            title: \"Action\",\n            items: extra_menu_items\n          };\n    }\n\n    //self._check_for_time_series(extra_menu_items);\n    var cluster_view = self\n      .open_exclusive_tab_view_aux(\n        filtered_json,\n        custom_name || \"Subcluster \" + cluster.cluster_id,\n        options\n      );\n      cluster_view.handle_attribute_categorical(\"recent_rapid\");\n      return cluster_view;\n\n    /*var selector =\n      \".subcluster-\" +\n      cluster.id.replace(\".\", \"_\") +\n      \" .show-small-clusters-button\";\n\n    var item = $(\n      '<span class=\"input-group-addon btn view-parent-btn\">View Parent</span>'\n    )\n      .data(\"cluster_id\", cluster.parent_cluster.cluster_id)\n      .insertAfter(selector);\n\n    item.on(\"click\", function(e) {\n      self.open_exclusive_tab_view($(this).data(\"cluster_id\"));\n    });*/\n  };\n\n  function _n_months_ago(reference_date, months) {\n    var past_date = new Date(reference_date);\n    var past_months = past_date.getMonth();\n    var diff_year = Math.floor(months / 12);\n    var left_over = months - diff_year * 12;\n\n    if (left_over > past_months) {\n      past_date.setFullYear(past_date.getFullYear() - diff_year - 1);\n      past_date.setMonth(12 - (left_over - past_months));\n    } else {\n      past_date.setFullYear(past_date.getFullYear() - diff_year);\n      past_date.setMonth(past_months - left_over);\n    }\n\n    //past_date.setTime (past_date.getTime () - months * 30 * 24 * 3600000);\n    return past_date;\n  }\n\n  var oldest_nodes_first = function(n1, n2) {\n\n    let date_field = date_field || _networkCDCDateField;\n\n    // consistent node sorting, older nodes first\n    var node1_dx = self.attribute_node_value_by_id(n1, date_field);\n    var node2_dx = self.attribute_node_value_by_id(n2, date_field);\n\n    if (node1_dx == node2_dx) {\n      return n1.id < n2.id ? -1 : 1;\n    } else {\n      return node1_dx < node2_dx ? -1 : 1;\n    }\n\n    return 0;\n\n  };\n\n  self.annotate_priority_clusters = function(\n    date_field,\n    span_months,\n    recent_months,\n    start_date\n  ) {\n\n    try {\n\n      start_date = start_date || self.today;\n\n      var filter_by_date = function(cutoff, node) {\n        var node_dx = self.attribute_node_value_by_id(node, date_field);\n        if (node_dx instanceof Date) {\n          return node_dx >= cutoff && node_dx <= start_date;\n        } else {\n          try {\n              node_dx = self._parse_dates(\n                self.attribute_node_value_by_id(node, date_field)\n              );\n              if (node_dx instanceof Date) {\n                return node_dx >= cutoff && node_dx <= start_date;\n              }\n          } catch (err) {\n            return undefined;\n          }\n        }\n        return false;\n      };\n\n      var cutoff_long = _n_months_ago(start_date, span_months);\n      var cutoff_short = _n_months_ago(start_date, recent_months);\n\n      var node_iterator;\n\n      if (start_date == self.today) {\n        node_iterator = self.nodes;\n      } else {\n\n        var beginning_of_time = new Date();\n        beginning_of_time.setYear(1900);\n        node_iterator = [];\n        _.each(self.nodes, function(node) {\n          var filter_result = filter_by_date (beginning_of_time, node);\n          if (_.isUndefined (filter_result)) {\n            node.priority_flag = 6;\n          } else {\n              if (filter_result) {\n                node.priority_flag = 5;\n                node_iterator.push(node);\n              } else {\n                node.priority_flag = 4;\n              }\n          }\n        });\n\n      }\n\n      // extract all clusters at once to avoid inefficiencies of multiple edge-set traverals\n\n      var split_clusters = {};\n      var node_id_to_local_cluster = {};\n\n      // reset all annotations\n\n      _.each(node_iterator, function(node) {\n        if (node.cluster) {\n          if (!(node.cluster in split_clusters)) {\n            split_clusters[node.cluster] = { Nodes: [], Edges: [] };\n          }\n          node_id_to_local_cluster[node.id] =\n            split_clusters[node.cluster][\"Nodes\"].length;\n          split_clusters[node.cluster][\"Nodes\"].push(node);\n        }\n      });\n\n      _.each(self.edges, function(edge) {\n        if (edge.length <= self.subcluster_threshold) {\n          var edge_cluster = json.Nodes[edge.source].cluster;\n\n          var source_id = json.Nodes[edge.source].id,\n            target_id = json.Nodes[edge.target].id;\n\n          if (\n            source_id in node_id_to_local_cluster &&\n            target_id in node_id_to_local_cluster\n          ) {\n            var copied_edge = _.clone(edge);\n\n            copied_edge.source = node_id_to_local_cluster[source_id];\n            copied_edge.target = node_id_to_local_cluster[target_id];\n\n            split_clusters[edge_cluster][\"Edges\"].push(copied_edge);\n          }\n        }\n      });\n\n      _.each(split_clusters, function(cluster_nodes, cluster_index) {\n        /** extract subclusters; all nodes at given threshold */\n        /** Sub-Cluster: all nodes connected at 0.005 subs/site; there can be multiple sub-clusters per cluster */\n\n        //var cluster_nodes       = _extract_single_cluster (cluster.children, null, true);\n\n        var array_index = self.cluster_mapping[cluster_index];\n\n        self.clusters[array_index].priority_score = 0;\n\n        /** all clusters with more than one member connected at 'threshold' edge length */\n        var edges = [];\n\n        var subclusters = _.filter(\n          hivtrace_cluster_depthwise_traversal(\n            cluster_nodes.Nodes,\n            cluster_nodes.Edges,\n            null,\n            edges\n          ),\n          function(cc) {\n            return cc.length > 1;\n          }\n        );\n\n        edges = _.filter(edges, function(es) {\n          return es.length > 1;\n        });\n\n        /** sort subclusters by oldest node */\n        _.each(subclusters, function(c, i) {\n          c.sort(oldest_nodes_first);\n        });\n\n        subclusters.sort(function(c1, c2) {\n          return oldest_nodes_first(c1[0], c2[0]);\n        });\n\n        subclusters = _.map(subclusters, function(c, i) {\n          var label = self.clusters[array_index].cluster_id + \"-\" + (i + 1);\n\n          _.each(c, function(n) {\n            n.subcluster = label;\n            n.subcluster_label = label;\n            n.priority_flag = 0;\n            n.in_rr = 0;\n          });\n\n          return {\n            children: _.clone(c),\n            parent_cluster: self.clusters[array_index],\n            cluster_id: label,\n            distances: helpers.describe_vector(\n              _.map(edges[i], function(e) {\n                return e.length;\n              })\n            )\n          };\n        });\n\n        _.each(subclusters, function(c) {\n          _compute_cluster_degrees(c);\n        });\n\n        self.clusters[array_index].subclusters = subclusters;\n\n        /** now, for each subcluster, extract the recent and rapid part */\n\n        /** Recent & Rapid (R&R) Cluster: the part of the Sub-Cluster inferred using only cases dxd in the previous 36 months\n                and at least two cases dxd in the previous 12 months; there is a path between all nodes in an R&R Cluster\n\n                20180406 SLKP: while unlikely, this definition could result in multiple R&R clusters\n                per subclusters; for now we will add up all the cases for prioritization, and\n                display the largest R&R cluster if there is more than one\n            */\n\n        _.each(subclusters, function(sub) {\n\n          // extract nodes based on dates\n          var subcluster_json = _extract_single_cluster(\n            _.filter(sub.children, _.partial(filter_by_date, cutoff_long)),\n            null,\n            true,\n            cluster_nodes\n          );\n\n          var rr_cluster = _.filter(\n            hivtrace_cluster_depthwise_traversal(\n              subcluster_json.Nodes,\n              _.filter(subcluster_json.Edges, function(e) {\n                return e.length <= self.subcluster_threshold;\n              })\n            ),\n            function(cc) {\n              return cc.length > 1;\n            }\n          );\n\n          sub.rr_count = rr_cluster.length;\n\n          rr_cluster.sort(function(a, b) {\n            return b.length - a.length;\n          });\n\n          sub.priority_score = [];\n          sub.recent_nodes = [];\n\n          _.each(rr_cluster, function(recent_cluster) {\n\n            var priority_nodes = _.groupBy(\n              recent_cluster,\n              _.partial(filter_by_date, cutoff_short)\n            );\n\n            sub.recent_nodes.push(recent_cluster.length);\n\n            if (true in priority_nodes) {\n              sub.priority_score.push(priority_nodes[true].length);\n              _.each(priority_nodes[true], function(n) {\n                n.priority_flag = filter_by_date(start_date, n) ? 4 : 1;\n                if (priority_nodes[true].length >= 3) {\n                  n.in_rr = true;\n                  if (n.priority_flag == 1) {\n                    n.priority_flag = 2;\n                  }\n                }\n              });\n            }\n            if (false in priority_nodes) {\n              _.each(priority_nodes[false], function(n) {\n                n.priority_flag = 3;\n              });\n            }\n          });\n\n          //console.log (sub.recent_nodes);\n          self.clusters[array_index].priority_score = sub.priority_score;\n        });\n\n      });\n\n    } catch (err) {\n      console.log(err);\n      return;\n    }\n\n  };\n\n  function default_layout(packed) {\n    // let's create an array of clusters from the json\n\n    var init_layout = get_initial_xy(packed);\n\n    if (self.clusters.length == 0) {\n      self.clusters = init_layout.filter(function(v, i, obj) {\n        return !(typeof v.cluster_id === \"undefined\");\n      });\n    } else {\n      var coordinate_update = {};\n      _.each(self.clusters, function(c) {\n        coordinate_update[c.cluster_id] = c;\n      });\n      _.each(init_layout, function(c) {\n        if (\"cluster_id\" in c) {\n          _.extendOwn(coordinate_update[c.cluster_id], c);\n        }\n      });\n    }\n\n    //var sizes = network_layout.size();\n\n    var set_init_coords = packed\n      ? function(n) {\n          n.x += n.r * 0.5;\n          n.y += n.r * 0.5;\n        }\n      : function(n) {\n          n.x += n.dx * 0.5;\n          n.y += n.dy * 0.5;\n        };\n\n    _.each([self.nodes, self.clusters], function(list) {\n      _.each(list, set_init_coords);\n    });\n\n    self.clusters.forEach(collapse_cluster);\n  }\n\n  function change_spacing(delta) {\n    self.charge_correction = self.charge_correction * delta;\n    network_layout.start();\n  }\n\n  function change_window_size(delta, trigger) {\n    if (delta) {\n      var x_scale = (self.width + delta / 2) / self.width;\n      var y_scale = (self.height + delta / 2) / self.height;\n\n      self.width += delta;\n      self.height += delta;\n\n      var rescale_x = d3.scale.linear().domain(\n        d3.extent(network_layout.nodes(), function(node) {\n          return node.x;\n        })\n      );\n      rescale_x.range(\n        _.map(rescale_x.domain(), function(v) {\n          return v * x_scale;\n        })\n      );\n      //.range ([50,self.width-50]),\n      var rescale_y = d3.scale.linear().domain(\n        d3.extent(network_layout.nodes(), function(node) {\n          return node.y;\n        })\n      );\n      rescale_y.range(\n        _.map(rescale_y.domain(), function(v) {\n          return v * y_scale;\n        })\n      );\n\n      _.each(network_layout.nodes(), function(node) {\n        node.x = rescale_x(node.x);\n        node.y = rescale_y(node.y);\n      });\n    }\n\n    self.width = Math.min(Math.max(self.width, 200), 4000);\n    self.height = Math.min(Math.max(self.height, 200), 4000);\n\n    network_layout.size([self.width, self.height]);\n    self.network_svg.attr(\"width\", self.width).attr(\"height\", self.height);\n    self._calc_country_nodes (options);\n    self._draw_topomap (true);\n    if (trigger) {\n      network_layout.start();\n    } else {\n      if (delta) {\n        self.update(true);\n      }\n    }\n  }\n\n  self.compute_adjacency_list = _.once(function() {\n    self.nodes.forEach(function(n) {\n      n.neighbors = d3.set();\n    });\n\n    self.edges.forEach(function(e) {\n      self.nodes[e.source].neighbors.add(e.target);\n      self.nodes[e.target].neighbors.add(e.source);\n    });\n  });\n\n  self.compute_local_clustering_coefficients = _.once(function() {\n    self.compute_adjacency_list();\n\n    self.nodes.forEach(function(n) {\n      _.defer(function(a_node) {\n        neighborhood_size = a_node.neighbors.size();\n        if (neighborhood_size < 2) {\n          a_node.lcc = misc.undefined;\n        } else {\n          if (neighborhood_size > 500) {\n            a_node.lcc = misc.too_large;\n          } else {\n            // count triangles\n            neighborhood = a_node.neighbors.values();\n            counter = 0;\n            for (n1 = 0; n1 < neighborhood_size; n1 += 1) {\n              for (n2 = n1 + 1; n2 < neighborhood_size; n2 += 1) {\n                if (\n                  self.nodes[neighborhood[n1]].neighbors.has(neighborhood[n2])\n                ) {\n                  counter++;\n                }\n              }\n            }\n\n            a_node.lcc =\n              2 * counter / neighborhood_size / (neighborhood_size - 1);\n          }\n        }\n      }, n);\n    });\n  });\n\n  self.get_node_by_id = function(id) {\n    return self.nodes.filter(function(n) {\n      return n.id == id;\n    })[0];\n  };\n\n  self.compute_local_clustering_coefficients_worker = _.once(function() {\n    var worker = new Worker(\"workers/lcc.js\");\n\n    worker.onmessage = function(event) {\n      var nodes = event.data.Nodes;\n\n      nodes.forEach(function(n) {\n        node_to_update = self.get_node_by_id(n.id);\n        node_to_update.lcc = n.lcc ? n.lcc : misc.undefined;\n      });\n    };\n\n    var worker_obj = {};\n    worker_obj[\"Nodes\"] = self.nodes;\n    worker_obj[\"Edges\"] = self.edges;\n    worker.postMessage(worker_obj);\n  });\n\n  var estimate_cubic_compute_cost = _.memoize(\n    function(c) {\n      self.compute_adjacency_list();\n      return _.reduce(\n        _.first(_.pluck(c.children, \"degree\").sort(d3.descending), 3),\n        function(memo, value) {\n          return memo * value;\n        },\n        1\n      );\n    },\n    function(c) {\n      return c.cluster_id;\n    }\n  );\n\n  self.compute_global_clustering_coefficients = _.once(function() {\n    self.compute_adjacency_list();\n\n    self.clusters.forEach(function(c) {\n      _.defer(function(a_cluster) {\n        cluster_size = a_cluster.children.length;\n        if (cluster_size < 3) {\n          a_cluster.cc = misc.undefined;\n        } else {\n          if (estimate_cubic_compute_cost(a_cluster, true) >= 5000000) {\n            a_cluster.cc = misc.too_large;\n          } else {\n            // pull out all the nodes that have this cluster id\n            member_nodes = [];\n\n            var triads = 0;\n            var triangles = 0;\n\n            self.nodes.forEach(function(n, i) {\n              if (n.cluster == a_cluster.cluster_id) {\n                member_nodes.push(i);\n              }\n            });\n            member_nodes.forEach(function(node) {\n              my_neighbors = self.nodes[node].neighbors\n                .values()\n                .map(function(d) {\n                  return +d;\n                })\n                .sort(d3.ascending);\n              for (n1 = 0; n1 < my_neighbors.length; n1 += 1) {\n                for (n2 = n1 + 1; n2 < my_neighbors.length; n2 += 1) {\n                  triads += 1;\n                  if (\n                    self.nodes[my_neighbors[n1]].neighbors.has(my_neighbors[n2])\n                  ) {\n                    triangles += 1;\n                  }\n                }\n              }\n            });\n\n            a_cluster.cc = triangles / triads;\n          }\n        }\n      }, c);\n    });\n  });\n\n  self.mark_nodes_as_processing = function(property) {\n    self.nodes.forEach(function(n) {\n      n[property] = misc.processing;\n    });\n  };\n\n  self.compute_graph_stats = function() {\n    d3.select(this).classed(\"disabled\", true).select(\"i\").classed({\n      \"fa-calculator\": false,\n      \"fa-cog\": true,\n      \"fa-spin\": true\n    });\n    self.mark_nodes_as_processing(\"lcc\");\n    self.compute_local_clustering_coefficients_worker();\n    self.compute_global_clustering_coefficients();\n    d3.select(this).remove();\n  };\n\n  /*------------ Constructor ---------------*/\n  function initial_json_load() {\n    var connected_links = [];\n    var total = 0;\n    self.exclude_cluster_ids = {};\n    self.has_hxb2_links = false;\n    self.cluster_sizes = [];\n\n    graph_data.Nodes.forEach(function(d) {\n      if (typeof self.cluster_sizes[d.cluster - 1] === \"undefined\") {\n        self.cluster_sizes[d.cluster - 1] = 1;\n      } else {\n        self.cluster_sizes[d.cluster - 1]++;\n      }\n      if (\"is_lanl\" in d) {\n        d.is_lanl = d.is_lanl == \"true\";\n      }\n\n      if (d.attributes.indexOf(\"problematic\") >= 0) {\n        self.has_hxb2_links = d.hxb2_linked = true;\n      }\n    });\n\n    /* add buttons and handlers */\n    /* clusters first */\n\n    self.ui_container_selector = button_bar_ui;\n\n    self._extract_attributes_for_nodes = function(nodes, column_names) {\n      var result = [\n        _.map(column_names, function(c) {\n          return c.raw_attribute_key;\n        })\n      ];\n      _.each(nodes, function(n) {\n        result.push(\n          _.map(column_names, function(c) {\n            if (c.raw_attribute_key == _networkNodeIDField) {\n                return n.id;\n            }\n            if (_.has (n, c.raw_attribute_key)) {\n                return n[c.raw_attribute_key];\n            }\n            return self.attribute_node_value_by_id(n, c.raw_attribute_key);\n          })\n        );\n      });\n      return result;\n    };\n\n    self._extract_exportable_attributes = function(extended) {\n      var allowed_types = {\n        String: 1,\n        Date: 1,\n        Number: 1\n      };\n\n      var return_array = [];\n      \n      if (extended) {\n        return_array = [{\n                            \"raw_attribute_key\" : _networkNodeIDField,\n                            \"type\" : \"String\",\n                            \"label\" : \"Node ID\",\n                            \"format\" : function () {return \"Node ID\";}\n                        },\n                        {\n                            \"raw_attribute_key\" : \"cluster\",\n                            \"type\" : \"String\",\n                            \"label\" : \"Which cluster the individual belongs to\",\n                            \"format\" : function () {return \"Cluster ID\";}\n                        },\n                        {                        \n                            \"raw_attribute_key\" : \"subcluster\",\n                            \"type\" : \"String\",\n                            \"label\" : \"Which subcluster the individual belongs to\",\n                            \"format\" : function () {return \"Subcluster ID\";}\n                        }                        \n                        ];\n      }\n\n      return_array.push(_.filter(self.json[_networkGraphAttrbuteID], function(d) {\n        return d.type in allowed_types;\n      }));\n\n\n      return _.flatten (return_array, true);\n    };\n\n    self._extract_nodes_by_id = function(id) {\n      var string_id = id.toString();\n      return _.filter(self.nodes, function(n) {\n        return n.cluster == id || n.subcluster == string_id;\n      });\n    };\n\n    self._cluster_list_view_render = function(\n      cluster_id,\n      group_by_attribute,\n      the_list\n    ) {\n      the_list.selectAll(\"*\").remove();\n      var column_ids = self._extract_exportable_attributes();\n      var cluster_nodes = self._extract_nodes_by_id(cluster_id);\n\n      d3\n        .select(\n          self.get_ui_element_selector_by_role(\"cluster_list_data_export\", true)\n        )\n        .on(\"click\", function(d) {\n          helpers.export_csv_button(\n            self._extract_attributes_for_nodes(cluster_nodes, column_ids)\n          );\n        });\n\n      if (group_by_attribute) {\n        _.each(column_ids, function(column) {\n          var binned = _.groupBy(cluster_nodes, function(n) {\n            return self.attribute_node_value_by_id(n, column.raw_attribute_key);\n          });\n          var sorted_keys = _.keys(binned).sort();\n          var attribute_record = the_list.append(\"li\");\n          attribute_record.append(\"code\").text(column.raw_attribute_key);\n          var attribute_list = attribute_record\n            .append(\"dl\")\n            .classed(\"dl-horizontal\", true);\n          _.each(sorted_keys, function(key) {\n            attribute_list.append(\"dt\").text(key);\n            attribute_list.append(\"dd\").text(\n              _.map(binned[key], function(n) {\n                return n.id;\n              }).join(\", \")\n            );\n          });\n        });\n      } else {\n        _.each(cluster_nodes, function(node) {\n          var patient_record = the_list.append(\"li\");\n          patient_record.append(\"code\").text(node.id);\n          var patient_list = patient_record\n            .append(\"dl\")\n            .classed(\"dl-horizontal\", true);\n          _.each(column_ids, function(column) {\n            patient_list.append(\"dt\").text(column.raw_attribute_key);\n            patient_list\n              .append(\"dd\")\n              .text(\n                self.attribute_node_value_by_id(node, column.raw_attribute_key)\n              );\n          });\n        });\n      }\n    };\n\n    self._setup_cluster_list_view = function() {\n      d3\n        .select(\n          self.get_ui_element_selector_by_role(\"cluster_list_view_toggle\", true)\n        )\n        .on(\"click\", function() {\n          d3.event.preventDefault();\n          var group_by_id = false;\n\n          var button_clicked = $(this);\n          if (button_clicked.data(\"view\") == \"id\") {\n            button_clicked.data(\"view\", \"attribute\");\n            button_clicked.text(\"Group by ID\");\n            group_by_id = false;\n          } else {\n            button_clicked.data(\"view\", \"id\");\n            button_clicked.text(\"Group by attribute\");\n            group_by_id = true;\n          }\n          self._cluster_list_view_render(\n            button_clicked.data(\"cluster\").toString(),\n            !group_by_id,\n            d3.select(\n              self.get_ui_element_selector_by_role(\"cluster_list_payload\", true)\n            )\n          );\n        });\n\n      $(\n        self.get_ui_element_selector_by_role(\"cluster_list\", true)\n      ).on(\"show.bs.modal\", function(event) {\n        var link_clicked = $(event.relatedTarget);\n        var cluster_id = link_clicked.data(\"cluster\");\n        var modal = d3.select(\n          self.get_ui_element_selector_by_role(\"cluster_list\", true)\n        );\n        modal\n          .selectAll(\".modal-title\")\n          .text(\"Listing nodes in cluster \" + cluster_id);\n        $(\n          self.get_ui_element_selector_by_role(\"cluster_list_view_toggle\", true)\n        ).data(\"cluster\", cluster_id);\n\n        self._cluster_list_view_render(\n          cluster_id,\n          $(\n            self.get_ui_element_selector_by_role(\n              \"cluster_list_view_toggle\",\n              true\n            )\n          ).data(\"view\") != \"id\",\n          modal.select(\n            self.get_ui_element_selector_by_role(\"cluster_list_payload\", true)\n          )\n        );\n      });\n    };\n\n    if (button_bar_ui) {\n      self._setup_cluster_list_view();\n\n      var cluster_ui_container = d3.select(\n        self.get_ui_element_selector_by_role(\"cluster_operations_container\")\n      );\n\n      cluster_ui_container.selectAll(\"li\").remove();\n\n      var fix_handler = function(do_fix) {\n        _.each([self.clusters, self.nodes], function(list) {\n          _.each(list, function(obj) {\n            obj.fixed = do_fix;\n          });\n        });\n      };\n\n      var layout_reset_handler = function(packed) {\n        var fixed = [];\n        _.each(self.clusters, function(obj) {\n          if (obj.fixed) {\n            fixed.push(obj);\n          }\n          obj.fixed = false;\n        });\n        default_layout(packed);\n        network_layout.tick();\n        self.update();\n        _.each(fixed, function(obj) {\n          obj.fixed = true;\n        });\n      };\n\n      var cluster_commands = [\n        [\n          \"Expand All\",\n          function() {\n            return self.expand_some_clusters();\n          },\n          true,\n          \"hivtrace-expand-all\"\n        ],\n        [\n          \"Collapse All\",\n          function() {\n            return self.collapse_some_clusters();\n          },\n          true,\n          \"hivtrace-collapse-all\"\n        ],\n        [\n          \"Expand Filtered\",\n          function() {\n            return self.expand_some_clusters(\n              self.select_some_clusters(function(n) {\n                return n.match_filter;\n              })\n            );\n          },\n          true,\n          \"hivtrace-expand-filtered\"\n        ],\n        [\n          \"Collapse Filtered\",\n          function() {\n            return self.collapse_some_clusters(\n              self.select_some_clusters(function(n) {\n                return n.match_filter;\n              })\n            );\n          },\n          true,\n          \"hivtrace-collapse-filtered\"\n        ],\n        [\n          \"Fix all objects in place\",\n          _.partial(fix_handler, true),\n          true,\n          \"hivtrace-fix-in-place\"\n        ],\n        [\n          \"Allow all objects to float\",\n          _.partial(fix_handler, false),\n          true,\n          \"hivtrace-allow-to-float\"\n        ],\n        [\n          \"Reset layout [packed]\",\n          _.partial(layout_reset_handler, true),\n          true,\n          \"hivtrace-reset-layout\"\n        ],\n        [\n          \"Reset layout [tiled]\",\n          _.partial(layout_reset_handler, false),\n          true,\n          \"hivtrace-reset-layout\"\n        ],\n        [\n          \"Hide problematic clusters\",\n          function(item) {\n            d3\n              .select(item)\n              .text(\n                self.hide_hxb2\n                  ? \"Hide problematic clusters\"\n                  : \"Show problematic clusters\"\n              );\n            self.toggle_hxb2();\n          },\n          self.has_hxb2_links,\n          \"hivtrace-hide-problematic-clusters\"\n        ]\n      ];\n\n      if (!self._is_CDC_) {\n        cluster_commands.push([\n          \"Show removed edges\",\n          function(item) {\n            self.filter_edges = !self.filter_edges;\n            d3\n              .select(item)\n              .text(\n                self.filter_edges ? \"Show removed edges\" : \"Hide removed edges\"\n              );\n            self.update(false);\n          },\n          function() {\n            return _.some(self.edges, function(d) {\n              return d.removed;\n            });\n          },\n          \"hivtrace-show-removed-edges\"\n        ]);\n      }\n\n      cluster_commands.forEach(function(item, index) {\n        var handler_callback = item[1];\n        if (item[2]) {\n          this.append(\"li\")\n            .append(\"a\")\n            .text(item[0])\n            .attr(\"href\", \"#\")\n            //.attr(\"id\", item[3])\n            .on(\"click\", function(e) {\n              handler_callback(this);\n              d3.event.preventDefault();\n            });\n        }\n      }, cluster_ui_container);\n\n      var button_group = d3.select(\n        self.get_ui_element_selector_by_role(\"button_group\")\n      );\n\n      if (!button_group.empty()) {\n        button_group.selectAll(\"button\").remove();\n        button_group\n          .append(\"button\")\n          .classed(\"btn btn-default btn-sm\", true)\n          .attr(\"title\", \"Expand spacing\")\n          .on(\"click\", function(d) {\n            change_spacing(5 / 4);\n          })\n          .append(\"i\")\n          .classed(\"fa fa-plus\", true);\n        button_group\n          .append(\"button\")\n          .classed(\"btn btn-default btn-sm\", true)\n          .attr(\"title\", \"Compress spacing\")\n          .on(\"click\", function(d) {\n            change_spacing(4 / 5);\n          })\n          .append(\"i\")\n          .classed(\"fa fa-minus\", true);\n        button_group\n          .append(\"button\")\n          .classed(\"btn btn-default btn-sm\", true)\n          .attr(\"title\", \"Enlarge window\")\n          .on(\"click\", function(d) {\n            change_window_size(100, true);\n          })\n          .append(\"i\")\n          .classed(\"fa fa-expand\", true);\n        button_group\n          .append(\"button\")\n          .classed(\"btn btn-default btn-sm\", true)\n          .attr(\"title\", \"Shrink window\")\n          .on(\"click\", function(d) {\n            change_window_size(-100, true);\n          })\n          .append(\"i\")\n          .classed(\"fa fa-compress\", true);\n\n        if (!self._is_CDC_) {\n          button_group\n            .append(\"button\")\n            .classed(\"btn btn-default btn-sm\", true)\n            .attr(\"title\", \"Compute graph statistics\")\n            .attr(\"id\", \"hivtrace-compute-graph-statistics\")\n            .on(\"click\", function(d) {\n              _.bind(self.compute_graph_stats, this)();\n            })\n            .append(\"i\")\n            .classed(\"fa fa-calculator\", true);\n        } else {\n           button_group\n            .append(\"button\")\n            .classed(\"btn btn-default btn-sm\", true)\n            .attr(\"title\", \"Toggle epi-curve\")\n            .attr(\"id\", \"hivtrace-toggle-epi-curve\")\n            .on(\"click\", function(d) {\n              self._check_for_time_series();\n            })\n            .append(\"i\")\n            .classed(\"fa fa-line-chart\", true);\n        }\n\n        button_group\n          .append(\"button\")\n          .classed(\"btn btn-default btn-sm\", true)\n          .attr(\"title\", \"Save Image\")\n          //.attr(\"id\", \"hivtrace-export-image\")\n          .on(\"click\", function(d) {\n            helpers.save_image(\"png\", \"#\" + self.dom_prefix + \"-network-svg\");\n          })\n          .append(\"i\")\n          .classed(\"fa fa-image\", true);\n      }\n\n      $(self.get_ui_element_selector_by_role(\"filter\")).on(\n        \"input propertychange\",\n        _.throttle(function(e) {\n          var filter_value = $(this).val();\n          self.filter(\n            filter_value\n              .split(\" \")\n              .filter(function(d) {\n                return d.length > 0;\n              })\n              .map(function(d) {\n                if (d.length > 2) {\n                  if (d[0] == '\"' && d[d.length - 1] == '\"') {\n                    return {\n                      type: \"re\",\n                      value: new RegExp(\n                        \"^\" + d.substr(1, d.length - 2) + \"$\",\n                        \"i\"\n                      )\n                    };\n                  }\n                  if (d[0] == \"<\") {\n                    var distance_threshold = parseFloat(d.substr(1));\n                    if (distance_threshold > 0) {\n                      return {\n                        type: \"distance\",\n                        value: distance_threshold\n                      };\n                    }\n                  }\n                }\n                return {\n                  type: \"re\",\n                  value: new RegExp(d, \"i\")\n                };\n              })\n          );\n        }, 250)\n      );\n\n      $(self.get_ui_element_selector_by_role(\"hide_filter\")).on(\n        \"change\",\n        _.throttle(function(e) {\n          self.hide_unselected = !self.hide_unselected;\n          self.filter_visibility();\n          self.update(true);\n        }, 250)\n      );\n\n      $(self.get_ui_element_selector_by_role(\"show_small_clusters\")).on(\n        \"change\",\n        _.throttle(function(e) {\n          if (\"size\" in self.cluster_filtering_functions) {\n            delete self.cluster_filtering_functions[\"size\"];\n          } else {\n            self.cluster_filtering_functions[\"size\"] = self.filter_by_size;\n          }\n\n          self.update(false);\n        }, 250)\n      );\n\n      $(\n        self.get_ui_element_selector_by_role(\"pairwise_table_pecentage\", true)\n      ).on(\n        \"change\",\n        _.throttle(function(e) {\n          self.show_percent_in_pairwise_table = !self.show_percent_in_pairwise_table;\n          render_binned_table(\n            \"attribute_table\",\n            self.colorizer[\"category_map\"],\n            self.colorizer[\"category_pairwise\"]\n          );\n        }, 250)\n      );\n    }\n\n    if (_networkGraphAttrbuteID in json) {\n      attributes = json[_networkGraphAttrbuteID];\n    } else {\n      if (attributes && \"hivtrace\" in attributes) {\n        attributes = attributes[\"hivtrace\"];\n      }\n    }\n\n    // Initialize class attributes\n    singletons = graph_data.Nodes.filter(function(v, i) {\n      return v.cluster === null;\n    }).length;\n    self.nodes = graph_data.Nodes.filter(function(v, i) {\n      if (\n        v.cluster &&\n        typeof self.exclude_cluster_ids[v.cluster] === \"undefined\"\n      ) {\n        connected_links[i] = total++;\n        return true;\n      }\n      return false;\n    });\n    self.edges = graph_data.Edges.filter(function(v, i) {\n      return (\n        connected_links[v.source] != undefined &&\n        connected_links[v.target] != undefined\n      );\n    });\n    self.edges = self.edges.map(function(v, i) {\n      v.source = connected_links[v.source];\n      v.target = connected_links[v.target];\n      v.id = i;\n      return v;\n    });\n\n    compute_node_degrees(self.nodes, self.edges);\n\n    default_layout(self.initial_packed);\n    self.clusters.forEach(function(d, i) {\n      self.cluster_mapping[d.cluster_id] = i;\n      d.hxb2_linked = d.children.some(function(c) {\n        return c.hxb2_linked;\n      });\n      _compute_cluster_degrees(d);\n      d.distances = [];\n    });\n\n    try {\n      if (options && options[\"extra_menu\"]) {\n        var extra_ui_container = d3.select(\n          self.get_ui_element_selector_by_role(\"extra_operations_container\")\n        );\n\n        d3\n          .select(\n            self.get_ui_element_selector_by_role(\"extra_operations_enclosure\")\n          )\n          .selectAll(\"button\")\n          .text(options[\"extra_menu\"][\"title\"])\n          .append(\"span\")\n          .classed(\"caret\", \"true\");\n        //extra_ui_container\n        extra_ui_container.selectAll(\"li\").remove();\n\n        options[\"extra_menu\"][\"items\"].forEach(function(item, index) {\n          //console.log (item);\n          var handler_callback = item[1];\n          if (_.isFunction(item[0])) {\n            item[0](self, this.append(\"li\"));\n          } else {\n            this.append(\"li\")\n              .append(\"a\")\n              .text(item[0])\n              .attr(\"href\", \"#\")\n              .on(\"click\", function(e) {\n                handler_callback(self, this);\n                d3.event.preventDefault();\n              });\n          }\n        }, extra_ui_container);\n\n        d3\n          .select(\n            self.get_ui_element_selector_by_role(\"extra_operations_enclosure\")\n          )\n          .style(\"display\", null);\n      }\n    } catch (err) {\n      console.log(err);\n    }\n\n    self._aux_populate_category_menus = function() {\n      if (button_bar_ui) {\n        // decide if the variable can be considered categorical by examining its range\n\n        //console.log (\"self._aux_populate_category_menus\");\n        var valid_cats = _.filter(\n          _.map(\n            graph_data[_networkGraphAttrbuteID],\n            self._aux_populate_category_fields\n          ),\n          function(d) {\n            //console.log (d);\n            return (\n              d.discrete &&\n              \"value_range\" in d &&\n              d[\"value_range\"].length <= _maximumValuesInCategories\n            );\n          }\n        );\n\n        var valid_shapes = _.filter(valid_cats, function(d) {\n          return (\n            (d.discrete && d.dimension <= 7) ||\n            d[\"raw_attribute_key\"] in _networkPresetShapeSchemes\n          );\n        });\n\n        // sort values alphabetically for consistent coloring\n\n        _.each([valid_cats, valid_shapes], function(list) {\n          _.each(list, self._aux_process_category_values);\n        });\n\n        var valid_scales = _.filter(\n          _.map(graph_data[_networkGraphAttrbuteID], function(d, k) {\n            function determine_scaling(d, values, scales) {\n              var low_var = Infinity;\n\n              _.each(scales, function(scl) {\n                d[\"value_range\"] = d3.extent(values);\n                var bins = _.map(\n                  _.range(_networkContinuousColorStops),\n                  function() {\n                    return 0;\n                  }\n                );\n                scl\n                  .range([0, _networkContinuousColorStops - 1])\n                  .domain(d[\"value_range\"]);\n                _.each(values, function(v) {\n                  bins[Math.floor(scl(v))]++;\n                });\n\n                var mean = values.length / _networkContinuousColorStops;\n                var vrnc = _.reduce(bins, function(p, c) {\n                  return p + (c - mean) * (c - mean);\n                });\n\n                //console.log (d['value_range'], bins);\n\n                if (vrnc < low_var) {\n                  low_var = vrnc;\n                  d[\"scale\"] = scl;\n                }\n              });\n            }\n\n            d[\"raw_attribute_key\"] = k;\n            if (d.type == \"Number\") {\n              var values = _.filter(\n                _.map(graph_data.Nodes, function(nd) {\n                  return self.attribute_node_value_by_id(nd, k, true);\n                }),\n                function(v) {\n                  return v != _networkMissing;\n                }\n              );\n              // automatically determine the scale and see what spaces the values most evenly\n              determine_scaling(d, values, [\n                d3.scale.linear(),\n                d3.scale.log(),\n                d3.scale.pow().exponent(1 / 3),\n                d3.scale.pow().exponent(0.25),\n                d3.scale.pow().exponent(0.5),\n                d3.scale.pow().exponent(1 / 8),\n                d3.scale.pow().exponent(1 / 16)\n              ]);\n            } else {\n              if (d.type == \"Date\") {\n                var values = _.filter(\n                  _.map(graph_data.Nodes, function(nd) {\n                    try {\n                      var a_date = self.attribute_node_value_by_id(nd, k);\n                      //console.log (k, a_date);\n                      inject_attribute_node_value_by_id(\n                        nd,\n                        k,\n                        self._parse_dates(a_date)\n                      );\n                    } catch (err) {\n                      inject_attribute_node_value_by_id(nd, k, _networkMissing);\n                    }\n                    return self.attribute_node_value_by_id(nd, k);\n                  }),\n                  function(v) {\n                    return v == _networkMissing ? null : v;\n                  }\n                );\n                // automatically determine the scale and see what spaces the values most evenly\n                if (values.length == 0) {\n                  // invalid scale\n                  return {};\n                }\n                determine_scaling(d, values, [d3.time.scale()]);\n              }\n            }\n            return d;\n          }),\n          function(d) {\n            return d.type == \"Number\" || d.type == \"Date\";\n          }\n        );\n\n        function _menu_label_gen(d) {\n          return (\n            (d[\"annotation\"] ? \"[\" + d[\"annotation\"] + \"] \" : \"\") + d[\"label\"]\n          );\n        }\n\n        //console.log (valid_scales);\n        //valid_cats.splice (0,0, {'label' : 'None', 'index' : -1});\n\n        [\n          d3.select(self.get_ui_element_selector_by_role(\"attributes\")),\n          d3.select(\n            self.get_ui_element_selector_by_role(\"attributes_cat\", true)\n          )\n        ].forEach(function(m) {\n          //console.log (m);\n\n          if (m.empty()) {\n            return;\n          }\n          m.selectAll(\"li\").remove();\n\n          var menu_items = [\n            [\n              [\"None\", null, _.partial(self.handle_attribute_categorical, null)]\n            ],\n            [[\"Categorical\", \"heading\", null]]\n          ].concat(\n            valid_cats.map(function(d, i) {\n              return [\n                [\n                  _menu_label_gen(d),\n                  d[\"raw_attribute_key\"],\n                  _.partial(\n                    self.handle_attribute_categorical,\n                    d[\"raw_attribute_key\"]\n                  )\n                ]\n              ];\n            })\n          );\n\n          if (valid_scales.length) {\n            menu_items = menu_items\n              .concat([[[\"Continuous\", \"heading\", null]]])\n              .concat(\n                valid_scales.map(function(d, i) {\n                  return [\n                    [\n                      _menu_label_gen(d),\n                      d[\"raw_attribute_key\"],\n                      _.partial(\n                        self.handle_attribute_continuous,\n                        d[\"raw_attribute_key\"]\n                      )\n                    ]\n                  ];\n                })\n              );\n          }\n\n          var cat_menu = m.selectAll(\"li\").data(menu_items);\n\n          cat_menu\n            .enter()\n            .append(\"li\")\n            .classed(\"disabled\", function(d) {\n              return d[0][1] == \"heading\";\n            })\n            .style(\"font-variant\", function(d) {\n              return d[0][1] < -1 ? \"small-caps\" : \"normal\";\n            });\n\n          cat_menu\n            .selectAll(\"a\")\n            .data(function(d) {\n              return d;\n            })\n            .enter()\n            .append(\"a\")\n            .text(function(d, i, j) {\n              return d[0];\n            })\n            .attr(\"style\", function(d, i, j) {\n              if (d[1] == \"heading\") return \"font-style: italic\";\n              if (j == 0) {\n                return \" font-weight: bold;\";\n              }\n              return null;\n            })\n            .attr(\"href\", \"#\")\n            .on(\"click\", function(d) {\n              if (d[2]) {\n                d[2].call();\n              }\n            });\n        });\n\n        [\n          d3.select(self.get_ui_element_selector_by_role(\"shapes\"))\n        ].forEach(function(m) {\n          m.selectAll(\"li\").remove();\n          var cat_menu = m.selectAll(\"li\").data(\n            [\n              [[\"None\", null, _.partial(self.handle_shape_categorical, null)]]\n            ].concat(\n              valid_shapes.map(function(d, i) {\n                return [\n                  [\n                    _menu_label_gen(d),\n                    d[\"raw_attribute_key\"],\n                    _.partial(\n                      self.handle_shape_categorical,\n                      d[\"raw_attribute_key\"]\n                    )\n                  ]\n                ];\n              })\n            )\n          );\n\n          cat_menu.enter().append(\"li\").style(\"font-variant\", function(d) {\n            return d[0][1] < -1 ? \"small-caps\" : \"normal\";\n          });\n\n          cat_menu\n            .selectAll(\"a\")\n            .data(function(d) {\n              return d;\n            })\n            .enter()\n            .append(\"a\")\n            .text(function(d, i, j) {\n              return d[0];\n            })\n            .attr(\"style\", function(d, i, j) {\n              if (j == 0) {\n                return \" font-weight: bold;\";\n              }\n              return null;\n            })\n            .attr(\"href\", \"#\")\n            .on(\"click\", function(d) {\n              if (d[2]) {\n                d[2].call();\n              }\n            });\n        });\n\n        $(\n          self.get_ui_element_selector_by_role(\"opacity_invert\")\n        ).on(\"click\", function(e) {\n          if (self.colorizer[\"opacity_scale\"]) {\n            self.colorizer[\"opacity_scale\"].range(\n              self.colorizer[\"opacity_scale\"].range().reverse()\n            );\n            self.update(true);\n            self.draw_attribute_labels();\n          }\n          $(this).toggleClass(\"btn-active btn-default\");\n        });\n\n        $(\n          self.get_ui_element_selector_by_role(\"attributes_invert\")\n        ).on(\"click\", function(e) {\n          if (self.colorizer[\"category_id\"]) {\n            graph_data[_networkGraphAttrbuteID][self.colorizer[\"category_id\"]][\n              \"scale\"\n            ].range(\n              graph_data[_networkGraphAttrbuteID][\n                self.colorizer[\"category_id\"]\n              ][\"scale\"]\n                .range()\n                .reverse()\n            );\n            self.clusters.forEach(function(the_cluster) {\n              the_cluster[\"gradient\"] = compute_cluster_gradient(\n                the_cluster,\n                self.colorizer[\"category_id\"]\n              );\n            });\n            self.update(true);\n            self.draw_attribute_labels();\n          }\n          $(this).toggleClass(\"btn-active btn-default\");\n        });\n\n        [\n          d3.select(self.get_ui_element_selector_by_role(\"opacity\"))\n        ].forEach(function(m) {\n          m.selectAll(\"li\").remove();\n          var cat_menu = m.selectAll(\"li\").data(\n            [\n              [[\"None\", null, _.partial(self.handle_attribute_opacity, null)]]\n            ].concat(\n              valid_scales.map(function(d, i) {\n                return [\n                  [\n                    d[\"label\"],\n                    d[\"raw_attribute_key\"],\n                    _.partial(\n                      self.handle_attribute_opacity,\n                      d[\"raw_attribute_key\"]\n                    )\n                  ]\n                ];\n              })\n            )\n          );\n\n          cat_menu.enter().append(\"li\").style(\"font-variant\", function(d) {\n            return d[0][1] < -1 ? \"small-caps\" : \"normal\";\n          });\n          cat_menu\n            .selectAll(\"a\")\n            .data(function(d) {\n              return d;\n            })\n            .enter()\n            .append(\"a\")\n            .text(function(d, i, j) {\n              return d[0];\n            })\n            .attr(\"style\", function(d, i, j) {\n              if (j == 0) {\n                return \" font-weight: bold;\";\n              }\n              return null;\n            })\n            .attr(\"href\", \"#\")\n            .on(\"click\", function(d) {\n              if (d[2]) {\n                d[2].call();\n              }\n            });\n        });\n      }\n    };\n\n    if (attributes) {\n      /*\n         map attributes into nodes and into the graph object itself using\n         _networkGraphAttrbuteID as the key\n      */\n\n      if (\"attribute_map\" in attributes) {\n        var attribute_map = attributes[\"attribute_map\"];\n\n        if (\"map\" in attribute_map && attribute_map[\"map\"].length > 0) {\n          graph_data[_networkGraphAttrbuteID] = attribute_map[\n            \"map\"\n          ].map(function(a, i) {\n            return {\n              label: a,\n              type: null,\n              values: {},\n              index: i,\n              range: 0\n            };\n          });\n\n          graph_data.Nodes.forEach(function(n) {\n            n[_networkGraphAttrbuteID] = n.id.split(attribute_map[\"delimiter\"]);\n            n[_networkGraphAttrbuteID].forEach(function(v, i) {\n              if (i < graph_data[_networkGraphAttrbuteID].length) {\n                if (!(v in graph_data[_networkGraphAttrbuteID][i][\"values\"])) {\n                  graph_data[_networkGraphAttrbuteID][i][\"values\"][v] =\n                    graph_data[_networkGraphAttrbuteID][i][\"range\"];\n                  graph_data[_networkGraphAttrbuteID][i][\"range\"] += 1;\n                }\n              }\n              //graph_data [_networkGraphAttrbuteID][i][\"values\"][v] = 1 + (graph_data [_networkGraphAttrbuteID][i][\"values\"][v] ? graph_data [_networkGraphAttrbuteID][i][\"values\"][v] : 0);\n            });\n          });\n\n          graph_data[_networkGraphAttrbuteID].forEach(function(d) {\n            if (\n              d[\"range\"] < graph_data.Nodes.length &&\n              d[\"range\"] > 1 &&\n              d[\"range\"] <= 20\n            ) {\n              d[\"type\"] = \"category\";\n            }\n          });\n        }\n      }\n\n      _.each(self._networkPredefinedAttributeTransforms, function(\n        computed,\n        key\n      ) {\n        if (_.isFunction(computed)) {\n          computed = computed(self);\n        }\n\n        if (\n          !computed[\"depends\"] ||\n          _.has(graph_data[_networkGraphAttrbuteID], computed[\"depends\"])\n        ) {\n          var extension = {};\n          extension[key] = computed;\n          _.extend(graph_data[_networkGraphAttrbuteID], extension);\n          self.inject_attribute_description(key, computed);\n          _.each(graph_data.Nodes, function(node) {\n            inject_attribute_node_value_by_id(\n              node,\n              key,\n              computed[\"map\"](node, self)\n            );\n          });\n        }\n      });\n\n      self._aux_populate_category_menus();\n\n      // populate the UI elements\n    }\n\n    if (self.cluster_sizes.length > max_points_to_render) {\n      var sorted_array = self.cluster_sizes\n        .map(function(d, i) {\n          return [d, i + 1];\n        })\n        .sort(function(a, b) {\n          return a[0] - b[0];\n        });\n\n      for (var k = 0; k < sorted_array.length - max_points_to_render; k++) {\n        self.exclude_cluster_ids[sorted_array[k][1]] = 1;\n      }\n\n      warning_string =\n        \"Excluded \" +\n        (sorted_array.length - max_points_to_render) +\n        \" clusters (maximum size \" +\n        sorted_array[k - 1][0] +\n        \" nodes) because only \" +\n        max_points_to_render +\n        \" objects can be shown at once.\";\n    }\n\n    self.edges.forEach(function(e, i) {\n      self.clusters[\n        self.cluster_mapping[self.nodes[e.target].cluster]\n      ].distances.push(e.length);\n    });\n\n    self.clusters.forEach(function(d, i) {\n      d.distances = helpers.describe_vector(d.distances);\n    });\n    //self.clusters\n\n    self.update();\n  }\n\n  function sort_table_toggle_icon(element, value) {\n     //console.log (value);\n     if (value) {\n      $(element).data(\"sorted\", value);\n      d3\n        .select(element)\n        .selectAll(\"i\")\n        .classed(\"fa-sort-amount-desc\", value == \"desc\")\n        .classed(\"fa-sort-amount-asc\", value == \"asc\")\n        .classed(\"fa-sort\", value == \"unsorted\");\n    } else {\n      var sorted_state = $(element).data(\"sorted\");\n      sort_table_toggle_icon(element, sorted_state == \"asc\" ? \"desc\" : \"asc\");\n      return sorted_state == \"asc\" ? d3.descending : d3.ascending;\n    }\n  }\n\n  /** element is the sortable clicker **/\n  function sort_table_by_column(element, datum) {\n    if (d3.event) {\n     d3.event.preventDefault();\n    }\n    var table_element = $(element).closest(\"table\");\n    if (table_element.length) {\n      var sort_on = parseInt($(element).data(\"column-id\"));\n      var sort_key = datum.sort;\n      var sorted_state = $(element).data(\"sorted\");\n      var sorted_function = sort_table_toggle_icon(element);\n\n      var sort_accessor;\n\n      if (sort_key) {\n        if (_.isFunction(sort_key)) {\n          sort_accessor = function(x) {\n            return sort_key(x);\n          };\n        } else {\n          sort_accessor = function(x) {\n            var val = x[sort_key];\n            if (_.isFunction(val)) return val();\n            return val;\n          };\n        }\n      } else {\n        sort_accessor = function(x) {\n          return x;\n        };\n      }\n\n      d3\n        .select(table_element[0])\n        .select(\"tbody\")\n        .selectAll(\"tr\")\n        .sort(function(a, b) {\n          return sorted_function(\n            sort_accessor(a[sort_on]),\n            sort_accessor(b[sort_on])\n          );\n        });\n\n      // select all other elements from thead and toggle their icons\n\n      $(table_element)\n        .find(\"thead [data-column-id]\")\n        .filter(function() {\n          return parseInt($(this).data(\"column-id\")) != sort_on;\n        })\n        .each(function() {\n          sort_table_toggle_icon(this, \"unsorted\");\n        });\n    }\n  }\n\n  function format_a_cell(data, index, item) {\n\n    var this_sel = d3.select(item);\n    var current_value =\n      typeof data.value === \"function\" ? data.value() : data.value;\n\n    var handle_sort = this_sel;\n\n    if (\"callback\" in data) {\n      handle_sort = data.callback(item, current_value);\n    } else {\n      var repr = \"format\" in data ? data.format(current_value) : current_value;\n      if (\"html\" in data) this_sel.html(repr);\n      else this_sel.text(repr);\n    }\n      if (handle_sort && (\"sort\" in data)) {\n        var clicker = handle_sort\n          .append(\"a\")\n          .property(\"href\", \"#\")\n          .on(\"click\", function(d) {\n            sort_table_by_column(this, d);\n          })\n          .attr(\"data-sorted\", \"unsorted\")\n          .attr(\"data-column-id\", index);\n        clicker\n          .append(\"i\")\n          .classed(\"fa fa-sort\", true)\n          .style(\"margin-left\", \"0.2em\");\n\n        if (\"presort\" in data) {\n            if (data[\"presort\"] == \"desc\") {\n                clicker.attr(\"data-sorted\", \"asc\");\n            }\n            sort_table_by_column (clicker.node(), data);\n        }\n    }\n    if (\"help\" in data) {\n      this_sel.attr(\"title\", data.help);\n    }\n  }\n\n  function add_a_sortable_table(container, headers, content, overwrite) {\n\n    var thead = container.selectAll(\"thead\");\n    var tbody = container.selectAll(\"tbody\");\n\n    if (tbody.empty() || overwrite) {\n      tbody.remove();\n      tbody = container.append(\"tbody\");\n      tbody\n        .selectAll(\"tr\")\n        .data(content)\n        .enter()\n        .append(\"tr\")\n        .selectAll(\"td\")\n        .data(function(d) {\n          return d;\n        })\n        .enter()\n        .append(\"td\")\n        .call(function(selection) {\n          return selection.each(function(d, i) {\n            //handle_cluster_click;\n            format_a_cell(d, i, this);\n          });\n        });\n    }\n\n   // head AFTER rows, so we can handle pre-sorting\n   if (thead.empty() || overwrite) {\n      thead.remove();\n      thead = container.append(\"thead\");\n      thead\n        .selectAll(\"tr\")\n        .data(headers)\n        .enter()\n        .append(\"tr\")\n        .selectAll(\"th\")\n        .data(function(d) {\n          return d;\n        })\n        .enter()\n        .append(\"th\")\n        .call(function(selection) {\n          return selection.each(function(d, i) {\n            format_a_cell(d, i, this);\n          });\n        });\n    }\n  }\n\n  function _cluster_table_draw_id(element, payload) {\n    var this_cell = d3.select(element);\n    this_cell.selectAll(\"*\").remove();\n    var _is_subcluster = payload[1];\n    var cluster_id = payload[0];\n\n    if (_is_subcluster) {\n        //console.log (payload);\n\n      //this_cell.append(\"i\")\n      //      .classed(\"fa fa-arrow-circle-o-right\", true).style(\"padding-right\", \"0.25em\");\n\n      /*if (payload[2].rr_count) {\n        this_cell\n          .append(\"i\")\n          .classed(\"fa fa-exclamation-triangle\", true)\n          .attr(\"title\", \"Subcluster has recent/rapid nodes\");\n      }*/\n      this_cell.append(\"span\").text(cluster_id).style(\"padding-right\", \"0.5em\");\n\n      this_cell\n        .append(\"button\")\n        .classed(\"btn btn-primary btn-xs pull-right\", true)\n        .text(\"view\")\n        .on(\"click\", function(e) {\n          self.view_subcluster(payload[2]);\n        });\n    } else {\n      this_cell.append(\"span\").text(cluster_id).style(\"padding-right\", \"0.5em\");\n      this_cell\n        .append(\"button\")\n        .classed(\"btn btn-primary btn-xs pull-right\", true)\n        .style(\"margin-right\", \"0.25em\")\n        .text(\"view\")\n        .on(\"click\", function(e) {\n          self.open_exclusive_tab_view(cluster_id);\n        });\n    }\n    this_cell\n      .append(\"button\")\n      .classed(\"btn btn-default btn-xs pull-right\", true)\n      .style(\"margin-right\", \"0.25em\")\n      .text(\"list\")\n      .attr(\"data-toggle\", \"modal\")\n      .attr(\n        \"data-target\",\n        self.get_ui_element_selector_by_role(\"cluster_list\", true)\n      )\n      .attr(\"data-cluster\", cluster_id);\n  }\n\n  function _cluster_table_draw_buttons(element, payload) {\n    var this_cell = d3.select(element);\n    var labels = [[payload[0] ? \"expand\" : \"collapse\", 0]];\n    if (payload[1]) {\n      labels.push([\"problematic\", 1]);\n    }\n    if (payload[2]) {\n      labels.push([\"match\", 1]);\n    }\n    var buttons = this_cell.selectAll(\"button\").data(labels);\n    buttons.enter().append(\"button\");\n    buttons.exit().remove();\n    buttons\n      .classed(\"btn btn-default btn-xs\", true)\n      .text(function(d) {\n        return d[0];\n      })\n      .style(\"margin-right\", \"0.25em\")\n      .attr(\"disabled\", function(d) {\n        return d[1] ? \"disabled\" : null;\n      })\n      .on(\"click\", function(d) {\n        if (d[1] == 0) {\n          if (payload[0]) {\n            expand_cluster(\n              self.clusters[payload[payload.length - 1] - 1],\n              true\n            );\n          } else {\n            collapse_cluster(self.clusters[payload[payload.length - 1] - 1]);\n          }\n          self.update_volatile_elements(self.cluster_table);\n          if (self.subcluster_table) {\n            self.update_volatile_elements(self.subcluster_table);\n          }\n        }\n      });\n  }\n\n  function _extract_single_cluster(nodes, filter, no_clone, given_json, include_extra_edges) {\n    /**\n        Extract the nodes and edges between them into a separate objects\n        @param nodes [array]  the list of nodes to extract\n        @param filter [function, optional] (edge) -> bool filtering function for deciding which edges will be used to define clusters\n        @param no_clone [bool] if set to T, node objects are not shallow cloned in the return object\n\n        @return [dict] the object representing \"Nodes\" and \"Edges\" in the extracted cluster\n\n    */\n\n    var cluster_json = {};\n    var map_to_id = {};\n\n    cluster_json.Nodes = _.map(nodes, function(c, i) {\n      map_to_id[c.id] = i;\n      if (no_clone) {\n        return c;\n      }\n      var cc = _.clone(c);\n      cc.cluster = 1;\n      return cc;\n    });\n\n    given_json = given_json || json;\n\n    cluster_json.Edges = _.filter(given_json.Edges, function(e) {\n\n      if(_.isUndefined(e.source) || _.isUndefined(e.target)) {\n        return false;\n      }\n\n      return (\n        given_json.Nodes[e.source].id in map_to_id &&\n        given_json.Nodes[e.target].id in map_to_id && (\n        include_extra_edges || !self.is_edge_injected (e))\n      );\n    });\n\n    if (filter) {\n      cluster_json.Edges = _.filter(cluster_json.Edges, filter);\n    }\n\n    cluster_json.Edges = _.map(cluster_json.Edges, function(e) {\n      var ne = _.clone(e);\n      ne.source = map_to_id[given_json.Nodes[e.source].id];\n      ne.target = map_to_id[given_json.Nodes[e.target].id];\n      return ne;\n    });\n\n    return cluster_json;\n  }\n\n  function _node_table_draw_buttons(element, payload) {\n    var this_cell = d3.select(element);\n    var labels = [\n      payload.length == 1\n        ? _.isString(payload[0])\n          ? [payload[0], 1, \"btn-warning\"]\n          : [\"can't be shown\", 1]\n        : [payload[0] ? \"hide\" : \"show\", 0]\n    ];\n\n    if (payload.length == 2 && payload[1] >= 1) {\n      labels.push([\n        \"view cluster\",\n        function() {\n          self.open_exclusive_tab_view(payload[1]);\n        }\n      ]);\n    }\n\n    var buttons = this_cell.selectAll(\"button\").data(labels);\n    buttons.enter().append(\"button\");\n    buttons.exit().remove();\n    buttons\n      .classed(\"btn btn-xs btn-node-property\", true)\n      .classed(\"btn-primary\", true)\n      //.classed(function (d) {return d.length >=3 ? d[2] : \"\";}, function (d) {return d.length >= 3;})\n      .text(function(d) {\n        return d[0];\n      })\n      .attr(\"disabled\", function(d) {\n        return d[1] && !_.isFunction(d[1]) ? \"disabled\" : null;\n      })\n      .on(\"click\", function(d) {\n        if (_.isFunction(d[1])) {\n          d[1].call(d);\n        } else {\n          if (d[1] == 0) {\n            if (payload[0]) {\n              collapse_cluster(\n                self.clusters[payload[payload.length - 1] - 1],\n                true\n              );\n            } else {\n              expand_cluster(self.clusters[payload[payload.length - 1] - 1]);\n            }\n            //format_a_cell(d3.select(element).datum(), null, element);\n            self.update_volatile_elements(self.node_table);\n          }\n        }\n      });\n    buttons.each(function(d, e) {\n      if (d.length >= 3) {\n        d3.select(this).classed(\"btn-primary\", false).classed(d[2], true);\n      }\n    });\n  }\n\n  self.update_volatile_elements = function(container) {\n    container\n      .selectAll(\"td\")\n      .filter(function(d, i) {\n        return \"volatile\" in d;\n      })\n      .each(function(d, i) {\n        format_a_cell(d, i, this);\n      });\n  };\n\n  self.draw_extended_node_table = function (node_list) {\n    if (self.node_table) {\n      node_list = node_list || self.nodes;\n      var column_ids = self._extract_exportable_attributes(true);\n\n      self.displayed_node_subset = _.map (self.displayed_node_subset, function (n, i) {\n        if (_.isString (n)) {\n\n\n            n = _.find (column_ids, function (cd) {\n                return cd.raw_attribute_key == n;\n            });\n\n            if (n) {\n                return n;\n            }\n            return column_ids[i];\n        }\n        return n;\n      });\n\n      var node_data = self._extract_attributes_for_nodes (node_list, self.displayed_node_subset);\n      node_data.splice (0,1);\n      var table_headers = _.map (self.displayed_node_subset, function (n, col_id) {\n        return {\n            value : n.raw_attribute_key,\n            sort : \"value\",\n            help : \"label\" in n ? n.label : n.raw_attribute_key,\n            callback: function(element, payload) {\n                var dropdown = d3.select (element).append (\"div\").classed (\"dropdown\", true);\n                var menu_id = \"hivtrace_node_column_\" + payload;\n                var dropdown_button = dropdown.append (\"button\").classed ({\"btn\" : true,\n                                                                           \"btn-default\": true,\n                                                                            \"dropdown-toggle\": true})\n                                              .attr (\"type\", \"button\").attr (\"data-toggle\", \"dropdown\")\n                                              .attr (\"aria-haspopup\", \"true\").attr (\"aria-expanded\", \"false\")\n                                              .attr (\"id\", menu_id);\n\n                if (\"format\" in n) {\n                    dropdown_button.text (n.format (payload));\n                } else {\n                    dropdown_button.text (payload);\n                }\n                dropdown_button.append (\"i\").classed({\n                      \"fa\": true,\n                      \"fa-caret-down\" : true,\n                      \"fa-lg\" : true\n                    });\n                var dropdown_list = dropdown.append (\"ul\")\n                                            .classed (\"dropdown-menu\", true)\n                                            .attr (\"aria-labelledby\", menu_id);\n\n                dropdown_list = dropdown_list.selectAll (\"li\").data (_.filter (column_ids, function (alt) {\n                    return alt.raw_attribute_key != n.raw_attribute_key;\n                }));\n                dropdown_list.enter ().append (\"li\");\n                dropdown_list.each (function (data, i) {\n                    var handle_change = d3.select(this).append (\"a\").attr (\"href\", \"#\").text (function (data) {\n                        return data.raw_attribute_key;\n                    });\n                    handle_change.on (\"click\", function (d) {\n                        self.displayed_node_subset[col_id] = d;\n                        self.draw_extended_node_table (node_list);\n                    });\n                });\n                return dropdown;\n            }\n        }\n      });\n\n      var table_rows = node_data.map (function(n, i) {\n            return _.map (n, function (cell, c) {\n                if (self.displayed_node_subset[c].type == \"Date\") {\n                    return {value : cell, format : function (v) {\n                        if (v == _networkMissing) {\n                            return v;\n                        }\n                        return _defaultDateViewFormatSlider (v);\n\n\n                    }};\n                } else {\n                    if (self.displayed_node_subset[c].type == \"Number\") {\n                        return {value : cell, format : d3.format(\".2f\")};\n                    }\n                }\n                return {value : cell};\n\n            });\n      });\n\n      self.draw_node_table (null, null, [table_headers], table_rows);\n\n    }\n  };\n\n  self.draw_node_table = function(extra_columns, node_list, headers, rows) {\n    if (self.node_table) {\n      node_list = node_list || self.nodes;\n\n     if (!headers) {\n         headers = [\n            [\n              {\n                value: \"ID\",\n                sort: \"value\",\n                help: \"Node ID\"\n              },\n              {\n                value: \"Action\",\n                sort: \"value\"\n              },\n              {\n                value: \"# of links\",\n                sort: \"value\",\n                help: \"Number of links (Node degree)\"\n              },\n              {\n                value: \"Cluster\",\n                sort: \"value\",\n                help: \"Which cluster does the node belong to\"\n              }\n            ]\n          ];\n\n          if (extra_columns) {\n            _.each(extra_columns, function(d) {\n              headers[0].push(d.description);\n            });\n          }\n\n        rows = node_list.map(function(n, i) {\n          var this_row = [\n          {\n            value: n.id,\n            help: \"Node ID\"\n          },\n          {\n            value: function() {\n              if (n.node_class != \"injected\") {\n                try {\n                  if (self.exclude_cluster_ids[n.cluster]) {\n                    // parent cluster can't be rendered\n                    // because of size restrictions\n                    return [n.cluster];\n                  }\n                  return [\n                    !self.clusters[self.cluster_mapping[n.cluster]].collapsed,\n                    n.cluster\n                  ];\n                } catch (err) {\n                  return [-1];\n                }\n              } else {\n                return [n.node_annotation];\n              }\n            },\n            callback: _node_table_draw_buttons,\n            volatile: true\n          },\n          {\n            value: \"degree\" in n ? n.degree : \"Not defined\",\n            help: \"Node degree\"\n          },\n          {\n            value: \"cluster\" in n ? n.cluster : \"Not defined\",\n            help: \"Which cluster does the node belong to\"\n          }\n        ];\n\n            if (extra_columns) {\n              _.each(extra_columns, function(ed) {\n                this_row.push(ed.generator(n, self));\n              });\n            }\n            return this_row;\n          });\n      }\n\n\n      add_a_sortable_table(\n        self.node_table,\n        headers,\n        rows,\n        true\n        // rows\n      );\n    }\n  };\n\n  self.draw_cluster_table = function(\n    extra_columns,\n    element,\n    options\n  ) {\n\n    var skip_clusters  =    (options && options[\"no-clusters\"]) ? true  : false;\n    var skip_subclusters = (options && options[\"subclusters\"]) ? false  : true;\n\n    element = element || self.cluster_table;\n\n    if (element) {\n      var headers = [\n        [\n          {\n            value: \"Cluster ID\",\n            sort: function(c) {\n              return _.map(c.value[0].split(\"-\"), function(ss) {\n                return _networkDotFormatPadder(+ss);\n              }).join(\"|\");\n            },\n            help: \"Unique cluster ID\"\n          },\n          {\n            value: \"Visibility\",\n            sort: \"value\",\n            help: \"Visibility in the network tab\"\n          },\n          {\n            value: \"Size\",\n            sort: \"value\",\n            help: \"Number of nodes in the cluster\"\n          }\n        ]\n      ];\n\n      if (!self._is_CDC_) {\n        headers[0].push({\n          value: \"# links/node<br>Mean [Median, IQR]\",\n          html: true\n        });\n\n        headers[0].push({\n          value: \"Genetic distance<br>Mean [Median, IQR]\",\n          help: \"Genetic distance among nodes in the cluster\",\n          html: true\n        });\n      }\n\n      if (extra_columns) {\n        _.each(extra_columns, function(d) {\n          headers[0].push(d.description);\n        });\n      }\n\n      if (options && options [\"headers\"]) {\n        options[\"headers\"] (headers);\n      }\n\n      var rows = [];\n\n      _.each(self.clusters, function(cluster) {\n        var make_row = function(d, is_subcluster) {\n          var this_row = [\n            {\n              value: [d.cluster_id, is_subcluster, d], //.cluster_id,\n              callback: _cluster_table_draw_id\n            },\n            {\n              value: function() {\n                var actual_cluster = is_subcluster ? d.parent_cluster : d;\n\n                return [\n                  actual_cluster.collapsed,\n                  actual_cluster.hxb2_linked,\n                  actual_cluster.match_filter,\n                  actual_cluster.cluster_id\n                ];\n              },\n              callback: _cluster_table_draw_buttons,\n              volatile: true\n            },\n            {\n              value: d.children.length\n            }\n          ];\n\n          if (!self._is_CDC_) {\n            this_row.push({\n              value: d.degrees,\n              format: function(d) {\n                try {\n                  return (\n                    _defaultFloatFormat(d[\"mean\"]) +\n                    \" [\" +\n                    _defaultFloatFormat(d[\"median\"]) +\n                    \", \" +\n                    _defaultFloatFormat(d[\"Q1\"]) +\n                    \" - \" +\n                    _defaultFloatFormat(d[\"Q3\"]) +\n                    \"]\"\n                  );\n                } catch (e) {\n                  return \"\";\n                }\n              }\n            });\n            this_row.push({\n              value: d.distances,\n              format: function(d) {\n                try {\n                  return (\n                    _defaultFloatFormat(d[\"mean\"]) +\n                    \" [\" +\n                    _defaultFloatFormat(d[\"median\"]) +\n                    \", \" +\n                    _defaultFloatFormat(d[\"Q1\"]) +\n                    \" - \" +\n                    _defaultFloatFormat(d[\"Q3\"]) +\n                    \"]\"\n                  );\n                } catch (e) {\n                  return \"\";\n                }\n              }\n            });\n          }\n          if (extra_columns) {\n            _.each(extra_columns, function(ed) {\n              this_row.push(ed.generator(d, self));\n            });\n          }\n\n          return this_row;\n        };\n\n        if (!skip_clusters) {\n          rows.push(make_row(cluster, false));\n        }\n\n\n        if (!skip_subclusters) {\n          _.each(cluster.subclusters, function(sub_cluster) {\n            rows.push(make_row(sub_cluster, true));\n          });\n        }\n      });\n\n      add_a_sortable_table(element, headers, rows, true);\n\n    }\n  };\n\n  /*------------ Update layout code ---------------*/\n  function update_network_string(node_count, edge_count) {\n    if (network_status_string) {\n      var clusters_shown = _.filter(self.clusters, function(c) {\n          return !c.collapsed;\n        }).length,\n        clusters_removed = self.cluster_sizes.length - self.clusters.length,\n        nodes_removed =\n          graph_data.Nodes.length - singletons - self.nodes.length;\n\n      var clusters_selected = _.filter(self.clusters, function(c) {\n        return (\n          !c.is_hidden && c.match_filter !== undefined && c.match_filter > 0\n        );\n      }).length;\n\n      var nodes_selected = _.filter(self.nodes, function(n) {\n        return n.match_filter && !n.is_hidden;\n      }).length;\n\n      /*var s = \"Displaying a network on <strong>\" + self.nodes.length + \"</strong> nodes, <strong>\" + self.clusters.length + \"</strong> clusters\"\n              + (clusters_removed > 0 ? \" (an additional \" + clusters_removed + \" clusters and \" + nodes_removed + \" nodes have been removed due to network size constraints)\" : \"\") + \". <strong>\"\n              + clusters_shown +\"</strong> clusters are expanded. Of <strong>\" + self.edges.length + \"</strong> edges, <strong>\" + draw_me.edges.length + \"</strong>, and of  <strong>\" + self.nodes.length  + \" </strong> nodes,  <strong>\" + draw_me.nodes.length + \" </strong> are displayed. \";\n      if (singletons > 0) {\n          s += \"<strong>\" +singletons + \"</strong> singleton nodes are not shown. \";\n      }*/\n\n      var s =\n        \"<span class = 'badge'>\" +\n        self.clusters.length +\n        \"</span> clusters <span class = 'label label-primary'>\" +\n        clusters_shown +\n        \" expanded / \" +\n        clusters_selected +\n        \" match </span> <span class = 'badge'> \" +\n        self.nodes.length +\n        \"</span> nodes <span class = 'label label-primary'>\" +\n        node_count +\n        \" shown / \" +\n        nodes_selected +\n        \" match </span> <span class = 'badge'> \" +\n        self.edges.length +\n        \"</span> \" +\n        (self._is_CDC_ ? \"links\" : \"edges\") +\n        \" <span class = 'label label-primary'>\" +\n        edge_count +\n        \" shown</span>\";\n\n      d3.select(network_status_string).html(s);\n    }\n  }\n\n  function draw_a_node(container, node) {\n    if (node) {\n      container = d3.select(container);\n\n      var symbol_type =\n        node.hxb2_linked && !node.is_lanl\n          ? \"cross\"\n          : node.is_lanl ? \"triangle-down\" : self.node_shaper[\"shaper\"](node);\n\n      node.rendered_size = Math.sqrt(node_size(node)) / 2 + 2;\n\n      container\n        .attr(\"d\", misc.symbol(symbol_type).size(node_size(node)))\n        .attr(\"class\", \"node\")\n        .classed(\"selected_object\", function(d) {\n          return d.match_filter;\n        })\n        .classed(\"injected_object\", function(d) {\n          return d.node_class == \"injected\";\n        })\n        .attr(\"transform\", function(d) {\n          return \"translate(\" + d.x + \",\" + d.y + \")\";\n        })\n        .style(\"fill\", function(d) {\n          return node_color(d);\n        })\n        .style(\"opacity\", function(d) {\n          return node_opacity(d);\n        })\n        .style(\"display\", function(d) {\n          if (d.is_hidden) return \"none\";\n          return null;\n        })\n        .on(\"click\", handle_node_click)\n        .on(\"mouseover\", node_pop_on)\n        .on(\"mouseout\", node_pop_off)\n        .call(network_layout.drag().on(\"dragstart\", node_pop_off));\n    }\n  }\n\n  function draw_a_cluster(container, the_cluster) {\n    var container_group = d3.select(container);\n\n    var draw_from = the_cluster[\"binned_attributes\"]\n      ? the_cluster[\"binned_attributes\"].map(function(d) {\n          return d.concat([0]);\n        })\n      : [[null, 1, 0]];\n\n    if (the_cluster.match_filter) {\n      draw_from = draw_from.concat([\n        [\"selected\", the_cluster.match_filter, 1],\n        [\n          \"not selected\",\n          the_cluster.children.length - the_cluster.match_filter,\n          1\n        ]\n      ]);\n    }\n\n    var sums = [\n      d3.sum(\n        draw_from.filter(function(d) {\n          return d[2] == 0;\n        }),\n        function(d) {\n          return d[1];\n        }\n      ),\n      d3.sum(\n        draw_from.filter(function(d) {\n          return d[2] != 0;\n        }),\n        function(d) {\n          return d[1];\n        }\n      )\n    ];\n\n    var running_totals = [0, 0];\n\n    draw_from = draw_from.map(function(d) {\n      var index = d[2];\n      var v = {\n        container: container,\n        cluster: the_cluster,\n        startAngle: running_totals[index] / sums[index] * 2 * Math.PI,\n        endAngle: (running_totals[index] + d[1]) / sums[index] * 2 * Math.PI,\n        name: d[0],\n        rim: index > 0\n      };\n      running_totals[index] += d[1];\n      return v;\n    });\n\n    var arc_radius = cluster_box_size(the_cluster) * 0.5;\n    the_cluster.rendered_size = arc_radius + 2;\n    var paths = container_group.selectAll(\"path\").data(draw_from);\n    paths.enter().append(\"path\");\n    paths.exit().remove();\n\n    paths\n      .classed(\"cluster\", true)\n      .classed(\"hiv-trace-problematic\", function(d) {\n        return the_cluster.hxb2_linked && !d.rim;\n      })\n      .classed(\"hiv-trace-selected\", function(d) {\n        return d.rim;\n      })\n      .attr(\"d\", function(d) {\n        return (d.rim\n          ? d3.svg.arc().innerRadius(arc_radius + 2).outerRadius(arc_radius + 5)\n          : d3.svg.arc().innerRadius(0).outerRadius(arc_radius))(d);\n      })\n      .style(\"fill\", function(d, i) {\n        return d.rim\n          ? self.colorizer[\"selected\"](d.name)\n          : the_cluster[\"gradient\"]\n            ? \"url(#\" + the_cluster[\"gradient\"] + \")\"\n            : cluster_color(the_cluster, d.name);\n      })\n      .style(\"stroke-linejoin\", function(d, i) {\n        return draw_from.length > 1 ? \"round\" : \"\";\n      })\n      .style(\"display\", function(d) {\n        if (the_cluster.is_hidden) return \"none\";\n        return null;\n      });\n  }\n\n  function check_for_predefined_shapes(cat_id) {\n    //console.log (cat_id);\n\n    if (cat_id in _networkPresetShapeSchemes) {\n      var domain = _.range(\n        0,\n        graph_data[_networkGraphAttrbuteID][cat_id][\"value_range\"].length\n      );\n\n      return {\n        domain: domain,\n        range: _.map(domain, function(v) {\n          return _networkPresetShapeSchemes[\n            cat_id\n          ][graph_data[_networkGraphAttrbuteID][cat_id][\"value_range\"][v]];\n        })\n      };\n    } else {\n      return {\n        domain: _.range(\n          0,\n          graph_data[_networkGraphAttrbuteID][cat_id].dimension\n        ),\n        range: _networkShapeOrdering\n      };\n    }\n  }\n\n  self.handle_shape_categorical = function(cat_id) {\n    var set_attr = \"None\";\n\n    [\"shapes\"].forEach(function(lbl) {\n      d3\n        .select(self.get_ui_element_selector_by_role(lbl))\n        .selectAll(\"li\")\n        .selectAll(\"a\")\n        .attr(\"style\", function(d, i) {\n          if (d[1] == cat_id) {\n            set_attr = d[0];\n            return \" font-weight: bold;\";\n          }\n          return null;\n        });\n      d3\n        .select(self.get_ui_element_selector_by_role(lbl + \"_label\"))\n        .html(\"Shape: \" + set_attr + ' <span class=\"caret\"></span>');\n    });\n\n    if (cat_id) {\n      var domain_range = check_for_predefined_shapes(cat_id);\n\n      var shape_mapper = d3.scale\n        .ordinal()\n        .domain(domain_range[\"domain\"])\n        .range(domain_range[\"range\"]);\n      self.node_shaper[\"id\"] = cat_id;\n      self.node_shaper[\"shaper\"] = function(d) {\n        return shape_mapper(\n          graph_data[_networkGraphAttrbuteID][cat_id][\"value_map\"](\n            self.attribute_node_value_by_id(d, cat_id)\n          )\n        );\n      };\n      self.node_shaper[\"category_map\"] =\n        graph_data[_networkGraphAttrbuteID][cat_id][\"value_map\"];\n    } else {\n      self.node_shaper.id = null;\n      self.node_shaper.shaper = function() {\n        return \"circle\";\n      };\n      self.node_shaper[\"category_map\"] = null;\n    }\n    //console.log (graph_data [_networkGraphAttrbuteID][cat_id]['value_map'], self.node_shaper.domain(), self.node_shaper.range());\n    self.draw_attribute_labels();\n    self.update(true);\n    d3.event.preventDefault();\n  };\n\n  self.draw_attribute_labels = function() {\n\n    var determine_label_format_cont =   function (field_data) {\n        if (\"label_format\" in field_data) {\n            return field_data[\"label_format\"];\n        }\n        if (field_data[\"type\"] == \"Date\") {\n            return _defaultDateViewFormatShort;\n        }\n        return d3.format(\",.4r\");\n    };\n\n\n    self.legend_svg.selectAll(\"g.hiv-trace-legend\").remove();\n\n    var offset = 10;\n\n    if (self.legend_caption) {\n      self.legend_svg\n        .append(\"g\")\n        .attr(\"transform\", \"translate(0,\" + offset + \")\")\n        .classed(\"hiv-trace-legend\", true)\n        .append(\"text\")\n        .text(self.legend_caption)\n        .style(\"font-weight\", \"bold\");\n      offset += 18;\n    }\n\n    if (self.edge_legend) {\n      self.legend_svg\n        .append(\"g\")\n        .attr(\"transform\", \"translate(0,\" + offset + \")\")\n        .classed(\"hiv-trace-legend\", true)\n        .append(\"text\")\n        .text(self.edge_legend[\"caption\"])\n        .style(\"font-weight\", \"bold\");\n      offset += 18;\n\n      _.each(self.edge_legend[\"types\"], function(value, key) {\n        self.legend_svg\n          .append(\"g\")\n          .classed(\"hiv-trace-legend\", true)\n          .attr(\"transform\", \"translate(20,\" + offset + \")\")\n          .append(\"text\")\n          .text(key);\n\n        value.call(\n          self.legend_svg\n            .append(\"g\")\n            .classed(\"hiv-trace-legend\", true)\n            .attr(\"transform\", \"translate(0,\" + offset + \")\")\n            .append(\"line\")\n            .attr(\"x1\", \"0\")\n            .attr(\"y1\", \"-4\")\n            .attr(\"x2\", \"12\")\n            .attr(\"y2\", \"-4\")\n            .classed(\"legend\", true)\n        );\n\n        offset += 18;\n      });\n    }\n\n    if (self.colorizer[\"category_id\"]) {\n      //console.log (self.colorizer);\n      //_.each (self.colorizer[\"category_map\"](null, \"map\"), function (v){ console.log (v); });\n\n      self.legend_svg\n        .append(\"g\")\n        .attr(\"transform\", \"translate(0,\" + offset + \")\")\n        .classed(\"hiv-trace-legend\", true)\n        .append(\"text\")\n        .text(\"Color: \" + self.colorizer[\"category_id\"])\n        .style(\"font-weight\", \"bold\");\n      offset += 18;\n\n      if (self.colorizer[\"continuous\"]) {\n        var anchor_format = determine_label_format_cont (graph_data[_networkGraphAttrbuteID][self.colorizer[\"category_id\"]]);\n\n         var scale =\n          graph_data[_networkGraphAttrbuteID][self.colorizer[\"category_id\"]][\n            \"scale\"\n          ];\n\n        _.each(_.range(_networkContinuousColorStops), function(value) {\n          var x = scale.invert(value);\n          self.legend_svg\n            .append(\"g\")\n            .classed(\"hiv-trace-legend\", true)\n            .attr(\"transform\", \"translate(20,\" + offset + \")\")\n            .append(\"text\")\n            .text(anchor_format(x));\n          self.legend_svg\n            .append(\"g\")\n            .classed(\"hiv-trace-legend\", true)\n            .attr(\"transform\", \"translate(0,\" + offset + \")\")\n            .append(\"circle\")\n            .attr(\"cx\", \"8\")\n            .attr(\"cy\", \"-4\")\n            .attr(\"r\", \"8\")\n            .classed(\"legend\", true)\n            .style(\"fill\", self.colorizer[\"category\"](x));\n\n          offset += 18;\n        });\n\n        self.legend_svg\n          .append(\"g\")\n          .classed(\"hiv-trace-legend\", true)\n          .attr(\"transform\", \"translate(20,\" + offset + \")\")\n          .append(\"text\")\n          .text(\"missing\");\n        self.legend_svg\n          .append(\"g\")\n          .classed(\"hiv-trace-legend\", true)\n          .attr(\"transform\", \"translate(0,\" + offset + \")\")\n          .append(\"circle\")\n          .attr(\"cx\", \"8\")\n          .attr(\"cy\", \"-4\")\n          .attr(\"r\", \"8\")\n          .classed(\"legend\", true)\n          .style(\"fill\", _networkMissingColor);\n\n        offset += 18;\n      } else {\n        _.each(self.colorizer[\"category_map\"](null, \"map\"), function(\n          value,\n          key\n        ) {\n          self.legend_svg\n            .append(\"g\")\n            .classed(\"hiv-trace-legend\", true)\n            .attr(\"transform\", \"translate(20,\" + offset + \")\")\n            .append(\"text\")\n            .text(key);\n          self.legend_svg\n            .append(\"g\")\n            .classed(\"hiv-trace-legend\", true)\n            .attr(\"transform\", \"translate(0,\" + offset + \")\")\n            .append(\"circle\")\n            .attr(\"cx\", \"8\")\n            .attr(\"cy\", \"-4\")\n            .attr(\"r\", \"8\")\n            .classed(\"legend\", true)\n            .style(\"fill\", self.colorizer[\"category\"](key));\n\n          offset += 18;\n        });\n      }\n    }\n\n    if (self.node_shaper[\"id\"]) {\n      self.legend_svg\n        .append(\"g\")\n        .attr(\"transform\", \"translate(0,\" + offset + \")\")\n        .classed(\"hiv-trace-legend\", true)\n        .append(\"text\")\n        .text(\"Shape: \" + self.node_shaper[\"id\"])\n        .style(\"font-weight\", \"bold\");\n      offset += 18;\n\n      var domain_range = check_for_predefined_shapes(self.node_shaper[\"id\"]);\n      var shape_mapper = d3.scale\n        .ordinal()\n        .domain(domain_range[\"domain\"])\n        .range(domain_range[\"range\"]);\n\n      _.each(self.node_shaper[\"category_map\"](null, \"map\"), function(\n        value,\n        key\n      ) {\n        self.legend_svg\n          .append(\"g\")\n          .classed(\"hiv-trace-legend\", true)\n          .attr(\"transform\", \"translate(20,\" + offset + \")\")\n          .append(\"text\")\n          .text(key);\n\n        self.legend_svg\n          .append(\"g\")\n          .classed(\"hiv-trace-legend\", true)\n          .attr(\"transform\", \"translate(0,\" + offset + \")\")\n          .append(\"path\")\n          .attr(\"transform\", \"translate(5,-5)\")\n          .attr(\"d\", misc.symbol(shape_mapper(value)).size(128))\n          .classed(\"legend\", true)\n          .style(\"fill\", \"none\");\n\n        offset += 18;\n      });\n    }\n\n    if (self.colorizer[\"opacity_id\"]) {\n      self.legend_svg\n        .append(\"g\")\n        .attr(\"transform\", \"translate(0,\" + offset + \")\")\n        .classed(\"hiv-trace-legend\", true)\n        .append(\"text\")\n        .text(\"Opacity: \" + self.colorizer[\"opacity_id\"])\n        .style(\"font-weight\", \"bold\");\n      offset += 18;\n\n      var anchor_format = determine_label_format_cont (graph_data[_networkGraphAttrbuteID][self.colorizer[\"opacity_id\"]]);\n\n\n      var scale =\n        graph_data[_networkGraphAttrbuteID][self.colorizer[\"opacity_id\"]][\n          \"scale\"\n        ];\n\n      _.each(_.range(_networkContinuousColorStops), function(value) {\n        var x = scale.invert(value);\n        self.legend_svg\n          .append(\"g\")\n          .classed(\"hiv-trace-legend\", true)\n          .attr(\"transform\", \"translate(20,\" + offset + \")\")\n          .append(\"text\")\n          .text(anchor_format(x));\n        self.legend_svg\n          .append(\"g\")\n          .classed(\"hiv-trace-legend\", true)\n          .attr(\"transform\", \"translate(0,\" + offset + \")\")\n          .append(\"circle\")\n          .attr(\"cx\", \"8\")\n          .attr(\"cy\", \"-4\")\n          .attr(\"r\", \"8\")\n          .classed(\"legend\", true)\n          .style(\"fill\", \"black\")\n          .style(\"opacity\", self.colorizer[\"opacity\"](x));\n\n        offset += 18;\n      });\n\n      self.legend_svg\n        .append(\"g\")\n        .classed(\"hiv-trace-legend\", true)\n        .attr(\"transform\", \"translate(20,\" + offset + \")\")\n        .append(\"text\")\n        .text(\"missing\");\n      self.legend_svg\n        .append(\"g\")\n        .classed(\"hiv-trace-legend\", true)\n        .attr(\"transform\", \"translate(0,\" + offset + \")\")\n        .append(\"circle\")\n        .attr(\"cx\", \"8\")\n        .attr(\"cy\", \"-4\")\n        .attr(\"r\", \"8\")\n        .classed(\"legend\", true)\n        .style(\"fill\", \"black\")\n        .style(\"opacity\", _networkMissingOpacity);\n\n      offset += 18;\n    }\n  };\n\n  function compute_cluster_gradient(cluster, cat_id) {\n    if (cat_id) {\n      var id = self.dom_prefix + \"-cluster-gradient-\" + self.gradient_id++;\n      var gradient = self.network_svg\n        .selectAll(\"defs\")\n        .append(\"radialGradient\")\n        .attr(\"id\", id);\n      var values = _.map(cluster.children, function(node) {\n        var value = self.attribute_node_value_by_id(node, cat_id);\n        return value == _networkMissing ? Infinity : value;\n      }).sort(function(a, b) {\n        return 0 + a - (0 + b);\n      });\n      var finite = _.filter(values, function(d) {\n        return d < Infinity;\n      });\n      var infinite = values.length - finite.length;\n\n      if (infinite) {\n        gradient\n          .append(\"stop\")\n          .attr(\"offset\", \"0%\")\n          .attr(\"stop-color\", _networkMissingColor);\n        gradient\n          .append(\"stop\")\n          .attr(\"offset\", \"\" + infinite / values.length * 100 + \"%\")\n          .attr(\"stop-color\", _networkMissingColor);\n      }\n\n      _.each(finite, function(value, index) {\n        gradient\n          .append(\"stop\")\n          .attr(\n            \"offset\",\n            \"\" + (1 + index + infinite) * 100 / values.length + \"%\"\n          )\n          .attr(\"stop-color\", self.colorizer[\"category\"](value));\n      });\n      //gradient.append (\"stop\").attr (\"offset\", \"100%\").attr (\"stop-color\", self.colorizer['category'] (dom[1]));\n\n      return id;\n    }\n    return null;\n  }\n\n  self.handle_attribute_opacity = function(cat_id) {\n    var set_attr = \"None\";\n\n    [\"opacity\"].forEach(function(lbl) {\n      d3\n        .select(self.get_ui_element_selector_by_role(lbl))\n        .selectAll(\"li\")\n        .selectAll(\"a\")\n        .attr(\"style\", function(d, i) {\n          if (d[1] == cat_id) {\n            set_attr = d[0];\n            return \" font-weight: bold;\";\n          }\n          return null;\n        });\n      d3\n        .select(self.get_ui_element_selector_by_role(lbl + \"_label\"))\n        .html(\"Opacity: \" + set_attr + ' <span class=\"caret\"></span>');\n    });\n\n    d3\n      .select(self.get_ui_element_selector_by_role(\"opacity_invert\"))\n      .style(\"display\", set_attr == \"None\" ? \"none\" : \"inline\")\n      .classed(\"btn-active\", false)\n      .classed(\"btn-default\", true);\n\n    self.colorizer[\"opacity_id\"] = cat_id;\n    if (cat_id) {\n      var scale = graph_data[_networkGraphAttrbuteID][cat_id][\"scale\"];\n      self.colorizer[\"opacity_scale\"] = d3.scale\n        .linear()\n        .domain([0, _networkContinuousColorStops - 1])\n        .range([0.25, 1]);\n      self.colorizer[\"opacity\"] = function(v) {\n        if (v == _networkMissing) {\n          return _networkMissingOpacity;\n        }\n        return self.colorizer[\"opacity_scale\"](scale(v));\n      };\n    } else {\n      self.colorizer[\"opacity\"] = null;\n      self.colorizer[\"opacity_scale\"] = null;\n    }\n\n    self.draw_attribute_labels();\n    self.update(true);\n    d3.event.preventDefault();\n  };\n\n  self.handle_attribute_continuous = function(cat_id) {\n    var set_attr = \"None\";\n\n    render_chord_diagram(\"aux_svg_holder\", null, null);\n    render_binned_table(\"attribute_table\", null, null);\n\n    self.network_svg.selectAll(\"radialGradient\").remove();\n\n    self.clusters.forEach(function(the_cluster) {\n      delete the_cluster[\"binned_attributes\"];\n      delete the_cluster[\"gradient\"];\n    });\n\n    [[\"attributes\", false], [\"attributes_cat\", true]].forEach(function(lbl) {\n      d3\n        .select(self.get_ui_element_selector_by_role(lbl[0], lbl[1]))\n        .selectAll(\"li\")\n        .selectAll(\"a\")\n        .attr(\"style\", function(d, i) {\n          if (d[1] == cat_id) {\n            set_attr = d[0];\n            return \" font-weight: bold;\";\n          }\n          return null;\n        });\n      d3\n        .select(self.get_ui_element_selector_by_role(lbl[0] + \"_label\", lbl[1]))\n        .html(\"Color: \" + set_attr + ' <span class=\"caret\"></span>');\n    });\n\n    d3\n      .select(self.get_ui_element_selector_by_role(\"attributes_invert\"))\n      .style(\"display\", set_attr == \"None\" ? \"none\" : \"inline\")\n      .classed(\"btn-active\", false)\n      .classed(\"btn-default\", true);\n\n    if (cat_id) {\n      //console.log (graph_data [_networkGraphAttrbuteID][cat_id]);\n\n      self.colorizer[\"category\"] = _.wrap(\n        d3.scale\n          .linear()\n          .range([\n            \"#fff7ec\",\n            \"#fee8c8\",\n            \"#fdd49e\",\n            \"#fdbb84\",\n            \"#fc8d59\",\n            \"#ef6548\",\n            \"#d7301f\",\n            \"#b30000\",\n            \"#7f0000\"\n          ])\n          .domain(_.range(_networkContinuousColorStops)),\n        function(func, arg) {\n          return func(\n            graph_data[_networkGraphAttrbuteID][cat_id][\"scale\"](arg)\n          );\n        }\n      ); //console.log (self.colorizer['category'].exponent ());\n\n      //console.log (self.colorizer['category'] (graph_data [_networkGraphAttrbuteID][cat_id]['value_range'][0]), self.colorizer['category'] (d['value_range'][1]));\n\n      self.colorizer[\"category_id\"] = cat_id;\n      self.colorizer[\"continuous\"] = true;\n      self.clusters.forEach(function(the_cluster) {\n        the_cluster[\"gradient\"] = compute_cluster_gradient(the_cluster, cat_id);\n      });\n\n      var points = [];\n\n      _.each(self.edges, function(e) {\n        var src = self.attribute_node_value_by_id(\n            self.nodes[e.source],\n            cat_id,\n            true\n          ),\n          tgt = self.attribute_node_value_by_id(\n            self.nodes[e.target],\n            cat_id,\n            true\n          );\n\n        if (src != _networkMissing && tgt != _networkMissing) {\n          points.push({\n            x: src,\n            y: tgt,\n            title:\n              self.nodes[e.source].id +\n              \" (\" +\n              src +\n              \") -- \" +\n              self.nodes[e.target].id +\n              \" (\" +\n              tgt +\n              \")\"\n          });\n        }\n      });\n      d3\n        .select(\n          self.get_ui_element_selector_by_role(\"aux_svg_holder_enclosed\", true)\n        )\n        .style(\"display\", null);\n\n      scatterPlot.scatterPlot(\n        points,\n        400,\n        400,\n        self.get_ui_element_selector_by_role(\"aux_svg_holder\", true),\n        {\n          x: \"Source\",\n          y: \"Target\"\n        },\n        graph_data[_networkGraphAttrbuteID][cat_id][\"type\"] == \"Date\"\n      );\n    } else {\n      self.colorizer[\"category\"] = null;\n      self.colorizer[\"category_id\"] = null;\n      self.colorizer[\"continuous\"] = false;\n      self.colorizer[\"category_pairwise\"] = null;\n      self.colorizer[\"category_map\"] = null;\n    }\n\n    self.draw_attribute_labels();\n    self.update(true);\n    d3.event.preventDefault();\n  };\n\n  self.handle_attribute_categorical = function(cat_id) {\n    var set_attr = \"None\";\n    d3\n      .select(self.get_ui_element_selector_by_role(\"attributes_invert\"))\n      .style(\"display\", \"none\");\n\n    self.network_svg.selectAll(\"radialGradient\").remove();\n\n    [[\"attributes\", false], [\"attributes_cat\", true]].forEach(function(lbl) {\n      d3\n        .select(self.get_ui_element_selector_by_role(lbl[0], lbl[1]))\n        .selectAll(\"li\")\n        .selectAll(\"a\")\n        .attr(\"style\", function(d, i) {\n          if (d[1] == cat_id) {\n            set_attr = d[0];\n            return \" font-weight: bold;\";\n          }\n          return null;\n        });\n      d3\n        .select(self.get_ui_element_selector_by_role(lbl[0] + \"_label\", lbl[1]))\n        .html(\"Color: \" + set_attr + ' <span class=\"caret\"></span>');\n    });\n\n    self.clusters.forEach(function(the_cluster) {\n      delete the_cluster[\"gradient\"];\n      the_cluster[\"binned_attributes\"] = stratify(\n        attribute_cluster_distribution(the_cluster, cat_id)\n      );\n    });\n\n    self.colorizer[\"continuous\"] = false;\n\n    if (cat_id) {\n      if (cat_id in _networkPresetColorSchemes) {\n        var domain = [],\n          range = [];\n        _.each(_networkPresetColorSchemes[cat_id], function(value, key) {\n          domain.push(key);\n          range.push(value);\n        });\n        self.colorizer[\"category\"] = d3.scale\n          .ordinal()\n          .domain(domain)\n          .range(range);\n      } else {\n        if (graph_data[_networkGraphAttrbuteID][cat_id][\"color_scale\"]) {\n          self.colorizer[\"category\"] = graph_data[_networkGraphAttrbuteID][\n            cat_id\n          ][\"color_scale\"](graph_data[_networkGraphAttrbuteID][cat_id], self);\n        } else {\n          self.colorizer[\"category\"] = d3.scale\n            .ordinal()\n            .range(_networkCategorical);\n          var extended_range = _.clone(self.colorizer[\"category\"].range());\n          extended_range.push(_networkMissingColor);\n\n          self.colorizer[\"category\"].domain(\n            _.range(_maximumValuesInCategories + 1)\n          );\n          self.colorizer[\"category\"].range(extended_range);\n\n          if (graph_data[_networkGraphAttrbuteID][cat_id][\"stable-ish order\"]) {\n            self.colorizer[\"category\"] = _.wrap(\n              self.colorizer[\"category\"],\n              function(func, arg) {\n                if (arg == _networkMissing) {\n                  return func(_maximumValuesInCategories);\n                }\n                return func(\n                  graph_data[_networkGraphAttrbuteID][cat_id][\n                    \"stable-ish order\"\n                  ][arg]\n                );\n              }\n            );\n            //console.log (graph_data[_networkGraphAttrbuteID][cat_id]['stable-ish order']);\n          }\n        }\n      }\n      self.colorizer[\"category_id\"] = cat_id;\n      self.colorizer[\"category_map\"] =\n        graph_data[_networkGraphAttrbuteID][cat_id][\"value_map\"];\n\n      //console.log (cat_id, self.json[_networkGraphAttrbuteID][cat_id], graph_data[_networkGraphAttrbuteID][cat_id][\"value_map\"] (null, \"lookup\"));\n      //self.colorizer['category_map'][null] =  graph_data [_networkGraphAttrbuteID][cat_id]['range'];\n\n      //try {\n      //console.log (self.colorizer[\"category_map\"]);\n      self.colorizer[\"category_pairwise\"] = attribute_pairwise_distribution(\n        cat_id,\n        graph_data[_networkGraphAttrbuteID][cat_id].dimension,\n        self.colorizer[\"category_map\"]\n      );\n      //} catch (err) {\n      // TODO: there are still lingering issues with this \"category_map\"\n      //}\n\n      render_chord_diagram(\n        \"aux_svg_holder\",\n        self.colorizer[\"category_map\"],\n        self.colorizer[\"category_pairwise\"]\n      );\n      render_binned_table(\n        \"attribute_table\",\n        self.colorizer[\"category_map\"],\n        self.colorizer[\"category_pairwise\"]\n      );\n    } else {\n      self.colorizer[\"category\"] = null;\n      self.colorizer[\"category_id\"] = null;\n      self.colorizer[\"category_pairwise\"] = null;\n      self.colorizer[\"category_map\"] = null;\n      render_chord_diagram(\"aux_svg_holder\", null, null);\n      render_binned_table(\"attribute_table\", null, null);\n    }\n    if (self.handle_inline_charts) {\n      self.handle_inline_charts();\n    }\n\n    self.draw_attribute_labels();\n    self.update(true);\n    d3.event.preventDefault();\n  };\n\n  self.filter_visibility = function() {\n    self.clusters.forEach(function(c) {\n      c.is_hidden = self.hide_unselected && !c.match_filter;\n    });\n    self.nodes.forEach(function(n) {\n      n.is_hidden = self.hide_unselected && !n.match_filter;\n    });\n  };\n\n  self.filter = function(conditions, skip_update) {\n    var anything_changed = false;\n\n    conditions = _.map([\"re\", \"distance\"], function(cnd) {\n      return _.map(\n        _.filter(conditions, function(v) {\n          return v.type == cnd;\n        }),\n        function(v) {\n          return v.value;\n        }\n      );\n    });\n\n    if (conditions[1].length) {\n      self.nodes.forEach(function(n) {\n        n.length_filter = false;\n      });\n\n      _.each(self.edges, function(e) {\n        var did_match = _.some(conditions[1], function(d) {\n          return e.length <= d;\n        });\n\n        if (did_match) {\n          self.nodes[e.source].length_filter = true;\n          self.nodes[e.target].length_filter = true;\n        }\n      });\n    } else {\n      self.nodes.forEach(function(n) {\n        n.length_filter = false;\n      });\n    }\n\n    self.clusters.forEach(function(c) {\n      c.match_filter = 0;\n    });\n\n    self.nodes.forEach(function(n) {\n      var did_match = _.some(conditions[0], function(regexp) {\n        return (\n          regexp.test(n.id) ||\n          _.some(n[_networkNodeAttributeID], function(attr) {\n            return regexp.test(attr);\n          })\n        );\n      });\n\n      did_match = did_match || n.length_filter;\n\n      if (did_match != n.match_filter) {\n        n.match_filter = did_match;\n        anything_changed = true;\n      }\n\n      if (n.match_filter) {\n        n.parent.match_filter += 1;\n      }\n    });\n\n    if (anything_changed && self.handle_inline_charts) {\n        self.handle_inline_charts (function (n) {return n.match_filter;});\n    }\n\n    if (anything_changed && !skip_update) {\n      if (self.hide_unselected) {\n        self.filter_visibility();\n      }\n\n      self.update(true);\n    }\n  };\n\n  self.is_empty = function() {\n    return self.cluster_sizes.length == 0;\n  };\n\n  self.display_warning = function(warning_string, is_html) {\n    if (network_warning_tag) {\n      if (warning_string.length) {\n        var warning_box = d3.select(network_warning_tag);\n        warning_box.selectAll(\"div\").remove();\n        if (is_html) {\n          warning_box.append(\"div\").html(warning_string);\n        } else {\n          warning_box.append(\"div\").text(warning_string);\n        }\n        warning_box.style(\"display\", \"block\");\n        warning_string = \"\";\n      } else {\n        d3.select(network_warning_tag).style(\"display\", \"none\");\n      }\n    }\n  };\n\n  self.link_generator_function = function(d) {\n    var pull = d.pull || 0.0;\n    var path;\n\n    if (pull != 0.0) {\n      var dist_x = d.target.x - d.source.x;\n      var dist_y = d.target.y - d.source.y;\n      var pull = pull * Math.sqrt(dist_x * dist_x + dist_y * dist_y);\n\n      var theta = Math.PI / 6; // 18deg additive angle\n\n      var alpha = dist_x ? Math.atan(-dist_y / dist_x) : Math.PI / 2; // angle with the X axis\n\n      if (pull < 0) {\n        theta = -theta;\n        pull = -pull;\n      }\n\n      var dx = Math.cos(theta + alpha) * pull,\n        dx2 = Math.cos(theta - alpha) * pull;\n\n      var dy = Math.sin(theta + alpha) * pull,\n        dy2 = Math.sin(theta - alpha) * pull;\n\n      var s1, s2;\n      if (d.target.x >= d.source.x) {\n        s1 = [dx, -dy];\n        s2 = [-dx2, -dy2];\n      } else {\n        s1 = [-dx2, -dy2];\n        s2 = [dx, -dy];\n      }\n\n      path =\n        \"M\" +\n        d.source.x +\n        \" \" +\n        d.source.y +\n        \" C \" +\n        (d.source.x + s1[0]) +\n        \" \" +\n        (d.source.y + s1[1]) +\n        \", \" +\n        (d.target.x + s2[0]) +\n        \" \" +\n        (d.target.y + s2[1]) +\n        \", \" +\n        d.target.x +\n        \" \" +\n        d.target.y;\n    } else {\n      path =\n        \"M\" +\n        d.source.x +\n        \" \" +\n        d.source.y +\n        \" L \" +\n        d.target.x +\n        \" \" +\n        d.target.y;\n    }\n\n    d3.select(this).attr(\"d\", path);\n  };\n\n  self.update = function(soft, friction) {\n    self.needs_an_update = false;\n\n    if (options && options [\"extra-graphics\"]) {\n        options [\"extra-graphics\"].call(null, self, options);\n    }\n\n    if (friction) {\n      network_layout.friction(friction);\n    }\n    self.display_warning(warning_string);\n\n    var rendered_nodes, rendered_clusters, link;\n\n    if (!soft) {\n      var draw_me = prepare_data_to_graph();\n\n      network_layout.nodes(draw_me.all).links(draw_me.edges);\n      update_network_string(draw_me.nodes.length, draw_me.edges.length);\n\n      var edge_set = {};\n\n      _.each(draw_me.edges, function(d) {\n        d.pull = 0.0;\n        var tag = \"\";\n\n        if (d.source < d.target) {\n          tag = \"\" + d.source + \"|\" + d.target;\n        } else {\n          tag = \"\" + d.target + \"|\" + d.source;\n        }\n        if (tag in edge_set) {\n          edge_set[tag].push(d);\n        } else {\n          edge_set[tag] = [d];\n        }\n      });\n\n      _.each(edge_set, function(v) {\n        if (v.length > 1) {\n          var step = 1 / (v.length - 1);\n          _.each(v, function(edge, index) {\n            edge.pull = -0.5 + index * step;\n          });\n        }\n      });\n\n      link = self.network_svg\n        .selectAll(\".link\")\n        .data(draw_me.edges, function(d) {\n          return d.id;\n        });\n\n      //link.enter().append(\"line\").classed(\"link\", true);\n      link.enter().append(\"path\").classed(\"link\", true);\n      link.exit().remove();\n\n      link\n        .classed(\"removed\", function(d) {\n          return d.removed;\n        })\n        .classed(\"unsupported\", function(d) {\n          return \"support\" in d && d[\"support\"] > 0.05;\n        })\n        .classed(\"core-link\", function(d) {\n          //console.log (d[\"length\"] <= self.core_link_length);\n          return d[\"length\"] <= self.core_link_length;\n          //return false;\n        });\n\n      link\n        .on(\"mouseover\", edge_pop_on)\n        .on(\"mouseout\", edge_pop_off)\n        .filter(function(d) {\n          return d.directed;\n        })\n        .attr(\"marker-end\", \"url(#\" + self.dom_prefix + \"_arrowhead)\");\n\n      rendered_nodes = self.network_svg\n        .selectAll(\".node\")\n        .data(draw_me.nodes, function(d) {\n          return d.id;\n        });\n\n      rendered_nodes.exit().remove();\n      rendered_nodes.enter().append(\"path\");\n\n      rendered_clusters = self.network_svg\n        .selectAll(\".cluster-group\")\n        .data(\n          draw_me.clusters.map(function(d) {\n            return d;\n          }),\n          function(d) {\n            return d.cluster_id;\n          }\n        );\n\n      rendered_clusters.exit().remove();\n      rendered_clusters\n        .enter()\n        .append(\"g\")\n        .attr(\"class\", \"cluster-group\")\n        .attr(\"transform\", function(d) {\n          return \"translate(\" + d.x + \",\" + d.y + \")\";\n        })\n        .on(\"click\", handle_cluster_click)\n        .on(\"mouseover\", cluster_pop_on)\n        .on(\"mouseout\", cluster_pop_off)\n        .call(network_layout.drag().on(\"dragstart\", cluster_pop_off));\n\n      self.draw_cluster_table(\n        self.extra_cluster_table_columns,\n        self.cluster_table\n      );\n\n      if (self._is_CDC_ && !(options && options[\"no-subclusters\"]) && !(options && options[\"no-subcluster-compute\"])) {\n\n        self.annotate_priority_clusters(_networkCDCDateField, 36, 12);\n\n        try {\n            graph_data[_networkGraphAttrbuteID][\"recent_rapid\"] =\n                self._aux_process_category_values(self._aux_populate_category_fields (graph_data[_networkGraphAttrbuteID][\"recent_rapid\"],\"recent_rapid\"));\n        } catch (err) {\n            console.log (err);\n        }\n      }\n\n      if (self._is_CDC_ && !(options && options[\"no-subclusters\"]) && (options && options[\"no-subcluster-compute\"])) {\n\n        //// Create subcluster list from nodes data\n        //_.each(self.clusters, d => {\n        //  // get all nodes with parent_cluster_id equal to cluster's id\n        //  let nodes = _.filter(self.nodes, n => { return n.parent_cluster_id == d.cluster_id }); \n        //  let subclusters = _.values(_.groupBy(nodes, n => n.subcluster_id));\n        //  d.subclusters = subclusters;\n        //});\n\n        _.each(self.clusters, function(cluster_nodes, cluster_index) {\n          /** extract subclusters; all nodes at given threshold */\n          /** Sub-Cluster: all nodes connected at 0.005 subs/site; there can be multiple sub-clusters per cluster */\n          let subclusters = _.groupBy(cluster_nodes.children, n => n.subcluster_id);\n          subclusters = _.values(_.reject(subclusters, (v,k) => { return k == \"undefined\" } ));\n\n          /** sort subclusters by oldest node */\n          _.each(subclusters, function(c, i) {\n            c.sort(oldest_nodes_first);\n          });\n\n          subclusters.sort(function(c1, c2) {\n            return oldest_nodes_first(c1[0], c2[0]);\n          });\n\n          subclusters = _.map(subclusters, function(c, i) {\n\n            let parent_cluster_id = c[0].parent_cluster_id;\n            let subcluster_id = c[0].subcluster_id;\n            let label = c[0].subcluster_label;\n\n            var edges = [];\n\n            var meta_data = _.filter(\n              hivtrace_cluster_depthwise_traversal(\n                cluster_nodes.Nodes,\n                cluster_nodes.Edges,\n                null,\n                edges\n              ),\n              function(cc) {\n                return cc.length > 1;\n              }\n            );\n\n            edges = _.filter(edges, function(es) {\n              return es.length > 1;\n            });\n\n            var stats = self.json.subcluster_summary_stats[parent_cluster_id][subcluster_id];\n\n            return {\n              children: _.clone(c),\n              parent_cluster: cluster_nodes,\n              cluster_id: label,\n              subcluster : subcluster_id,\n              recent_nodes : stats.recent_nodes,\n              priority_score: stats.priority_score,\n              distances: helpers.describe_vector(\n                _.map(edges[i], function(e) {\n                  return e.length;\n                })\n              )\n            };\n          });\n\n          _.each(subclusters, function(c) {\n            _compute_cluster_degrees(c);\n          });\n\n          cluster_nodes.subclusters = subclusters || [];\n\n          // add additional information\n          let stats = self.json.subcluster_summary_stats[cluster_nodes.cluster_id];\n          cluster_nodes.recent_nodes = _.map(_.values(stats), d => d.recent_nodes[0] || 0);\n          cluster_nodes.priority_score = _.map(_.values(stats), d => d.priority_score[0] || 0);\n        });\n\n      }\n\n      if (self.subcluster_table) {\n        self.draw_cluster_table(\n          self.extra_subcluster_table_columns,\n          self.subcluster_table,\n          {\n            \"no-clusters\" : true,\n            \"subclusters\" : true,\n            \"headers\" : function (headers) {\n                headers[0][0].value = \"Subcluster ID\";\n                headers[0][0].help  = \"Unique subcluster ID\";\n                headers[0][2].help  = \"Number of total cases in the subcluster\";\n            }\n          }\n        );\n\n      }\n      if (self._is_CDC_) {\n        self.draw_extended_node_table ();\n      } else {\n        self.draw_node_table(self.extra_node_table_columns);\n      }\n    } else {\n      rendered_nodes = self.network_svg.selectAll(\".node\");\n      rendered_clusters = self.network_svg.selectAll(\".cluster-group\");\n      link = self.network_svg.selectAll(\".link\");\n      update_network_string(rendered_nodes.size(), link.size());\n    }\n\n    rendered_nodes.each(function(d) {\n      draw_a_node(this, d);\n    });\n\n    rendered_clusters.each(function(d) {\n      draw_a_cluster(this, d);\n    });\n\n    link.style(\"opacity\", function(d) {\n      return Math.max(node_opacity(d.target), node_opacity(d.source));\n    });\n\n    if (self.additional_edge_styler) {\n      link.each(function(d) {\n        self.additional_edge_styler(this, d, self);\n      });\n    }\n\n    link.style(\"display\", function(d) {\n      if (d.target.is_hidden || d.source.is_hidden || d.is_hidden) {\n        return \"none\";\n      }\n      return null;\n    });\n\n\n    if (!soft) {\n      currently_displayed_objects =\n        rendered_clusters[0].length + rendered_nodes[0].length;\n\n      network_layout.on(\"tick\", function() {\n        var sizes = network_layout.size();\n\n        rendered_nodes.attr(\"transform\", function(d) {\n\n          // Defalut values (just to keep nodes in the svg container rectangle).\n          var xBoundLower = 10;\n          var xBoundUpper = sizes[0] - 10;\n          var yBoundLower = 10;\n          var yBoundUpper = sizes[1] - 10;\n\n          if (self.showing_on_map) {\n            const allowed_offset_from_center_of_country = 15;\n            // If the country is in the list that we have, override the default values for the bounds.\n            var country_code = self._get_node_country (d);\n\n            if (country_code in self.countryCentersObject) {\n              let center = self.countryCentersObject[country_code].countryXY;\n\n              xBoundLower = center[0] - allowed_offset_from_center_of_country;\n              xBoundUpper = center[0] + allowed_offset_from_center_of_country;\n              yBoundLower = center[1]- allowed_offset_from_center_of_country;\n              yBoundUpper = center[1] + allowed_offset_from_center_of_country;\n            }\n          }\n\n          return (\n            \"translate(\" +\n            (d.x = Math.max(\n              xBoundLower,\n              Math.min(xBoundUpper, d.x)\n            )) +\n            \",\" +\n            (d.y = Math.max(\n              yBoundLower,\n              Math.min(yBoundUpper, d.y)\n            )) +\n            \")\"\n          );\n        });\n        rendered_clusters.attr(\"transform\", function(d) {\n          return (\n            \"translate(\" +\n            (d.x = Math.max(\n              d.rendered_size,\n              Math.min(sizes[0] - d.rendered_size, d.x)\n            )) +\n            \",\" +\n            (d.y = Math.max(\n              d.rendered_size,\n              Math.min(sizes[1] - d.rendered_size, d.y)\n            )) +\n            \")\"\n          );\n        });\n\n        link.each(self.link_generator_function);\n      });\n\n      network_layout.start();\n    } else {\n      link.each(self.link_generator_function);\n    }\n  };\n\n  function tick() {\n    var sizes = network_layout.size();\n\n    node\n      .attr(\"cx\", function(d) {\n        return (d.x = Math.max(10, Math.min(sizes[0] - 10, d.x)));\n      })\n      .attr(\"cy\", function(d) {\n        return (d.y = Math.max(10, Math.min(sizes[1] - 10, d.y)));\n      });\n\n    link\n      .attr(\"x1\", function(d) {\n        return d.source.x;\n      })\n      .attr(\"y1\", function(d) {\n        return d.source.y;\n      })\n      .attr(\"x2\", function(d) {\n        return d.target.x;\n      })\n      .attr(\"y2\", function(d) {\n        return d.target.y;\n      });\n  }\n\n  /*------------ Node Methods ---------------*/\n  function compute_node_degrees(nodes, edges) {\n    for (var n in nodes) {\n      nodes[n].degree = 0;\n    }\n\n    for (var e in edges) {\n      nodes[edges[e].source].degree++;\n      nodes[edges[e].target].degree++;\n    }\n  }\n\n  self.attribute_node_value_by_id = function(d, id, number) {\n    try {\n\n      if (_networkNodeAttributeID in d && id) {\n\n        if (id in d[_networkNodeAttributeID]) {\n          var v;\n\n          if (self.json[_networkGraphAttrbuteID][id].volatile) {\n            v = self.json[_networkGraphAttrbuteID][id].map(d, self);\n          } else {\n            v = d[_networkNodeAttributeID][id];\n          }\n\n          if (_.isString(v)) {\n            if (v.length == 0) {\n              return _networkMissing;\n            } else {\n              if (number) {\n                v = +v;\n                return _.isNaN(v) ? _networkMissing : v;\n              }\n            }\n          }\n          return v;\n        }\n      }\n    } catch (e) {\n      console.log(\"self.attribute_node_value_by_id\", e, d, id, number);\n    }\n    return _networkMissing;\n  };\n\n  function inject_attribute_node_value_by_id(d, id, value) {\n    //console.log (\"Injecting \" + id + \" with value \" + value);\n    if (_networkNodeAttributeID in d && id) {\n      d[_networkNodeAttributeID][id] = value;\n    }\n  }\n\n  self.inject_attribute_description = function(key, d) {\n    if (_networkGraphAttrbuteID in self.json) {\n      var new_attr = {};\n      new_attr[key] = d;\n      _.extend(self.json[_networkGraphAttrbuteID], new_attr);\n      //self.json[_networkGraphAttrbuteID][key] = _.clone (d);\n    }\n  };\n  function node_size(d) {\n    if (self.showing_on_map) {\n      return 50;\n    }\n    var r = 5 + Math.sqrt(d.degree); //return (d.match_filter ? 10 : 4)*r*r;\n    return 4 * r * r;\n  }\n\n  function node_color(d) {\n    /*if (d.match_filter) {\n        return \"white\";\n    }*/\n\n    if (self.colorizer[\"category_id\"]) {\n      var v = self.attribute_node_value_by_id(d, self.colorizer[\"category_id\"]);\n      if (self.colorizer[\"continuous\"]) {\n        if (v == _networkMissing) {\n          return _networkMissingColor;\n        }\n        //console.log (v, self.colorizer['category'](v));\n      }\n      return self.colorizer[\"category\"](v);\n    }\n    return d.hxb2_linked ? \"black\" : d.is_lanl ? \"red\" : \"gray\";\n  }\n\n  function node_opacity(d) {\n    if (self.colorizer[\"opacity\"]) {\n      return self.colorizer[\"opacity\"](\n        self.attribute_node_value_by_id(d, self.colorizer[\"opacity_id\"], true)\n      );\n    }\n    return 1;\n  }\n\n  function cluster_color(d, type) {\n    if (d[\"binned_attributes\"]) {\n      return self.colorizer[\"category\"](type);\n    }\n    return \"#bdbdbd\";\n  }\n\n  function hxb2_node_color(d) {\n    return \"black\";\n  }\n\n  function node_info_string(n) {\n    var str;\n\n    if (!self._is_CDC_) {\n      str =\n        \"Degree <em>\" +\n        n.degree +\n        \"</em><br>Clustering coefficient <em> \" +\n        misc.format_value(n.lcc, _defaultFloatFormat) +\n        \"</em>\";\n    } else {\n      str = \"# links <em>\" + n.degree + \"</em>\";\n    }\n\n    _.each(\n      _.union(self._additional_node_pop_fields, [\n        self.colorizer[\"category_id\"],\n        self.node_shaper[\"id\"],\n        self.colorizer[\"opacity_id\"]\n      ]),\n      function(key) {\n        if (key) {\n          if (key in graph_data[_networkGraphAttrbuteID]) {\n            var attribute = self.attribute_node_value_by_id(n, key);\n\n            if (graph_data[_networkGraphAttrbuteID][key][\"type\"] == \"Date\") {\n              try {\n                attribute = _defaultDateViewFormat(attribute);\n              } catch (err) {}\n            }\n            if (attribute) {\n              str += \"<br>\" + key + \" <em>\" + attribute + \"</em>\";\n            }\n          }\n        }\n      }\n    );\n\n    return str;\n  }\n\n  function edge_info_string(n) {\n    var str = \"Length <em>\" + _defaultFloatFormat(n.length) + \"</em>\";\n    if (\"support\" in n) {\n      str +=\n        \"<br>Worst triangle-based support (p): <em>\" +\n        _defaultFloatFormat(n.support) +\n        \"</em>\";\n    }\n\n    var attribute = self.attribute_node_value_by_id(\n      n,\n      self.colorizer[\"category_id\"]\n    );\n\n    return str;\n  }\n\n  function node_pop_on(d) {\n    toggle_tooltip(\n      this,\n      true,\n      (self._is_CDC_ ? \"Individual \" : \"Node \") + d.id,\n      node_info_string(d),\n      self.container\n    );\n  }\n\n  function node_pop_off(d) {\n    toggle_tooltip(this, false);\n  }\n\n  function edge_pop_on(e) {\n    toggle_tooltip(\n      this,\n      true,\n      e.source.id + \" - \" + e.target.id,\n      edge_info_string(e),\n      self.container\n    );\n  }\n\n  function edge_pop_off(d) {\n    toggle_tooltip(this, false);\n  }\n\n  /*------------ Cluster Methods ---------------*/\n\n  /* Creates a new object that groups nodes by cluster\n   * @param nodes\n   * @returns clusters\n   */\n  function get_all_clusters(nodes) {\n    var by_cluster = _.groupBy(nodes, \"cluster\");\n    return by_cluster;\n  }\n\n  function compute_cluster_centroids(clusters) {\n    for (var c in clusters) {\n      var cls = clusters[c];\n      cls.x = 0;\n      cls.y = 0;\n      if (_.has(cls, \"children\")) {\n        cls.children.forEach(function(x) {\n          cls.x += x.x;\n          cls.y += x.y;\n        });\n        cls.x /= cls.children.length;\n        cls.y /= cls.children.length;\n      }\n    }\n  }\n\n  function collapse_cluster(x, keep_in_q) {\n    self.needs_an_update = true;\n    x.collapsed = true;\n    currently_displayed_objects -= self.cluster_sizes[x.cluster_id - 1] - 1;\n    if (!keep_in_q) {\n      var idx = open_cluster_queue.indexOf(x.cluster_id);\n      if (idx >= 0) {\n        open_cluster_queue.splice(idx, 1);\n      }\n    }\n    compute_cluster_centroids([x]);\n    return x.children.length;\n  }\n\n  function expand_cluster(x, copy_coord) {\n    self.needs_an_update = true;\n    x.collapsed = false;\n    currently_displayed_objects += self.cluster_sizes[x.cluster_id - 1] - 1;\n    open_cluster_queue.push(x.cluster_id);\n\n    if (copy_coord) {\n      x.children.forEach(function(n) {\n        n.x = x.x + (Math.random() - 0.5) * x.children.length;\n        n.y = x.y + (Math.random() - 0.5) * x.children.length;\n      });\n    } else {\n      x.children.forEach(function(n) {\n        n.x = self.width * 0.25 + (Math.random() - 0.5) * x.children.length;\n        n.y = 0.25 * self.height + (Math.random() - 0.5) * x.children.length;\n      });\n    }\n  }\n\n  function render_binned_table(id, the_map, matrix) {\n    var the_table = d3.select(self.get_ui_element_selector_by_role(id, true));\n    if (the_table.empty()) {\n      return;\n    }\n\n    the_table.selectAll(\"thead\").remove();\n    the_table.selectAll(\"tbody\").remove();\n\n    d3\n      .select(self.get_ui_element_selector_by_role(id + \"_enclosed\", true))\n      .style(\"display\", matrix ? null : \"none\");\n\n    if (matrix) {\n      var fill = self.colorizer[\"category\"];\n      var lookup = the_map(null, \"lookup\");\n\n      var headers = the_table.append(\"thead\").append(\"tr\").selectAll(\"th\").data(\n        [\"\"].concat(\n          matrix[0].map(function(d, i) {\n            return lookup[i];\n          })\n        )\n      );\n\n      headers.enter().append(\"th\");\n      headers\n        .html(function(d) {\n          return \"<span>&nbsp;\" + d + \"</span>\";\n        })\n        .each(function(d, i) {\n          if (i) {\n            d3\n              .select(this)\n              .insert(\"i\", \":first-child\")\n              .classed(\"fa fa-circle\", true)\n              .style(\"color\", function() {\n                return fill(d);\n              });\n          }\n        });\n\n      if (self.show_percent_in_pairwise_table) {\n        var sum = _.map(matrix, function(row) {\n          return _.reduce(\n            row,\n            function(p, c) {\n              return p + c;\n            },\n            0\n          );\n        });\n\n        matrix = _.map(matrix, function(row, row_index) {\n          return _.map(row, function(c) {\n            return c / sum[row_index];\n          });\n        });\n      }\n\n      var rows = the_table.append(\"tbody\").selectAll(\"tr\").data(\n        matrix.map(function(d, i) {\n          return [lookup[i]].concat(d);\n        })\n      );\n\n      rows.enter().append(\"tr\");\n      rows\n        .selectAll(\"td\")\n        .data(function(d) {\n          return d;\n        })\n        .enter()\n        .append(\"td\")\n        .html(function(d, i) {\n          return i == 0\n            ? \"<span>&nbsp;\" + d + \"</span>\"\n            : self.show_percent_in_pairwise_table\n              ? _defaultPercentFormat(d)\n              : d;\n        })\n        .each(function(d, i) {\n          if (i == 0) {\n            d3\n              .select(this)\n              .insert(\"i\", \":first-child\")\n              .classed(\"fa fa-circle\", true)\n              .style(\"color\", function() {\n                return fill(d);\n              });\n          }\n        });\n    }\n  }\n\n  function render_chord_diagram(id, the_map, matrix) {\n    var container = d3.select(self.get_ui_element_selector_by_role(id, true));\n\n    if (container.empty()) {\n      return;\n    }\n\n    container.selectAll(\"svg\").remove();\n\n    d3\n      .select(self.get_ui_element_selector_by_role(id + \"_enclosed\", true))\n      .style(\"display\", matrix ? null : \"none\");\n\n    if (matrix) {\n      var lookup = the_map(null, \"lookup\");\n\n      var svg = container.append(\"svg\");\n\n      var chord = d3.layout\n        .chord()\n        .padding(0.05)\n        .sortSubgroups(d3.descending)\n        .matrix(matrix);\n\n      var text_offset = 20,\n        width = 450,\n        height = 450,\n        innerRadius = Math.min(width, height - text_offset) * 0.41,\n        outerRadius = innerRadius * 1.1;\n\n      var fill = self.colorizer[\"category\"],\n        font_size = 12;\n\n      var text_label = svg\n        .append(\"g\")\n        .attr(\n          \"transform\",\n          \"translate(\" + width / 2 + \",\" + (height - text_offset) + \")\"\n        )\n        .append(\"text\")\n        .attr(\"text-anchor\", \"middle\")\n        .attr(\"font-size\", font_size)\n        .text(\"\");\n\n      svg = svg\n        .attr(\"width\", width)\n        .attr(\"height\", height - text_offset)\n        .append(\"g\")\n        .attr(\n          \"transform\",\n          \"translate(\" + width / 2 + \",\" + (height - text_offset) / 2 + \")\"\n        );\n\n      svg\n        .append(\"g\")\n        .selectAll(\"path\")\n        .data(chord.groups)\n        .enter()\n        .append(\"path\")\n        .style(\"fill\", function(d) {\n          return fill(lookup[d.index]);\n        })\n        .style(\"stroke\", function(d) {\n          return fill(lookup[d.index]);\n        })\n        .attr(\n          \"d\",\n          d3.svg.arc().innerRadius(innerRadius).outerRadius(outerRadius)\n        )\n        .on(\"mouseover\", fade(0.1, true))\n        .on(\"mouseout\", fade(1, false));\n\n      svg\n        .append(\"g\")\n        .attr(\"class\", \"chord\")\n        .selectAll(\"path\")\n        .data(chord.chords)\n        .enter()\n        .append(\"path\")\n        .attr(\"d\", d3.svg.chord().radius(innerRadius))\n        .style(\"fill\", function(d) {\n          return fill(d.target.index);\n        })\n        .style(\"opacity\", 1);\n\n      // Returns an event handler for fading a given chord group.\n      function fade(opacity, t) {\n        return function(g, i) {\n          text_label.text(t ? lookup[i] : \"\");\n          svg\n            .selectAll(\".chord path\")\n            .filter(function(d) {\n              return d.source.index != i && d.target.index != i;\n            })\n            .transition()\n            .style(\"opacity\", opacity);\n        };\n      }\n    }\n  }\n\n  function attribute_pairwise_distribution(id, dim, the_map, only_expanded) {\n    var scan_from = only_expanded ? draw_me.edges : self.edges;\n    var the_matrix = [];\n    for (var i = 0; i < dim; i += 1) {\n      the_matrix.push([]);\n      for (var j = 0; j < dim; j += 1) {\n        the_matrix[i].push(0);\n      }\n    }\n\n    _.each(scan_from, function(edge) {\n      //console.log (self.attribute_node_value_by_id(self.nodes[edge.source], id), self.attribute_node_value_by_id(self.nodes[edge.target], id));\n      the_matrix[\n        the_map(self.attribute_node_value_by_id(self.nodes[edge.source], id))\n      ][\n        the_map(self.attribute_node_value_by_id(self.nodes[edge.target], id))\n      ] += 1;\n    });\n    // check if there are null values\n\n    var haz_null = the_matrix.some(function(d, i) {\n      if (i == dim - 1) {\n        return d.some(function(d2) {\n          return d2 > 0;\n        });\n      }\n      return d[dim - 1] > 0;\n    });\n    if (!haz_null) {\n      the_matrix.pop();\n      for (i = 0; i < dim - 1; i += 1) {\n        the_matrix[i].pop();\n      }\n    }\n\n    // symmetrize the matrix\n\n    dim = the_matrix.length;\n\n    for (i = 0; i < dim; i += 1) {\n      for (j = i; j < dim; j += 1) {\n        the_matrix[i][j] += the_matrix[j][i];\n        the_matrix[j][i] = the_matrix[i][j];\n      }\n    }\n\n    return the_matrix;\n  }\n\n  self._aux_populate_category_fields = function(d, k) {\n    d[\"raw_attribute_key\"] = k;\n    if (!(\"label\" in d)) {\n        d[\"label\"] = k;\n    }\n    d.discrete = false;\n    if (d[\"type\"] == \"String\") {\n      d.discrete = true;\n      d[\"value_range\"] = _.keys(\n        _.countBy(graph_data.Nodes, function(nd) {\n          return self.attribute_node_value_by_id(nd, k);\n        })\n      );\n      d[\"dimension\"] = d[\"value_range\"].length;\n    } else {\n      if (\"enum\" in d) {\n        d.discrete = true;\n        d[\"value_range\"] = _.clone(d[\"enum\"]);\n        if (!(_networkMissing in d[\"value_range\"])) {\n          d[\"value_range\"].push(_networkMissing);\n        }\n        d[\"dimension\"] = d[\"value_range\"].length;\n        d[\"no-sort\"] = true;\n      }\n    }\n    return d;\n  };\n\n  self._aux_process_category_values = function(d) {\n    var values;\n    if (d[\"no-sort\"]) {\n      values = d[\"value_range\"];\n    } else {\n      if (d[\"type\"] == \"String\") {\n        values = d[\"value_range\"].sort();\n\n        if (d.dimension <= _maximumValuesInCategories) {\n          var string_hash = function(str) {\n            var hash = 5801;\n            for (var ci = 0; ci < str.length; ci++) {\n              var charCode = str.charCodeAt(ci);\n              hash = (hash << (5 + hash)) + charCode;\n            }\n            return hash;\n          };\n\n          var hashed = _.map(values, string_hash);\n          var available_keys = {};\n          var reindexed = {};\n\n          for (var i = 0; i < _maximumValuesInCategories; i++) {\n            available_keys[i] = true;\n          }\n\n          _.each(hashed, function(value, index) {\n            if (value < 0) {\n              value = -value;\n            }\n\n            var first_try = value % _maximumValuesInCategories;\n            if (first_try in available_keys) {\n              reindexed[values[index]] = first_try;\n              delete available_keys[first_try];\n              return;\n            }\n\n            var second_try =\n              Math.floor(value / _maximumValuesInCategories) %\n              _maximumValuesInCategories;\n            if (second_try in available_keys) {\n              reindexed[values[index]] = second_try;\n              delete available_keys[second_try];\n              return;\n            }\n\n            var last_resort = parseInt(_.keys(available_keys).sort()[0]);\n            reindexed[values[index]] = last_resort;\n            delete available_keys[last_resort];\n          });\n\n          d[\"stable-ish order\"] = reindexed;\n        }\n        //values = _.unzip(_.zip (d['value_range'], ordering_map).sort (function (a,b) { if (a[1] < b[1]) return -1; if (a[1] > b[1]) return 1; return 0}))[0]; //d['value_range'].sort ();\n      } else {\n        values = d[\"value_range\"].sort();\n      }\n    }\n\n    var map = new Object();\n\n    _.each(values, function(d2, i) {\n      map[d2] = i;\n    });\n\n    d[\"value_map\"] = function(v, key) {\n      return key ? (key == \"lookup\" ? _.invert(map) : map) : map[v];\n    };\n    return d;\n  };\n\n  function attribute_cluster_distribution(the_cluster, attribute_id) {\n    if (attribute_id && the_cluster) {\n      return the_cluster.children.map(function(d) {\n        return self.attribute_node_value_by_id(d, attribute_id);\n      });\n    }\n    return null;\n  }\n\n  function cluster_info_string(id) {\n    var the_cluster = self.clusters[self.cluster_mapping[id]],\n      attr_info = the_cluster[\"binned_attributes\"];\n\n    var str;\n\n    if (self._is_CDC_) {\n      str =\n        \"<strong>\" +\n        self.cluster_sizes[id - 1] +\n        \"</strong> individuals.\" +\n        \"<br>Mean links/individual <em> = \" +\n        _defaultFloatFormat(the_cluster.degrees[\"mean\"]) +\n        \"</em>\" +\n        \"<br>Max links/individual <em> = \" +\n        the_cluster.degrees[\"max\"] +\n        \"</em>\";\n    } else {\n      str =\n        \"<strong>\" +\n        self.cluster_sizes[id - 1] +\n        \"</strong> nodes.\" +\n        \"<br>Mean degree <em>\" +\n        _defaultFloatFormat(the_cluster.degrees[\"mean\"]) +\n        \"</em>\" +\n        \"<br>Max degree <em>\" +\n        the_cluster.degrees[\"max\"] +\n        \"</em>\" +\n        \"<br>Clustering coefficient <em> \" +\n        misc.format_value(the_cluster.cc, _defaultFloatFormat) +\n        \"</em>\";\n    }\n\n    if (attr_info) {\n      attr_info.forEach(function(d) {\n        str += \"<br>\" + d[0] + \" <em>\" + d[1] + \"</em>\";\n      });\n    }\n\n    return str;\n  }\n\n  function cluster_pop_on(d) {\n    toggle_tooltip(\n      this,\n      true,\n      \"Cluster \" + d.cluster_id,\n      cluster_info_string(d.cluster_id),\n      self.container\n    );\n  }\n\n  function cluster_pop_off(d) {\n    toggle_tooltip(this, false);\n  }\n\n  self.expand_cluster_handler = function(d, do_update, move_out) {\n    if (d.collapsed) {\n      var new_nodes = self.cluster_sizes[d.cluster_id - 1] - 1;\n\n      if (new_nodes > max_points_to_render) {\n        warning_string = \"This cluster is too large to be displayed\";\n      } else {\n        var leftover =\n          new_nodes + currently_displayed_objects - max_points_to_render;\n        if (leftover > 0) {\n          var k = 0;\n          for (; k < open_cluster_queue.length && leftover > 0; k++) {\n            var cluster =\n              self.clusters[self.cluster_mapping[open_cluster_queue[k]]];\n            leftover -= cluster.children.length - 1;\n            collapse_cluster(cluster, true);\n          }\n          if (k || open_cluster_queue.length) {\n            open_cluster_queue.splice(0, k);\n          }\n        }\n\n        if (leftover <= 0) {\n          expand_cluster(d, !move_out);\n        }\n      }\n\n      if (do_update) {\n        self.update(false, 0.6);\n      }\n    }\n    return \"\";\n  };\n\n  function show_sequences_in_cluster(d) {\n    var sequences = new Object();\n    _.each(\n      _extract_single_cluster(\n        self.clusters[self.cluster_mapping[d.cluster]].children,\n        null,\n        true\n      ).Edges,\n      function(e) {\n        _.each(e.sequences, function(s) {\n          if (!(s in sequences)) {\n            sequences[s] = 1;\n          }\n        });\n      }\n    );\n    //console.log (_.keys(sequences));\n  }\n\n  function _compute_cluster_degrees(d) {\n    var degrees = d.children.map(function(c) {\n      return c.degree;\n    });\n    degrees.sort(d3.ascending);\n    d.degrees = helpers.describe_vector(degrees);\n  }\n\n  function collapse_cluster_handler(d, do_update) {\n    collapse_cluster(self.clusters[self.cluster_mapping[d.cluster]]);\n    if (do_update) {\n      self.update(false, 0.4);\n    }\n  }\n\n  function center_cluster_handler(d) {\n    d.x = self.width / 2;\n    d.y = self.height / 2;\n    self.update(false, 0.4);\n  }\n\n  function cluster_box_size(c) {\n    return 8 * Math.sqrt(c.children.length);\n  }\n\n  self.extract_network_time_series = function(\n    time_attr,\n    other_attributes,\n    node_filter\n  ) {\n    var use_these_nodes = node_filter\n      ? _.filter(self.nodes, node_filter)\n      : self.nodes;\n\n    var result = _.map(use_these_nodes, function(node) {\n      var series = {\n        time: self.attribute_node_value_by_id(node, time_attr)\n      };\n      if (other_attributes) {\n        _.each(other_attributes, function(attr, key) {\n          series[attr] = self.attribute_node_value_by_id(node, key);\n        });\n      }\n      return series;\n    });\n\n    result.sort(function(a, b) {\n      if (a.time < b.time) return -1;\n      if (a.time == b.time) return 0;\n      return 1;\n    });\n\n    return result;\n  };\n\n  self.expand_some_clusters = function(subset) {\n    subset = subset || self.clusters;\n    subset.forEach(function(x) {\n      if (!x.is_hidden) {\n        self.expand_cluster_handler(x, false);\n      }\n    });\n    self.update();\n  };\n\n  self.select_some_clusters = function(condition) {\n    return self.clusters.filter(function(c, i) {\n      return _.some(c.children, function(n) {\n        return condition(n);\n      });\n    });\n  };\n\n  self.collapse_some_clusters = function(subset) {\n    subset = subset || self.clusters;\n    subset.forEach(function(x) {\n      if (!x.collapsed) collapse_cluster(x);\n    });\n    self.update();\n  };\n\n  self.toggle_hxb2 = function() {\n    self.hide_hxb2 = !self.hide_hxb2;\n    self.update();\n  };\n\n  function stratify(array) {\n    if (array) {\n      var dict = {},\n        stratified = [];\n\n      array.forEach(function(d) {\n        if (d in dict) {\n          dict[d] += 1;\n        } else {\n          dict[d] = 1;\n        }\n      });\n      for (var uv in dict) {\n        stratified.push([uv, dict[uv]]);\n      }\n      return stratified.sort(function(a, b) {\n        return a[0] - b[0];\n      });\n    }\n    return array;\n  }\n\n  self.is_edge_injected = function (e) {\n    //console.log (e, \"edge_type\" in e);\n    return \"edge_type\" in e;\n  }\n\n  /*------------ Node injection (social network) ---------------*/\n\n  self.load_nodes_edges = function(\n    nodes_and_attributes,\n    index_id,\n    edges_and_attributes,\n    annotation\n  ) {\n    annotation = annotation || \"Social\";\n    /**\n        1. Scan the list of nodes for\n            a. Nodes not present in the existing network\n            b. Attribute names\n            c. Attribute values\n\n        2. Scan the list of edges for\n            a. Edges not present in the existing network\n            b. Attribute names\n            c. Attribute values\n     */\n\n    var new_nodes = [];\n    var edge_types_dict = {};\n    var existing_nodes = 0;\n    \n    try {\n      var injected_nodes            = {};\n      var node_attributes           = {};\n      var existing_network_nodes    = {};\n      var node_name_2_id            = {};\n      \n      _.each(self.json.Nodes, (n, i) => {\n          existing_network_nodes[n.id] = n;\n          node_name_2_id[n.id] = i;\n        });\n\n     const handle_node_attributes = (target, n) => {\n            _.each(n, function(attribute_value, attribute_key) {\n              if (attribute_key != index_id) {\n                inject_attribute_node_value_by_id(\n                  target,\n                  attribute_key,\n                  attribute_value\n                );\n              }\n            });\n          };\n\n     const inject_new_node = (node_name, n) => {\n        let new_node = {\n          node_class: \"injected\",\n          node_annotation: annotation,\n          attributes: [],\n          degree: 0\n        };\n        new_node [_networkNodeAttributeID] = {};\n        new_node.id = node_name;\n        handle_node_attributes(new_node, n);\n        node_name_2_id[node_name] = self.json.Nodes.length;\n        self.json.Nodes.push(new_node);\n        new_nodes.push(new_node);\n     };\n    \n    \n      if (nodes_and_attributes && nodes_and_attributes.length) {\n\n        if (!(index_id in nodes_and_attributes[0])) {\n          throw index_id +\n            \" is not one of the attributes in the imported node records\";\n        }\n\n        _.each(nodes_and_attributes[0], function(r, i) {\n          if (i != index_id) {\n            var attribute_definition = {\n              label: i,\n              type: \"String\",\n              annotation: annotation\n            };\n            self.inject_attribute_description(i, attribute_definition);\n          }\n        });\n\n\n        _.each(nodes_and_attributes, function(n) {\n          if (n[index_id] in existing_network_nodes) {\n            handle_node_attributes(existing_network_nodes[n[index_id]], n);\n            existing_nodes++;\n          } else {\n            inject_new_node (n[index_id], n);\n          }\n        });\n    }\n    \n    \n    \n    if (edges_and_attributes && edges_and_attributes.length) {\n\n        const auto_inject = !(nodes_and_attributes && nodes_and_attributes.length);\n        \n        if (auto_inject) {\n            _.map (existing_network_nodes, (e) => false);\n        }\n        \n        _.each(edges_and_attributes, function(e) {\n          try {\n            if (\"Index\" in e && \"Partner\" in e && \"Contact\" in e) {\n              if (!(e[\"Index\"] in node_name_2_id)) {\n                if (auto_inject) {\n                    inject_new_node (e[\"Index\"], []);\n                } else {\n                    throw \"Invalid index node\";\n                }\n              } else {\n                if (auto_inject) {\n                    existing_network_nodes[e[\"Index\"]] = true;\n                }\n              } \n              \n              if (!(e[\"Partner\"] in node_name_2_id)) {\n                if (auto_inject) {\n                    inject_new_node (e[\"Partner\"], []);\n                } else {\n                    throw \"Invalid partner node\";\n                }\n              } else {\n                if (auto_inject) {\n                    existing_network_nodes[e[\"Partner\"]] = true;\n                }\n              } \n\n              edge_types_dict[e[\"Contact\"]] =\n                (edge_types_dict[e[\"Contact\"]]\n                  ? edge_types_dict[e[\"Contact\"]]\n                  : 0) + 1;\n\n              var new_edge = {\n                source: node_name_2_id[e[\"Index\"]],\n                target: node_name_2_id[e[\"Partner\"]],\n                edge_type: e[\"Contact\"],\n                length: 0.005,\n                directed: true\n              };\n\n              self.json.Edges.push(new_edge);\n            } else {\n              throw \"Missing required attribute\";\n            }\n          } catch (err) {\n            throw \"Invalid edge specification ( \" +\n              err +\n              \") \" +\n              JSON.stringify(e);\n          }\n        });\n        \n        if (auto_inject) {\n            existing_nodes = _.size (_.filter (existing_network_nodes, (e) => e));\n        }\n\n        self._aux_populate_category_menus();\n        self.update_clusters_with_injected_nodes(null, null, annotation);\n        if (self._is_CDC_) {\n            self.draw_extended_node_table (self.json.Nodes);\n        } else {\n            self.draw_node_table(self.extra_node_table_columns, self.json.Nodes);\n        }\n        if (!self.extra_cluster_table_columns) {\n          self.extra_cluster_table_columns = [];\n        }\n        if (!self.extra_subcluster_table_columns) {\n          self.extra_subcluster_table_columns = [];\n        }\n\n        var edge_types_by_cluster = {};\n        _.each(self.json.Edges, function(e) {\n          var edge_clusters = _.union(\n            _.keys(self.json.Nodes[e.source].extended_cluster),\n            _.keys(self.json.Nodes[e.target].extended_cluster)\n          );\n          _.each(edge_clusters, function(c) {\n            if (!(c in edge_types_by_cluster)) {\n              edge_types_by_cluster[c] = {};\n            }\n            if (e.edge_type) {\n              edge_types_by_cluster[c][e.edge_type] = 1;\n            }\n          });\n        });\n\n\n        var edge_types_by_cluster_sorted = {};\n        _.each(edge_types_by_cluster, function(v, c) {\n          var my_keys = _.keys(v);\n          my_keys.sort();\n          edge_types_by_cluster_sorted[c] = my_keys;\n        });\n\n        var edge_types = _.keys(edge_types_dict);\n        edge_types.sort();\n        var _edge_colorizer = d3.scale\n          .ordinal()\n          .range(_networkCategoricalBase)\n          .domain(edge_types);\n\n        /*var _edge_dasher = d3.scale\n          .ordinal()\n          .range(_networkCategoricalDashPatterns)\n          .domain(edge_types);\n        */\n\n        var _social_view_options = function (labeled_links, shown_types) {\n            return {\n                \"edge-styler\": function(element, d, network) {\n                  if (_.has(d, \"edge_type\")) {\n                    d3\n                      .select(element)\n                      .style(\n                        \"stroke\",\n                        network._edge_colorizer(d[\"edge_type\"])\n                      );//.style (\"stroke-dasharray\", network._edge_dasher (d[\"edge_type\"]));\n\n                    d.is_hidden = !network.shown_types[\n                      d[\"edge_type\"]\n                    ];\n                  } else {\n                    d.is_hidden = !network.shown_types[\"\"];\n                  }\n                  d3.select(element).style (\"stroke-width\", \"5px\");\n                },\n\n                init_code: function(network) {\n                  function style_edge(type) {\n                    this.style(\"stroke-width\", \"5px\");\n                    if (type.length) {\n                      this.style(\n                        \"stroke\",\n                        network._edge_colorizer(type)\n                      );//.style (\"stroke-dasharray\", network._edge_dasher (type));\n                    } else {\n                      this.classed(\"link\", true);\n                      var def_color = this.style(\"stroke\");\n                      this.classed(\"link\", null);\n                      this.style(\"stroke\", def_color);\n                    }\n                  }\n                  network._edge_colorizer = _edge_colorizer;\n                  //network._edge_dasher   = _edge_dasher;\n                  network.shown_types = _.clone(shown_types);\n                  network.edge_legend = {\n                    caption: \"Network links\",\n                    types: {}\n                  };\n\n                  _.each(network.shown_types, function(ignore, t) {\n                    if (t.length) {\n                      network.edge_legend.types[t] = _.partial(\n                        style_edge,\n                        t\n                      );\n                    } else {\n                      network.edge_legend.types[\n                        \"Molecular links\"\n                      ] = _.partial(style_edge, t);\n                    }\n                  });\n                },\n\n                extra_menu: {\n                  title: \"Additional options\",\n                  items: _.map(labeled_links, function(edge_class) {\n                    return [\n                      function(network, element) {\n                        function toggle_element() {\n                          network.shown_types[edge_class] = !network\n                            .shown_types[edge_class];\n                          checkbox.attr(\n                            \"checked\",\n                            network.shown_types[edge_class]\n                              ? \"\"\n                              : null\n                          );\n                          network.update(true);\n                        }\n\n                        var link;\n\n                        if (edge_class.length) {\n                          link = element\n                            .append(\"a\")\n                            .text(edge_class + \" links\")\n                            .style(\n                              \"color\",\n                              network._edge_colorizer(edge_class)\n                            )\n                            .on(\"click\", toggle_element);\n                        } else {\n                          link = element\n                            .append(\"a\")\n                            .text(\"Molecular links\")\n                            .on(\"click\", toggle_element);\n                        }\n                        var checkbox = link\n                          .append(\"input\")\n                          .attr(\"type\", \"checkbox\")\n                          .attr(\"checked\", \"\");\n                      }\n                    ];\n                  })\n                }\n              };\n        };\n\n        var _social_view_handler = function(id, node_filter, labeled_links, shown_types, title, e) {\n\n            self.open_exclusive_tab_view(\n              id,\n              node_filter,\n              title,\n              _social_view_options (labeled_links, shown_types),\n            true);\n          };\n\n\n        var _injected_column_subcluster_button_handler = function (payload, edge_filter, title, e) {\n\n               function edge_filter_for_subclusters (edge) {\n                    return self.is_edge_injected(edge) || edge.length <= self.subcluster_threshold;\n               }\n\n                var subcluster_edges = [];\n\n                var direct_links_only = hivtrace_cluster_depthwise_traversal (\n                    self.json.Nodes,\n                    self.json.Edges,\n                    edge_filter || edge_filter_for_subclusters,\n                    //null,\n                    subcluster_edges,\n                    payload.children\n                );\n\n                var labeled_links = {}, shown_types = {};\n                _.each (subcluster_edges[0], function (e) {\n                    if (e.edge_type) {\n                        labeled_links[e.edge_type] = 1;\n                        shown_types[e.edge_type] = 1;\n                    }\n                });\n\n                labeled_links = _.keys (labeled_links);\n                labeled_links.sort ();\n                labeled_links.push (\"\");\n                shown_types[\"\"] = 1;\n\n                title = title || function (id) { return \"Subcluster \" + payload.cluster_id + \"[+ \" + annotation + \"]\"; };\n\n                var cv = self.view_subcluster (payload, direct_links_only[0],  title (payload.cluster_id),\n                        _social_view_options (labeled_links, shown_types), edge_filter_for_subclusters, true);\n                //cv.annotate_priority_clusters(_networkCDCDateField, 36, 12);\n                //cv.handle_attribute_categorical(\"recent_rapid\");\n                cv._refresh_subcluster_view (new Date ());\n\n        };\n\n\n        var injected_column_subcluster = [\n          {\n            description: {\n              value: annotation + \" network\",\n              help: \"View subclusters with \" + annotation + \" data\"\n            },\n\n            generator: function (cluster) {\n                return {\n                    value : cluster,\n                    callback: function(element, payload) {\n                        var this_cell = d3.select(element);\n                        this_cell\n                          .append(\"button\")\n                          .classed(\"btn btn-primary btn-xs pull-right\", true)\n                          .style(\"margin-left\", \"1em\")\n                          .text(\"Complete \" + annotation)\n                          .on(\"click\", _.partial ( _injected_column_subcluster_button_handler, payload, null, null));\n\n                        var node_ids = {};\n\n                        _.each (payload.children, function (n) {\n                            node_ids[n.id] = 1;\n                        });\n\n                        this_cell\n                          .append(\"button\")\n                          .classed(\"btn btn-primary btn-xs pull-right\", true)\n                          .text(\"Directly linked \" + annotation)\n                          .on(\"click\", _.partial ( _injected_column_subcluster_button_handler, payload,\n                                function (edge) {\n                                     return (self.json.Nodes[edge.target].id in node_ids) || (self.json.Nodes[edge.source].id in node_ids);\n                                }\n                          , function (id) { return \"Subcluster \" + payload.cluster_id + \"[+ direct  \" + annotation + \"]\"; }));\n                    }\n                }\n            }\n          }\n         ];\n\n\n        var injected_column = [\n          {\n            description: {\n              value: annotation + \" network\",\n              sort: function(c) {\n                return c.value[0];\n              },\n              help: \"Nodes added and clusters merged through \" + annotation\n            },\n            generator: function(cluster) {\n\n              return {\n                value: [\n                  cluster.injected[annotation],\n                  cluster.linked_clusters,\n                  cluster.cluster_id\n                ],\n\n                callback: function(element, payload) {\n                  var this_cell = d3.select(element);\n                  this_cell.text(+payload[0] + \" \" + annotation + \" nodes. \");\n                  var other_clusters = [];\n                  if (payload[1]) {\n                    other_clusters = _.without(_.keys(payload[1]), payload[2]);\n                    if (other_clusters.length) {\n                      other_clusters.sort();\n                      this_cell\n                        .append(\"span\")\n                        .classed(\"label label-info\", true)\n                        .text(\n                          \"Bridges to \" + other_clusters.length + \" clusters\"\n                        )\n                        .attr(\"title\", other_clusters.join(\", \"));\n                    }\n                  }\n\n                  var labeled_links = _.clone(\n                    edge_types_by_cluster_sorted[payload[2]]\n                  );\n\n\n\n                  if (\n                    payload[0] > 0 ||\n                    other_clusters.length ||\n                    (edge_types_by_cluster_sorted[payload[2]] &&\n                      labeled_links.length)\n                  ) {\n                    labeled_links.push(\"\");\n\n                    var shown_types = {};\n                    _.each(labeled_links, function(t) {\n                      shown_types[t] = 1;\n                    });\n\n\n                    this_cell\n                      .append(\"button\")\n                      .classed(\"btn btn-primary btn-xs pull-right\", true)\n                      .text(\"Directly linked \" + annotation)\n                      .style(\"margin-left\", \"1em\")\n                      .on(\"click\", function (e) {\n                            var directly_linked_ids = {};\n                            var node_ids = {};\n\n                            _.each (cluster.children, function (n) {\n                                node_ids[n.id] = 1;\n                            });\n\n                            var direct_links_only = hivtrace_cluster_depthwise_traversal (\n                                self.json.Nodes,\n                                self.json.Edges,\n                                function (edge) {\n                                     return (self.json.Nodes[edge.target].id in node_ids) || (self.json.Nodes[edge.source].id in node_ids);\n                                },\n                                false,\n                                cluster.children\n                            );\n\n                            _.each (direct_links_only[0], function (n) {\n                                directly_linked_ids[n.id] = true;\n                            });\n\n                            //console.log (directly_linked_ids);\n\n\n                            _social_view_handler (payload[2], function(n) {\n                                    return n.id in directly_linked_ids;\n                                }, labeled_links, shown_types, function(id) {\n                                    return \"Cluster \" + id + \"[+ direct \" + annotation + \"]\";\n                                  }, e);\n                       });\n\n                    this_cell\n                      .append(\"button\")\n                      .classed(\"btn btn-primary btn-xs pull-right\", true)\n                      .text(\"Complete \" + annotation)\n                      .on(\"click\", _.partial (_social_view_handler, payload[2], function(n) {\n                        return (\n                          n.extended_cluster &&\n                          payload[2] in n.extended_cluster\n                        );\n                      }, labeled_links, shown_types, function(id) {\n                             return \"Cluster \" + id + \"[+ \" + annotation + \"]\";\n                        }));\n\n                  }\n                }\n              };\n            }\n          }\n        ];\n\n        if (self.extra_cluster_table_columns) {\n            self.extra_cluster_table_columns = self.extra_cluster_table_columns.concat(\n              injected_column\n            );\n        } else {\n            self.extra_cluster_table_columns = injected_column;\n        }\n\n        self.draw_cluster_table(\n          self.extra_cluster_table_columns,\n          self.cluster_table\n        );\n\n        if (self.subcluster_table) {\n            if (self.extra_subcluster_table_columns) {\n                self.extra_subcluster_table_columns = self.extra_subcluster_table_columns.concat(\n                    injected_column_subcluster\n                );\n            } else {\n                self.extra_subcluster_table_columns = injected_column_subcluster;\n            }\n            self.draw_cluster_table(\n                  self.extra_subcluster_table_columns,\n                  self.subcluster_table,\n                  {\"subclusters\" : true, \"no-clusters\" : true}\n            );\n        }\n      }\n    } catch (e) {\n      throw e;\n    }\n\n    return {\n      nodes: new_nodes,\n      existing_nodes: existing_nodes,\n      edges: edge_types_dict\n    };\n  };\n\n\n  self.update_clusters_with_injected_nodes = function(\n    node_filter,\n    edge_filter,\n    annotation\n  ) {\n    var cluster_report = {};\n\n    try {\n      node_filter =\n        node_filter ||\n        function() {\n          return true;\n        };\n      edge_filter =\n        edge_filter ||\n        function() {\n          return true;\n        };\n\n      var split_clusters = {};\n      var node_id_to_local_cluster = {};\n\n      var recomputed_clusters = hivtrace_cluster_depthwise_traversal(\n        _.filter(self.json.Nodes, node_filter),\n        self.json.Edges,\n        null,\n        false\n      );\n\n      _.each(recomputed_clusters, function(c) {\n        var cluster_ids = {};\n        var injected_count = 0;\n\n        _.each(c, function(n) {\n          cluster_ids[n.cluster] = 1;\n          injected_count += n.cluster ? 0 : 1;\n        });\n\n        //var cluster_ids = _.keys (cluster_ids);\n\n        //console.log (cluster_ids.length);\n\n        // count how many \"injected\" nodes are there in the new cluster\n\n        if (injected_count) {\n          delete cluster_ids[undefined];\n        }\n\n        var cluster_count = _.keys(cluster_ids).length;\n\n        _.each(c, function(n) {\n          if (\"extended_cluster\" in n) {\n            _.extend(n[\"extended_cluster\"], cluster_ids);\n          } else {\n            n[\"extended_cluster\"] = cluster_ids;\n          }\n        });\n\n        _.each(cluster_ids, function(c, k) {\n          //console.log (k);\n          var existing_cluster = self.clusters[k - 1];\n          if (!existing_cluster.injected) {\n            existing_cluster.injected = {};\n          }\n          existing_cluster.injected[annotation] = injected_count;\n          if (\"linked_clusters\" in existing_cluster) {\n            _.extend(existing_cluster[\"linked_clusters\"], cluster_ids);\n          } else {\n            existing_cluster[\"linked_clusters\"] = cluster_ids;\n          }\n        });\n      });\n    } catch (err) {\n      console.log(err);\n      throw err;\n    }\n\n    return recomputed_clusters;\n  };\n  /*------------ Event Functions ---------------*/\n  function toggle_tooltip(element, turn_on, title, tag, container) {\n    //if (d3.event.defaultPrevented) return;\n\n    if (turn_on && !element.tooltip) {\n      // check to see if there are any other tooltips shown\n      $(\"[role='tooltip']\").each(function(d) {\n        $(this).remove();\n      });\n\n      var this_box = $(element);\n      var this_data = d3.select(element).datum();\n      element.tooltip = this_box.tooltip({\n        title: title + \"<br>\" + tag,\n        html: true,\n        container: container ? container : \"body\"\n      });\n\n      //this_data.fixed = true;\n\n      _.delay(_.bind(element.tooltip.tooltip, element.tooltip), 500, \"show\");\n    } else {\n      if (turn_on == false && element.tooltip) {\n        element.tooltip.tooltip(\"destroy\");\n        element.tooltip = undefined;\n      }\n    }\n  }\n\n  /*------------ Init code ---------------*/\n\n  var l_scale = 5000, // link scale\n    graph_data = self.json, // the raw JSON network object\n    max_points_to_render = 2048,\n    warning_string = \"\",\n    singletons = 0,\n    open_cluster_queue = [],\n    currently_displayed_objects,\n    gravity_scale = d3.scale\n      .pow()\n      .exponent(0.5)\n      .domain([1, 100000])\n      .range([0.1, 0.15]);\n\n  /*------------ D3 globals and SVG elements ---------------*/\n\n  var network_layout = d3.layout\n    .force()\n    .on(\"tick\", tick)\n    .charge(function(d) {\n      if (self.showing_on_map) {\n        return -60\n      }\n      if (d.cluster_id)\n        return (\n          self.charge_correction * (-20 - 5 * Math.pow(d.children.length, 0.7))\n        );\n      return self.charge_correction * (-5 - 20 * Math.sqrt(d.degree));\n    })\n    .linkDistance(function(d) {\n      return Math.max(d.length, 0.005) * l_scale;\n    })\n    .linkStrength(function(d) {\n      if (self.showing_on_map) {\n        return 0.01;\n      }\n      if (d.support !== undefined) {\n        return 2 * (0.5 - d.support);\n      }\n      return 1;\n    })\n    .chargeDistance(l_scale * 0.25)\n    .gravity(self.showing_on_map ? 0 : gravity_scale(json.Nodes.length))\n    .friction(0.25);\n\n  d3.select(self.container).selectAll(\".my_progress\").style(\"display\", \"none\");\n  d3.select(self.container).selectAll(\"svg\").remove();\n  self.node_table.selectAll(\"*\").remove();\n  self.cluster_table.selectAll(\"*\").remove();\n\n  self.network_svg = d3\n    .select(self.container)\n    .append(\"svg:svg\")\n    //.style (\"border\", \"solid black 1px\")\n    .attr(\"id\", self.dom_prefix + \"-network-svg\")\n    .attr(\"width\", self.width + self.margin.left + self.margin.right)\n    .attr(\"height\", self.height + self.margin.top + self.margin.bottom);\n\n  self.network_cluster_dynamics = null;\n\n  //.append(\"g\")\n  // .attr(\"transform\", \"translate(\" + self.margin.left + \",\" + self.margin.top + \")\");\n\n  var legend_vertical_offset;\n  self.showing_on_map ? legend_vertical_offset = 100 : legend_vertical_offset = 5;\n  self.legend_svg = self.network_svg\n    .append(\"g\")\n    .attr(\"transform\", \"translate(5,\" + legend_vertical_offset + \")\");\n\n/*\n    self.network_svg\n    .append(\"defs\")\n    .append(\"marker\")\n    .attr(\"id\", self.dom_prefix + \"_arrowhead\")\n    .attr(\"refX\", 9)\n    .attr(\"refY\", 2)\n    .attr(\"markerWidth\", 6)\n    .attr(\"markerHeight\", 4)\n    .attr(\"orient\", \"auto\")\n    .attr(\"stroke\", \"#666666\")\n    //.attr(\"markerUnits\", \"userSpaceOnUse\")\n    .attr(\"fill\", \"#AAAAAA\")\n    .append(\"path\")\n    .attr(\"d\", \"M 0,0 V 4 L6,2 Z\"); //this is actual shape for arrowhead\n\n*/\n    self.network_svg\n    .append(\"defs\")\n    .append(\"marker\")\n    .attr(\"id\", self.dom_prefix + \"_arrowhead\")\n    .attr(\"refX\", 18)\n    .attr(\"refY\", 6)\n    .attr(\"markerWidth\", 20)\n    .attr(\"markerHeight\", 16)\n    .attr(\"orient\", \"auto\")\n    .attr(\"stroke\", \"#666666\")\n    .attr(\"markerUnits\", \"userSpaceOnUse\")\n    .attr(\"fill\", \"#AAAAAA\")\n    .append(\"path\")\n    .attr(\"d\", \"M 0,0 L 2,6 L 0,12 L14,6 Z\"); //this is actual shape for arrowhead\n\n  change_window_size();\n\n  initial_json_load();\n\n\n  if (options) {\n    if (_.isNumber(options[\"charge\"])) {\n      self.charge_correction = options[\"charge\"];\n    }\n\n    if (\"colorizer\" in options) {\n      self.colorizer = options[\"colorizer\"];\n    }\n\n    if (\"node_shaper\" in options) {\n      self.node_shaper = options[\"node_shaper\"];\n    }\n\n    if (\"callbacks\" in options) {\n      options[\"callbacks\"](self);\n    }\n\n\n    if (_.isArray(options[\"expand\"])) {\n      self.expand_some_clusters(\n        _.filter(self.clusters, function(c) {\n          return options[\"expand\"].indexOf(c.cluster_id) >= 0;\n        })\n      );\n    }\n\n  }\n\n  self.draw_attribute_labels();\n  d3.select(self.container).selectAll(\".my_progress\").style(\"display\", \"none\");\n  network_layout.start();\n\n  return self;\n};\n\nvar hivtrace_cluster_graph_summary = function(graph, tag) {\n  var summary_table = d3.select(tag);\n\n  summary_table = d3.select(tag).select(\"tbody\");\n  if (summary_table.empty()) {\n    summary_table = d3.select(tag).append(\"tbody\");\n  }\n\n  var table_data = [];\n\n  if (!summary_table.empty()) {\n    _.each(graph[\"Network Summary\"], function(value, key) {\n      if (self._is_CDC_ && key == \"Edges\") {\n        key = \"Links\";\n      }\n      if (_.isNumber(value)) {\n        table_data.push([key, value]);\n      }\n    });\n  }\n\n  var degrees = [];\n  _.each(graph[\"Degrees\"][\"Distribution\"], function(value, index) {\n    for (var k = 0; k < value; k++) {\n      degrees.push(index + 1);\n    }\n  });\n  degrees = helpers.describe_vector(degrees);\n  table_data.push([\"Links/node\", \"\"]);\n  table_data.push([\n    \"&nbsp;&nbsp;<i>Mean</i>\",\n    _defaultFloatFormat(degrees[\"mean\"])\n  ]);\n  table_data.push([\n    \"&nbsp;&nbsp;<i>Median</i>\",\n    _defaultFloatFormat(degrees[\"median\"])\n  ]);\n  table_data.push([\n    \"&nbsp;&nbsp;<i>Range</i>\",\n    degrees[\"min\"] + \" - \" + degrees[\"max\"]\n  ]);\n  table_data.push([\n    \"&nbsp;&nbsp;<i>Interquartile range</i>\",\n    degrees[\"Q1\"] + \" - \" + degrees[\"Q3\"]\n  ]);\n\n  degrees = helpers.describe_vector(graph[\"Cluster sizes\"]);\n  table_data.push([\"Cluster sizes\", \"\"]);\n  table_data.push([\n    \"&nbsp;&nbsp;<i>Mean</i>\",\n    _defaultFloatFormat(degrees[\"mean\"])\n  ]);\n  table_data.push([\n    \"&nbsp;&nbsp;<i>Median</i>\",\n    _defaultFloatFormat(degrees[\"median\"])\n  ]);\n  table_data.push([\n    \"&nbsp;&nbsp;<i>Range</i>\",\n    degrees[\"min\"] + \" - \" + degrees[\"max\"]\n  ]);\n  table_data.push([\n    \"&nbsp;&nbsp;<i>Interquartile range</i>\",\n    degrees[\"Q1\"] + \" - \" + degrees[\"Q3\"]\n  ]);\n\n  if (self._is_CDC_) {\n    degrees = helpers.describe_vector(\n      _.map(graph[\"Edges\"], function(e) {\n        return e.length;\n      })\n    );\n    table_data.push([\"Genetic distances (links only)\", \"\"]);\n    table_data.push([\n      \"&nbsp;&nbsp;<i>Mean</i>\",\n      _defaultPercentFormat(degrees[\"mean\"])\n    ]);\n    table_data.push([\n      \"&nbsp;&nbsp;<i>Median</i>\",\n      _defaultPercentFormat(degrees[\"median\"])\n    ]);\n    table_data.push([\n      \"&nbsp;&nbsp;<i>Range</i>\",\n      _defaultPercentFormat(degrees[\"min\"]) +\n        \" - \" +\n        _defaultPercentFormat(degrees[\"max\"])\n    ]);\n    table_data.push([\n      \"&nbsp;&nbsp;<i>Interquartile range</i>\",\n      _defaultPercentFormat(degrees[\"Q1\"]) +\n        \" - \" +\n        _defaultPercentFormat(degrees[\"Q3\"])\n    ]);\n  }\n\n  var rows = summary_table.selectAll(\"tr\").data(table_data);\n  rows.enter().append(\"tr\");\n  rows.exit().remove();\n  var columns = rows.selectAll(\"td\").data(function(d) {\n    return d;\n  });\n  columns.enter().append(\"td\");\n  columns.exit();\n  columns.html(function(d) {\n    return d;\n  });\n};\n\nmodule.exports.computeCluster = hivtrace_cluster_depthwise_traversal;\nmodule.exports.clusterNetwork = hivtrace_cluster_network_graph;\nmodule.exports.graphSummary = hivtrace_cluster_graph_summary;\n\n\n\n// WEBPACK FOOTER //\n// ./src/clusternetwork.js","var d3 = require(\"d3\"),\n  _ = require(\"underscore\"),\n  helpers = require(\"./helpers.js\");\n\nfunction hivtrace_cluster_adjacency_list(obj) {\n  var nodes = obj.Nodes,\n    edges = obj.Edges;\n\n  var adjacency_list = {};\n\n  edges.forEach(function(e, i) {\n    function in_nodes(n, id) {\n      return n.id == id;\n    }\n\n    var seq_ids = e[\"sequences\"];\n\n    var n1 = nodes.filter(function(n) {\n        return in_nodes(n, seq_ids[0]);\n      })[0],\n      n2 = nodes.filter(function(n) {\n        return in_nodes(n, seq_ids[1]);\n      })[0];\n\n    adjacency_list[n1.id]\n      ? adjacency_list[n1.id].push(n2)\n      : (adjacency_list[n1.id] = [n2]);\n    adjacency_list[n2.id]\n      ? adjacency_list[n2.id].push(n1)\n      : (adjacency_list[n2.id] = [n1]);\n  });\n\n  return adjacency_list;\n}\n\nvar hivtrace_generate_svg_polygon_lookup = {};\n\n_.each(_.range(3, 20), function(d) {\n  var angle_step = Math.PI * 2 / d;\n  hivtrace_generate_svg_polygon_lookup[d] = _.map(_.range(1, d), function(i) {\n    return [Math.cos(angle_step * i), Math.sin(angle_step * i)];\n  });\n});\n\nfunction hivtrace_generate_svg_symbol(type) {\n  switch (type) {\n    case \"circle\":\n    case \"cross\":\n    case \"diamond\":\n    case \"square\":\n    case \"triangle-down\":\n    case \"triangle-up\":\n      return d3.svg.symbol().type(type);\n    case \"triangle\":\n      return new hivtrace_generate_svg_polygon().sides(3);\n    case \"pentagon\":\n      return new hivtrace_generate_svg_polygon().sides(5);\n    case \"hexagon\":\n      return new hivtrace_generate_svg_polygon().sides(6);\n    case \"septagon\":\n      return new hivtrace_generate_svg_polygon().sides(7);\n    case \"octagon\":\n      return new hivtrace_generate_svg_polygon().sides(8);\n    case \"ellipse\":\n      return new hivtrace_generate_svg_ellipse();\n  }\n  //console.log (type);\n  return d3.svg.symbol().type(\"circle\");\n}\n\nvar hivtrace_generate_svg_ellipse = function() {\n  var self = this;\n\n  self.ellipse = function() {\n    var path =\n      \"M \" +\n      self.radius +\n      \" 0 A \" +\n      self.radius * 1 +\n      \" \" +\n      self.radius * 0.75 +\n      \" 0 1 0 \" +\n      self.radius +\n      \" 0.00001\";\n    return path;\n  };\n\n  self.ellipse.type = function() {\n    return self.ellipse;\n  };\n\n  self.ellipse.size = function(attr) {\n    if (_.isNumber(attr)) {\n      self.size = attr;\n      self.radius = Math.sqrt(1.25 * attr / Math.PI);\n      return self.ellipse;\n    }\n\n    return self.size;\n  };\n\n  self.ellipse.size(64);\n\n  return self.ellipse;\n};\n\nvar hivtrace_generate_svg_polygon = function() {\n  var self = this;\n\n  self.polygon = function() {\n    var path = \" M\" + self.radius + \" 0\";\n\n    if (self.sides in hivtrace_generate_svg_polygon_lookup) {\n      path += hivtrace_generate_svg_polygon_lookup[self.sides]\n        .map(function(value) {\n          return \" L\" + self.radius * value[0] + \" \" + self.radius * value[1];\n        })\n        .join(\" \");\n    } else {\n      var angle_step = Math.PI * 2 / self.sides,\n        current_angle = 0;\n      for (i = 0; i < self.sides - 1; i++) {\n        current_angle += angle_step;\n        path +=\n          \" L\" +\n          self.radius * Math.cos(current_angle) +\n          \" \" +\n          self.radius * Math.sin(current_angle);\n      }\n    }\n\n    path += \" Z\";\n    return path;\n  };\n\n  self.polygon.sides = function(attr) {\n    if (_.isNumber(attr) && attr > 2) {\n      self.sides = attr;\n      return self.polygon;\n    }\n\n    return self.sides;\n  };\n\n  self.polygon.type = function() {\n    return self.polygon;\n  };\n\n  self.polygon.size = function(attr) {\n    if (_.isNumber(attr)) {\n      self.size = attr;\n      self.radius = Math.sqrt(attr / Math.PI);\n      return self.polygon;\n    }\n\n    return self.size;\n  };\n\n  self.polygon.size(64);\n  self.sides = 6;\n\n  return self.polygon;\n};\n\nfunction hivtrace_new_cluster_adjacency_list(obj) {\n  var nodes = obj.Nodes,\n    edges = obj.Edges;\n\n  nodes.forEach(function(n) {\n    n.neighbors = d3.set();\n  });\n\n  edges.forEach(function(e) {\n    nodes[e.source].neighbors.add(e.target);\n    nodes[e.target].neighbors.add(e.source);\n  });\n}\n\n// Reconstructs path from floyd-warshall algorithm\nfunction hivtrace_get_path(next, i, j) {\n  var all_paths = [];\n  i = parseInt(i);\n  j = parseInt(j);\n\n  for (var c = 0; c < next[i][j].length; c++) {\n    var k = next[i][j][c];\n    var intermediate = k;\n\n    if (intermediate === null || intermediate == i) {\n      return [[parseInt(i), parseInt(j)]];\n    } else {\n      var paths_i_k = hivtrace_get_path(next, i, intermediate);\n      var paths_k_j = hivtrace_get_path(next, intermediate, j);\n\n      for (var i_k_index = 0; i_k_index < paths_i_k.length; i_k_index++) {\n        var i_k = paths_i_k[i_k_index];\n        for (var k_j_index = 0; k_j_index < paths_k_j.length; k_j_index++) {\n          var k_j = paths_k_j[k_j_index];\n          if (i_k.length) {\n            if (\n              i_k[0] == i &&\n              i_k[i_k.length - 1] == k &&\n              k_j[0] == k &&\n              k_j[k_j.length - 1] == j\n            ) {\n              i_k.pop();\n              all_paths.push(i_k.concat(k_j));\n            }\n          }\n        }\n      }\n    }\n  }\n\n  return all_paths;\n}\n\nfunction hivtrace_paths_with_node(node, next, i, j) {\n  var paths = hivtrace_get_path(next, i, j);\n\n  // Retrieve intermediary paths\n  paths = paths.map(function(sublist) {\n    return sublist.slice(1, -1);\n  });\n\n  if (!paths) {\n    return 0;\n  }\n\n  var num_nodes = [];\n\n  for (var k = 0; i < paths.length; k++) {\n    sublist = paths[k];\n    num_nodes.push(\n      d3.sum(\n        sublist.map(function(n) {\n          return n == node;\n        })\n      )\n    );\n  }\n\n  var mean = d3.mean(num_nodes);\n\n  if (mean === undefined) {\n    mean = 0;\n  }\n\n  return mean;\n}\n\n// Same as compute shortest paths, but with an additional next parameter for reconstruction\nfunction hivtrace_compute_shortest_paths_with_reconstruction(\n  obj,\n  subset,\n  use_actual_distances\n) {\n  // Floyd-Warshall implementation\n  var distances = [];\n  var next = [];\n  var nodes = obj.Nodes;\n  var edges = obj.Edges;\n  var node_ids = [];\n\n  var adjacency_list = hivtrace_cluster_adjacency_list(obj);\n\n  if (!subset) {\n    subset = Object.keys(adjacency_list);\n  }\n\n  var node_count = subset.length;\n\n  for (var i = 0; i < subset.length; i++) {\n    var a_node = subset[i];\n    var empty_arr = _.range(node_count).map(function(d) {\n      return null;\n    });\n    var zeroes = _.range(node_count).map(function(d) {\n      return null;\n    });\n    distances.push(zeroes);\n    next.push(empty_arr);\n  }\n\n  for (var index = 0; index < subset.length; index++) {\n    var a_node = subset[index];\n    for (var index2 = 0; index2 < subset.length; index2++) {\n      var second_node = subset[index2];\n      if (second_node != a_node) {\n        if (\n          adjacency_list[a_node]\n            .map(function(n) {\n              return n.id;\n            })\n            .indexOf(second_node) != -1\n        ) {\n          distances[index][index2] = 1;\n          distances[index2][index] = 1;\n        }\n      }\n    }\n  }\n\n  for (var index_i = 0; index_i < subset.length; index_i++) {\n    var n_i = subset[index_i];\n    for (var index_j = 0; index_j < subset.length; index_j++) {\n      var n_j = subset[index_j];\n      if (index_i == index_j) {\n        next[index_i][index_j] = [];\n      } else {\n        next[index_i][index_j] = [index_i];\n      }\n    }\n  }\n\n  // clone distances\n  var distances2 = _.map(distances, _.clone);\n  var c = 0;\n\n  for (var index_k = 0; index_k < subset.length; index_k++) {\n    var n_k = subset[index_k];\n    for (var index_i = 0; index_i < subset.length; index_i++) {\n      var n_i = subset[index_i];\n      for (var index_j = 0; index_j < subset.length; index_j++) {\n        var n_j = subset[index_j];\n\n        if (n_i != n_j) {\n          d_ik = distances[index_k][index_i];\n          d_jk = distances[index_k][index_j];\n          d_ij = distances[index_i][index_j];\n\n          if (d_ik !== null && d_jk !== null) {\n            d_ik += d_jk;\n            if (d_ij === null || d_ij > d_ik) {\n              distances2[index_i][index_j] = d_ik;\n              distances2[index_j][index_i] = d_ik;\n              next[index_i][index_j] = [];\n              next[index_i][index_j] = next[index_i][index_j].concat(\n                next[index_k][index_j]\n              );\n              continue;\n            } else if (d_ij == d_ik) {\n              next[index_i][index_j] = next[index_i][index_j].concat(\n                next[index_k][index_j]\n              );\n            }\n          }\n          c++;\n          distances2[index_j][index_i] = distances[index_j][index_i];\n          distances2[index_i][index_j] = distances[index_i][index_j];\n        }\n      }\n    }\n\n    var t = distances2;\n    distances2 = distances;\n    distances = t;\n  }\n\n  return {\n    ordering: subset,\n    distances: distances,\n    next: next\n  };\n}\n\nfunction hivtrace_filter_to_node_in_cluster(node, obj) {\n  var nodes = obj.Nodes,\n    edges = obj.Edges,\n    cluster_id = null;\n\n  // Retrieve nodes that are part of the cluster\n  var node_obj = nodes.filter(function(n) {\n    return node == n.id;\n  });\n\n  if (node_obj) {\n    cluster_id = node_obj[0].cluster;\n  } else {\n    console.log(\"could not find node\");\n    return null;\n  }\n\n  // Filter out all edges and nodes that belong to the cluster\n  var nodes_in_cluster = nodes.filter(function(n) {\n    return cluster_id == n.cluster;\n  });\n  var node_ids = nodes_in_cluster.map(function(n) {\n    return n.id;\n  });\n  var edges_in_cluster = edges.filter(function(e) {\n    return node_ids.indexOf(e.sequences[0]) != -1;\n  });\n\n  var filtered_obj = {};\n  filtered_obj[\"Nodes\"] = nodes_in_cluster;\n  filtered_obj[\"Edges\"] = edges_in_cluster;\n  return filtered_obj;\n}\n\nfunction hivtrace_compute_betweenness_centrality_all_nodes_in_cluster(\n  cluster,\n  obj,\n  cb\n) {\n  var nodes = obj.Nodes,\n    edges = obj.Edges;\n\n  var nodes_in_cluster = nodes.filter(function(n) {\n    return cluster == n.cluster;\n  });\n  var node_ids = nodes_in_cluster.map(function(n) {\n    return n.id;\n  });\n  var edges_in_cluster = edges.filter(function(e) {\n    return node_ids.indexOf(e.sequences[0]) != -1;\n  });\n\n  var filtered_obj = {};\n  filtered_obj[\"Nodes\"] = nodes_in_cluster;\n  filtered_obj[\"Edges\"] = edges_in_cluster;\n\n  // get length of cluster\n  if (nodes_in_cluster.length > 70) {\n    cb(\"cluster too large\", null);\n    return;\n  }\n\n  // get paths\n  var paths = hivtrace_compute_shortest_paths_with_reconstruction(filtered_obj);\n  var node_ids = nodes_in_cluster.map(function(n) {\n    return n.id;\n  });\n\n  var betweenness = {};\n  nodes_in_cluster.forEach(function(n) {\n    betweenness[n.id] = hivtrace_compute_betweenness_centrality(\n      n.id,\n      filtered_obj,\n      paths\n    );\n  });\n\n  cb(null, betweenness);\n  return;\n}\n\n// Returns dictionary of nodes' betweenness centrality\n// Utilizes the Floyd-Warshall Algorithm with reconstruction\nfunction hivtrace_compute_betweenness_centrality(node, obj, paths) {\n  if (!paths) {\n    var filtered_obj = hivtrace_filter_to_node_in_cluster(node, obj);\n    paths = hivtrace_compute_shortest_paths_with_reconstruction(filtered_obj);\n  }\n\n  // find index of id\n  var index = paths.ordering.indexOf(node);\n\n  if (index == -1) {\n    return null;\n  }\n\n  var length = paths.distances.length;\n\n  if (length != 2) {\n    scale = 1 / ((length - 1) * (length - 2));\n  } else {\n    scale = 1;\n  }\n\n  // If s->t goes through 1, add to sum\n  // Reconstruct each shortest path and check if node is in it\n  var paths_with_node = [];\n  for (var i in _.range(length)) {\n    for (var j in _.range(length)) {\n      paths_with_node.push(hivtrace_paths_with_node(index, paths.next, i, j));\n    }\n  }\n\n  return d3.sum(paths_with_node) * scale;\n}\n\nfunction hivtrace_compute_node_degrees(obj) {\n  var nodes = obj.Nodes,\n    edges = obj.Edges;\n\n  for (var n in nodes) {\n    nodes[n].degree = 0;\n  }\n\n  for (var e in edges) {\n    nodes[edges[e].source].degree++;\n    nodes[edges[e].target].degree++;\n  }\n}\n\nfunction hivtrace_get_node_by_id(id, obj) {\n  return (\n    obj.Nodes.filter(function(n) {\n      return id == n.id;\n    })[0] || undefined\n  );\n}\n\nfunction hivtrace_compute_cluster_betweenness(obj, callback) {\n  var nodes = obj.Nodes;\n\n  function onlyUnique(value, index, self) {\n    return self.indexOf(value) === index;\n  }\n\n  // Get all unique clusters\n  var clusters = nodes.map(function(n) {\n    return n.cluster;\n  });\n  var unique_clusters = clusters.filter(onlyUnique);\n\n  var cb_count = 0;\n\n  function cb(err, results) {\n    cb_count++;\n\n    for (var node in results) {\n      hivtrace_get_node_by_id(node, obj)[\"betweenness\"] = results[node];\n    }\n\n    if (cb_count >= unique_clusters.length) {\n      callback(\"done\");\n    }\n  }\n\n  // Compute betweenness in parallel\n  unique_clusters.forEach(function(cluster_id) {\n    hivtrace_betweenness_centrality_all_nodes_in_cluster(cluster_id, obj, cb);\n  });\n\n  // once all settled callback\n}\n\nfunction hivtrace_is_contaminant(node) {\n  return node.attributes.indexOf(\"problematic\") != -1;\n}\n\nfunction hivtrace_convert_to_csv(obj, callback) {\n  //Translate nodes to rows, and then use d3.format\n  hivtrace_compute_node_degrees(obj);\n\n  hivtrace_compute_cluster_betweenness(obj, function(err) {\n    var node_array = obj.Nodes.map(function(d) {\n      return [\n        d.id,\n        d.cluster,\n        d.degree,\n        d.betweenness,\n        hivtrace_is_contaminant(d),\n        d.attributes.join(\";\")\n      ];\n    });\n    node_array.unshift([\n      \"seqid\",\n      \"cluster\",\n      \"degree\",\n      \"betweenness\",\n      \"is_contaminant\",\n      \"attributes\"\n    ]);\n    node_csv = d3.csv.format(node_array);\n    callback(null, node_csv);\n  });\n}\n\nfunction hivtrace_export_csv_button(graph, tag) {\n  var data = hivtrace_convert_to_csv(graph, function(err, data) {\n    if (data !== null) {\n      var pom = document.createElement(\"a\");\n      pom.setAttribute(\n        \"href\",\n        \"data:text/csv;charset=utf-8,\" + encodeURIComponent(data)\n      );\n      pom.setAttribute(\"download\", \"export.csv\");\n      pom.className = \"btn btn-default btn-sm\";\n      pom.innerHTML =\n        '<span class=\"glyphicon glyphicon-floppy-save\"></span> Export Results';\n      $(tag).append(pom);\n    }\n  });\n}\n\nfunction hiv_trace_export_table_to_text(parent_id, table_id, sep) {\n  var the_button = d3.select(parent_id);\n  the_button.selectAll(\"[data-type='download-button']\").remove();\n\n  the_button = the_button\n    .append(\"a\")\n    .attr(\"target\", \"_blank\")\n    .attr(\"data-type\", \"download-button\")\n    .on(\"click\", function(data, element) {\n      d3.event.preventDefault();\n      var table_tag = d3.select(this).attr(\"data-table\");\n      var table_text = helpers.table_to_text(table_tag);\n      helpers.export_handler(\n        table_text,\n        table_tag.substring(1) + \".tsv\",\n        \"text/tab-separated-values\"\n      );\n    })\n    .attr(\"data-table\", table_id);\n\n  the_button.append(\"i\").classed(\"fa fa-download fa-2x\", true);\n  return the_button;\n}\n\nvar hivtrace_compute_local_clustering_coefficients = _.once(function(obj) {\n  hivtrace_new_cluster_adjacency_list(obj);\n\n  var nodes = obj.Nodes;\n\n  nodes.forEach(function(n) {\n    var a_node = n;\n    var neighborhood_size = a_node.neighbors.size();\n\n    if (neighborhood_size < 2) {\n      a_node.lcc = undefined;\n    } else {\n      if (neighborhood_size > 500) {\n        a_node.lcc = hivtrace_too_large;\n      } else {\n        // count triangles\n        neighborhood = a_node.neighbors.values();\n        counter = 0;\n        for (n1 = 0; n1 < neighborhood_size; n1 += 1) {\n          for (n2 = n1 + 1; n2 < neighborhood_size; n2 += 1) {\n            if (nodes[neighborhood[n1]].neighbors.has(neighborhood[n2])) {\n              counter++;\n            }\n          }\n        }\n        a_node.lcc = 2 * counter / neighborhood_size / (neighborhood_size - 1);\n      }\n    }\n  });\n});\n\nfunction hivtrace_render_settings(settings, explanations) {\n  // TODO:\n  //d3.json (explanations, function (error, expl) {\n  //    //console.log (settings);\n  //});\n}\n\nfunction hivtrace_format_value(value, formatter) {\n  if (typeof value === \"undefined\") {\n    return \"Not computed\";\n  }\n  if (value === hivtrace_undefined) {\n    return \"Undefined\";\n  }\n  if (value === hivtrace_too_large) {\n    return \"Size limit\";\n  }\n\n  if (value === hivtrace_processing) {\n    return '<span class=\"fa fa-spin fa-spinner\"></span>';\n  }\n\n  return formatter ? formatter(value) : value;\n}\n\n\nfunction hivtrace_plot_case_time_series(\n  time_series,\n  container,\n  x_title,\n  y_title,\n  y_scale,\n  bin_by,\n  options\n) {\n  options = options || {\n    base_line: 20,\n    top: 40,\n    right: 30,\n    bottom: 3 * 20,\n    left: 5 * 20,\n    font_size: 18,\n    rect_size: 22,\n    width: 1024,\n    height: 600\n  };\n\n\n}\n\nfunction hivtrace_plot_cluster_dynamics(\n  time_series,\n  container,\n  x_title,\n  y_title,\n  y_scale,\n  bin_by,\n  options\n) {\n  options = options || {\n    base_line: 20,\n    top: 40,\n    right: 30,\n    bottom: 3 * 20,\n    left: 5 * 20,\n    font_size: 18,\n    rect_size: 22,\n    width: 1024,\n    height: 600\n  };\n\n  if (time_series.length == 0) {\n    return;\n  }\n\n  var do_barchart     = options && options[\"barchart\"];\n  var skip_cumulative = options && options[\"skip_cumulative\"] || do_barchart;\n\n\n\n  var width = options.width - options.left - options.right;\n  var height = options.height - options.top - options.bottom;\n  var min_diff;\n\n  if (!bin_by) {\n    bin_by = function(date) {\n      var year = date.getFullYear(),\n        nearest_quarter = new Date(),\n        mid_point = new Date();\n\n      nearest_quarter.setDate(1);\n      nearest_quarter.setFullYear(year);\n      mid_point.setFullYear(year);\n\n      var quarter = Math.floor(date.getMonth() / 3) + 1;\n      nearest_quarter.setMonth(quarter * 3);\n      nearest_quarter.setHours(0, 0, 0);\n      mid_point.setHours(0, 0, 0);\n\n      nearest_quarter.setFullYear(year + (quarter == 4 ? 1 : 0));\n      mid_point.setMonth(quarter * 3 + 1);\n      mid_point.setDate(15);\n\n      return [\"Q\" + quarter + \" \" + year, nearest_quarter, mid_point];\n    };\n\n    min_diff = new Date (2018,3,0) - new Date(2018,0,0);\n  }\n\n\n\n  var x_tick_format = function (d) {\n    var year = d.getFullYear();\n    var quarter = Math.floor(d.getMonth() / 3) + 1;\n\n    return \"\" + year + \"-Q\" + quarter;\n  };\n\n  if (options && options [\"x-tick-format\"]) {\n    x_tick_format = options [\"x-tick-format\"];\n  }\n\n  /** plot_data is an array with entries like\n        {\n            \"time\": DATE,\n            \"sex_trans\":\"IDU-Male\"\n        }\n\n        \"time\" is required, everything else are optional attributes\n\n        1. First, we bin everything into ranges (like years or quarters, this is returned by the mapper callback)\n        2. Second, we compute growth dynamics of total counts and individual attributes\n        3. Third, if additional attributes are present, one that's tagged for display is stratified by values and\n           converted into time series\n\n    */\n\n  var x = d3.time.scale().range([0, width]);\n\n  var y = y_scale ? y_scale : d3.scale.linear();\n\n\n  if (!y_scale) {\n    y.rangeRound ([height, 0]);\n  } else {\n    y.range([height, 0]);\n  }\n\n  var xAxis = d3.svg\n    .axis()\n    .scale(x)\n    .orient(\"bottom\")\n    .ticks(8)\n    .tickFormat(d3.time.format(\"%m/%Y\"));\n\n  if (x_tick_format) {\n    xAxis.tickFormat (x_tick_format);\n  }\n\n  var yAxis = d3.svg.axis().scale(y).orient(\"left\").tickFormat(function (v) {\n    if (v << 0 == v) { // an integer\n        return v;\n    }\n    return;\n  });\n\n  var binned = {};\n  var values_by_attribute = {};\n  var total_id = \"total\";\n  var total_color = \"#555555\";\n  var prefix = options && options[\"prefix\"] ? options[\"prefix\"] : \"\";\n  var max_bin = 0;\n\n  _.each(time_series, function(point, index) {\n    var bin_tag = bin_by(point[\"time\"]);\n    if (!(bin_tag[0] in binned)) {\n      binned[bin_tag[0]] = { time: bin_tag[1], x: bin_tag[2] };\n      binned[bin_tag[0]][total_id] = 0;\n      _.each(point, function(v, k) {\n        if (k != \"time\") {\n          binned[bin_tag[0]][k] = {};\n        }\n      });\n    }\n\n    binned[bin_tag[0]][total_id] += 1;\n    max_bin = Math.max(max_bin, binned[bin_tag[0]][total_id]);\n\n    var y = {};\n    y[total_id] = index + 1;\n    _.each(point, function(v, k) {\n      if (k != \"time\") {\n        binned[bin_tag[0]][k][v] = binned[bin_tag[0]][k][v]\n          ? binned[bin_tag[0]][k][v] + 1\n          : 1;\n        if (!(k in values_by_attribute)) {\n          values_by_attribute[k] = {};\n        }\n        if (v in values_by_attribute[k]) {\n          values_by_attribute[k][v]++;\n        } else {\n          values_by_attribute[k][v] = 1;\n        }\n        max_bin = Math.max(max_bin, binned[bin_tag[0]][k][v]);\n        y[k] = _.clone(values_by_attribute[k]);\n      }\n    });\n\n    point[\"y\"] = y;\n    point[\"_bin\"] = bin_tag[1];\n  });\n\n  var binned_array = [];\n  _.each(binned, function(v, k) {\n    v[\"id\"] = k;\n    binned_array.push(v);\n  });\n\n\n  binned_array.sort(function(a, b) {\n    return b[\"time\"] > a[\"time\"] ? 1 : b[\"time\"] == a[\"time\"] ? 0 : -1;\n  });\n\n\n  if (do_barchart) {\n    if (_.isUndefined (min_diff)) {\n      _.each(binned_array, function (d, i) {\n            if (i > 0) {\n                min_diff = Math.min (min_diff, -(d[\"time\"] - binned_array[i-1][\"time\"]));\n            }\n      });\n    }\n    min_diff = min_diff * 0.8; // convert to seconds and shrink a bit\n  }\n\n\n\n  var min_x = d3.min(time_series, function(d) {\n    return d[\"time\"] < d[\"_bin\"] ? d[\"time\"] : d[\"_bin\"];\n  });\n  var max_x = d3.max(time_series, function(d) {\n    return d[\"time\"] > d[\"_bin\"] ? d[\"time\"] : d[\"_bin\"];\n  });\n\n  if (do_barchart) {\n     var max_x2 = new Date ();\n     max_x2.setTime(max_x.getTime() + min_diff);\n     max_x = max_x2;\n  }\n\n  x.domain([min_x, max_x]).clamp(true);\n  y\n    .domain([\n      0.0,\n      Math.round(skip_cumulative ? max_bin + 1 : time_series.length * 1.2)\n    ])\n    .clamp(true);\n\n  /* step-plot generator*/\n\n  /*var svg = container.append(\"svg\")//.style(\"display\", \"table-cell\")\n        .attr(\"width\", width + options.left + options.right)\n        .attr(\"height\", height + options.top + options.bottom);*/\n\n  container.selectAll(\"*\").remove(); // clean up previous plots\n\n  var legend_area = container\n    .append(\"g\")\n    .attr(\n      \"transform\",\n      \"translate(\" +\n        (options.left + options.font_size * 2.5) +\n        \",\" +\n        (options.top + options.font_size) +\n        \")\"\n    );\n\n  var svg = container\n    .append(\"g\")\n    .attr(\"transform\", \"translate(\" + options.left + \",\" + options.top + \")\");\n\n  /* set the domain for the codons */\n\n  var y_key = _.keys(values_by_attribute)[0];\n\n  var color_scale =\n    \"colorizer\" in options &&\n    options[\"colorizer\"] &&\n    y_key in options[\"colorizer\"]\n      ? options[\"colorizer\"][y_key]\n      : d3.scale.category10();\n\n  color_scale = _.wrap(color_scale, function(func, arg) {\n    if (arg == total_id) return total_color;\n    return func(arg);\n  });\n\n  var plot_types = _.keys(values_by_attribute[y_key]);\n\n  if (do_barchart) {\n    if (plot_types.length == 0) {\n        plot_types.push(total_id);\n    }\n  } else {\n    plot_types.push(total_id);\n  }\n\n  plot_types.sort();\n\n  if (options && options[\"drag\"]) {\n    var drag = d3.behavior.drag();\n    drag.on(\"drag\", function() {\n      options[\"drag\"].x += d3.event.dx;\n      options[\"drag\"].y += d3.event.dy;\n      d3\n        .select(this)\n        .attr(\n          \"transform\",\n          \"translate(\" + options[\"drag\"].x + \",\" + options[\"drag\"].y + \")\"\n        );\n    });\n    container.call(drag);\n  }\n\n  function opacity_toggle(tag, on_off) {\n    if (do_barchart) {\n        d3\n          .selectAll('[data-plotid=\"' + tag + '\"]')\n          .style(\"stroke-width\", on_off ? 4 : 1);\n\n    } else {\n        d3\n          .selectAll('[data-plotid=\"' + tag + '\"]')\n          .style(\"fill-opacity\", on_off ? 0.5 : 0.1);\n    }\n    d3\n      .selectAll('[data-curveid=\"' + tag + '\"]')\n      .style(\"stroke-width\", on_off ? 3 : 1);\n  }\n\n  if (!do_barchart || plot_types.length > 1 || plot_types[0] != total_id) {\n\n      var legend_lines = legend_area.selectAll(\"g\").data(plot_types);\n\n      legend_lines.enter().append(\"g\").attr(\"class\", \"annotation-text\");\n\n\n      legend_lines\n        .selectAll(\"text\")\n        .data(function(d) {\n          return [d];\n        })\n        .enter()\n        .append(\"text\")\n        .attr(\"transform\", function(d, i, j) {\n          return (\n            \"translate(\" +\n            options.rect_size +\n            \",\" +\n            (options.rect_size * (plot_types.length - 1 - j) -\n              (options.rect_size - options.font_size)) +\n            \")\"\n          );\n        })\n        .attr(\"dx\", \"0.2em\")\n        .style(\"font-size\", options.font_size)\n        .text(function(d) {\n          return d;\n        })\n        .on(\"mouseover\", function(d) {\n          opacity_toggle(prefix + d, true);\n        })\n        .on(\"mouseout\", function(d) {\n          opacity_toggle(prefix + d, false);\n        });\n\n      legend_lines\n        .selectAll(\"rect\")\n        .data(function(d) {\n          return [d];\n        })\n        .enter()\n        .append(\"rect\")\n        .attr(\"x\", 0)\n        .attr(\"y\", function(d, i, j) {\n          return options.rect_size * (plot_types.length - 2 - j);\n        })\n        .attr(\"width\", options.rect_size)\n        .attr(\"height\", options.rect_size)\n        .attr(\"class\", \"area\")\n        .style(\"fill\", function(d, i, j) {\n          return color_scale(d);\n        })\n        .on(\"mouseover\", function(d) {\n          opacity_toggle(prefix + d, true);\n        })\n        .on(\"mouseout\", function(d) {\n          opacity_toggle(prefix + d, false);\n        });\n    }\n\n  var last = _.clone(time_series[time_series.length - 1]);\n  last[\"time\"] = x.domain()[1];\n  time_series.push(last);\n\n\n\n  _.each(plot_types, function(plot_key, idx) {\n\n\n    var plot_color = color_scale(plot_key);\n    var y_accessor = function(d) {\n      //console.log ((plot_key in d['y']) ? d['y'][plot_key] : 0);\n      if (plot_key in d[\"y\"]) {\n        return d[\"y\"][plot_key];\n      }\n      if (y_key in d[\"y\"]) {\n        if (plot_key in d[\"y\"][y_key]) {\n          return d[\"y\"][y_key][plot_key];\n        }\n      }\n      return 0.0;\n    };\n\n    var bin_accessor = function(d) {\n      if (y_key && plot_key in d[y_key]) {\n        return d[y_key][plot_key];\n      } else {\n        if (plot_key in d) {\n          return d[plot_key];\n        }\n      }\n      return 0.0;\n    };\n\n    if (!skip_cumulative) {\n      var curve = d3.svg\n        .area()\n        .x(function(d) {\n          return x(d[\"time\"]);\n        })\n        .y1(function(d) {\n          return y(y_accessor(d));\n        })\n        .y0(function(d) {\n          return y(0);\n        })\n        .interpolate(\"step\");\n\n      svg\n        .append(\"path\")\n        .datum(time_series)\n        .classed(\"trend\", true)\n        .style(\"fill\", plot_color)\n        .style(\"stroke\", plot_color)\n        .attr(\"d\", curve)\n        .attr(\"data-plotid\", prefix + plot_key);\n    }\n\n\n\n    if (do_barchart) {\n        binned_array.forEach(function(d) {\n            var dd = new Date();\n            dd.setTime(d[\"time\"].getTime() - min_diff * 0.5);\n            var dd2 = new Date();\n            dd2.setTime(d[\"time\"].getTime() + min_diff * 0.5);\n            var xc = x(dd);\n            var w = x(dd2) - x(dd);\n            var last_y = (\"last_y\" in d) ? d[\"last_y\"] : 0;\n            var new_y = bin_accessor(d);\n            svg.append (\"rect\")\n               .attr (\"x\", xc)\n               .attr (\"y\", y(last_y+new_y))\n               .attr (\"height\",  y(0) - y(new_y))\n               .attr (\"width\", w).attr(\"data-plotid\", prefix + plot_key)\n               .classed(\"tracer\", true)\n               .style(\"fill\", plot_color)\n               .style(\"stroke\", d3.rgb (plot_color).darker (2))\n               .style(\"fill-opacity\", 1)\n               .append (\"title\").text (plot_key + \" \" + new_y + \" cases in \" +\n                    (x_tick_format ? x_tick_format(d[\"time\"]) : d[\"time\"]));\n\n            d[\"last_y\"] = (d[\"last_y\"] ? d[\"last_y\"] : 0) + new_y;\n\n        });\n    } else {\n\n        binned_array.forEach(function(d) {\n          svg\n            .append(\"circle\")\n            .attr(\"cx\", x(d[\"time\"]))\n            .attr(\"cy\", y(bin_accessor(d)))\n            .attr(\"r\", \"5\")\n            .classed(\"node\", true)\n            .style(\"fill\", plot_color)\n            .style(\"stroke\", plot_color)\n            .attr(\"title\", plot_key + \" : \" + bin_accessor(d));\n        });\n\n        var curve_year = d3.svg\n          .line()\n          .x(function(d) {\n            return x(d[\"time\"]);\n          })\n          .y(function(d) {\n            return y(bin_accessor(d));\n          })\n          .interpolate(\"cardinal\");\n\n        svg\n          .append(\"path\")\n          .datum(binned_array)\n          .classed(\"tracer\", true)\n          .style(\"stroke\", plot_color)\n          .attr(\"d\", curve_year)\n          .attr(\"data-curveid\", prefix + plot_key);\n    }\n  });\n\n  /* x-axis */\n  var x_axis = svg\n    .append(\"g\")\n    .attr(\"class\", \"x axis\")\n    .attr(\"transform\", \"translate(0,\" + height + \")\")\n    .style(\"font-size\", options.font_size)\n    .call(xAxis);\n\n  x_axis\n    .selectAll(\"text\")\n    .attr(\"transform\", \"rotate(-45)\")\n    .attr(\"dy\", \"0.9em\")\n    .attr(\"dx\", \"-1.75em\");\n\n  x_axis\n    .append(\"text\")\n    .attr(\"x\", width / 2)\n    .attr(\"dy\", \"3.5em\")\n    .style(\"text-anchor\", \"middle\")\n    .style(\"font-size\", options.font_size * 1.5)\n    .text(x_title);\n\n  /* y-axis*/\n  svg\n    .append(\"g\")\n    .attr(\"class\", \"y axis\")\n    .style(\"font-size\", options.font_size)\n    .call(yAxis)\n    .append(\"text\")\n    .style(\"font-size\", options.font_size * 1.5)\n    .attr(\"transform\", \"rotate(-90)\")\n    .attr(\"y\", 6)\n    .attr(\"dy\", \"-2em\")\n    //.attr(\"dx\", \"-1em\")\n    .style(\"text-anchor\", \"end\")\n    .text(y_title); // beta - alpha\n}\n\nmodule.exports.compute_node_degrees = hivtrace_compute_node_degrees;\nmodule.exports.export_csv_button = hivtrace_export_csv_button;\nmodule.exports.convert_to_csv = hivtrace_convert_to_csv;\nmodule.exports.betweenness_centrality = hivtrace_compute_betweenness_centrality;\nmodule.exports.betweenness_centrality_all_nodes_in_cluster = hivtrace_compute_betweenness_centrality_all_nodes_in_cluster;\nmodule.exports.cluster_adjacency_list = hivtrace_cluster_adjacency_list;\nmodule.exports.new_cluster_adjacency_list = hivtrace_new_cluster_adjacency_list;\nmodule.exports.analysis_settings = hivtrace_render_settings;\nmodule.exports.export_table_to_text = hiv_trace_export_table_to_text;\nmodule.exports.compute_local_clustering = hivtrace_compute_local_clustering_coefficients;\nmodule.exports.undefined = {};\nmodule.exports.too_large = {};\nmodule.exports.processing = {};\nmodule.exports.format_value = hivtrace_format_value;\nmodule.exports.polygon = hivtrace_generate_svg_polygon;\nmodule.exports.symbol = hivtrace_generate_svg_symbol;\nmodule.exports.cluster_dynamics = hivtrace_plot_cluster_dynamics;\n\n\n\n// WEBPACK FOOTER //\n// ./src/misc.js","var download = require(\"downloadjs\");\n\nvar datamonkey_error_modal = function(msg) {\n  $(\"#modal-error-msg\").text(msg);\n  $(\"#errorModal\").modal();\n};\n\nfunction b64toBlob(b64, onsuccess, onerror) {\n  var img = new Image();\n\n  img.onerror = onerror;\n\n  img.onload = function onload() {\n    var canvas = document.getElementById(\"hyphy-chart-canvas\");\n    canvas.width = img.width;\n    canvas.height = img.height;\n\n    var ctx = canvas.getContext(\"2d\");\n    ctx.fillStyle = \"#FFFFFF\";\n    ctx.fillRect(0, 0, canvas.width, canvas.height);\n    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);\n\n    if (canvas.msToBlob) {\n      var blob = canvas.msToBlob(onsuccess);\n      onsuccess(blob);\n      window.navigator.msSaveBlob(blob, \"image.png\");\n    } else {\n      canvas.toBlob(onsuccess);\n    }\n  };\n\n  img.src = b64;\n}\n\nvar datamonkey_export_csv_button = function(data) {\n  data = d3.csv.format(data);\n  if (data !== null) {\n    var pom = document.createElement(\"a\");\n    pom.setAttribute(\n      \"href\",\n      \"data:text/csv;charset=utf-8,\" + encodeURIComponent(data)\n    );\n    pom.setAttribute(\"download\", \"export.csv\");\n    pom.className = \"btn btn-default btn-sm\";\n    pom.innerHTML =\n      '<span class=\"glyphicon glyphicon-floppy-save\"></span> Download CSV';\n    $(\"body\").append(pom);\n    pom.click();\n    pom.remove();\n  }\n};\n\nvar datamonkey_save_image = function(type, container) {\n  var prefix = {\n    xmlns: \"http://www.w3.org/2000/xmlns/\",\n    xlink: \"http://www.w3.org/1999/xlink\",\n    svg: \"http://www.w3.org/2000/svg\"\n  };\n\n  function get_styles(doc) {\n    function process_stylesheet(ss) {\n      try {\n        if (ss.cssRules) {\n          for (var i = 0; i < ss.cssRules.length; i++) {\n            var rule = ss.cssRules[i];\n            if (rule.type === 3) {\n              // Import Rule\n              process_stylesheet(rule.styleSheet);\n            } else {\n              // hack for illustrator crashing on descendent selectors\n              if (rule.selectorText) {\n                if (rule.selectorText.indexOf(\">\") === -1) {\n                  styles += \"\\n\" + rule.cssText;\n                }\n              }\n            }\n          }\n        }\n      } catch (e) {\n        console.log(\"Could not process stylesheet : \" + ss);\n      }\n    }\n\n    var styles = \"\",\n      styleSheets = doc.styleSheets;\n\n    if (styleSheets) {\n      for (var i = 0; i < styleSheets.length; i++) {\n        process_stylesheet(styleSheets[i]);\n      }\n    }\n\n    return styles;\n  }\n\n  var convert_svg_to_png = function(image_string) {\n    var image = document.getElementById(\"hyphy-chart-image\");\n\n    image.onload = function() {\n      var canvas = document.getElementById(\"hyphy-chart-canvas\");\n      canvas.width = image.width;\n      canvas.height = image.height;\n      var context = canvas.getContext(\"2d\");\n      context.fillStyle = \"#FFFFFF\";\n      context.fillRect(0, 0, image.width, image.height);\n      context.drawImage(image, 0, 0);\n      var img = canvas.toDataURL(\"image/png\");\n      var pom = document.createElement(\"a\");\n      pom.setAttribute(\"download\", \"image.png\");\n      pom.href = canvas.toDataURL(\"image/png\");\n      $(\"body\").append(pom);\n      pom.click();\n      pom.remove();\n    };\n\n    image.src = image_string;\n  };\n\n  var svg = $(container).find(\"svg\")[0];\n  if (!svg) {\n    svg = $(container)[0];\n  }\n\n  var styles = get_styles(window.document);\n\n  svg.setAttribute(\"version\", \"1.1\");\n\n  var defsEl = document.createElement(\"defs\");\n  svg.insertBefore(defsEl, svg.firstChild);\n\n  var styleEl = document.createElement(\"style\");\n  defsEl.appendChild(styleEl);\n  styleEl.setAttribute(\"type\", \"text/css\");\n\n  // removing attributes so they aren't doubled up\n  svg.removeAttribute(\"xmlns\");\n  svg.removeAttribute(\"xlink\");\n\n  // These are needed for the svg\n  if (!svg.hasAttributeNS(prefix.xmlns, \"xmlns\")) {\n    svg.setAttributeNS(prefix.xmlns, \"xmlns\", prefix.svg);\n  }\n\n  if (!svg.hasAttributeNS(prefix.xmlns, \"xmlns:xlink\")) {\n    svg.setAttributeNS(prefix.xmlns, \"xmlns:xlink\", prefix.xlink);\n  }\n\n  var source = new XMLSerializer()\n    .serializeToString(svg)\n    .replace(\"</style>\", \"<![CDATA[\" + styles + \"]]></style>\");\n  var rect = svg.getBoundingClientRect();\n  var doctype =\n    '<?xml version=\"1.0\" standalone=\"no\"?><!DOCTYPE svg PUBLIC \"-//W3C//DTD SVG 1.1//EN\" \"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\">';\n  var to_download = [doctype + source];\n  var image_string =\n    \"data:image/svg+xml;base66,\" + encodeURIComponent(to_download);\n\n  if (navigator.msSaveBlob) {\n    // IE10\n    download(image_string, \"image.svg\", \"image/svg+xml\");\n  } else if (type == \"png\") {\n    b64toBlob(\n      image_string,\n      function(blob) {\n        var url = window.URL.createObjectURL(blob);\n        var pom = document.createElement(\"a\");\n        pom.setAttribute(\"download\", \"image.png\");\n        pom.setAttribute(\"href\", url);\n        $(\"body\").append(pom);\n        pom.click();\n        pom.remove();\n      },\n      function(error) {\n        console.log(error);\n      }\n    );\n  } else {\n    var pom = document.createElement(\"a\");\n    pom.setAttribute(\"download\", \"image.svg\");\n    pom.setAttribute(\"href\", image_string);\n    $(\"body\").append(pom);\n    pom.click();\n    pom.remove();\n  }\n};\n\nvar datamonkey_validate_date = function() {\n  // Check that it is not empty\n  if ($(this).val().length === 0) {\n    $(this).next(\".help-block\").remove();\n    $(this).parent().removeClass(\"has-success\");\n    $(this).parent().addClass(\"has-error\");\n\n    jQuery(\"<span/>\", {\n      class: \"help-block\",\n      text: \"Field is empty\"\n    }).insertAfter($(this));\n  } else if (isNaN(Date.parse($(this).val()))) {\n    $(this).next(\".help-block\").remove();\n    $(this).parent().removeClass(\"has-success\");\n    $(this).parent().addClass(\"has-error\");\n\n    jQuery(\"<span/>\", {\n      class: \"help-block\",\n      text: \"Date format should be in the format YYYY-mm-dd\"\n    }).insertAfter($(this));\n  } else {\n    $(this).parent().removeClass(\"has-error\");\n    $(this).parent().addClass(\"has-success\");\n    $(this).next(\".help-block\").remove();\n  }\n};\n\nfunction datamonkey_get_styles(doc) {\n  var styles = \"\",\n    styleSheets = doc.styleSheets;\n\n  if (styleSheets) {\n    for (var i = 0; i < styleSheets.length; i++) {\n      processStyleSheet(styleSheets[i]);\n    }\n  }\n\n  function processStyleSheet(ss) {\n    if (ss.cssRules) {\n      for (var i = 0; i < ss.cssRules.length; i++) {\n        var rule = ss.cssRules[i];\n        if (rule.type === 3) {\n          // Import Rule\n          processStyleSheet(rule.styleSheet);\n        } else {\n          // hack for illustrator crashing on descendent selectors\n          if (rule.selectorText) {\n            if (rule.selectorText.indexOf(\">\") === -1) {\n              styles += \"\\n\" + rule.cssText;\n            }\n          }\n        }\n      }\n    }\n  }\n  return styles;\n}\n\nfunction datamonkey_save_newick_to_file() {\n  var top_modal_container = \"#neighbor-tree-modal\";\n  var nwk = $(top_modal_container).data(\"tree\");\n  var pom = document.createElement(\"a\");\n  pom.setAttribute(\n    \"href\",\n    \"data:text/octet-stream;charset=utf-8,\" + encodeURIComponent(nwk)\n  );\n  pom.setAttribute(\"download\", \"nwk.txt\");\n  $(\"body\").append(pom);\n  pom.click();\n  pom.remove();\n}\n\nfunction datamonkey_convert_svg_to_png(image_string) {\n  var image = document.getElementById(\"image\");\n  image.src = image_string;\n\n  image.onload = function() {\n    var canvas = document.getElementById(\"canvas\");\n    canvas.width = image.width;\n    canvas.height = image.height;\n    var context = canvas.getContext(\"2d\");\n    context.fillStyle = \"#FFFFFF\";\n    context.fillRect(0, 0, image.width, image.height);\n    context.drawImage(image, 0, 0);\n    var img = canvas.toDataURL(\"image/png\");\n\n    var pom = document.createElement(\"a\");\n    pom.setAttribute(\"download\", \"phylotree.png\");\n    pom.href = canvas.toDataURL(\"image/png\");\n    $(\"body\").append(pom);\n    pom.click();\n    pom.remove();\n  };\n}\n\nfunction datamonkey_save_newick_tree(type) {\n  var prefix = {\n    xmlns: \"http://www.w3.org/2000/xmlns/\",\n    xlink: \"http://www.w3.org/1999/xlink\",\n    svg: \"http://www.w3.org/2000/svg\"\n  };\n\n  var tree_container = \"#tree_container\";\n  var svg = $(\"#tree_container\").find(\"svg\")[0];\n  var styles = datamonkey_get_styles(window.document);\n\n  svg.setAttribute(\"version\", \"1.1\");\n\n  var defsEl = document.createElement(\"defs\");\n  svg.insertBefore(defsEl, svg.firstChild);\n\n  var styleEl = document.createElement(\"style\");\n  defsEl.appendChild(styleEl);\n  styleEl.setAttribute(\"type\", \"text/css\");\n\n  // removing attributes so they aren't doubled up\n  svg.removeAttribute(\"xmlns\");\n  svg.removeAttribute(\"xlink\");\n\n  // These are needed for the svg\n  if (!svg.hasAttributeNS(prefix.xmlns, \"xmlns\")) {\n    svg.setAttributeNS(prefix.xmlns, \"xmlns\", prefix.svg);\n  }\n\n  if (!svg.hasAttributeNS(prefix.xmlns, \"xmlns:xlink\")) {\n    svg.setAttributeNS(prefix.xmlns, \"xmlns:xlink\", prefix.xlink);\n  }\n\n  var source = new XMLSerializer()\n    .serializeToString(svg)\n    .replace(\"</style>\", \"<![CDATA[\" + styles + \"]]></style>\");\n  var rect = svg.getBoundingClientRect();\n  var doctype =\n    '<?xml version=\"1.0\" standalone=\"no\"?><!DOCTYPE svg PUBLIC \"-//W3C//DTD SVG 1.1//EN\" \"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\">';\n  var to_download = [doctype + source];\n  var image_string =\n    \"data:image/svg+xml;base66,\" + encodeURIComponent(to_download);\n\n  if (type == \"png\") {\n    datamonkey_convert_svg_to_png(image_string);\n  } else {\n    var pom = document.createElement(\"a\");\n    pom.setAttribute(\"download\", \"phylotree.svg\");\n    pom.setAttribute(\"href\", image_string);\n    $(\"body\").append(pom);\n    pom.click();\n    pom.remove();\n  }\n}\n\nfunction datamonkey_validate_email(email) {\n  if ($(this).find(\"input[name='receive_mail']\")[0].checked) {\n    var regex = /^([a-zA-Z0-9_.+-])+\\@(([a-zA-Z0-9-])+\\.)+([a-zA-Z0-9]{2,4})+$/;\n    if (regex.test($(this).find(\"input[name='mail']\").val())) {\n      // Give them green. They like that.\n      $(this).removeClass(\"has-error\");\n      $(this).addClass(\"has-success\");\n      $(this).next(\".help-block\").remove();\n    } else {\n      $(this).next(\".help-block\").remove();\n      $(this).removeClass(\"has-error\");\n      $(this).removeClass(\"has-success\");\n      $(this).addClass(\"has-error\");\n      var span = jQuery(\"<span/>\", {\n        class: \"help-block col-lg-9 pull-right\",\n        text: \"Invalid Email\"\n      }).insertAfter($(this));\n    }\n  } else {\n    $(this).removeClass(\"has-error\");\n    $(this).removeClass(\"has-success\");\n    $(this).next(\".help-block\").remove();\n  }\n}\n\nfunction datamonkey_describe_vector(vector, as_list) {\n  var d = {};\n\n  if (vector.length) {\n    vector.sort(d3.ascending);\n\n    var d = {\n      min: d3.min(vector),\n      max: d3.max(vector),\n      median: d3.median(vector),\n      Q1: d3.quantile(vector, 0.25),\n      Q3: d3.quantile(vector, 0.75),\n      mean: d3.mean(vector)\n    };\n  } else {\n    var d = {\n      min: null,\n      max: null,\n      median: null,\n      Q1: null,\n      Q3: null,\n      mean: null\n    };\n  }\n\n  if (as_list) {\n    d =\n      \"<pre>Range  :\" +\n      d[\"min\"] +\n      \"-\" +\n      d[\"max\"] +\n      \"\\n\" +\n      \"IQR    :\" +\n      d[\"Q1\"] +\n      \"-\" +\n      d[\"Q3\"] +\n      \"\\n\" +\n      \"Mean   :\" +\n      d[\"mean\"] +\n      \"\\n\" +\n      \"Median :\" +\n      d[\"median\"] +\n      \"\\n\" +\n      \"</pre>\";\n\n    /*d =\n    \"<dl class = 'dl-horizontal'>\" +\n    \"<dt>Range</dt><dd>\" + d['min'] + \"-\" + d['max'] + \"</dd>\" +\n    \"<dt>IQR</dt><dd>\" + d['Q1'] + \"-\" + d['Q3'] +  \"</dd>\" +\n    \"<dt>Mean</dt><dd>\" + d['mean'] +  \"</dd>\" +\n    \"<dt>Median</dt><dd>\" + d['median'] + \"</dd></dl>\";*/\n  }\n\n  return d;\n}\n\nfunction datamonkey_export_handler(data, filename, mimeType) {\n  function msieversion() {\n    var ua = window.navigator.userAgent;\n    var msie = ua.indexOf(\"MSIE \");\n    if (msie > 0 || !!navigator.userAgent.match(/Trident.*rv\\:11\\./)) {\n      return true;\n    }\n    return false;\n  }\n\n  if (msieversion()) {\n    var IEwindow = window.open();\n    IEwindow.document.write(data);\n    IEwindow.document.close();\n    IEwindow.document.execCommand(\"SaveAs\", true, filename + \".csv\");\n    IEwindow.close();\n  } else {\n    var pom = document.createElement(\"a\");\n    pom.setAttribute(\n      \"href\",\n      \"data:\" +\n        (mimeType || \"text/plain\") +\n        \";charset=utf-8,\" +\n        encodeURIComponent(data)\n    );\n    pom.setAttribute(\"download\", filename || \"download.tsv\");\n    pom.click();\n    pom.remove();\n  }\n}\n\nfunction datamonkey_table_to_text(table_id, sep) {\n  sep = sep || \"\\t\";\n  var header_row = [];\n  var extract_text = function (e) {\n    var first_element = d3.select (e).selectAll (\"p, span, button\");\n    if (!first_element.empty()) {\n        return d3.select(first_element.node()).text();\n    } else {\n        return d3.select(e).text();\n    }\n  };\n\n  d3.selectAll(table_id + \" thead th\").each(function() {\n    header_row.push(extract_text(this));\n  });\n  var data_rows = [];\n  d3.select(table_id + \" tbody\").selectAll (\"tr\").each(function(d, i) {\n    data_rows.push([]);\n    d3.select(this).selectAll(\"td\").each(function() {\n      data_rows[i].push(extract_text(this));\n    });\n  });\n\n  return (\n    header_row.join(sep) +\n    \"\\n\" +\n    data_rows\n      .map(function(d) {\n        return d.join(sep);\n      })\n      .join(\"\\n\")\n  );\n}\n\nfunction datamonkey_capitalize(s) {\n  if (s.length > 0) {\n    return s[0].toUpperCase() + s.slice(1);\n  } else {\n    return s;\n  }\n}\n\nfunction datamonkey_count_partitions(json) {\n  try {\n    return _.keys(json).length;\n  } catch (e) {\n    // ignore errors\n  }\n  return 0;\n}\n\nfunction datamonkey_sum(object, accessor) {\n  accessor =\n    accessor ||\n    function(value) {\n      return value;\n    };\n  return _.reduce(\n    object,\n    function(sum, value, index) {\n      return sum + accessor(value, index);\n    },\n    0\n  );\n}\n\nfunction datamonkey_count_sites_from_partitions(json) {\n  try {\n    return datamonkey_sum(json[\"partitions\"], function(value) {\n      return value[\"coverage\"][0].length;\n    });\n  } catch (e) {\n    // ignore errors\n  }\n  return 0;\n}\n\nfunction datamonkey_filter_list(list, predicate, context) {\n  var result = {};\n  predicate = _.bind(predicate, context);\n  _.each(\n    list,\n    _.bind(function(value, key) {\n      if (predicate(value, key)) {\n        result[key] = value;\n      }\n    }, context)\n  );\n  return result;\n}\n\nfunction datamonkey_map_list(list, transform, context) {\n  var result = {};\n  transform = _.bind(transform, context);\n  _.each(\n    list,\n    _.bind(function(value, key) {\n      result[key] = transform(value, key);\n    }, context)\n  );\n  return result;\n}\n\nmodule.exports.errorModal = datamonkey_error_modal;\nmodule.exports.export_csv_button = datamonkey_export_csv_button;\nmodule.exports.save_image = datamonkey_save_image;\nmodule.exports.validate_date = datamonkey_validate_date;\n\nmodule.exports.save_newick_to_file = datamonkey_save_newick_to_file;\nmodule.exports.convert_svg_to_png = datamonkey_convert_svg_to_png;\nmodule.exports.save_newick_tree = datamonkey_save_newick_tree;\nmodule.exports.validate_email = datamonkey_validate_email;\nmodule.exports.describe_vector = datamonkey_describe_vector;\nmodule.exports.table_to_text = datamonkey_table_to_text;\nmodule.exports.export_handler = datamonkey_export_handler;\nmodule.exports.capitalize = datamonkey_capitalize;\nmodule.exports.countPartitionsJSON = datamonkey_count_partitions;\nmodule.exports.countSitesFromPartitionsJSON = datamonkey_count_sites_from_partitions;\nmodule.exports.sum = datamonkey_sum;\nmodule.exports.filter = datamonkey_filter_list;\nmodule.exports.map = datamonkey_map_list;\n\n\n\n// WEBPACK FOOTER //\n// ./src/helpers.js","//download.js v4.2, by dandavis; 2008-2016. [MIT] see http://danml.com/download.html for tests/usage\n// v1 landed a FF+Chrome compat way of downloading strings to local un-named files, upgraded to use a hidden frame and optional mime\n// v2 added named files via a[download], msSaveBlob, IE (10+) support, and window.URL support for larger+faster saves than dataURLs\n// v3 added dataURL and Blob Input, bind-toggle arity, and legacy dataURL fallback was improved with force-download mime and base64 support. 3.1 improved safari handling.\n// v4 adds AMD/UMD, commonJS, and plain browser support\n// v4.1 adds url download capability via solo URL argument (same domain/CORS only)\n// v4.2 adds semantic variable names, long (over 2MB) dataURL support, and hidden by default temp anchors\n// https://github.com/rndme/download\n\n(function (root, factory) {\n\tif (typeof define === 'function' && define.amd) {\n\t\t// AMD. Register as an anonymous module.\n\t\tdefine([], factory);\n\t} else if (typeof exports === 'object') {\n\t\t// Node. Does not work with strict CommonJS, but\n\t\t// only CommonJS-like environments that support module.exports,\n\t\t// like Node.\n\t\tmodule.exports = factory();\n\t} else {\n\t\t// Browser globals (root is window)\n\t\troot.download = factory();\n  }\n}(this, function () {\n\n\treturn function download(data, strFileName, strMimeType) {\n\n\t\tvar self = window, // this script is only for browsers anyway...\n\t\t\tdefaultMime = \"application/octet-stream\", // this default mime also triggers iframe downloads\n\t\t\tmimeType = strMimeType || defaultMime,\n\t\t\tpayload = data,\n\t\t\turl = !strFileName && !strMimeType && payload,\n\t\t\tanchor = document.createElement(\"a\"),\n\t\t\ttoString = function(a){return String(a);},\n\t\t\tmyBlob = (self.Blob || self.MozBlob || self.WebKitBlob || toString),\n\t\t\tfileName = strFileName || \"download\",\n\t\t\tblob,\n\t\t\treader;\n\t\t\tmyBlob= myBlob.call ? myBlob.bind(self) : Blob ;\n\t  \n\t\tif(String(this)===\"true\"){ //reverse arguments, allowing download.bind(true, \"text/xml\", \"export.xml\") to act as a callback\n\t\t\tpayload=[payload, mimeType];\n\t\t\tmimeType=payload[0];\n\t\t\tpayload=payload[1];\n\t\t}\n\n\n\t\tif(url && url.length< 2048){ // if no filename and no mime, assume a url was passed as the only argument\n\t\t\tfileName = url.split(\"/\").pop().split(\"?\")[0];\n\t\t\tanchor.href = url; // assign href prop to temp anchor\n\t\t  \tif(anchor.href.indexOf(url) !== -1){ // if the browser determines that it's a potentially valid url path:\n        \t\tvar ajax=new XMLHttpRequest();\n        \t\tajax.open( \"GET\", url, true);\n        \t\tajax.responseType = 'blob';\n        \t\tajax.onload= function(e){ \n\t\t\t\t  download(e.target.response, fileName, defaultMime);\n\t\t\t\t};\n        \t\tsetTimeout(function(){ ajax.send();}, 0); // allows setting custom ajax headers using the return:\n\t\t\t    return ajax;\n\t\t\t} // end if valid url?\n\t\t} // end if url?\n\n\n\t\t//go ahead and download dataURLs right away\n\t\tif(/^data:([\\w+-]+\\/[\\w+.-]+)?[,;]/.test(payload)){\n\t\t\n\t\t\tif(payload.length > (1024*1024*1.999) && myBlob !== toString ){\n\t\t\t\tpayload=dataUrlToBlob(payload);\n\t\t\t\tmimeType=payload.type || defaultMime;\n\t\t\t}else{\t\t\t\n\t\t\t\treturn navigator.msSaveBlob ?  // IE10 can't do a[download], only Blobs:\n\t\t\t\t\tnavigator.msSaveBlob(dataUrlToBlob(payload), fileName) :\n\t\t\t\t\tsaver(payload) ; // everyone else can save dataURLs un-processed\n\t\t\t}\n\t\t\t\n\t\t}else{//not data url, is it a string with special needs?\n\t\t\tif(/([\\x80-\\xff])/.test(payload)){\t\t\t  \n\t\t\t\tvar i=0, tempUiArr= new Uint8Array(payload.length), mx=tempUiArr.length;\n\t\t\t\tfor(i;i<mx;++i) tempUiArr[i]= payload.charCodeAt(i);\n\t\t\t \tpayload=new myBlob([tempUiArr], {type: mimeType});\n\t\t\t}\t\t  \n\t\t}\n\t\tblob = payload instanceof myBlob ?\n\t\t\tpayload :\n\t\t\tnew myBlob([payload], {type: mimeType}) ;\n\n\n\t\tfunction dataUrlToBlob(strUrl) {\n\t\t\tvar parts= strUrl.split(/[:;,]/),\n\t\t\ttype= parts[1],\n\t\t\tdecoder= parts[2] == \"base64\" ? atob : decodeURIComponent,\n\t\t\tbinData= decoder( parts.pop() ),\n\t\t\tmx= binData.length,\n\t\t\ti= 0,\n\t\t\tuiArr= new Uint8Array(mx);\n\n\t\t\tfor(i;i<mx;++i) uiArr[i]= binData.charCodeAt(i);\n\n\t\t\treturn new myBlob([uiArr], {type: type});\n\t\t }\n\n\t\tfunction saver(url, winMode){\n\n\t\t\tif ('download' in anchor) { //html5 A[download]\n\t\t\t\tanchor.href = url;\n\t\t\t\tanchor.setAttribute(\"download\", fileName);\n\t\t\t\tanchor.className = \"download-js-link\";\n\t\t\t\tanchor.innerHTML = \"downloading...\";\n\t\t\t\tanchor.style.display = \"none\";\n\t\t\t\tdocument.body.appendChild(anchor);\n\t\t\t\tsetTimeout(function() {\n\t\t\t\t\tanchor.click();\n\t\t\t\t\tdocument.body.removeChild(anchor);\n\t\t\t\t\tif(winMode===true){setTimeout(function(){ self.URL.revokeObjectURL(anchor.href);}, 250 );}\n\t\t\t\t}, 66);\n\t\t\t\treturn true;\n\t\t\t}\n\n\t\t\t// handle non-a[download] safari as best we can:\n\t\t\tif(/(Version)\\/(\\d+)\\.(\\d+)(?:\\.(\\d+))?.*Safari\\//.test(navigator.userAgent)) {\n\t\t\t\tif(/^data:/.test(url))\turl=\"data:\"+url.replace(/^data:([\\w\\/\\-\\+]+)/, defaultMime);\n\t\t\t\tif(!window.open(url)){ // popup blocked, offer direct download:\n\t\t\t\t\tif(confirm(\"Displaying New Document\\n\\nUse Save As... to download, then click back to return to this page.\")){ location.href=url; }\n\t\t\t\t}\n\t\t\t\treturn true;\n\t\t\t}\n\n\t\t\t//do iframe dataURL download (old ch+FF):\n\t\t\tvar f = document.createElement(\"iframe\");\n\t\t\tdocument.body.appendChild(f);\n\n\t\t\tif(!winMode && /^data:/.test(url)){ // force a mime that will download:\n\t\t\t\turl=\"data:\"+url.replace(/^data:([\\w\\/\\-\\+]+)/, defaultMime);\n\t\t\t}\n\t\t\tf.src=url;\n\t\t\tsetTimeout(function(){ document.body.removeChild(f); }, 333);\n\n\t\t}//end saver\n\n\n\n\n\t\tif (navigator.msSaveBlob) { // IE10+ : (has Blob, but not a[download] or URL)\n\t\t\treturn navigator.msSaveBlob(blob, fileName);\n\t\t}\n\n\t\tif(self.URL){ // simple fast and modern way using Blob and URL:\n\t\t\tsaver(self.URL.createObjectURL(blob), true);\n\t\t}else{\n\t\t\t// handle non-Blob()+non-URL browsers:\n\t\t\tif(typeof blob === \"string\" || blob.constructor===toString ){\n\t\t\t\ttry{\n\t\t\t\t\treturn saver( \"data:\" +  mimeType   + \";base64,\"  +  self.btoa(blob)  );\n\t\t\t\t}catch(y){\n\t\t\t\t\treturn saver( \"data:\" +  mimeType   + \",\" + encodeURIComponent(blob)  );\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Blob but not URL support:\n\t\t\treader=new FileReader();\n\t\t\treader.onload=function(e){\n\t\t\t\tsaver(this.result);\n\t\t\t};\n\t\t\treader.readAsDataURL(blob);\n\t\t}\n\t\treturn true;\n\t}; /* end download() */\n}));\n\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./~/downloadjs/download.js\n// module id = 46\n// module chunks = 0","var d3 = require(\"d3\"),\n  _ = require(\"underscore\");\n\nfunction hivtrace_render_scatterplot(points, w, h, id, labels, dates) {\n  var _defaultDateViewFormat = d3.time.format(\"%B %d, %Y\");\n  var _defaultFloatFormat = d3.format(\",.2r\");\n  var _defaultDateViewFormatShort = d3.time.format(\"%B %Y\");\n\n  var margin = {\n      top: 10,\n      right: 10,\n      bottom: 100,\n      left: 100\n    },\n    width = w - margin.left - margin.right,\n    height = h - margin.top - margin.bottom;\n\n  var x = (dates ? d3.time.scale() : d3.scale.linear())\n    .domain(\n      d3.extent(points, function(p) {\n        return p.x;\n      })\n    )\n    .range([0, width]);\n\n  var y = (dates ? d3.time.scale() : d3.scale.linear())\n    .domain(\n      d3.extent(points, function(p) {\n        return p.y;\n      })\n    )\n    .range([height, 0]);\n\n  var xAxis = d3.svg\n    .axis()\n    .scale(x)\n    .orient(\"bottom\")\n    .tickFormat(dates ? _defaultDateViewFormatShort : _defaultFloatFormat);\n\n  var yAxis = d3.svg\n    .axis()\n    .scale(y)\n    .orient(\"left\")\n    .tickFormat(dates ? _defaultDateViewFormatShort : _defaultFloatFormat);\n\n  var histogram_svg = d3.select(id).selectAll(\"svg\");\n\n  if (!histogram_svg.empty()) {\n    histogram_svg.remove();\n  }\n\n  histogram_svg = d3\n    .select(id)\n    .append(\"svg\")\n    .attr(\"width\", w)\n    .attr(\"height\", h)\n    .append(\"g\")\n    .attr(\"transform\", \"translate(\" + margin.left + \",\" + margin.top + \")\");\n\n  points = histogram_svg.selectAll(\"circle\").data(points);\n  points.enter().append(\"circle\");\n\n  points\n    .attr(\"cx\", function(d) {\n      return x(d.x);\n    })\n    .attr(\"cy\", function(d) {\n      return y(d.y);\n    })\n    .attr(\"r\", 3)\n    .classed(\"node scatter\", true);\n\n  points.each(function(d) {\n    if (\"title\" in d) {\n      d3.select(this).append(\"title\").text(d.title);\n    }\n  });\n\n  var x_axis = histogram_svg\n    .append(\"g\")\n    .attr(\"class\", \"x axis\")\n    .attr(\"transform\", \"translate(0,\" + height + \")\")\n    .call(xAxis);\n\n  x_axis\n    .selectAll(\"text\")\n    .attr(\"transform\", \"rotate(-45)\")\n    .attr(\"dx\", \"-.5em\")\n    .attr(\"dy\", \".25em\")\n    .style(\"text-anchor\", \"end\");\n  x_axis\n    .append(\"text\")\n    .text(labels.x)\n    .attr(\"transform\", \"translate(\" + width + \",0)\")\n    .attr(\"dy\", \"-1em\")\n    .attr(\"text-anchor\", \"end\");\n\n  var y_axis = histogram_svg\n    .append(\"g\")\n    .attr(\"class\", \"y axis\")\n    .attr(\"transform\", \"translate(0,\" + 0 + \")\")\n    .call(yAxis);\n\n  y_axis\n    .selectAll(\"text\")\n    .attr(\"transform\", \"rotate(-45)\")\n    .attr(\"dx\", \"-.5em\")\n    .attr(\"dy\", \".25em\")\n    .style(\"text-anchor\", \"end\");\n  y_axis\n    .append(\"text\")\n    .text(labels.y)\n    .attr(\"transform\", \"rotate(-90)\")\n    .attr(\"dy\", \"1em\")\n    .attr(\"text-anchor\", \"end\");\n}\n\nmodule.exports.scatterPlot = hivtrace_render_scatterplot;\n\n\n\n// WEBPACK FOOTER //\n// ./src/scatterplot.js","'use strict';\n\nObject.defineProperty(exports, '__esModule', { value: true });\n\nvar topojsonClient = require('topojson-client');\nvar topojsonServer = require('topojson-server');\nvar topojsonSimplify = require('topojson-simplify');\n\n\n\nObject.keys(topojsonClient).forEach(function (key) { exports[key] = topojsonClient[key]; });\nObject.keys(topojsonServer).forEach(function (key) { exports[key] = topojsonServer[key]; });\nObject.keys(topojsonSimplify).forEach(function (key) { exports[key] = topojsonSimplify[key]; });\n\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./~/topojson/dist/topojson.node.js\n// module id = 48\n// module chunks = 0","// https://github.com/topojson/topojson-client Version 3.0.0. Copyright 2017 Mike Bostock.\n(function (global, factory) {\n\ttypeof exports === 'object' && typeof module !== 'undefined' ? factory(exports) :\n\ttypeof define === 'function' && define.amd ? define(['exports'], factory) :\n\t(factory((global.topojson = global.topojson || {})));\n}(this, (function (exports) { 'use strict';\n\nvar identity = function(x) {\n  return x;\n};\n\nvar transform = function(transform) {\n  if (transform == null) return identity;\n  var x0,\n      y0,\n      kx = transform.scale[0],\n      ky = transform.scale[1],\n      dx = transform.translate[0],\n      dy = transform.translate[1];\n  return function(input, i) {\n    if (!i) x0 = y0 = 0;\n    var j = 2, n = input.length, output = new Array(n);\n    output[0] = (x0 += input[0]) * kx + dx;\n    output[1] = (y0 += input[1]) * ky + dy;\n    while (j < n) output[j] = input[j], ++j;\n    return output;\n  };\n};\n\nvar bbox = function(topology) {\n  var t = transform(topology.transform), key,\n      x0 = Infinity, y0 = x0, x1 = -x0, y1 = -x0;\n\n  function bboxPoint(p) {\n    p = t(p);\n    if (p[0] < x0) x0 = p[0];\n    if (p[0] > x1) x1 = p[0];\n    if (p[1] < y0) y0 = p[1];\n    if (p[1] > y1) y1 = p[1];\n  }\n\n  function bboxGeometry(o) {\n    switch (o.type) {\n      case \"GeometryCollection\": o.geometries.forEach(bboxGeometry); break;\n      case \"Point\": bboxPoint(o.coordinates); break;\n      case \"MultiPoint\": o.coordinates.forEach(bboxPoint); break;\n    }\n  }\n\n  topology.arcs.forEach(function(arc) {\n    var i = -1, n = arc.length, p;\n    while (++i < n) {\n      p = t(arc[i], i);\n      if (p[0] < x0) x0 = p[0];\n      if (p[0] > x1) x1 = p[0];\n      if (p[1] < y0) y0 = p[1];\n      if (p[1] > y1) y1 = p[1];\n    }\n  });\n\n  for (key in topology.objects) {\n    bboxGeometry(topology.objects[key]);\n  }\n\n  return [x0, y0, x1, y1];\n};\n\nvar reverse = function(array, n) {\n  var t, j = array.length, i = j - n;\n  while (i < --j) t = array[i], array[i++] = array[j], array[j] = t;\n};\n\nvar feature = function(topology, o) {\n  return o.type === \"GeometryCollection\"\n      ? {type: \"FeatureCollection\", features: o.geometries.map(function(o) { return feature$1(topology, o); })}\n      : feature$1(topology, o);\n};\n\nfunction feature$1(topology, o) {\n  var id = o.id,\n      bbox = o.bbox,\n      properties = o.properties == null ? {} : o.properties,\n      geometry = object(topology, o);\n  return id == null && bbox == null ? {type: \"Feature\", properties: properties, geometry: geometry}\n      : bbox == null ? {type: \"Feature\", id: id, properties: properties, geometry: geometry}\n      : {type: \"Feature\", id: id, bbox: bbox, properties: properties, geometry: geometry};\n}\n\nfunction object(topology, o) {\n  var transformPoint = transform(topology.transform),\n      arcs = topology.arcs;\n\n  function arc(i, points) {\n    if (points.length) points.pop();\n    for (var a = arcs[i < 0 ? ~i : i], k = 0, n = a.length; k < n; ++k) {\n      points.push(transformPoint(a[k], k));\n    }\n    if (i < 0) reverse(points, n);\n  }\n\n  function point(p) {\n    return transformPoint(p);\n  }\n\n  function line(arcs) {\n    var points = [];\n    for (var i = 0, n = arcs.length; i < n; ++i) arc(arcs[i], points);\n    if (points.length < 2) points.push(points[0]); // This should never happen per the specification.\n    return points;\n  }\n\n  function ring(arcs) {\n    var points = line(arcs);\n    while (points.length < 4) points.push(points[0]); // This may happen if an arc has only two points.\n    return points;\n  }\n\n  function polygon(arcs) {\n    return arcs.map(ring);\n  }\n\n  function geometry(o) {\n    var type = o.type, coordinates;\n    switch (type) {\n      case \"GeometryCollection\": return {type: type, geometries: o.geometries.map(geometry)};\n      case \"Point\": coordinates = point(o.coordinates); break;\n      case \"MultiPoint\": coordinates = o.coordinates.map(point); break;\n      case \"LineString\": coordinates = line(o.arcs); break;\n      case \"MultiLineString\": coordinates = o.arcs.map(line); break;\n      case \"Polygon\": coordinates = polygon(o.arcs); break;\n      case \"MultiPolygon\": coordinates = o.arcs.map(polygon); break;\n      default: return null;\n    }\n    return {type: type, coordinates: coordinates};\n  }\n\n  return geometry(o);\n}\n\nvar stitch = function(topology, arcs) {\n  var stitchedArcs = {},\n      fragmentByStart = {},\n      fragmentByEnd = {},\n      fragments = [],\n      emptyIndex = -1;\n\n  // Stitch empty arcs first, since they may be subsumed by other arcs.\n  arcs.forEach(function(i, j) {\n    var arc = topology.arcs[i < 0 ? ~i : i], t;\n    if (arc.length < 3 && !arc[1][0] && !arc[1][1]) {\n      t = arcs[++emptyIndex], arcs[emptyIndex] = i, arcs[j] = t;\n    }\n  });\n\n  arcs.forEach(function(i) {\n    var e = ends(i),\n        start = e[0],\n        end = e[1],\n        f, g;\n\n    if (f = fragmentByEnd[start]) {\n      delete fragmentByEnd[f.end];\n      f.push(i);\n      f.end = end;\n      if (g = fragmentByStart[end]) {\n        delete fragmentByStart[g.start];\n        var fg = g === f ? f : f.concat(g);\n        fragmentByStart[fg.start = f.start] = fragmentByEnd[fg.end = g.end] = fg;\n      } else {\n        fragmentByStart[f.start] = fragmentByEnd[f.end] = f;\n      }\n    } else if (f = fragmentByStart[end]) {\n      delete fragmentByStart[f.start];\n      f.unshift(i);\n      f.start = start;\n      if (g = fragmentByEnd[start]) {\n        delete fragmentByEnd[g.end];\n        var gf = g === f ? f : g.concat(f);\n        fragmentByStart[gf.start = g.start] = fragmentByEnd[gf.end = f.end] = gf;\n      } else {\n        fragmentByStart[f.start] = fragmentByEnd[f.end] = f;\n      }\n    } else {\n      f = [i];\n      fragmentByStart[f.start = start] = fragmentByEnd[f.end = end] = f;\n    }\n  });\n\n  function ends(i) {\n    var arc = topology.arcs[i < 0 ? ~i : i], p0 = arc[0], p1;\n    if (topology.transform) p1 = [0, 0], arc.forEach(function(dp) { p1[0] += dp[0], p1[1] += dp[1]; });\n    else p1 = arc[arc.length - 1];\n    return i < 0 ? [p1, p0] : [p0, p1];\n  }\n\n  function flush(fragmentByEnd, fragmentByStart) {\n    for (var k in fragmentByEnd) {\n      var f = fragmentByEnd[k];\n      delete fragmentByStart[f.start];\n      delete f.start;\n      delete f.end;\n      f.forEach(function(i) { stitchedArcs[i < 0 ? ~i : i] = 1; });\n      fragments.push(f);\n    }\n  }\n\n  flush(fragmentByEnd, fragmentByStart);\n  flush(fragmentByStart, fragmentByEnd);\n  arcs.forEach(function(i) { if (!stitchedArcs[i < 0 ? ~i : i]) fragments.push([i]); });\n\n  return fragments;\n};\n\nvar mesh = function(topology) {\n  return object(topology, meshArcs.apply(this, arguments));\n};\n\nfunction meshArcs(topology, object$$1, filter) {\n  var arcs, i, n;\n  if (arguments.length > 1) arcs = extractArcs(topology, object$$1, filter);\n  else for (i = 0, arcs = new Array(n = topology.arcs.length); i < n; ++i) arcs[i] = i;\n  return {type: \"MultiLineString\", arcs: stitch(topology, arcs)};\n}\n\nfunction extractArcs(topology, object$$1, filter) {\n  var arcs = [],\n      geomsByArc = [],\n      geom;\n\n  function extract0(i) {\n    var j = i < 0 ? ~i : i;\n    (geomsByArc[j] || (geomsByArc[j] = [])).push({i: i, g: geom});\n  }\n\n  function extract1(arcs) {\n    arcs.forEach(extract0);\n  }\n\n  function extract2(arcs) {\n    arcs.forEach(extract1);\n  }\n\n  function extract3(arcs) {\n    arcs.forEach(extract2);\n  }\n\n  function geometry(o) {\n    switch (geom = o, o.type) {\n      case \"GeometryCollection\": o.geometries.forEach(geometry); break;\n      case \"LineString\": extract1(o.arcs); break;\n      case \"MultiLineString\": case \"Polygon\": extract2(o.arcs); break;\n      case \"MultiPolygon\": extract3(o.arcs); break;\n    }\n  }\n\n  geometry(object$$1);\n\n  geomsByArc.forEach(filter == null\n      ? function(geoms) { arcs.push(geoms[0].i); }\n      : function(geoms) { if (filter(geoms[0].g, geoms[geoms.length - 1].g)) arcs.push(geoms[0].i); });\n\n  return arcs;\n}\n\nfunction planarRingArea(ring) {\n  var i = -1, n = ring.length, a, b = ring[n - 1], area = 0;\n  while (++i < n) a = b, b = ring[i], area += a[0] * b[1] - a[1] * b[0];\n  return Math.abs(area); // Note: doubled area!\n}\n\nvar merge = function(topology) {\n  return object(topology, mergeArcs.apply(this, arguments));\n};\n\nfunction mergeArcs(topology, objects) {\n  var polygonsByArc = {},\n      polygons = [],\n      groups = [];\n\n  objects.forEach(geometry);\n\n  function geometry(o) {\n    switch (o.type) {\n      case \"GeometryCollection\": o.geometries.forEach(geometry); break;\n      case \"Polygon\": extract(o.arcs); break;\n      case \"MultiPolygon\": o.arcs.forEach(extract); break;\n    }\n  }\n\n  function extract(polygon) {\n    polygon.forEach(function(ring) {\n      ring.forEach(function(arc) {\n        (polygonsByArc[arc = arc < 0 ? ~arc : arc] || (polygonsByArc[arc] = [])).push(polygon);\n      });\n    });\n    polygons.push(polygon);\n  }\n\n  function area(ring) {\n    return planarRingArea(object(topology, {type: \"Polygon\", arcs: [ring]}).coordinates[0]);\n  }\n\n  polygons.forEach(function(polygon) {\n    if (!polygon._) {\n      var group = [],\n          neighbors = [polygon];\n      polygon._ = 1;\n      groups.push(group);\n      while (polygon = neighbors.pop()) {\n        group.push(polygon);\n        polygon.forEach(function(ring) {\n          ring.forEach(function(arc) {\n            polygonsByArc[arc < 0 ? ~arc : arc].forEach(function(polygon) {\n              if (!polygon._) {\n                polygon._ = 1;\n                neighbors.push(polygon);\n              }\n            });\n          });\n        });\n      }\n    }\n  });\n\n  polygons.forEach(function(polygon) {\n    delete polygon._;\n  });\n\n  return {\n    type: \"MultiPolygon\",\n    arcs: groups.map(function(polygons) {\n      var arcs = [], n;\n\n      // Extract the exterior (unique) arcs.\n      polygons.forEach(function(polygon) {\n        polygon.forEach(function(ring) {\n          ring.forEach(function(arc) {\n            if (polygonsByArc[arc < 0 ? ~arc : arc].length < 2) {\n              arcs.push(arc);\n            }\n          });\n        });\n      });\n\n      // Stitch the arcs into one or more rings.\n      arcs = stitch(topology, arcs);\n\n      // If more than one ring is returned,\n      // at most one of these rings can be the exterior;\n      // choose the one with the greatest absolute area.\n      if ((n = arcs.length) > 1) {\n        for (var i = 1, k = area(arcs[0]), ki, t; i < n; ++i) {\n          if ((ki = area(arcs[i])) > k) {\n            t = arcs[0], arcs[0] = arcs[i], arcs[i] = t, k = ki;\n          }\n        }\n      }\n\n      return arcs;\n    })\n  };\n}\n\nvar bisect = function(a, x) {\n  var lo = 0, hi = a.length;\n  while (lo < hi) {\n    var mid = lo + hi >>> 1;\n    if (a[mid] < x) lo = mid + 1;\n    else hi = mid;\n  }\n  return lo;\n};\n\nvar neighbors = function(objects) {\n  var indexesByArc = {}, // arc index -> array of object indexes\n      neighbors = objects.map(function() { return []; });\n\n  function line(arcs, i) {\n    arcs.forEach(function(a) {\n      if (a < 0) a = ~a;\n      var o = indexesByArc[a];\n      if (o) o.push(i);\n      else indexesByArc[a] = [i];\n    });\n  }\n\n  function polygon(arcs, i) {\n    arcs.forEach(function(arc) { line(arc, i); });\n  }\n\n  function geometry(o, i) {\n    if (o.type === \"GeometryCollection\") o.geometries.forEach(function(o) { geometry(o, i); });\n    else if (o.type in geometryType) geometryType[o.type](o.arcs, i);\n  }\n\n  var geometryType = {\n    LineString: line,\n    MultiLineString: polygon,\n    Polygon: polygon,\n    MultiPolygon: function(arcs, i) { arcs.forEach(function(arc) { polygon(arc, i); }); }\n  };\n\n  objects.forEach(geometry);\n\n  for (var i in indexesByArc) {\n    for (var indexes = indexesByArc[i], m = indexes.length, j = 0; j < m; ++j) {\n      for (var k = j + 1; k < m; ++k) {\n        var ij = indexes[j], ik = indexes[k], n;\n        if ((n = neighbors[ij])[i = bisect(n, ik)] !== ik) n.splice(i, 0, ik);\n        if ((n = neighbors[ik])[i = bisect(n, ij)] !== ij) n.splice(i, 0, ij);\n      }\n    }\n  }\n\n  return neighbors;\n};\n\nvar untransform = function(transform) {\n  if (transform == null) return identity;\n  var x0,\n      y0,\n      kx = transform.scale[0],\n      ky = transform.scale[1],\n      dx = transform.translate[0],\n      dy = transform.translate[1];\n  return function(input, i) {\n    if (!i) x0 = y0 = 0;\n    var j = 2,\n        n = input.length,\n        output = new Array(n),\n        x1 = Math.round((input[0] - dx) / kx),\n        y1 = Math.round((input[1] - dy) / ky);\n    output[0] = x1 - x0, x0 = x1;\n    output[1] = y1 - y0, y0 = y1;\n    while (j < n) output[j] = input[j], ++j;\n    return output;\n  };\n};\n\nvar quantize = function(topology, transform) {\n  if (topology.transform) throw new Error(\"already quantized\");\n\n  if (!transform || !transform.scale) {\n    if (!((n = Math.floor(transform)) >= 2)) throw new Error(\"n must be 2\");\n    box = topology.bbox || bbox(topology);\n    var x0 = box[0], y0 = box[1], x1 = box[2], y1 = box[3], n;\n    transform = {scale: [x1 - x0 ? (x1 - x0) / (n - 1) : 1, y1 - y0 ? (y1 - y0) / (n - 1) : 1], translate: [x0, y0]};\n  } else {\n    box = topology.bbox;\n  }\n\n  var t = untransform(transform), box, key, inputs = topology.objects, outputs = {};\n\n  function quantizePoint(point) {\n    return t(point);\n  }\n\n  function quantizeGeometry(input) {\n    var output;\n    switch (input.type) {\n      case \"GeometryCollection\": output = {type: \"GeometryCollection\", geometries: input.geometries.map(quantizeGeometry)}; break;\n      case \"Point\": output = {type: \"Point\", coordinates: quantizePoint(input.coordinates)}; break;\n      case \"MultiPoint\": output = {type: \"MultiPoint\", coordinates: input.coordinates.map(quantizePoint)}; break;\n      default: return input;\n    }\n    if (input.id != null) output.id = input.id;\n    if (input.bbox != null) output.bbox = input.bbox;\n    if (input.properties != null) output.properties = input.properties;\n    return output;\n  }\n\n  function quantizeArc(input) {\n    var i = 0, j = 1, n = input.length, p, output = new Array(n); // pessimistic\n    output[0] = t(input[0], 0);\n    while (++i < n) if ((p = t(input[i], i))[0] || p[1]) output[j++] = p; // non-coincident points\n    if (j === 1) output[j++] = [0, 0]; // an arc must have at least two points\n    output.length = j;\n    return output;\n  }\n\n  for (key in inputs) outputs[key] = quantizeGeometry(inputs[key]);\n\n  return {\n    type: \"Topology\",\n    bbox: box,\n    transform: transform,\n    objects: outputs,\n    arcs: topology.arcs.map(quantizeArc)\n  };\n};\n\nexports.bbox = bbox;\nexports.feature = feature;\nexports.mesh = mesh;\nexports.meshArcs = meshArcs;\nexports.merge = merge;\nexports.mergeArcs = mergeArcs;\nexports.neighbors = neighbors;\nexports.quantize = quantize;\nexports.transform = transform;\nexports.untransform = untransform;\n\nObject.defineProperty(exports, '__esModule', { value: true });\n\n})));\n\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./~/topojson-client/dist/topojson-client.js\n// module id = 49\n// module chunks = 0","// https://github.com/topojson/topojson-server Version 3.0.0. Copyright 2017 Mike Bostock.\n(function (global, factory) {\n\ttypeof exports === 'object' && typeof module !== 'undefined' ? factory(exports) :\n\ttypeof define === 'function' && define.amd ? define(['exports'], factory) :\n\t(factory((global.topojson = global.topojson || {})));\n}(this, (function (exports) { 'use strict';\n\n// Computes the bounding box of the specified hash of GeoJSON objects.\nvar bounds = function(objects) {\n  var x0 = Infinity,\n      y0 = Infinity,\n      x1 = -Infinity,\n      y1 = -Infinity;\n\n  function boundGeometry(geometry) {\n    if (geometry != null && boundGeometryType.hasOwnProperty(geometry.type)) boundGeometryType[geometry.type](geometry);\n  }\n\n  var boundGeometryType = {\n    GeometryCollection: function(o) { o.geometries.forEach(boundGeometry); },\n    Point: function(o) { boundPoint(o.coordinates); },\n    MultiPoint: function(o) { o.coordinates.forEach(boundPoint); },\n    LineString: function(o) { boundLine(o.arcs); },\n    MultiLineString: function(o) { o.arcs.forEach(boundLine); },\n    Polygon: function(o) { o.arcs.forEach(boundLine); },\n    MultiPolygon: function(o) { o.arcs.forEach(boundMultiLine); }\n  };\n\n  function boundPoint(coordinates) {\n    var x = coordinates[0],\n        y = coordinates[1];\n    if (x < x0) x0 = x;\n    if (x > x1) x1 = x;\n    if (y < y0) y0 = y;\n    if (y > y1) y1 = y;\n  }\n\n  function boundLine(coordinates) {\n    coordinates.forEach(boundPoint);\n  }\n\n  function boundMultiLine(coordinates) {\n    coordinates.forEach(boundLine);\n  }\n\n  for (var key in objects) {\n    boundGeometry(objects[key]);\n  }\n\n  return x1 >= x0 && y1 >= y0 ? [x0, y0, x1, y1] : undefined;\n};\n\nvar hashset = function(size, hash, equal, type, empty) {\n  if (arguments.length === 3) {\n    type = Array;\n    empty = null;\n  }\n\n  var store = new type(size = 1 << Math.max(4, Math.ceil(Math.log(size) / Math.LN2))),\n      mask = size - 1;\n\n  for (var i = 0; i < size; ++i) {\n    store[i] = empty;\n  }\n\n  function add(value) {\n    var index = hash(value) & mask,\n        match = store[index],\n        collisions = 0;\n    while (match != empty) {\n      if (equal(match, value)) return true;\n      if (++collisions >= size) throw new Error(\"full hashset\");\n      match = store[index = (index + 1) & mask];\n    }\n    store[index] = value;\n    return true;\n  }\n\n  function has(value) {\n    var index = hash(value) & mask,\n        match = store[index],\n        collisions = 0;\n    while (match != empty) {\n      if (equal(match, value)) return true;\n      if (++collisions >= size) break;\n      match = store[index = (index + 1) & mask];\n    }\n    return false;\n  }\n\n  function values() {\n    var values = [];\n    for (var i = 0, n = store.length; i < n; ++i) {\n      var match = store[i];\n      if (match != empty) values.push(match);\n    }\n    return values;\n  }\n\n  return {\n    add: add,\n    has: has,\n    values: values\n  };\n};\n\nvar hashmap = function(size, hash, equal, keyType, keyEmpty, valueType) {\n  if (arguments.length === 3) {\n    keyType = valueType = Array;\n    keyEmpty = null;\n  }\n\n  var keystore = new keyType(size = 1 << Math.max(4, Math.ceil(Math.log(size) / Math.LN2))),\n      valstore = new valueType(size),\n      mask = size - 1;\n\n  for (var i = 0; i < size; ++i) {\n    keystore[i] = keyEmpty;\n  }\n\n  function set(key, value) {\n    var index = hash(key) & mask,\n        matchKey = keystore[index],\n        collisions = 0;\n    while (matchKey != keyEmpty) {\n      if (equal(matchKey, key)) return valstore[index] = value;\n      if (++collisions >= size) throw new Error(\"full hashmap\");\n      matchKey = keystore[index = (index + 1) & mask];\n    }\n    keystore[index] = key;\n    valstore[index] = value;\n    return value;\n  }\n\n  function maybeSet(key, value) {\n    var index = hash(key) & mask,\n        matchKey = keystore[index],\n        collisions = 0;\n    while (matchKey != keyEmpty) {\n      if (equal(matchKey, key)) return valstore[index];\n      if (++collisions >= size) throw new Error(\"full hashmap\");\n      matchKey = keystore[index = (index + 1) & mask];\n    }\n    keystore[index] = key;\n    valstore[index] = value;\n    return value;\n  }\n\n  function get(key, missingValue) {\n    var index = hash(key) & mask,\n        matchKey = keystore[index],\n        collisions = 0;\n    while (matchKey != keyEmpty) {\n      if (equal(matchKey, key)) return valstore[index];\n      if (++collisions >= size) break;\n      matchKey = keystore[index = (index + 1) & mask];\n    }\n    return missingValue;\n  }\n\n  function keys() {\n    var keys = [];\n    for (var i = 0, n = keystore.length; i < n; ++i) {\n      var matchKey = keystore[i];\n      if (matchKey != keyEmpty) keys.push(matchKey);\n    }\n    return keys;\n  }\n\n  return {\n    set: set,\n    maybeSet: maybeSet, // set if unset\n    get: get,\n    keys: keys\n  };\n};\n\nvar equalPoint = function(pointA, pointB) {\n  return pointA[0] === pointB[0] && pointA[1] === pointB[1];\n};\n\n// TODO if quantized, use simpler Int32 hashing?\n\nvar buffer = new ArrayBuffer(16);\nvar floats = new Float64Array(buffer);\nvar uints = new Uint32Array(buffer);\n\nvar hashPoint = function(point) {\n  floats[0] = point[0];\n  floats[1] = point[1];\n  var hash = uints[0] ^ uints[1];\n  hash = hash << 5 ^ hash >> 7 ^ uints[2] ^ uints[3];\n  return hash & 0x7fffffff;\n};\n\n// Given an extracted (pre-)topology, identifies all of the junctions. These are\n// the points at which arcs (lines or rings) will need to be cut so that each\n// arc is represented uniquely.\n//\n// A junction is a point where at least one arc deviates from another arc going\n// through the same point. For example, consider the point B. If there is a arc\n// through ABC and another arc through CBA, then B is not a junction because in\n// both cases the adjacent point pairs are {A,C}. However, if there is an\n// additional arc ABD, then {A,D} != {A,C}, and thus B becomes a junction.\n//\n// For a closed ring ABCA, the first point As adjacent points are the second\n// and last point {B,C}. For a line, the first and last point are always\n// considered junctions, even if the line is closed; this ensures that a closed\n// line is never rotated.\nvar join = function(topology) {\n  var coordinates = topology.coordinates,\n      lines = topology.lines,\n      rings = topology.rings,\n      indexes = index(),\n      visitedByIndex = new Int32Array(coordinates.length),\n      leftByIndex = new Int32Array(coordinates.length),\n      rightByIndex = new Int32Array(coordinates.length),\n      junctionByIndex = new Int8Array(coordinates.length),\n      junctionCount = 0, // upper bound on number of junctions\n      i, n,\n      previousIndex,\n      currentIndex,\n      nextIndex;\n\n  for (i = 0, n = coordinates.length; i < n; ++i) {\n    visitedByIndex[i] = leftByIndex[i] = rightByIndex[i] = -1;\n  }\n\n  for (i = 0, n = lines.length; i < n; ++i) {\n    var line = lines[i],\n        lineStart = line[0],\n        lineEnd = line[1];\n    currentIndex = indexes[lineStart];\n    nextIndex = indexes[++lineStart];\n    ++junctionCount, junctionByIndex[currentIndex] = 1; // start\n    while (++lineStart <= lineEnd) {\n      sequence(i, previousIndex = currentIndex, currentIndex = nextIndex, nextIndex = indexes[lineStart]);\n    }\n    ++junctionCount, junctionByIndex[nextIndex] = 1; // end\n  }\n\n  for (i = 0, n = coordinates.length; i < n; ++i) {\n    visitedByIndex[i] = -1;\n  }\n\n  for (i = 0, n = rings.length; i < n; ++i) {\n    var ring = rings[i],\n        ringStart = ring[0] + 1,\n        ringEnd = ring[1];\n    previousIndex = indexes[ringEnd - 1];\n    currentIndex = indexes[ringStart - 1];\n    nextIndex = indexes[ringStart];\n    sequence(i, previousIndex, currentIndex, nextIndex);\n    while (++ringStart <= ringEnd) {\n      sequence(i, previousIndex = currentIndex, currentIndex = nextIndex, nextIndex = indexes[ringStart]);\n    }\n  }\n\n  function sequence(i, previousIndex, currentIndex, nextIndex) {\n    if (visitedByIndex[currentIndex] === i) return; // ignore self-intersection\n    visitedByIndex[currentIndex] = i;\n    var leftIndex = leftByIndex[currentIndex];\n    if (leftIndex >= 0) {\n      var rightIndex = rightByIndex[currentIndex];\n      if ((leftIndex !== previousIndex || rightIndex !== nextIndex)\n        && (leftIndex !== nextIndex || rightIndex !== previousIndex)) {\n        ++junctionCount, junctionByIndex[currentIndex] = 1;\n      }\n    } else {\n      leftByIndex[currentIndex] = previousIndex;\n      rightByIndex[currentIndex] = nextIndex;\n    }\n  }\n\n  function index() {\n    var indexByPoint = hashmap(coordinates.length * 1.4, hashIndex, equalIndex, Int32Array, -1, Int32Array),\n        indexes = new Int32Array(coordinates.length);\n\n    for (var i = 0, n = coordinates.length; i < n; ++i) {\n      indexes[i] = indexByPoint.maybeSet(i, i);\n    }\n\n    return indexes;\n  }\n\n  function hashIndex(i) {\n    return hashPoint(coordinates[i]);\n  }\n\n  function equalIndex(i, j) {\n    return equalPoint(coordinates[i], coordinates[j]);\n  }\n\n  visitedByIndex = leftByIndex = rightByIndex = null;\n\n  var junctionByPoint = hashset(junctionCount * 1.4, hashPoint, equalPoint), j;\n\n  // Convert back to a standard hashset by point for caller convenience.\n  for (i = 0, n = coordinates.length; i < n; ++i) {\n    if (junctionByIndex[j = indexes[i]]) {\n      junctionByPoint.add(coordinates[j]);\n    }\n  }\n\n  return junctionByPoint;\n};\n\n// Given an extracted (pre-)topology, cuts (or rotates) arcs so that all shared\n// point sequences are identified. The topology can then be subsequently deduped\n// to remove exact duplicate arcs.\nvar cut = function(topology) {\n  var junctions = join(topology),\n      coordinates = topology.coordinates,\n      lines = topology.lines,\n      rings = topology.rings,\n      next,\n      i, n;\n\n  for (i = 0, n = lines.length; i < n; ++i) {\n    var line = lines[i],\n        lineMid = line[0],\n        lineEnd = line[1];\n    while (++lineMid < lineEnd) {\n      if (junctions.has(coordinates[lineMid])) {\n        next = {0: lineMid, 1: line[1]};\n        line[1] = lineMid;\n        line = line.next = next;\n      }\n    }\n  }\n\n  for (i = 0, n = rings.length; i < n; ++i) {\n    var ring = rings[i],\n        ringStart = ring[0],\n        ringMid = ringStart,\n        ringEnd = ring[1],\n        ringFixed = junctions.has(coordinates[ringStart]);\n    while (++ringMid < ringEnd) {\n      if (junctions.has(coordinates[ringMid])) {\n        if (ringFixed) {\n          next = {0: ringMid, 1: ring[1]};\n          ring[1] = ringMid;\n          ring = ring.next = next;\n        } else { // For the first junction, we can rotate rather than cut.\n          rotateArray(coordinates, ringStart, ringEnd, ringEnd - ringMid);\n          coordinates[ringEnd] = coordinates[ringStart];\n          ringFixed = true;\n          ringMid = ringStart; // restart; we may have skipped junctions\n        }\n      }\n    }\n  }\n\n  return topology;\n};\n\nfunction rotateArray(array, start, end, offset) {\n  reverse(array, start, end);\n  reverse(array, start, start + offset);\n  reverse(array, start + offset, end);\n}\n\nfunction reverse(array, start, end) {\n  for (var mid = start + ((end-- - start) >> 1), t; start < mid; ++start, --end) {\n    t = array[start], array[start] = array[end], array[end] = t;\n  }\n}\n\n// Given a cut topology, combines duplicate arcs.\nvar dedup = function(topology) {\n  var coordinates = topology.coordinates,\n      lines = topology.lines, line,\n      rings = topology.rings, ring,\n      arcCount = lines.length + rings.length,\n      i, n;\n\n  delete topology.lines;\n  delete topology.rings;\n\n  // Count the number of (non-unique) arcs to initialize the hashmap safely.\n  for (i = 0, n = lines.length; i < n; ++i) {\n    line = lines[i]; while (line = line.next) ++arcCount;\n  }\n  for (i = 0, n = rings.length; i < n; ++i) {\n    ring = rings[i]; while (ring = ring.next) ++arcCount;\n  }\n\n  var arcsByEnd = hashmap(arcCount * 2 * 1.4, hashPoint, equalPoint),\n      arcs = topology.arcs = [];\n\n  for (i = 0, n = lines.length; i < n; ++i) {\n    line = lines[i];\n    do {\n      dedupLine(line);\n    } while (line = line.next);\n  }\n\n  for (i = 0, n = rings.length; i < n; ++i) {\n    ring = rings[i];\n    if (ring.next) { // arc is no longer closed\n      do {\n        dedupLine(ring);\n      } while (ring = ring.next);\n    } else {\n      dedupRing(ring);\n    }\n  }\n\n  function dedupLine(arc) {\n    var startPoint,\n        endPoint,\n        startArcs, startArc,\n        endArcs, endArc,\n        i, n;\n\n    // Does this arc match an existing arc in order?\n    if (startArcs = arcsByEnd.get(startPoint = coordinates[arc[0]])) {\n      for (i = 0, n = startArcs.length; i < n; ++i) {\n        startArc = startArcs[i];\n        if (equalLine(startArc, arc)) {\n          arc[0] = startArc[0];\n          arc[1] = startArc[1];\n          return;\n        }\n      }\n    }\n\n    // Does this arc match an existing arc in reverse order?\n    if (endArcs = arcsByEnd.get(endPoint = coordinates[arc[1]])) {\n      for (i = 0, n = endArcs.length; i < n; ++i) {\n        endArc = endArcs[i];\n        if (reverseEqualLine(endArc, arc)) {\n          arc[1] = endArc[0];\n          arc[0] = endArc[1];\n          return;\n        }\n      }\n    }\n\n    if (startArcs) startArcs.push(arc); else arcsByEnd.set(startPoint, [arc]);\n    if (endArcs) endArcs.push(arc); else arcsByEnd.set(endPoint, [arc]);\n    arcs.push(arc);\n  }\n\n  function dedupRing(arc) {\n    var endPoint,\n        endArcs,\n        endArc,\n        i, n;\n\n    // Does this arc match an existing line in order, or reverse order?\n    // Rings are closed, so their start point and end point is the same.\n    if (endArcs = arcsByEnd.get(endPoint = coordinates[arc[0]])) {\n      for (i = 0, n = endArcs.length; i < n; ++i) {\n        endArc = endArcs[i];\n        if (equalRing(endArc, arc)) {\n          arc[0] = endArc[0];\n          arc[1] = endArc[1];\n          return;\n        }\n        if (reverseEqualRing(endArc, arc)) {\n          arc[0] = endArc[1];\n          arc[1] = endArc[0];\n          return;\n        }\n      }\n    }\n\n    // Otherwise, does this arc match an existing ring in order, or reverse order?\n    if (endArcs = arcsByEnd.get(endPoint = coordinates[arc[0] + findMinimumOffset(arc)])) {\n      for (i = 0, n = endArcs.length; i < n; ++i) {\n        endArc = endArcs[i];\n        if (equalRing(endArc, arc)) {\n          arc[0] = endArc[0];\n          arc[1] = endArc[1];\n          return;\n        }\n        if (reverseEqualRing(endArc, arc)) {\n          arc[0] = endArc[1];\n          arc[1] = endArc[0];\n          return;\n        }\n      }\n    }\n\n    if (endArcs) endArcs.push(arc); else arcsByEnd.set(endPoint, [arc]);\n    arcs.push(arc);\n  }\n\n  function equalLine(arcA, arcB) {\n    var ia = arcA[0], ib = arcB[0],\n        ja = arcA[1], jb = arcB[1];\n    if (ia - ja !== ib - jb) return false;\n    for (; ia <= ja; ++ia, ++ib) if (!equalPoint(coordinates[ia], coordinates[ib])) return false;\n    return true;\n  }\n\n  function reverseEqualLine(arcA, arcB) {\n    var ia = arcA[0], ib = arcB[0],\n        ja = arcA[1], jb = arcB[1];\n    if (ia - ja !== ib - jb) return false;\n    for (; ia <= ja; ++ia, --jb) if (!equalPoint(coordinates[ia], coordinates[jb])) return false;\n    return true;\n  }\n\n  function equalRing(arcA, arcB) {\n    var ia = arcA[0], ib = arcB[0],\n        ja = arcA[1], jb = arcB[1],\n        n = ja - ia;\n    if (n !== jb - ib) return false;\n    var ka = findMinimumOffset(arcA),\n        kb = findMinimumOffset(arcB);\n    for (var i = 0; i < n; ++i) {\n      if (!equalPoint(coordinates[ia + (i + ka) % n], coordinates[ib + (i + kb) % n])) return false;\n    }\n    return true;\n  }\n\n  function reverseEqualRing(arcA, arcB) {\n    var ia = arcA[0], ib = arcB[0],\n        ja = arcA[1], jb = arcB[1],\n        n = ja - ia;\n    if (n !== jb - ib) return false;\n    var ka = findMinimumOffset(arcA),\n        kb = n - findMinimumOffset(arcB);\n    for (var i = 0; i < n; ++i) {\n      if (!equalPoint(coordinates[ia + (i + ka) % n], coordinates[jb - (i + kb) % n])) return false;\n    }\n    return true;\n  }\n\n  // Rings are rotated to a consistent, but arbitrary, start point.\n  // This is necessary to detect when a ring and a rotated copy are dupes.\n  function findMinimumOffset(arc) {\n    var start = arc[0],\n        end = arc[1],\n        mid = start,\n        minimum = mid,\n        minimumPoint = coordinates[mid];\n    while (++mid < end) {\n      var point = coordinates[mid];\n      if (point[0] < minimumPoint[0] || point[0] === minimumPoint[0] && point[1] < minimumPoint[1]) {\n        minimum = mid;\n        minimumPoint = point;\n      }\n    }\n    return minimum - start;\n  }\n\n  return topology;\n};\n\n// Given an array of arcs in absolute (but already quantized!) coordinates,\n// converts to fixed-point delta encoding.\n// This is a destructive operation that modifies the given arcs!\nvar delta = function(arcs) {\n  var i = -1,\n      n = arcs.length;\n\n  while (++i < n) {\n    var arc = arcs[i],\n        j = 0,\n        k = 1,\n        m = arc.length,\n        point = arc[0],\n        x0 = point[0],\n        y0 = point[1],\n        x1,\n        y1;\n\n    while (++j < m) {\n      point = arc[j], x1 = point[0], y1 = point[1];\n      if (x1 !== x0 || y1 !== y0) arc[k++] = [x1 - x0, y1 - y0], x0 = x1, y0 = y1;\n    }\n\n    if (k === 1) arc[k++] = [0, 0]; // Each arc must be an array of two or more positions.\n\n    arc.length = k;\n  }\n\n  return arcs;\n};\n\n// Extracts the lines and rings from the specified hash of geometry objects.\n//\n// Returns an object with three properties:\n//\n// * coordinates - shared buffer of [x, y] coordinates\n// * lines - lines extracted from the hash, of the form [start, end]\n// * rings - rings extracted from the hash, of the form [start, end]\n//\n// For each ring or line, start and end represent inclusive indexes into the\n// coordinates buffer. For rings (and closed lines), coordinates[start] equals\n// coordinates[end].\n//\n// For each line or polygon geometry in the input hash, including nested\n// geometries as in geometry collections, the `coordinates` array is replaced\n// with an equivalent `arcs` array that, for each line (for line string\n// geometries) or ring (for polygon geometries), points to one of the above\n// lines or rings.\nvar extract = function(objects) {\n  var index = -1,\n      lines = [],\n      rings = [],\n      coordinates = [];\n\n  function extractGeometry(geometry) {\n    if (geometry && extractGeometryType.hasOwnProperty(geometry.type)) extractGeometryType[geometry.type](geometry);\n  }\n\n  var extractGeometryType = {\n    GeometryCollection: function(o) { o.geometries.forEach(extractGeometry); },\n    LineString: function(o) { o.arcs = extractLine(o.arcs); },\n    MultiLineString: function(o) { o.arcs = o.arcs.map(extractLine); },\n    Polygon: function(o) { o.arcs = o.arcs.map(extractRing); },\n    MultiPolygon: function(o) { o.arcs = o.arcs.map(extractMultiRing); }\n  };\n\n  function extractLine(line) {\n    for (var i = 0, n = line.length; i < n; ++i) coordinates[++index] = line[i];\n    var arc = {0: index - n + 1, 1: index};\n    lines.push(arc);\n    return arc;\n  }\n\n  function extractRing(ring) {\n    for (var i = 0, n = ring.length; i < n; ++i) coordinates[++index] = ring[i];\n    var arc = {0: index - n + 1, 1: index};\n    rings.push(arc);\n    return arc;\n  }\n\n  function extractMultiRing(rings) {\n    return rings.map(extractRing);\n  }\n\n  for (var key in objects) {\n    extractGeometry(objects[key]);\n  }\n\n  return {\n    type: \"Topology\",\n    coordinates: coordinates,\n    lines: lines,\n    rings: rings,\n    objects: objects\n  };\n};\n\n// Given a hash of GeoJSON objects, returns a hash of GeoJSON geometry objects.\n// Any null input geometry objects are represented as {type: null} in the output.\n// Any feature.{id,properties,bbox} are transferred to the output geometry object.\n// Each output geometry object is a shallow copy of the input (e.g., properties, coordinates)!\nvar geometry = function(inputs) {\n  var outputs = {}, key;\n  for (key in inputs) outputs[key] = geomifyObject(inputs[key]);\n  return outputs;\n};\n\nfunction geomifyObject(input) {\n  return input == null ? {type: null}\n      : (input.type === \"FeatureCollection\" ? geomifyFeatureCollection\n      : input.type === \"Feature\" ? geomifyFeature\n      : geomifyGeometry)(input);\n}\n\nfunction geomifyFeatureCollection(input) {\n  var output = {type: \"GeometryCollection\", geometries: input.features.map(geomifyFeature)};\n  if (input.bbox != null) output.bbox = input.bbox;\n  return output;\n}\n\nfunction geomifyFeature(input) {\n  var output = geomifyGeometry(input.geometry), key; // eslint-disable-line no-unused-vars\n  if (input.id != null) output.id = input.id;\n  if (input.bbox != null) output.bbox = input.bbox;\n  for (key in input.properties) { output.properties = input.properties; break; }\n  return output;\n}\n\nfunction geomifyGeometry(input) {\n  if (input == null) return {type: null};\n  var output = input.type === \"GeometryCollection\" ? {type: \"GeometryCollection\", geometries: input.geometries.map(geomifyGeometry)}\n      : input.type === \"Point\" || input.type === \"MultiPoint\" ? {type: input.type, coordinates: input.coordinates}\n      : {type: input.type, arcs: input.coordinates}; // TODO Check for unknown types?\n  if (input.bbox != null) output.bbox = input.bbox;\n  return output;\n}\n\nvar prequantize = function(objects, bbox, n) {\n  var x0 = bbox[0],\n      y0 = bbox[1],\n      x1 = bbox[2],\n      y1 = bbox[3],\n      kx = x1 - x0 ? (n - 1) / (x1 - x0) : 1,\n      ky = y1 - y0 ? (n - 1) / (y1 - y0) : 1;\n\n  function quantizePoint(input) {\n    return [Math.round((input[0] - x0) * kx), Math.round((input[1] - y0) * ky)];\n  }\n\n  function quantizePoints(input, m) {\n    var i = -1,\n        j = 0,\n        n = input.length,\n        output = new Array(n), // pessimistic\n        pi,\n        px,\n        py,\n        x,\n        y;\n\n    while (++i < n) {\n      pi = input[i];\n      x = Math.round((pi[0] - x0) * kx);\n      y = Math.round((pi[1] - y0) * ky);\n      if (x !== px || y !== py) output[j++] = [px = x, py = y]; // non-coincident points\n    }\n\n    output.length = j;\n    while (j < m) j = output.push([output[0][0], output[0][1]]);\n    return output;\n  }\n\n  function quantizeLine(input) {\n    return quantizePoints(input, 2);\n  }\n\n  function quantizeRing(input) {\n    return quantizePoints(input, 4);\n  }\n\n  function quantizePolygon(input) {\n    return input.map(quantizeRing);\n  }\n\n  function quantizeGeometry(o) {\n    if (o != null && quantizeGeometryType.hasOwnProperty(o.type)) quantizeGeometryType[o.type](o);\n  }\n\n  var quantizeGeometryType = {\n    GeometryCollection: function(o) { o.geometries.forEach(quantizeGeometry); },\n    Point: function(o) { o.coordinates = quantizePoint(o.coordinates); },\n    MultiPoint: function(o) { o.coordinates = o.coordinates.map(quantizePoint); },\n    LineString: function(o) { o.arcs = quantizeLine(o.arcs); },\n    MultiLineString: function(o) { o.arcs = o.arcs.map(quantizeLine); },\n    Polygon: function(o) { o.arcs = quantizePolygon(o.arcs); },\n    MultiPolygon: function(o) { o.arcs = o.arcs.map(quantizePolygon); }\n  };\n\n  for (var key in objects) {\n    quantizeGeometry(objects[key]);\n  }\n\n  return {\n    scale: [1 / kx, 1 / ky],\n    translate: [x0, y0]\n  };\n};\n\n// Constructs the TopoJSON Topology for the specified hash of features.\n// Each object in the specified hash must be a GeoJSON object,\n// meaning FeatureCollection, a Feature or a geometry object.\nvar topology = function(objects, quantization) {\n  var bbox = bounds(objects = geometry(objects)),\n      transform = quantization > 0 && bbox && prequantize(objects, bbox, quantization),\n      topology = dedup(cut(extract(objects))),\n      coordinates = topology.coordinates,\n      indexByArc = hashmap(topology.arcs.length * 1.4, hashArc, equalArc);\n\n  objects = topology.objects; // for garbage collection\n  topology.bbox = bbox;\n  topology.arcs = topology.arcs.map(function(arc, i) {\n    indexByArc.set(arc, i);\n    return coordinates.slice(arc[0], arc[1] + 1);\n  });\n\n  delete topology.coordinates;\n  coordinates = null;\n\n  function indexGeometry(geometry$$1) {\n    if (geometry$$1 && indexGeometryType.hasOwnProperty(geometry$$1.type)) indexGeometryType[geometry$$1.type](geometry$$1);\n  }\n\n  var indexGeometryType = {\n    GeometryCollection: function(o) { o.geometries.forEach(indexGeometry); },\n    LineString: function(o) { o.arcs = indexArcs(o.arcs); },\n    MultiLineString: function(o) { o.arcs = o.arcs.map(indexArcs); },\n    Polygon: function(o) { o.arcs = o.arcs.map(indexArcs); },\n    MultiPolygon: function(o) { o.arcs = o.arcs.map(indexMultiArcs); }\n  };\n\n  function indexArcs(arc) {\n    var indexes = [];\n    do {\n      var index = indexByArc.get(arc);\n      indexes.push(arc[0] < arc[1] ? index : ~index);\n    } while (arc = arc.next);\n    return indexes;\n  }\n\n  function indexMultiArcs(arcs) {\n    return arcs.map(indexArcs);\n  }\n\n  for (var key in objects) {\n    indexGeometry(objects[key]);\n  }\n\n  if (transform) {\n    topology.transform = transform;\n    topology.arcs = delta(topology.arcs);\n  }\n\n  return topology;\n};\n\nfunction hashArc(arc) {\n  var i = arc[0], j = arc[1], t;\n  if (j < i) t = i, i = j, j = t;\n  return i + 31 * j;\n}\n\nfunction equalArc(arcA, arcB) {\n  var ia = arcA[0], ja = arcA[1],\n      ib = arcB[0], jb = arcB[1], t;\n  if (ja < ia) t = ia, ia = ja, ja = t;\n  if (jb < ib) t = ib, ib = jb, jb = t;\n  return ia === ib && ja === jb;\n}\n\nexports.topology = topology;\n\nObject.defineProperty(exports, '__esModule', { value: true });\n\n})));\n\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./~/topojson-server/dist/topojson-server.js\n// module id = 50\n// module chunks = 0","// https://github.com/topojson/topojson-simplify Version 3.0.2. Copyright 2017 Mike Bostock.\n(function (global, factory) {\n\ttypeof exports === 'object' && typeof module !== 'undefined' ? factory(exports, require('topojson-client')) :\n\ttypeof define === 'function' && define.amd ? define(['exports', 'topojson-client'], factory) :\n\t(factory((global.topojson = global.topojson || {}),global.topojson));\n}(this, (function (exports,topojsonClient) { 'use strict';\n\nvar prune = function(topology) {\n  var oldObjects = topology.objects,\n      newObjects = {},\n      oldArcs = topology.arcs,\n      oldArcsLength = oldArcs.length,\n      oldIndex = -1,\n      newIndexByOldIndex = new Array(oldArcsLength),\n      newArcsLength = 0,\n      newArcs,\n      newIndex = -1,\n      key;\n\n  function scanGeometry(input) {\n    switch (input.type) {\n      case \"GeometryCollection\": input.geometries.forEach(scanGeometry); break;\n      case \"LineString\": scanArcs(input.arcs); break;\n      case \"MultiLineString\": input.arcs.forEach(scanArcs); break;\n      case \"Polygon\": input.arcs.forEach(scanArcs); break;\n      case \"MultiPolygon\": input.arcs.forEach(scanMultiArcs); break;\n    }\n  }\n\n  function scanArc(index) {\n    if (index < 0) index = ~index;\n    if (!newIndexByOldIndex[index]) newIndexByOldIndex[index] = 1, ++newArcsLength;\n  }\n\n  function scanArcs(arcs) {\n    arcs.forEach(scanArc);\n  }\n\n  function scanMultiArcs(arcs) {\n    arcs.forEach(scanArcs);\n  }\n\n  function reindexGeometry(input) {\n    var output;\n    switch (input.type) {\n      case \"GeometryCollection\": output = {type: \"GeometryCollection\", geometries: input.geometries.map(reindexGeometry)}; break;\n      case \"LineString\": output = {type: \"LineString\", arcs: reindexArcs(input.arcs)}; break;\n      case \"MultiLineString\": output = {type: \"MultiLineString\", arcs: input.arcs.map(reindexArcs)}; break;\n      case \"Polygon\": output = {type: \"Polygon\", arcs: input.arcs.map(reindexArcs)}; break;\n      case \"MultiPolygon\": output = {type: \"MultiPolygon\", arcs: input.arcs.map(reindexMultiArcs)}; break;\n      default: return input;\n    }\n    if (input.id != null) output.id = input.id;\n    if (input.bbox != null) output.bbox = input.bbox;\n    if (input.properties != null) output.properties = input.properties;\n    return output;\n  }\n\n  function reindexArc(oldIndex) {\n    return oldIndex < 0 ? ~newIndexByOldIndex[~oldIndex] : newIndexByOldIndex[oldIndex];\n  }\n\n  function reindexArcs(arcs) {\n    return arcs.map(reindexArc);\n  }\n\n  function reindexMultiArcs(arcs) {\n    return arcs.map(reindexArcs);\n  }\n\n  for (key in oldObjects) {\n    scanGeometry(oldObjects[key]);\n  }\n\n  newArcs = new Array(newArcsLength);\n\n  while (++oldIndex < oldArcsLength) {\n    if (newIndexByOldIndex[oldIndex]) {\n      newIndexByOldIndex[oldIndex] = ++newIndex;\n      newArcs[newIndex] = oldArcs[oldIndex];\n    }\n  }\n\n  for (key in oldObjects) {\n    newObjects[key] = reindexGeometry(oldObjects[key]);\n  }\n\n  return {\n    type: \"Topology\",\n    bbox: topology.bbox,\n    transform: topology.transform,\n    objects: newObjects,\n    arcs: newArcs\n  };\n};\n\nvar filter = function(topology, filter) {\n  var oldObjects = topology.objects,\n      newObjects = {},\n      key;\n\n  if (filter == null) filter = filterTrue;\n\n  function filterGeometry(input) {\n    var output, arcs;\n    switch (input.type) {\n      case \"Polygon\": {\n        arcs = filterRings(input.arcs);\n        output = arcs ? {type: \"Polygon\", arcs: arcs} : {type: null};\n        break;\n      }\n      case \"MultiPolygon\": {\n        arcs = input.arcs.map(filterRings).filter(filterIdentity);\n        output = arcs.length ? {type: \"MultiPolygon\", arcs: arcs} : {type: null};\n        break;\n      }\n      case \"GeometryCollection\": {\n        arcs = input.geometries.map(filterGeometry).filter(filterNotNull);\n        output = arcs.length ? {type: \"GeometryCollection\", geometries: arcs} : {type: null};\n        break;\n      }\n      default: return input;\n    }\n    if (input.id != null) output.id = input.id;\n    if (input.bbox != null) output.bbox = input.bbox;\n    if (input.properties != null) output.properties = input.properties;\n    return output;\n  }\n\n  function filterRings(arcs) {\n    return arcs.length && filterExteriorRing(arcs[0]) // if the exterior is small, ignore any holes\n        ? [arcs[0]].concat(arcs.slice(1).filter(filterInteriorRing))\n        : null;\n  }\n\n  function filterExteriorRing(ring) {\n    return filter(ring, false);\n  }\n\n  function filterInteriorRing(ring) {\n    return filter(ring, true);\n  }\n\n  for (key in oldObjects) {\n    newObjects[key] = filterGeometry(oldObjects[key]);\n  }\n\n  return prune({\n    type: \"Topology\",\n    bbox: topology.bbox,\n    transform: topology.transform,\n    objects: newObjects,\n    arcs: topology.arcs\n  });\n};\n\nfunction filterTrue() {\n  return true;\n}\n\nfunction filterIdentity(x) {\n  return x;\n}\n\nfunction filterNotNull(geometry) {\n  return geometry.type != null;\n}\n\nvar filterAttached = function(topology) {\n  var ownerByArc = new Array(topology.arcs.length), // arc index -> index of unique associated ring, or -1 if used by multiple rings\n      ownerIndex = 0,\n      key;\n\n  function testGeometry(o) {\n    switch (o.type) {\n      case \"GeometryCollection\": o.geometries.forEach(testGeometry); break;\n      case \"Polygon\": testArcs(o.arcs); break;\n      case \"MultiPolygon\": o.arcs.forEach(testArcs); break;\n    }\n  }\n\n  function testArcs(arcs) {\n    for (var i = 0, n = arcs.length; i < n; ++i, ++ownerIndex) {\n      for (var ring = arcs[i], j = 0, m = ring.length; j < m; ++j) {\n        var arc = ring[j];\n        if (arc < 0) arc = ~arc;\n        var owner = ownerByArc[arc];\n        if (owner == null) ownerByArc[arc] = ownerIndex;\n        else if (owner !== ownerIndex) ownerByArc[arc] = -1;\n      }\n    }\n  }\n\n  for (key in topology.objects) {\n    testGeometry(topology.objects[key]);\n  }\n\n  return function(ring) {\n    for (var j = 0, m = ring.length, arc; j < m; ++j) {\n      if (ownerByArc[(arc = ring[j]) < 0 ? ~arc : arc] === -1) {\n        return true;\n      }\n    }\n    return false;\n  };\n};\n\nfunction planarTriangleArea(triangle) {\n  var a = triangle[0], b = triangle[1], c = triangle[2];\n  return Math.abs((a[0] - c[0]) * (b[1] - a[1]) - (a[0] - b[0]) * (c[1] - a[1])) / 2;\n}\n\nfunction planarRingArea(ring) {\n  var i = -1, n = ring.length, a, b = ring[n - 1], area = 0;\n  while (++i < n) a = b, b = ring[i], area += a[0] * b[1] - a[1] * b[0];\n  return Math.abs(area) / 2;\n}\n\nvar filterWeight = function(topology, minWeight, weight) {\n  minWeight = minWeight == null ? Number.MIN_VALUE : +minWeight;\n\n  if (weight == null) weight = planarRingArea;\n\n  return function(ring, interior) {\n    return weight(topojsonClient.feature(topology, {type: \"Polygon\", arcs: [ring]}).geometry.coordinates[0], interior) >= minWeight;\n  };\n};\n\nvar filterAttachedWeight = function(topology, minWeight, weight) {\n  var a = filterAttached(topology),\n      w = filterWeight(topology, minWeight, weight);\n  return function(ring, interior) {\n    return a(ring, interior) || w(ring, interior);\n  };\n};\n\nfunction compare(a, b) {\n  return a[1][2] - b[1][2];\n}\n\nvar newHeap = function() {\n  var heap = {},\n      array = [],\n      size = 0;\n\n  heap.push = function(object) {\n    up(array[object._ = size] = object, size++);\n    return size;\n  };\n\n  heap.pop = function() {\n    if (size <= 0) return;\n    var removed = array[0], object;\n    if (--size > 0) object = array[size], down(array[object._ = 0] = object, 0);\n    return removed;\n  };\n\n  heap.remove = function(removed) {\n    var i = removed._, object;\n    if (array[i] !== removed) return; // invalid request\n    if (i !== --size) object = array[size], (compare(object, removed) < 0 ? up : down)(array[object._ = i] = object, i);\n    return i;\n  };\n\n  function up(object, i) {\n    while (i > 0) {\n      var j = ((i + 1) >> 1) - 1,\n          parent = array[j];\n      if (compare(object, parent) >= 0) break;\n      array[parent._ = i] = parent;\n      array[object._ = i = j] = object;\n    }\n  }\n\n  function down(object, i) {\n    while (true) {\n      var r = (i + 1) << 1,\n          l = r - 1,\n          j = i,\n          child = array[j];\n      if (l < size && compare(array[l], child) < 0) child = array[j = l];\n      if (r < size && compare(array[r], child) < 0) child = array[j = r];\n      if (j === i) break;\n      array[child._ = i] = child;\n      array[object._ = i = j] = object;\n    }\n  }\n\n  return heap;\n};\n\nfunction copy(point) {\n  return [point[0], point[1], 0];\n}\n\nvar presimplify = function(topology, weight) {\n  var point = topology.transform ? topojsonClient.transform(topology.transform) : copy,\n      heap = newHeap();\n\n  if (weight == null) weight = planarTriangleArea;\n\n  var arcs = topology.arcs.map(function(arc) {\n    var triangles = [],\n        maxWeight = 0,\n        triangle,\n        i,\n        n;\n\n    arc = arc.map(point);\n\n    for (i = 1, n = arc.length - 1; i < n; ++i) {\n      triangle = [arc[i - 1], arc[i], arc[i + 1]];\n      triangle[1][2] = weight(triangle);\n      triangles.push(triangle);\n      heap.push(triangle);\n    }\n\n    // Always keep the arc endpoints!\n    arc[0][2] = arc[n][2] = Infinity;\n\n    for (i = 0, n = triangles.length; i < n; ++i) {\n      triangle = triangles[i];\n      triangle.previous = triangles[i - 1];\n      triangle.next = triangles[i + 1];\n    }\n\n    while (triangle = heap.pop()) {\n      var previous = triangle.previous,\n          next = triangle.next;\n\n      // If the weight of the current point is less than that of the previous\n      // point to be eliminated, use the latters weight instead. This ensures\n      // that the current point cannot be eliminated without eliminating\n      // previously- eliminated points.\n      if (triangle[1][2] < maxWeight) triangle[1][2] = maxWeight;\n      else maxWeight = triangle[1][2];\n\n      if (previous) {\n        previous.next = next;\n        previous[2] = triangle[2];\n        update(previous);\n      }\n\n      if (next) {\n        next.previous = previous;\n        next[0] = triangle[0];\n        update(next);\n      }\n    }\n\n    return arc;\n  });\n\n  function update(triangle) {\n    heap.remove(triangle);\n    triangle[1][2] = weight(triangle);\n    heap.push(triangle);\n  }\n\n  return {\n    type: \"Topology\",\n    bbox: topology.bbox,\n    objects: topology.objects,\n    arcs: arcs\n  };\n};\n\nvar quantile = function(topology, p) {\n  var array = [];\n\n  topology.arcs.forEach(function(arc) {\n    arc.forEach(function(point) {\n      if (isFinite(point[2])) { // Ignore endpoints, whose weight is Infinity.\n        array.push(point[2]);\n      }\n    });\n  });\n\n  return array.length && quantile$1(array.sort(descending), p);\n};\n\nfunction quantile$1(array, p) {\n  if (!(n = array.length)) return;\n  if ((p = +p) <= 0 || n < 2) return array[0];\n  if (p >= 1) return array[n - 1];\n  var n,\n      h = (n - 1) * p,\n      i = Math.floor(h),\n      a = array[i],\n      b = array[i + 1];\n  return a + (b - a) * (h - i);\n}\n\nfunction descending(a, b) {\n  return b - a;\n}\n\nvar simplify = function(topology, minWeight) {\n  minWeight = minWeight == null ? Number.MIN_VALUE : +minWeight;\n\n  // Remove points whose weight is less than the minimum weight.\n  var arcs = topology.arcs.map(function(input) {\n    var i = -1,\n        j = 0,\n        n = input.length,\n        output = new Array(n), // pessimistic\n        point;\n\n    while (++i < n) {\n      if ((point = input[i])[2] >= minWeight) {\n        output[j++] = [point[0], point[1]];\n      }\n    }\n\n    output.length = j;\n    return output;\n  });\n\n  return {\n    type: \"Topology\",\n    transform: topology.transform,\n    bbox: topology.bbox,\n    objects: topology.objects,\n    arcs: arcs\n  };\n};\n\nvar pi = Math.PI;\nvar tau = 2 * pi;\nvar quarterPi = pi / 4;\nvar radians = pi / 180;\nvar abs = Math.abs;\nvar atan2 = Math.atan2;\nvar cos = Math.cos;\nvar sin = Math.sin;\n\nfunction halfArea(ring, closed) {\n  var i = 0,\n      n = ring.length,\n      sum = 0,\n      point = ring[closed ? i++ : n - 1],\n      lambda0, lambda1 = point[0] * radians,\n      phi1 = (point[1] * radians) / 2 + quarterPi,\n      cosPhi0, cosPhi1 = cos(phi1),\n      sinPhi0, sinPhi1 = sin(phi1);\n\n  for (; i < n; ++i) {\n    point = ring[i];\n    lambda0 = lambda1, lambda1 = point[0] * radians;\n    phi1 = (point[1] * radians) / 2 + quarterPi;\n    cosPhi0 = cosPhi1, cosPhi1 = cos(phi1);\n    sinPhi0 = sinPhi1, sinPhi1 = sin(phi1);\n\n    // Spherical excess E for a spherical triangle with vertices: south pole,\n    // previous point, current point.  Uses a formula derived from Cagnolis\n    // theorem.  See Todhunter, Spherical Trig. (1871), Sec. 103, Eq. (2).\n    // See https://github.com/d3/d3-geo/blob/master/README.md#geoArea\n    var dLambda = lambda1 - lambda0,\n        sdLambda = dLambda >= 0 ? 1 : -1,\n        adLambda = sdLambda * dLambda,\n        k = sinPhi0 * sinPhi1,\n        u = cosPhi0 * cosPhi1 + k * cos(adLambda),\n        v = k * sdLambda * sin(adLambda);\n    sum += atan2(v, u);\n  }\n\n  return sum;\n}\n\nfunction sphericalRingArea(ring, interior) {\n  var sum = halfArea(ring, true);\n  if (interior) sum *= -1;\n  return (sum < 0 ? tau + sum : sum) * 2;\n}\n\nfunction sphericalTriangleArea(t) {\n  return abs(halfArea(t, false)) * 2;\n}\n\nexports.filter = filter;\nexports.filterAttached = filterAttached;\nexports.filterAttachedWeight = filterAttachedWeight;\nexports.filterWeight = filterWeight;\nexports.planarRingArea = planarRingArea;\nexports.planarTriangleArea = planarTriangleArea;\nexports.presimplify = presimplify;\nexports.quantile = quantile;\nexports.simplify = simplify;\nexports.sphericalRingArea = sphericalRingArea;\nexports.sphericalTriangleArea = sphericalTriangleArea;\n\nObject.defineProperty(exports, '__esModule', { value: true });\n\n})));\n\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./~/topojson-simplify/dist/topojson-simplify.js\n// module id = 51\n// module chunks = 0","var d3 = require(\"d3\"),\n  _ = require(\"underscore\");\n\nfunction hivtrace_histogram(graph, histogram_tag, histogram_label) {\n  var defaultFloatFormat = d3.format(\",.2f\");\n  var histogram_w = 300,\n    histogram_h = 300;\n\n  hivtrace_render_histogram(\n    graph[\"Degrees\"][\"Distribution\"],\n    graph[\"Degrees\"][\"fitted\"],\n    histogram_w,\n    histogram_h,\n    histogram_tag\n  );\n\n  var label =\n    \"Network degree distribution is best described by the <strong>\" +\n    graph[\"Degrees\"][\"Model\"] +\n    \"</strong> model, with &rho; of \" +\n    defaultFloatFormat(graph[\"Degrees\"][\"rho\"]);\n\n  if (graph[\"Degrees\"][\"rho CI\"] != undefined) {\n    label +=\n      \" (95% CI \" +\n      defaultFloatFormat(graph[\"Degrees\"][\"rho CI\"][0]) +\n      \" - \" +\n      defaultFloatFormat(graph[\"Degrees\"][\"rho CI\"][1]) +\n      \")\";\n  }\n\n  d3.select(histogram_label).html(label);\n}\n\nfunction hivtrace_histogram_distances(graph, histogram_tag, histogram_label) {\n  var defaultFloatFormat = d3.format(\",.3p\");\n  var histogram_w = 300,\n    histogram_h = 300;\n\n  var edge_lengths = _.map(graph[\"Edges\"], function(edge) {\n    return edge.length;\n  });\n\n  hivtrace_render_histogram_continuous(\n    edge_lengths,\n    histogram_w,\n    histogram_h,\n    histogram_tag\n  );\n\n  var label = \"Genetic distances among linked nodes.\";\n  d3.select(histogram_label).html(label);\n}\n\nfunction hivtrace_render_histogram_continuous(data, w, h, id) {\n  var margin = {\n      top: 10,\n      right: 30,\n      bottom: 50,\n      left: 10\n    },\n    width = w - margin.right,\n    height = h - margin.top - margin.bottom;\n\n  var histogram_svg = d3.select(id).selectAll(\"svg\");\n\n  if (histogram_svg) {\n    histogram_svg.remove();\n  }\n\n  if (data.length > 0) {\n    var histogram_data = d3.layout.histogram()(data);\n\n    var x = d3.scale.linear().domain(d3.extent(data));\n\n    var y = d3.scale\n      .linear()\n      .domain([\n        0,\n        d3.max(\n          _.map(histogram_data, function(b) {\n            return b.y;\n          })\n        )\n      ])\n      .range([height, 0]);\n\n    margin.left += 10 * Math.ceil(Math.log10(y.domain()[1]));\n    width -= margin.left;\n    x.range([0, width]);\n\n    var xAxis = d3.svg.axis().scale(x).orient(\"bottom\");\n\n    var yAxis = d3.svg.axis().scale(y).orient(\"left\");\n\n    histogram_data.splice(0, 0, {\n      x: x.domain()[0],\n      y: 0,\n      dx: 0\n    });\n    histogram_data.splice(histogram_data.length, 0, {\n      x: x.domain()[1],\n      y: 0,\n      dx: 0\n    });\n\n    histogram_svg = d3\n      .select(id)\n      .insert(\"svg\", \".histogram-label\")\n      .attr(\"width\", width + margin.left + margin.right)\n      .attr(\"height\", height + margin.top + margin.bottom)\n      .append(\"g\")\n      .attr(\"transform\", \"translate(\" + margin.left + \",\" + margin.top + \")\")\n      .datum(histogram_data);\n\n    var histogram_line = d3.svg\n      .line()\n      .x(function(d) {\n        return x(d.x + d.dx);\n      })\n      .y(function(d) {\n        return y(d.y);\n      })\n      .interpolate(\"step-before\");\n\n    histogram_svg.selectAll(\"path\").remove();\n    histogram_svg\n      .append(\"path\")\n      .attr(\"d\", function(d) {\n        return histogram_line(d) + \"Z\";\n      })\n      .attr(\"class\", \"histogram\");\n\n    var x_axis = histogram_svg\n      .append(\"g\")\n      .attr(\"class\", \"x axis\")\n      .attr(\"transform\", \"translate(0,\" + height + \")\")\n      .call(xAxis);\n\n    x_axis\n      .selectAll(\"text\")\n      .attr(\"transform\", \"rotate(45)\")\n      .attr(\"dx\", \"1em\")\n      .attr(\"dy\", \"0.5em\");\n\n    var y_axis = histogram_svg\n      .append(\"g\")\n      .attr(\"class\", \"y axis\")\n      //.attr(\"transform\", \"translate(0,\" + height + \")\")\n      .call(yAxis);\n  }\n}\n\nfunction hivtrace_render_histogram(counts, fit, w, h, id) {\n  var margin = {\n      top: 10,\n      right: 30,\n      bottom: 50,\n      left: 30\n    },\n    width = w - margin.left - margin.right,\n    height = h - margin.top - margin.bottom;\n\n  var x = d3.scale.linear().domain([0, counts.length + 1]).range([0, width]);\n\n  var y = d3.scale.log().domain([1, d3.max(counts)]).range([height, 0]);\n\n  var total = d3.sum(counts);\n\n  var xAxis = d3.svg.axis().scale(x).orient(\"bottom\");\n\n  var histogram_svg = d3.select(id).selectAll(\"svg\");\n\n  if (histogram_svg) {\n    histogram_svg.remove();\n  }\n\n  var data_to_plot = counts.map(function(d, i) {\n    return {\n      x: i + 1,\n      y: d + 1\n    };\n  });\n  data_to_plot.push({\n    x: counts.length + 1,\n    y: 1\n  });\n  data_to_plot.push({\n    x: 0,\n    y: 1\n  });\n  data_to_plot.push({\n    x: 0,\n    y: counts[0] + 1\n  });\n\n  histogram_svg = d3\n    .select(id)\n    .insert(\"svg\", \".histogram-label\")\n    .attr(\"width\", width + margin.left + margin.right)\n    .attr(\"height\", height + margin.top + margin.bottom)\n    .append(\"g\")\n    .attr(\"transform\", \"translate(\" + margin.left + \",\" + margin.top + \")\")\n    .datum(data_to_plot);\n\n  var histogram_line = d3.svg\n    .line()\n    .x(function(d) {\n      return x(d.x);\n    })\n    .y(function(d) {\n      return y(d.y);\n    })\n    .interpolate(\"step-before\");\n\n  histogram_svg.selectAll(\"path\").remove();\n  histogram_svg\n    .append(\"path\")\n    .attr(\"d\", function(d) {\n      return histogram_line(d) + \"Z\";\n    })\n    .attr(\"class\", \"histogram\");\n\n  if (fit) {\n    var fit_line = d3.svg\n      .line()\n      .interpolate(\"linear\")\n      .x(function(d, i) {\n        return x(i + 1) + (x(i + 1) - x(i)) / 2;\n      })\n      .y(function(d) {\n        return y(1 + d * total);\n      });\n    histogram_svg\n      .append(\"path\")\n      .datum(fit)\n      .attr(\"class\", \"line\")\n      .attr(\"d\", function(d) {\n        return fit_line(d);\n      });\n  }\n\n  var x_axis = histogram_svg\n    .append(\"g\")\n    .attr(\"class\", \"x axis\")\n    .attr(\"transform\", \"translate(0,\" + height + \")\")\n    .call(xAxis);\n\n  x_axis\n    .selectAll(\"text\")\n    .attr(\"transform\", \"rotate(45)\")\n    .attr(\"dx\", \"1em\")\n    .attr(\"dy\", \"0.5em\");\n}\n\nexports.histogram = hivtrace_histogram;\nexports.histogramDistances = hivtrace_histogram_distances;\n\n\n\n// WEBPACK FOOTER //\n// ./src/histogram.js"],"sourceRoot":""}